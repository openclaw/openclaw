# MEMORY.md — Molt Knowledge Base

## Принципы работы
- **Логи первым делом** — при любой проблеме сначала смотреть логи (`./scripts/clawlog.sh`, session JSONL файлы), а не гадать.
- **Краткие записи контекста** — в конце сложных сессий писать summary в `memory/` чтобы не терять прогресс.
- **memory_search настроен** — Voyage AI (`voyage-3`) через OpenAI-compatible endpoint (2026-01-30).

## Memory & PARA структура
- **MEMORY.md** — долгосрочная курированная память
- **memory/YYYY-MM-DD.md** — дневные логи
- **notes/** — PARA структура (searchable через symlink `memory/notes -> notes/`)
  - `notes/projects/` — активные задачи с дедлайном
  - `notes/areas/` — постоянные зоны ответственности
  - `notes/resources/` — справочные материалы
  - `notes/archive/` — завершённое/неактивное
- **Куда писать:**
  - Сегодняшние события → `memory/YYYY-MM-DD.md`
  - Задача с дедлайном → `notes/projects/`
  - Постоянная тема → `notes/areas/`
  - Справочник → `notes/resources/`
  - Завершённое → `notes/archive/`
  - Выводы и уроки → `MEMORY.md`

## Рабочие паттерны
- **Батчевые вопросы** при брейншторме — Влад предпочитает несколько вопросов сразу, не по одному
- **Сверка с оригиналом** — при адаптации чужого кода/промптов делать таблицу соответствия
- **Subagent для ресёрча** — спавнить агента на исследование, не забивать основную сессию
- **Browser-тестирование** — Playwright MCP уже установлен в Claude Code, использовать для верификации
- **THE LOOP** — основной протокол разработки (скилл `the-loop`). Molt = архитектор, Claude Code = исполнитель

## Инфраструктура
- Gateway запускается из `~/moltbot/dist/index.js` (git checkout), НЕ из npm пакета
- `/opt/homebrew/bin/moltbot` → симлинк на `~/moltbot/moltbot.mjs`
- Обновляться через `git pull`, **НЕ** через `npm i -g moltbot` (сломает симлинки)
- GitHub аккаунт: `vladdick88`, READ доступ к `moltbot/moltbot` — для PR нужен форк

## Известные баги и фиксы

### Tool result pairing / "terminated" баг (2026-01-30)
- **Проблема:** После длинной работы assistant получает `stopReason=error` (terminated) с partial toolCall. Repair вставляет synthetic toolResult, но это ломает Anthropic API — два consecutive user messages мержатся и API реджектит.
- **Root cause:** `session-transcript-repair.ts` не стрипал toolCall блоки из error/terminated assistants.
- **Фикс начат:** Добавлен strip toolCalls из error assistants в repair. Но сессия крашнулась до завершения — **нужно проверить что фикс полный и протестирован**.
- **Файл:** `src/agents/session-transcript-repair.ts`
- **Логи сессий:** смотреть `~/.clawdbot/agents/main/sessions/*.jsonl`

## Принципы памяти
- Записывать контекст в `memory/` после каждого значимого шага (сделал, нашёл, решил)
- Не на каждое сообщение — только когда есть что терять
- Цель: при внезапном краше потерять максимум последний шаг

## WAL Protocol (Write-Ahead Log)
- **Закон:** если пользователь даёт конкретную деталь (имя, решение, исправление) → обновить SESSION-STATE.md ДО ответа
- **Триггер:** input пользователя, не моя память. Правило срабатывает автоматически.
- **SESSION-STATE.md** — горячая рабочая память (что делаю прямо сейчас). Читать ПЕРВЫМ при старте сессии.

## Recovery Protocol
- При старте сессии / после компакции: читать SESSION-STATE.md → memory/сегодня → memory_search
- НЕ спрашивать "что мы делали?" если SESSION-STATE.md содержит ответ
- При context > 70%: активный flush в SESSION-STATE.md и daily notes
- При context > 85%: emergency flush — полное summary перед следующим ответом

## Learnings система
- `memory/learnings/global.md` — мои ошибки как агента (забыл скилл, не стримил и т.д.)
- `memory/learnings/{project}.md` — ошибки/паттерны конкретного проекта
- После каждой ошибки — запись в learnings. Формат: Что/Почему/Фикс
- Перед работой с проектом — читать его learnings

## PREFLIGHT протокол
- PREFLIGHT.md — короткий чеклист, читать ПЕРЕД каждым ответом
- Сканировать скиллы → выбрать подходящий
- Проверить learnings → не повторять ошибки
- Стримить прогресс → не молчать

## Философия Влада: "Доктор Осьминог"
- Влад = мозг. AI-агенты = щупальца/руки. Не "AI за меня", а "мой мозг с 8 руками"
- Все проекты — одна идея: автономные системы которые работают за него (content factory, AI secretar, я, dating app)
- Хочет Джарвиса — сказал, подумал → система сделала
- Подход: "я-first, AI-руки" — AI идёт по его сценарию, не импровизирует
- Главная боль: "руки забывают что мозг сказал" — LLM теряют инструкции
- Решение: PREFLIGHT + learnings + стрим прогресса
- Ненавидит неэффективность — когда усилия не конвертируются в результат
- Хочет чип в мозг для прямого output мыслей (когда технология будет)

## Предпочтения Влада
- Раздражает когда сессия ломается и нужно делать /new
- Хочет чтобы контекст не терялся между сессиями
- Ценит когда агент сам обращается к логам при проблемах, а не спрашивает
- **Записывать в memory КАЖДОЕ сообщение** — минимальная правка после каждого обмена, не ждать накопления
- **Это критическое правило** — Влад повторял несколько раз, значит это важно. Без записи в память ответ незавершён.
- **НЕ обрезать/сокращать контент** — если Влад просит информацию, давать ПОЛНОСТЬЮ. Бить на части если длинно, но не резать. "Делаешь то о чём не просят" — прямая цитата.
- **Subagent'ы для ресёрча** — работает отлично. Спавнить на поиск/анализ, основная сессия свободна.

## Экосистема Влада — "Automation-as-Income"

### Архитектура
- **Molt (я)** — связующее звено. Личный агент Влада. Руки во всё: браузер, код, cron, публикация. Для личного использования хватает меня — бот не нужен.
- **SaaS модули** — продукты на продажу. Отдельные боты с удобным интерфейсом в Telegram. Каждый решает одну задачу.
- **Экосистема** — набор модулей для автоматизации контента/дохода. Продаются отдельно или bundle.

### Текущие модули (проекты)
- **Content Factory** — генерация/монтаж/публикация коротких видео (Shorts/TikTok/Reels)
- **Telegram Auto Channel** — автосбор/переписывание/публикация новостей в каналы

### Идеи на будущее
- Экосистема модулей "на любые случаи жизни" — не только контент-фермы
- Moltbot на сервере как hosted AGI-агент (продавать доступ к умному агенту)
- Dating app с автоматизацией через Second Me

### Бизнес-модель
- SaaS модули = пассивный заработок (подписки $3-10/мес)
- Влад = своя ЦА (17 лет, подростки которые хотят заработать)
- Концепция: продаём не инструмент, а "машину для печатания денег"
- Сначала продукты (пассивный доход), параллельно — основной стартап

## Проекты Влада
- **AI Secretar** — главный проект, телеграм бот-секретарь (Python/aiogram 3.x)
  - Neon PostgreSQL, OpenRouter (DeepSeek R1), Groq Whisper
  - 10/13 блоков готово, следующие — Block 12 (проактивность) и Block 13 (интеграция со мной)
  - 11 типов сущностей, 5 режимов AI, интеграции (GCal, Todoist, Notion)
  - Влад использует как личный инструмент для задач/идей/планов
  - Бот для тестов: `@daily_ai_helper_bot`
- ~/Projects/ — 15+ проектов, AI Secretar основной активный

## Правила работы с кодом
- **Всегда Claude Code** для любых изменений в проектах — не руками
- **Стримить прогресс** в чат: запуск → процесс → ошибки → результат. Влад в Телеграме, терминал не видит.
- Claude Code: `claude -p --dangerously-skip-permissions` для автономной работы, `pty: true`, `background: true`

## Договорённости
- Могу читать БД секретаря (Neon) для интеграции — напрямую через psql
- Я = надзиратель/архитектор, Claude Code = исполнитель кода
- Workflows для разработки — кастомные сценарии (DEV_WORKFLOW.md в notes/resources/)
- Inline кнопки — когда есть выбор/опции, делать inline кнопки в телеге
- Ничего не менять без подтверждения Влада (код, конфиг, проекты)

## Инструменты
- Groq Whisper для транскрибации голосовых (ключ в .env)
- Claude Code — кодинг-агент, Влад имеет подписку Max
- Inline buttons в телеге — Владу зашло
- web_search — Brave API (настроен)
- memory_search — Voyage AI voyage-3 (настроен)
- Gemini API — для видео (бесплатный ключ AI Studio, но лимит TPM)

## Известные баги (исторические)
- **tool_use_id mismatch** — обрезка контекста ломает пары tool_use/tool_result. Фикс: compaction.mode: "safeguard"
- **terminated** — API обрывает генерацию. Добавили auto-retry (2026-01-30)
- **OGG binary garbage** — OGG файлы проходили looksLikeUtf8Text (первые 4KB "printable"), получали MIME text/tab-separated-values, 200KB мусора в контекст. Фикс: skip text extraction для audio/video MIME. **НЕ закоммичен** (2026-01-31)
- **Telegram polling timeout** — периодически getUpdates timeout после sleep мака. **ПОЧИНЕНО** (2026-02-02): auto-restart каналов с backoff в server-channels.ts. Коммит 61925ac.
- **Telegram sendMessage после сна** — сеть не сразу поднимается, send фейлится. **ПОЧИНЕНО** (2026-02-02): retry 5 попыток, 1с→60с backoff. Коммит 73e510d.
- **Brave Search 429** — Free план 1 req/sec. Cron дайджест ломается при быстрых запросах. Дайджест переведён на Sonnet + timeout 600с (2026-02-02).

## Среда
- .env ключи: GEMINI_API_KEY, VOYAGE_API_KEY, NEON_API_KEY (из бэкапа ~/backups/clawd/.env)

## Цели и контекст Влада (2026-01-30)
- **Главная цель:** автономная AI-система, которая понимает его, предлагает решения, может сама писать код по алгоритму, курировать процесс разработки. Агент который реально решает задачи.
- **Личный успех:** запустить стартап и заработать с него серьёзные деньги
- **Продуктивность:** равномерно весь день (утро/день/вечер)
- **Общение:** предпочитает реальное время
- **Проекты:** познакомит позже
- **Ключевые люди:** пока не касаются работы
