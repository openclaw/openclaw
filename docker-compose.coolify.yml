services:
  # Init container to fix volume permissions before main app starts
  openclaw-init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw_init
    user: root # Run as root to change permissions
    command:
      [
        "sh",
        "-c",
        "chown -R 1000:1000 /home/node/.openclaw && chmod -R 755 /home/node/.openclaw && echo 'Init completed'",
      ]
    volumes:
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
    restart: "no"

  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw
    ports:
      - "${PORT:-18789}:18789"
    labels:
      - "coolify.managed=true"
      - "coolify.http.enabled=true"
      - "coolify.http.port=18789"
    # Force the host and allow the initial setup
    command:
      - sh
      - -c
      - |
        mkdir -p /home/node/.openclaw
        # Clean up any old config files
        rm -f /home/node/.openclaw/openclaw.yaml
        rm -f /home/node/.openclaw/config.yaml
        # Create comprehensive OpenClaw config with full intelligence features
        cat > /home/node/.openclaw/openclaw.json << 'EOF'
        {
          "gateway": {
            "mode": "local",
            "http": {
              "endpoints": {
                "chatCompletions": {
                  "enabled": true
                }
              }
            }
          },
          "mcp": {
            "enabled": true,
            "credentials": {
              "mongoUrl": "${MONGODB_URL}",
              "database": "openclaw_mcp",
              "collection": "tenant_credentials"
            },
            "servers": {
              "bigquery": {
                "url": "${BIGQUERY_MCP_URL}"
              },
              "qdrant": {
                "url": "${QDRANT_MCP_URL}"
              },
              "hubspot": {
                "clientId": "${HUBSPOT_CLIENT_ID}",
                "clientSecret": "${HUBSPOT_CLIENT_SECRET}"
              }
            },
            "isolationLevel": "organization",
            "intelligentDiscovery": {
              "enabled": true,
              "maxTools": 10
            },
            "toolTimeoutMs": 60000
          },
          "skills": {
            "allowBundled": [
              "mem0-memory",
              "autonomy-engine",
              "implicit-feedback",
              "proactive-intelligence",
              "role-router",
              "bigquery-mcp",
              "mongodb-mcp"
            ],
            "entries": {
              "mem0-memory": {
                "enabled": true,
                "env": {
                  "MEM0_API_KEY": "${MEM0_API_KEY}",
                  "MEM0_ORG_ID": "${MEM0_ORG_ID}"
                }
              },
              "autonomy-engine": {
                "enabled": true
              },
              "implicit-feedback": {
                "enabled": true
              },
              "proactive-intelligence": {
                "enabled": true
              },
              "role-router": {
                "enabled": true
              },
              "bigquery-mcp": {
                "enabled": true,
                "env": {
                  "BIGQUERY_MCP_URL": "${BIGQUERY_MCP_URL}",
                  "MONGODB_URL": "${MONGODB_URL}"
                }
              },
              "mongodb-mcp": {
                "enabled": true,
                "env": {
                  "MONGODB_URL": "${MONGODB_URL}"
                }
              }
            }
          },
          "agents": {
            "defaults": {
              "model": "${OPENCLAW_MODEL}",
              "skills": [
                "mem0-memory",
                "autonomy-engine",
                "implicit-feedback",
                "proactive-intelligence",
                "role-router",
                "bigquery-mcp",
                "mongodb-mcp"
              ],
              "thinking": "enabled"
            }
          }
        }
        EOF
        # Substitute environment variables in the config
        sed -i "s|\${MONGODB_URL}|${MONGODB_URL}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${BIGQUERY_MCP_URL}|${BIGQUERY_MCP_URL}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${QDRANT_MCP_URL}|${QDRANT_MCP_URL}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${HUBSPOT_CLIENT_ID}|${HUBSPOT_CLIENT_ID}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${HUBSPOT_CLIENT_SECRET}|${HUBSPOT_CLIENT_SECRET}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${MEM0_API_KEY}|${MEM0_API_KEY}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${MEM0_ORG_ID}|${MEM0_ORG_ID}|g" /home/node/.openclaw/openclaw.json
        sed -i "s|\${OPENCLAW_MODEL}|${OPENCLAW_MODEL}|g" /home/node/.openclaw/openclaw.json
        exec node dist/index.js gateway --allow-unconfigured --bind lan
    environment:
      - NODE_ENV=production
      - HOME=/home/node
      - OPENCLAW_GATEWAY_BIND=lan
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-changeme}
      - OPENCLAW_GATEWAY_CONTROLUI_ALLOWINSECUREAUTH=${OPENCLAW_GATEWAY_CONTROLUI_ALLOWINSECUREAUTH:-true}
      - REDIS_URL=redis://redis:6379

      # Default Model Configuration (uses OpenAI by default)
      - OPENCLAW_MODEL=${OPENCLAW_MODEL:-openai/gpt-4o}

      # Mem0 / Memory Configuration
      - MEM0_API_KEY=${MEM0_API_KEY}
      - MEM0_ORG_ID=${MEM0_ORG_ID:-omnis_v3}

      # AI Model Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # MCP Server URLs (your deployed servers)
      - BIGQUERY_MCP_URL=${BIGQUERY_MCP_URL:-http://ck8c84oo40gkcwwk4gcokco0.5.161.117.36.sslip.io}
      - QDRANT_MCP_URL=${QDRANT_MCP_URL:-http://gw80os8k0kcgc488o0gw0so8.5.161.117.36.sslip.io/sse}
      - HUBSPOT_CLIENT_ID=${HUBSPOT_CLIENT_ID}
      - HUBSPOT_CLIENT_SECRET=${HUBSPOT_CLIENT_SECRET}
      - MONGODB_URL=${MONGODB_URL}

      # Enable HTTP Chat Completions endpoint (JSON format)
      - OPENCLAW_CONFIG={"gateway":{"http":{"endpoints":{"chatCompletions":{"enabled":true}}}}}
    volumes:
      # We use names instead of paths for better Coolify compatibility
      - openclaw_config:/home/node/.openclaw
      - openclaw_workspace:/home/node/.openclaw/workspace
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:18789/health || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: always

  redis:
    image: redis:7-alpine
    container_name: openclaw_redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - redis_data:/data
    restart: always

volumes:
  redis_data:
  openclaw_workspace:
  openclaw_config:
