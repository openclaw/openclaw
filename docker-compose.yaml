# OpenClaw Gateway - Docker Compose for Coolify Deployment
# This is the primary docker-compose.yaml for Coolify deployments.
# For local development, use docker-compose.local.yaml instead.
#
# Deploy via Coolify's Docker Compose build pack
#
# Required Environment Variables (set in Coolify UI):
#   - ZAI_API_KEY: Your Z.AI API key for model access
#   - OPENCLAW_DOMAIN: Your desired subdomain (e.g., openclaw.coolify.example.com)
#
# Auto-generated by Coolify (magic variables):
#   - SERVICE_PASSWORD_GATEWAY: Random gateway authentication token
#
# Optional:
#   - OPENCLAW_GATEWAY_PORT: Internal port (default: 3000, routed via Traefik)

services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}

    environment:
      # Required: ZAI API key (Coolify shows red border if empty)
      - ZAI_API_KEY=${ZAI_API_KEY:?}

      # Required: Your custom domain (e.g., openclaw.coolify.example.com)
      - OPENCLAW_DOMAIN=${OPENCLAW_DOMAIN:?}

      # Gateway authentication - auto-generated by Coolify magic variable
      - OPENCLAW_GATEWAY_TOKEN=${SERVICE_PASSWORD_GATEWAY}

      # Internal port - Traefik routes external traffic to this port
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_GATEWAY_PORT:-3000}
      - OPENCLAW_GATEWAY_BIND=lan

      # Runtime configuration
      - NODE_ENV=production
      - HOME=/root
      - TERM=xterm-256color
      - OPENCLAW_STATE_DIR=/root/.openclaw
      - OPENCLAW_WORKSPACE=/root/openclaw-workspace

      # Trust Traefik proxy headers
      - GATEWAY_TRUSTED_PROXIES=*

      # File watching fix for Docker
      - CHOKIDAR_USEPOLLING=true

      # Node memory limit
      - NODE_OPTIONS=--max-old-space-size=4096

    volumes:
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace

    # Running as root for Coolify volume permissions
    # See: https://github.com/coollabsio/coolify/issues/2873
    user: "0"

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # File descriptor limits for WebSocket connections
    ulimits:
      nofile:
        soft: 65535
        hard: 65535

    # Healthcheck for Traefik routing
    # Traefik only routes to healthy containers
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${OPENCLAW_GATEWAY_PORT:-3000}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: "1.8"
        reservations:
          memory: 2G
          cpus: "0.5"
      restart_policy:
        condition: unless-stopped
        delay: 5s

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

    # Traefik labels for Coolify proxy routing
    # Set OPENCLAW_DOMAIN env var in Coolify to your desired subdomain (e.g., openclaw.coolify.example.com)
    # Or configure the domain in Coolify UI under Domains tab
    labels:
      - coolify.managed=true
      - traefik.enable=true
      - traefik.http.routers.openclaw.rule=Host(`${OPENCLAW_DOMAIN:-openclaw.localhost}`)
      - traefik.http.routers.openclaw.entrypoints=https
      - traefik.http.routers.openclaw.tls=true
      - traefik.http.routers.openclaw.tls.certresolver=letsencrypt
      - traefik.http.services.openclaw.loadbalancer.server.port=3000

    init: true
    stop_grace_period: 30s

    # Start gateway with bootstrap script
    command: ["bash", "/app/scripts/coolify-bootstrap.sh"]

    depends_on:
      docker-proxy:
        condition: service_started

  # Docker Socket Proxy for secure sandboxing (optional)
  # Allows OpenClaw to spawn sandbox containers securely
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    exclude_from_hc: true # Coolify: exclude from health checks
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      # Security: Only enable necessary Docker APIs
      POST: 1 # Create containers
      CONTAINERS: 1 # List/manage containers
      IMAGES: 1 # Pull images
      NETWORKS: 1 # Connect to networks
      INFO: 1 # Version check
      VERSION: 1
      EXEC: 1 # Run commands in containers
      EVENTS: 1 # Listen for events

volumes:
  openclaw-config:
  openclaw-workspace:
