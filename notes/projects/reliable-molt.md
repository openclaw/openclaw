# Проект: Надёжный Molt

## Цель

Сделать меня надёжной системой которая:

1. Следует инструкциям строго (PRE/POST чеклисты)
2. Самовосстанавливается при поломках (self-healing)
3. Имеет кастомные сценарии для разных задач

---

## Фаза 1: Чеклисты (enforcement)

### PRE-чеклист (перед началом формирования ответа)

```markdown
## PRE-CHECKLIST — Выполнить ДО ответа

### 1. Контекст

- [ ] Прочитал SESSION-STATE.md (если есть)
- [ ] Проверил memory/сегодня (если есть)
- [ ] memory_search если вопрос о прошлом

### 2. Сценарии (ОБЯЗАТЕЛЬНО)

- [ ] Определил тип задачи:
  - Код/фича/баг → THE LOOP (скилл the-loop)
  - Brainstorm/идея → creative-thought-partner
  - Ресёрч → subagent spawn
  - Простой вопрос → прямой ответ
- [ ] Если есть подходящий скилл → прочитал SKILL.md

### 3. Learnings

- [ ] Если работа с проектом → прочитал memory/learnings/{project}.md
- [ ] Проверил memory/learnings/global.md на повторяющиеся ошибки

### 4. Формат

- [ ] Определил ожидаемый output (код? текст? файл? действие?)
- [ ] Если код → Claude Code, не руками
```

### POST-чеклист (после формирования, перед отправкой)

```markdown
## POST-CHECKLIST — Выполнить ДО отправки

### 1. Полнота

- [ ] Ответил на ВСЕ пункты из сообщения Влада (Output = Input)
- [ ] Не обрезал/сократил контент если Влад просил информацию

### 2. Качество

- [ ] Нет воды/корпоратива ("отличный вопрос!", "конечно!")
- [ ] Если не уверен → сказал прямо, не выдумал

### 3. Стриминг (если длинная работа)

- [ ] Были промежуточные апдейты
- [ ] Не молчал > 30 сек при активной работе

### 4. Память

- [ ] Было решение/предпочтение/баг/урок? → записать в memory/YYYY-MM-DD.md
- [ ] Была моя ошибка? → записать в memory/learnings/global.md
- [ ] Ошибка в проекте? → записать в memory/learnings/{project}.md

### 5. Подтверждение

- [ ] Подтвердил что услышал: "Понял, делаю X" / "Записал"
```

---

## Фаза 2: Self-Healing механизм

### Идея

При поломке (terminated, crash, timeout) вызывать Claude Code который:

1. Читает логи ошибки
2. Диагностирует проблему
3. Применяет известные фиксы
4. Рестартит gateway если нужно
5. Пишет мне что сделал

### Реализация — варианты:

**Вариант A: Hook on error**

- Moltbot hook который срабатывает при ошибке сессии
- Спавнит subagent с задачей "диагностируй и почини"
- Минус: требует изменения кода Moltbot

**Вариант B: Cron watchdog**

- Cron каждые 5 мин проверяет здоровье
- Если gateway не отвечает / Telegram отвалился → запускает healing скрипт
- Плюс: можно сделать уже сейчас

**Вариант C: Внешний monitor**

- Скрипт который следит за логами
- При паттерне ошибки → вызывает Claude Code
- Плюс: гибкий, не зависит от Moltbot

### Healing скрипт (для варианта B/C)

```bash
#!/bin/bash
# scripts/self-heal.sh

# 1. Проверить gateway
if ! curl -s http://localhost:18789/health > /dev/null; then
  echo "Gateway down, restarting..."
  # restart logic
fi

# 2. Проверить Telegram
STATUS=$(moltbot channels status --probe 2>&1)
if echo "$STATUS" | grep -q "error\|timeout\|disconnected"; then
  echo "Telegram broken, restarting channel..."
  moltbot gateway restart --reason "self-heal: telegram broken"
fi

# 3. Проверить сессию на terminated
LAST_ERROR=$(tail -100 ~/.moltbot/logs/gateway.log | grep -i "terminated\|error")
if [ -n "$LAST_ERROR" ]; then
  echo "Recent errors detected, logging for analysis"
  echo "$LAST_ERROR" >> ~/.moltbot/logs/healing.log
fi
```

---

## Фаза 3: Кастомные сценарии (SCENARIOS.md)

Структура файла:

```markdown
# SCENARIOS.md — Сценарии работы

## Формат

Каждый сценарий:

- Триггер (ключевые слова / паттерн)
- Протокол (что делать)
- Output (что вернуть)

---

## Сценарий: Код / Фича / Баг

**Триггер:** код, фича, баг, сделай, напиши, исправь, implement, fix
**Протокол:** THE LOOP (скилл the-loop)
**Output:** Работающий код + отчёт

## Сценарий: Brainstorm / Идея

**Триггер:** идея, brainstorm, подумай, что думаешь, обсудим
**Протокол:** creative-thought-partner
**Output:** Инсайты + файл в notes/areas/brainstorm-\*.md

## Сценарий: Ресёрч

**Триггер:** найди, изучи, ресёрч, что там с, проверь
**Протокол:** spawn subagent → собрать → отчёт
**Output:** Структурированный отчёт

## Сценарий: Задача в секретарь

**Триггер:** добавь задачу, напомни, запиши в секретарь
**Протокол:** (TBD — интеграция с AI Secretar)
**Output:** Подтверждение добавления

## Сценарий: Простой вопрос

**Триггер:** (default — если ничего другое не подошло)
**Протокол:** Прямой ответ
**Output:** Краткий точный ответ
```

---

## План внедрения

### Этап 1 (сейчас)

- [x] Написать PRE/POST чеклисты
- [ ] Интегрировать в PREFLIGHT.md
- [ ] Протестировать на следующих 5 сообщениях

### Этап 2 (после теста)

- [ ] Настроить cron watchdog (каждые 5 мин)
- [ ] Написать self-heal.sh
- [ ] Добавить алерт в Telegram при поломке

### Этап 3 (вместе с Владом)

- [ ] Создать SCENARIOS.md
- [ ] Добавлять сценарии по мере необходимости
- [ ] Интеграция с AI Secretar

### Этап 4: LLM-as-Judge (валидация качества)

- [ ] Реализовать проверку ответа через стороннюю LLM
- [ ] Сценарий: сложная задача → Molt делает → другая LLM проверяет качество
- [ ] Чеклист для judge: полнота, точность, соответствие запросу
- [ ] Если не прошло — автоисправление или алерт Владу
- [ ] Триггер: сложные задачи (код, ресёрч, длинные ответы)

---

## Известные поломки (из логов)

| Проблема             | Частота              | Текущее решение       | Нужно           |
| -------------------- | -------------------- | --------------------- | --------------- |
| terminated           | Часто                | auto-retry 2x + strip | Надёжнее?       |
| tool_use_id mismatch | Редко                | synthetic repair      | Улучшить repair |
| prompt too long      | Редко                | compaction safeguard  | Ранний flush    |
| Telegram timeout     | После сна            | auto-restart          | Watchdog        |
| Brave 429            | При быстрых запросах | —                     | Retry + delay   |
