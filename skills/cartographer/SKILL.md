# Cartographer

Maps codebases of any size using parallel sub-agents via `sessions_spawn`.

**Triggers:** "map this codebase", "cartographer", "create codebase map", "document the architecture", "understand this codebase", or when onboarding to a new project.

## Quick Start

1. Run the scanner script to get file tree with token counts
2. Analyze the scan output to plan sub-agent work assignments
3. Spawn sub-agents in parallel to read and analyze file groups
4. Synthesize sub-agent reports into `docs/CODEBASE_MAP.md`
5. Update project docs with summary pointing to the map

## Step 1: Check for Existing Map

First, check if `docs/CODEBASE_MAP.md` already exists:

**If it exists:**

1. Read the `last_mapped` timestamp from the map's frontmatter
2. Check for changes since last map: `git log --oneline --since="<last_mapped>"`
3. If significant changes detected, proceed to update mode
4. If no changes, inform user the map is current

**If it does not exist:** Proceed to full mapping.

## Step 2: Scan the Codebase

Run the scanner script:

```bash
# Option 1: Direct execution (tiktoken installed)
python3 /home/i/moltbot/skills/cartographer/scripts/scan-codebase.py . --format json

# Option 2: With uv (auto-installs dependencies)
uv run /home/i/moltbot/skills/cartographer/scripts/scan-codebase.py . --format json

# Option 3: Tree format for visual overview
python3 /home/i/moltbot/skills/cartographer/scripts/scan-codebase.py . --format tree
```

The output provides:

- Complete file tree with token counts per file
- Total token budget needed
- Skipped files (binary, too large)

## Step 3: Plan Sub-Agent Assignments

Analyze the scan output to divide work among sub-agents:

**Token budget per sub-agent:** ~150,000 tokens (safe margin under 200k context limit)

**Grouping strategy:**

1. Group files by directory/module (keeps related code together)
2. Balance token counts across groups
3. Aim for more sub-agents with smaller chunks (150k max each)

**For small codebases (<100k tokens):** Still use at least one sub-agent for file reading.

**Example assignment:**

```
Sub-agent 1: src/api/, src/middleware/ (~120k tokens)
Sub-agent 2: src/components/, src/hooks/ (~140k tokens)
Sub-agent 3: src/lib/, src/utils/ (~100k tokens)
```

## Step 4: Spawn Sub-Agents with sessions_spawn

Use `sessions_spawn` for each group. Example task prompt:

```
You are mapping part of a codebase. Read and analyze these files:
- src/api/routes.ts
- src/api/middleware/auth.ts
[... list all files in this group]

For each file, document:
1. **Purpose**: One-line description
2. **Exports**: Key functions, classes, types exported
3. **Imports**: Notable dependencies
4. **Patterns**: Design patterns or conventions used
5. **Gotchas**: Non-obvious behavior, edge cases, warnings

Also identify:
- How these files connect to each other
- Entry points and data flow
- Any configuration or environment dependencies

Return your analysis as markdown with clear headers per file/module.
```

## Step 5: Synthesize Reports

Once all sub-agents complete, synthesize their outputs:

1. **Merge** all sub-agent reports
2. **Deduplicate** any overlapping analysis
3. **Identify cross-cutting concerns** (shared patterns, common gotchas)
4. **Build the architecture diagram** showing module relationships
5. **Extract key navigation paths** for common tasks

## Step 6: Write CODEBASE_MAP.md

Create `docs/CODEBASE_MAP.md` using this structure:

```markdown
---
last_mapped: YYYY-MM-DDTHH:MM:SSZ
total_files: N
total_tokens: N
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: [date]

## System Overview

[Mermaid diagram showing high-level architecture]

## Directory Structure

[Tree with purpose annotations]

## Module Guide

### [Module Name]

**Purpose**: [description]
**Entry point**: [file]
**Key files**:
| File | Purpose | Tokens |
|------|---------|--------|

**Exports**: [key APIs]
**Dependencies**: [what it needs]
**Dependents**: [what needs it]

[Repeat for each module]

## Data Flow

[Mermaid sequence diagrams for key flows]

## Conventions

[Naming, patterns, style]

## Gotchas

[Non-obvious behaviors, warnings]

## Navigation Guide

**To add a new API endpoint**: [files to touch]
**To add a new component**: [files to touch]
**To modify auth**: [files to touch]
```

## Update Mode

When updating an existing map:

1. Identify changed files from git or scanner diff
2. Spawn sub-agents only for changed modules
3. Merge new analysis with existing map
4. Update `last_mapped` timestamp
5. Preserve unchanged sections

## Token Budget Reference

| Model  | Context Window | Safe Budget per Sub-Agent |
| ------ | -------------- | ------------------------- |
| Sonnet | 200,000        | 150,000                   |
| Opus   | 200,000        | 100,000                   |
| Haiku  | 200,000        | 100,000                   |

## Troubleshooting

**Scanner fails with tiktoken error:**

```bash
uv pip install tiktoken --system
```

**Codebase too large even for sub-agents:**

- Increase number of sub-agents
- Focus on src/ directories, skip vendored code
- Use `--max-tokens` flag to skip huge files
