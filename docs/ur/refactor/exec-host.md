---
summary: "ریفیکٹر منصوبہ: exec ہوسٹ روٹنگ، نوڈ منظوریات، اور ہیڈلیس رنر"
read_when:
  - exec ہوسٹ روٹنگ یا exec منظوریات ڈیزائن کرتے وقت
  - نوڈ رنر + UI IPC نافذ کرتے وقت
  - exec ہوسٹ سکیورٹی موڈز اور سلیش کمانڈز شامل کرتے وقت
title: "Exec Host ریفیکٹر"
---

# Exec host ریفیکٹر منصوبہ

## اہداف

- **sandbox**، **gateway**، اور **node** کے درمیان اجرا کو روٹ کرنے کے لیے `exec.host` + `exec.security` شامل کریں۔
- ڈیفالٹس **محفوظ** رکھیں: واضح طور پر فعال کیے بغیر کراس-ہوسٹ اجرا نہ ہو۔
- اجرا کو ایک **ہیڈلیس رنر سروس** میں تقسیم کریں، جس کے ساتھ اختیاری UI (macOS ایپ) مقامی IPC کے ذریعے ہو۔
- **ہر ایجنٹ کے لیے** پالیسی، اجازت فہرست، ask موڈ، اور نوڈ بائنڈنگ فراہم کریں۔
- ایسے **ask موڈز** کی معاونت کریں جو اجازت فہرست کے _ساتھ_ یا _بغیر_ کام کریں۔
- کراس-پلیٹ فارم: یونکس ساکٹ + ٹوکن تصدیق (macOS/Linux/Windows برابری)۔

## غیر اہداف

- لیگیسی اجازت فہرست کی مائیگریشن یا لیگیسی اسکیما کی معاونت نہیں۔
- نوڈ exec کے لیے PTY/اسٹریمنگ نہیں (صرف مجموعی آؤٹ پٹ)۔
- موجودہ Bridge + Gateway کے علاوہ کوئی نیا نیٹ ورک لیئر نہیں۔

## فیصلے (مقفل)

- **کنفیگ کیز:** `exec.host` + `exec.security` (ہر ایجنٹ اوور رائیڈ کی اجازت)۔
- **Elevation:** `/elevated` کو گیٹ وے کی مکمل رسائی کے عرف کے طور پر برقرار رکھیں۔
- **Ask ڈیفالٹ:** `on-miss`۔
- **منظوریات اسٹور:** `~/.openclaw/exec-approvals.json` (JSON، لیگیسی مائیگریشن نہیں)۔
- **رنر:** ہیڈلیس سسٹم سروس؛ UI ایپ منظوریات کے لیے یونکس ساکٹ ہوسٹ کرتی ہے۔
- **نوڈ شناخت:** موجودہ `nodeId` استعمال کریں۔
- **ساکٹ تصدیق:** یونکس ساکٹ + ٹوکن (کراس-پلیٹ فارم)؛ ضرورت پڑنے پر بعد میں تقسیم۔
- **نوڈ ہوسٹ اسٹیٹ:** `~/.openclaw/node.json` (نوڈ آئی ڈی + پیئرنگ ٹوکن)۔
- **macOS exec ہوسٹ:** macOS ایپ کے اندر `system.run` چلائیں؛ نوڈ ہوسٹ سروس مقامی IPC کے ذریعے درخواستیں فارورڈ کرے۔
- **XPC ہیلپر نہیں:** یونکس ساکٹ + ٹوکن + پیر چیکس پر قائم رہیں۔

## کلیدی تصورات

### Host

- `sandbox`: Docker exec (موجودہ رویہ)۔
- `gateway`: گیٹ وے ہوسٹ پر exec۔
- `node`: Bridge کے ذریعے نوڈ رنر پر exec (`system.run`)۔

### سکیورٹی موڈ

- `deny`: ہمیشہ بلاک۔
- `allowlist`: صرف مماثلتوں کی اجازت۔
- `full`: سب کچھ اجازت (elevated کے برابر)۔

### Ask موڈ

- `off`: کبھی نہ پوچھیں۔
- `on-miss`: صرف تب پوچھیں جب اجازت فہرست مماثل نہ ہو۔
- `always`: ہر بار پوچھیں۔

Ask، اجازت فہرست سے **آزاد** ہے؛ اجازت فہرست `always` یا `on-miss` کے ساتھ استعمال کی جا سکتی ہے۔

### پالیسی ریزولوشن (ہر exec)

1. `exec.host` حل کریں (ٹول پیرامیٹر → ایجنٹ اوور رائیڈ → عالمی ڈیفالٹ)۔
2. `exec.security` اور `exec.ask` حل کریں (وہی ترجیح)۔
3. اگر ہوسٹ `sandbox` ہے، تو مقامی sandbox exec کے ساتھ آگے بڑھیں۔
4. اگر ہوسٹ `gateway` یا `node` ہے، تو اسی ہوسٹ پر سکیورٹی + ask پالیسی لاگو کریں۔

## ڈیفالٹ حفاظت

- ڈیفالٹ `exec.host = sandbox`۔
- `gateway` اور `node` کے لیے ڈیفالٹ `exec.security = deny`۔
- ڈیفالٹ `exec.ask = on-miss` (صرف تب متعلقہ جب سکیورٹی اجازت دے)۔
- اگر نوڈ بائنڈنگ سیٹ نہ ہو تو **ایجنٹ کسی بھی نوڈ کو ہدف بنا سکتا ہے**، لیکن صرف اسی صورت میں جب پالیسی اجازت دے۔

## کنفیگ سطح

### ٹول پیرامیٹرز

- `exec.host` (اختیاری): `sandbox | gateway | node`۔
- `exec.security` (اختیاری): `deny | allowlist | full`۔
- `exec.ask` (اختیاری): `off | on-miss | always`۔
- `exec.node` (اختیاری): نوڈ آئی ڈی/نام جو `host=node` ہونے پر استعمال ہو۔

### کنفیگ کیز (عالمی)

- `tools.exec.host`
- `tools.exec.security`
- `tools.exec.ask`
- `tools.exec.node` (ڈیفالٹ نوڈ بائنڈنگ)

### کنفیگ کیز (ہر ایجنٹ)

- `agents.list[].tools.exec.host`
- `agents.list[].tools.exec.security`
- `agents.list[].tools.exec.ask`
- `agents.list[].tools.exec.node`

### عرف

- `/elevated on` = ایجنٹ سیشن کے لیے `tools.exec.host=gateway`، `tools.exec.security=full` سیٹ کریں۔
- `/elevated off` = ایجنٹ سیشن کے لیے سابقہ exec سیٹنگز بحال کریں۔

## منظوریات اسٹور (JSON)

راستہ: `~/.openclaw/exec-approvals.json`

مقصد:

- **ایگزیکیوشن ہوسٹ** (گیٹ وے یا نوڈ رنر) کے لیے مقامی پالیسی + اجازت فہرستیں۔
- UI دستیاب نہ ہونے پر Ask فال بیک۔
- UI کلائنٹس کے لیے IPC اسناد۔

مجوزہ اسکیما (v1):

```json
{
  "version": 1,
  "socket": {
    "path": "~/.openclaw/exec-approvals.sock",
    "token": "base64-opaque-token"
  },
  "defaults": {
    "security": "deny",
    "ask": "on-miss",
    "askFallback": "deny"
  },
  "agents": {
    "agent-id-1": {
      "security": "allowlist",
      "ask": "on-miss",
      "allowlist": [
        {
          "pattern": "~/Projects/**/bin/rg",
          "lastUsedAt": 0,
          "lastUsedCommand": "rg -n TODO",
          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"
        }
      ]
    }
  }
}
```

نوٹس:

- لیگیسی اجازت فہرست فارمیٹس نہیں۔
- `askFallback` صرف تب لاگو ہوتا ہے جب `ask` درکار ہو اور کوئی UI قابلِ رسائی نہ ہو۔
- فائل اجازتیں: `0600`۔

## رنر سروس (ہیڈلیس)

### کردار

- مقامی طور پر `exec.security` + `exec.ask` نافذ کریں۔
- سسٹم کمانڈز چلائیں اور آؤٹ پٹ واپس کریں۔
- exec لائف سائیکل کے لیے Bridge ایونٹس خارج کریں (اختیاری مگر سفارش کردہ)۔

### سروس لائف سائیکل

- macOS پر Launchd/daemon؛ Linux/Windows پر سسٹم سروس۔
- منظوریات JSON ایگزیکیوشن ہوسٹ کے لیے مقامی ہے۔
- UI ایک مقامی یونکس ساکٹ ہوسٹ کرتی ہے؛ رنرز ضرورت کے مطابق کنیکٹ کرتے ہیں۔

## UI انضمام (macOS ایپ)

### IPC

- یونکس ساکٹ: `~/.openclaw/exec-approvals.sock` (0600)۔
- ٹوکن محفوظ: `exec-approvals.json` (0600)۔
- پیر چیکس: صرف ایک ہی UID۔
- چیلنج/رسپانس: نانس + HMAC(token, request-hash) تاکہ ری پلے سے بچاؤ ہو۔
- مختصر TTL (مثلاً 10s) + زیادہ سے زیادہ پے لوڈ + ریٹ لمٹ۔

### Ask فلو (macOS ایپ exec ہوسٹ)

1. نوڈ سروس گیٹ وے سے `system.run` وصول کرتی ہے۔
2. نوڈ سروس مقامی ساکٹ سے کنیکٹ ہو کر پرامپٹ/exec درخواست بھیجتی ہے۔
3. ایپ پیر + ٹوکن + HMAC + TTL کی توثیق کرتی ہے، پھر ضرورت پڑنے پر ڈائیلاگ دکھاتی ہے۔
4. ایپ UI کانٹیکسٹ میں کمانڈ چلاتی ہے اور آؤٹ پٹ واپس کرتی ہے۔
5. نوڈ سروس آؤٹ پٹ گیٹ وے کو واپس کرتی ہے۔

اگر UI موجود نہ ہو:

- `askFallback` لاگو کریں (`deny|allowlist|full`)۔

### ڈایاگرام (SCI)

```
Agent -> Gateway -> Bridge -> Node Service (TS)
                         |  IPC (UDS + token + HMAC + TTL)
                         v
                     Mac App (UI + TCC + system.run)
```

## نوڈ شناخت + بائنڈنگ

- Bridge پیئرنگ سے موجودہ `nodeId` استعمال کریں۔
- بائنڈنگ ماڈل:
  - `tools.exec.node` ایجنٹ کو کسی مخصوص نوڈ تک محدود کرتا ہے۔
  - اگر غیر سیٹ ہو تو ایجنٹ کسی بھی نوڈ کا انتخاب کر سکتا ہے (پالیسی اب بھی ڈیفالٹس نافذ کرتی ہے)۔
- نوڈ انتخاب ریزولوشن:
  - `nodeId` عین مطابق مماثلت
  - `displayName` (نارملائزڈ)
  - `remoteIp`
  - `nodeId` پری فکس (>= 6 حروف)

## ایونٹنگ

### کون ایونٹس دیکھتا ہے

- سسٹم ایونٹس **ہر سیشن** کے لیے ہوتے ہیں اور اگلے پرامپٹ پر ایجنٹ کو دکھائے جاتے ہیں۔
- گیٹ وے کی ان-میموری قطار (`enqueueSystemEvent`) میں محفوظ ہوتے ہیں۔

### ایونٹ متن

- `Exec started (node=<id>, id=<runId>)`
- `Exec finished (node=<id>, id=<runId>, code=<code>)` + اختیاری آؤٹ پٹ ٹیل
- `Exec denied (node=<id>, id=<runId>, <reason>)`

### ٹرانسپورٹ

آپشن A (سفارش کردہ):

- رنر Bridge `event` فریمز `exec.started` / `exec.finished` بھیجتا ہے۔
- گیٹ وے `handleBridgeEvent` انہیں `enqueueSystemEvent` میں میپ کرتا ہے۔

آپشن B:

- گیٹ وے `exec` ٹول لائف سائیکل کو براہِ راست سنبھالتا ہے (صرف ہم وقتی)۔

## Exec فلو

### Sandbox ہوسٹ

- موجودہ `exec` رویہ (Docker یا غیر sandbox ہونے پر ہوسٹ)۔
- PTY صرف غیر sandbox موڈ میں معاون ہے۔

### Gateway ہوسٹ

- Gateway پراسیس اپنی ہی مشین پر اجرا کرتا ہے۔
- مقامی `exec-approvals.json` نافذ کرتا ہے (سکیورٹی/ask/اجازت فہرست)۔

### Node ہوسٹ

- Gateway `node.invoke` کو `system.run` کے ساتھ کال کرتا ہے۔
- رنر مقامی منظوریات نافذ کرتا ہے۔
- رنر مجموعی stdout/stderr واپس کرتا ہے۔
- آغاز/اختتام/انکار کے لیے اختیاری Bridge ایونٹس۔

## آؤٹ پٹ حدود

- مشترکہ stdout+stderr کو **200k** پر محدود کریں؛ ایونٹس کے لیے **ٹیل 20k** رکھیں۔
- واضح لاحقے کے ساتھ مختصر کریں (مثلاً، "… (truncated)" )۔

## سلیش کمانڈز

- `/exec host=<sandbox|gateway|node> security=<deny|allowlist|full> ask=<off|on-miss|always> node=<id>`
- ہر ایجنٹ، ہر سیشن اوور رائیڈز؛ کنفیگ کے ذریعے محفوظ کیے بغیر مستقل نہیں۔
- `/elevated on|off|ask|full`، `host=gateway security=full` کے لیے شارٹ کٹ ہی رہتا ہے (جہاں `full` منظوریات کو اسکیپ کرتا ہے)۔

## کراس-پلیٹ فارم کہانی

- رنر سروس پورٹیبل ایگزیکیوشن ہدف ہے۔
- UI اختیاری ہے؛ اگر موجود نہ ہو تو `askFallback` لاگو ہوتا ہے۔
- Windows/Linux وہی منظوریات JSON + ساکٹ پروٹوکول سپورٹ کرتے ہیں۔

## نفاذ کے مراحل

### مرحلہ 1: کنفیگ + exec روٹنگ

- `exec.host`، `exec.security`، `exec.ask`، `exec.node` کے لیے کنفیگ اسکیما شامل کریں۔
- ٹول پلمنگ کو `exec.host` کا احترام کرنے کے لیے اپ ڈیٹ کریں۔
- `/exec` سلیش کمانڈ شامل کریں اور `/elevated` عرف برقرار رکھیں۔

### مرحلہ 2: منظوریات اسٹور + گیٹ وے نفاذ

- `exec-approvals.json` ریڈر/رائٹر نافذ کریں۔
- `gateway` ہوسٹ کے لیے اجازت فہرست + ask موڈز نافذ کریں۔
- آؤٹ پٹ حدود شامل کریں۔

### مرحلہ 3: نوڈ رنر نفاذ

- نوڈ رنر کو اجازت فہرست + ask نافذ کرنے کے لیے اپ ڈیٹ کریں۔
- macOS ایپ UI تک یونکس ساکٹ پرامپٹ برج شامل کریں۔
- `askFallback` وائر کریں۔

### مرحلہ 4: ایونٹس

- exec لائف سائیکل کے لیے نوڈ → گیٹ وے Bridge ایونٹس شامل کریں۔
- ایجنٹ پرامپٹس کے لیے `enqueueSystemEvent` میں میپ کریں۔

### مرحلہ 5: UI نکھار

- Mac ایپ: اجازت فہرست ایڈیٹر، ہر ایجنٹ سوئچر، ask پالیسی UI۔
- نوڈ بائنڈنگ کنٹرولز (اختیاری)۔

## جانچ منصوبہ

- یونٹ ٹیسٹس: اجازت فہرست مماثلت (glob + کیس اِن سینسِٹو)۔
- یونٹ ٹیسٹس: پالیسی ریزولوشن ترجیح (ٹول پیرامیٹر → ایجنٹ اوور رائیڈ → عالمی)۔
- انضمامی ٹیسٹس: نوڈ رنر deny/allow/ask فلو۔
- Bridge ایونٹ ٹیسٹس: نوڈ ایونٹ → سسٹم ایونٹ روٹنگ۔

## کھلے خطرات

- UI عدم دستیابی: یقینی بنائیں کہ `askFallback` کا احترام ہو۔
- طویل المدت کمانڈز: ٹائم آؤٹ + آؤٹ پٹ حدود پر انحصار کریں۔
- ملٹی-نوڈ ابہام: نوڈ بائنڈنگ یا واضح نوڈ پیرامیٹر کے بغیر خرابی۔

## متعلقہ دستاویزات

- [Exec tool](/tools/exec)
- [Exec approvals](/tools/exec-approvals)
- [Nodes](/nodes)
- [Elevated mode](/tools/elevated)
