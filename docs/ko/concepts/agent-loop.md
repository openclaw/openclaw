---
read_when:
    - 에이전트 루프 또는 수명 주기 이벤트에 대한 정확한 안내가 필요합니다.
summary: 에이전트 루프 수명 주기, 스트림 및 대기 의미 체계
title: 에이전트 루프
x-i18n:
    generated_at: "2026-02-08T15:53:29Z"
    model: gtx
    provider: google-translate
    source_hash: e2c14fb74bd42caacb708f625267142f017f891842d6f3a36689d3c524fbfd45
    source_path: concepts/agent-loop.md
    workflow: 15
---

# 에이전트 루프(OpenClaw)

에이전트 루프는 에이전트의 완전한 "실제" 실행입니다. 즉, 섭취 → 컨텍스트 조립 → 모델 추론 →
도구 실행 → 스트리밍 응답 → 지속성. 메시지를 바꾸는 권위 있는 경로입니다
세션 상태를 일관되게 유지하면서 작업과 최종 응답으로 전환합니다.

OpenClaw에서 루프는 수명 주기 및 스트림 이벤트를 내보내는 세션당 단일 직렬화된 실행입니다.
모델이 생각하는 대로 도구를 호출하고 출력을 스트리밍합니다. 이 문서에서는 실제 루프가 어떻게 작동하는지 설명합니다.
종단 간 유선 연결.

## 진입점

- 게이트웨이 RPC: `agent` 그리고 `agent.wait`.
- CLI: `agent` 명령.

## 작동 방식(상위 수준)

1. `agent` RPC는 매개변수의 유효성을 검사하고, 세션(sessionKey/sessionId)을 확인하고, 세션 메타데이터를 유지하고, 반환합니다. `{ runId, acceptedAt }` 즉시.
2. `agentCommand` 에이전트를 실행합니다.
   - 모델 + 사고/자세한 기본값 해결
   - 스킬 스냅샷 로드
   - 전화 `runEmbeddedPiAgent` (pi-agent-core 런타임)
   - 방출하다 **수명 주기 종료/오류** 포함된 루프가 하나를 방출하지 않는 경우
3. `runEmbeddedPiAgent`:
   - 세션별 ​​+ 전역 대기열을 통해 실행을 직렬화합니다.
   - 모델 + 인증 프로필을 확인하고 pi 세션을 구축합니다.
   - pi 이벤트를 구독하고 보조자/도구 델타를 스트리밍합니다.
   - 시간 초과 적용 -> 초과되면 실행을 중단합니다.
   - 페이로드 + 사용 메타데이터를 반환합니다.
4. `subscribeEmbeddedPiSession` pi-agent-core 이벤트를 OpenClaw에 연결합니다. `agent` 개울:
   - 도구 이벤트 => `stream: "tool"`
   - 보조 델타 => `stream: "assistant"`
   - 수명주기 이벤트 => `stream: "lifecycle"` (`phase: "start" | "end" | "error"`)
5. `agent.wait` 용도 `waitForAgentJob`:
   - 기다립니다 **수명 주기 종료/오류** ~을 위한 `runId`
   - 보고 `{ status: ok|error|timeout, startedAt, endedAt, error? }`

## 큐잉 + 동시성

- 실행은 세션 키(세션 레인)별로 직렬화되며 선택적으로 전역 레인을 통해 직렬화됩니다.
- 이렇게 하면 도구/세션 경합이 방지되고 세션 기록이 일관되게 유지됩니다.
- 메시징 채널은 이 레인 시스템에 피드를 제공하는 대기열 모드(수집/조종/후속 조치)를 선택할 수 있습니다.
  보다 [명령 대기열](/concepts/queue).

## 세션 + 작업공간 준비

- 작업공간이 해결되고 생성됩니다. 샌드박스 실행은 샌드박스 작업 영역 루트로 리디렉션될 수 있습니다.
- 스킬은 로드(또는 스냅샷에서 재사용)되어 환경 및 프롬프트에 주입됩니다.
- 부트스트랩/컨텍스트 파일이 확인되어 시스템 프롬프트 보고서에 삽입됩니다.
- 세션 쓰기 잠금이 획득되었습니다. `SessionManager` 스트리밍하기 전에 열리고 준비됩니다.

## 프롬프트 조립 + 시스템 프롬프트

- 시스템 프롬프트는 OpenClaw의 기본 프롬프트, 기술 프롬프트, 부트스트랩 컨텍스트 및 실행별 재정의를 통해 구축됩니다.
- 모델별 제한 및 압축 예약 토큰이 적용됩니다.
- 보다 [시스템 프롬프트](/concepts/system-prompt) 모델이 보는 것.

## 훅 포인트(요청할 수 있는 곳)

OpenClaw에는 두 가지 후크 시스템이 있습니다.

- **내부 후크** (게이트웨이 후크): 명령 및 수명 주기 이벤트에 대한 이벤트 기반 스크립트입니다.
- **플러그인 후크**: 에이전트/도구 수명 주기 및 게이트웨이 파이프라인 내부의 확장 지점입니다.

### 내부 후크(게이트웨이 후크)

- **`agent:bootstrap`**: 시스템 프롬프트가 완료되기 전에 부트스트랩 파일을 빌드하는 동안 실행됩니다.
  이를 사용하여 부트스트랩 컨텍스트 파일을 추가/제거합니다.
- **명령 후크**:`/new`, `/reset`, `/stop`, 기타 명령 이벤트(Hooks 문서 참조).

보다 [후크](/automation/hooks) 설정 및 예시를 확인하세요.

### 플러그인 후크(에이전트 + 게이트웨이 수명주기)

이는 에이전트 루프 또는 게이트웨이 파이프라인 내에서 실행됩니다.

- **`before_agent_start`**: 실행이 시작되기 전에 컨텍스트를 삽입하거나 시스템 프롬프트를 재정의합니다.
- **`agent_end`**: 최종 메시지 목록을 검사하고 완료 후 메타데이터를 실행합니다.
- **`before_compaction` / `after_compaction`**: 다짐 주기를 관찰하거나 주석을 답니다.
- **`before_tool_call` / `after_tool_call`**: 도구 매개변수/결과를 차단합니다.
- **`tool_result_persist`**: 도구 결과가 세션 기록에 기록되기 전에 동기적으로 변환됩니다.
- **`message_received` / `message_sending` / `message_sent`**: 인바운드 + 아웃바운드 메시지 후크.
- **`session_start` / `session_end`**: 세션 수명주기 경계.
- **`gateway_start` / `gateway_stop`**: 게이트웨이 수명주기 이벤트.

보다 [플러그인](/tools/plugin#plugin-hooks) 후크 API 및 등록 세부정보를 확인하세요.

## 스트리밍 + 부분 응답

- 보조 델타는 pi-agent-core에서 스트리밍되어 다음과 같이 방출됩니다. `assistant` 이벤트.
- 블록 스트리밍은 다음 중 하나에서 부분 응답을 내보낼 수 있습니다. `text_end` 또는 `message_end`.
- 추론 스트리밍은 별도의 스트림이나 블록 응답으로 내보낼 수 있습니다.
- 보다 [스트리밍](/concepts/streaming) 청킹 및 차단 응답 동작을 위해.

## 도구 실행 + 메시징 도구

- 도구 시작/업데이트/종료 이벤트는 `tool` 개울.
- 도구 결과는 로깅/내보내기 전에 크기 및 이미지 페이로드에 대해 정리됩니다.
- 메시징 도구 전송은 중복된 보조자 확인을 억제하기 위해 추적됩니다.

## 응답 형성 + 억제

- 최종 페이로드는 다음에서 조립됩니다.
  - 보조 텍스트(및 선택적 추론)
  - 인라인 도구 요약(상세 + 허용되는 경우)
  - 모델 오류 시 보조 오류 텍스트
- `NO_REPLY` 자동 토큰으로 처리되며 나가는 페이로드에서 필터링됩니다.
- 메시징 도구 중복은 최종 페이로드 목록에서 제거됩니다.
- 렌더링 가능한 페이로드가 남아 있지 않고 도구에 오류가 발생한 경우 대체 도구 오류 응답이 내보내집니다.
  (메시징 도구가 이미 사용자에게 표시되는 응답을 보낸 경우는 제외)

## 압축 + 재시도

- 자동 압축 방출 `compaction` 이벤트를 스트리밍하고 재시도를 트리거할 수 있습니다.
- 재시도 시 중복 출력을 방지하기 위해 메모리 내 버퍼와 도구 요약이 재설정됩니다.
- 보다 [압축](/concepts/compaction) 압축 파이프라인용.

## 이벤트 스트림(오늘)

- `lifecycle`:에 의해 방출 `subscribeEmbeddedPiSession` (그리고 대체적으로 `agentCommand`)
- `assistant`: pi-agent-core에서 스트리밍된 델타
- `tool`: pi-agent-core에서 스트리밍된 도구 이벤트

## 채팅 채널 처리

- 어시스턴트 델타는 채팅에 버퍼링됩니다. `delta` 메시지.
- 채팅 `final` 에 방출됩니다 **수명 주기 종료/오류**.

## 시간 초과

- `agent.wait` 기본값: 30초(기다립니다.) `timeoutMs` 매개변수가 재정의됩니다.
- 에이전트 런타임: `agents.defaults.timeoutSeconds` 기본 600s; 에서 시행 `runEmbeddedPiAgent` 타이머를 중단합니다.

## 일이 일찍 끝날 수 있는 곳

- 에이전트 시간 초과(중단)
- AbortSignal(취소)
- 게이트웨이 연결 끊김 또는 RPC 시간 초과
- `agent.wait` 시간 초과(대기 전용, 에이전트를 중지하지 않음)
