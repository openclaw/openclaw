# Shift-Left Risk Analysis: Cloud.ru FM Integration (ADR-001 through ADR-005)

## Level 4: Risk Analysis in Design Phase

**Analyst**: QE Regression Risk Analyzer (Security Auditor Profile)
**Date**: 2026-02-12
**Scope**: ADR-001 through ADR-005, upstream source code analysis
**Method**: Static analysis of architecture decisions against source code, threat modeling, dependency chain analysis

---

## Executive Summary

This analysis identifies **25 risks** across 5 Architecture Decision Records for the Cloud.ru Foundation Models integration into OpenClaw via claude-code-proxy. Risks are scored using Likelihood (1-5) x Impact (1-5) with a critical threshold at score >= 15.

**Risk Distribution**:

- CRITICAL (score >= 15): 4 risks
- HIGH (score 10-14): 9 risks
- MEDIUM (score 5-9): 9 risks
- LOW (score 1-4): 3 risks

**Top 3 Risks by Score**:

1. R001 - GLM-4.7 Tool Calling Instability (Score: 20)
2. R002 - Proxy Single Point of Failure (Score: 16)
3. R003 - API Key Exposure via Environment Variables (Score: 15)

---

## Risk Matrix Visualization

```
Impact
  5 |  R017     R003     R001
    |           R008     R002
  4 |  R019     R005     R004     R006
    |  R020     R009     R007
  3 |  R021     R012     R010
    |  R022     R013     R011
  2 |  R023     R015     R014
    |  R024
  1 |  R025     R016
    +-------------------------------------
      1        2        3        4        5
                    Likelihood
```

```
Score Legend:
  [CRITICAL >= 15]  [HIGH 10-14]  [MEDIUM 5-9]  [LOW 1-4]
```

---

## Risk Register

### CRITICAL RISKS (Score >= 15)

---

#### R001: GLM-4.7 Tool Calling Instability Causes Silent Failures

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R001                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ADR Source**    | ADR-001, ADR-003, ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Category**      | Technical                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description**   | GLM-4.7 has known tool calling instabilities (sglang issue #15721). Claude Code's agentic engine relies on tool calling for multi-step reasoning, tool orchestration, and session management. When tool calls fail or produce malformed output, Claude Code may return partial results, hang, or crash. ADR-003 notes tools are disabled via `cli-runner.ts:82-83` ("Tools are disabled in this session. Do not call tools."), but Claude Code's INTERNAL tool calling mechanism (its own reasoning pipeline) still communicates with the model using Anthropic tool_use format. The proxy must translate these to OpenAI function_calling format. GLM-4.7's instabilities mean even the proxy's translation may produce responses Claude Code cannot parse. |
| **Likelihood**    | **4** - Known issue documented in sglang #15721. Tool calling is fundamental to Claude Code's architecture. Every request exercises this path.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Impact**        | **5** - Complete request failure. User receives no response or garbled output. No graceful degradation path when internal tool calling fails (as opposed to user-facing tools which are disabled).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Risk Score**    | **20 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**    | (1) Implement proxy-side tool call response validation before returning to Claude Code. (2) Add retry logic in `runCliAgent()` specifically for tool-call parse failures (distinct from `FailoverError`). (3) Set `DISABLE_THINKING=true` in proxy env per ADR-005 mitigation table. (4) Monitor and log all non-zero exit codes from Claude Code subprocess with stderr content for tool-call failure pattern detection. (5) Consider fallback to GLM-4.7-Flash which may have fewer tool-calling issues.                                                                                                                                                                                                                                                   |
| **Test Coverage** | Integration test: send a prompt requiring multi-step reasoning through proxy to GLM-4.7, verify complete JSON response. Chaos test: inject malformed tool_use responses via proxy mock, verify `runCliAgent()` either retries or fails gracefully with `FailoverError`. Unit test: verify `parseCliJson()` handles corrupted tool-call JSON without throwing unhandled exceptions.                                                                                                                                                                                                                                                                                                                                                                           |

---

#### R002: Proxy Docker Container is a Single Point of Failure

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R002                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ADR Source**    | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Description**   | All LLM requests flow through the single claude-code-proxy Docker container. If the container crashes, enters a restart loop, or becomes unresponsive (e.g., memory leak, network timeout to cloud.ru), ALL user conversations fail simultaneously. ADR-004 documents a state machine (RUNNING -> UNHEALTHY -> RECOVERING) but provides no implementation for runtime health monitoring. The `runCliAgent()` function in `cli-runner.ts` has no pre-flight proxy health check -- it spawns the subprocess which then fails when it cannot reach the proxy, producing cryptic errors. |
| **Likelihood**    | **4** - Docker containers crash. The proxy handles protocol translation for every request. Long-running containers accumulate state. Cloud.ru API downtime propagates through the proxy.                                                                                                                                                                                                                                                                                                                                                                                             |
| **Impact**        | **4** - Total service outage for all cloud.ru FM conversations. Recovery requires Docker restart (potentially manual). Users see timeout or cryptic error messages.                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Risk Score**    | **16 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Mitigation**    | (1) Implement the runtime health check proposed in ADR-004 Section 3: add pre-flight `GET /health` call before `runCliAgent()` in the agent-runner routing layer. (2) Add Docker restart policy `unless-stopped` (already in ADR-001 compose). (3) Add container memory limits to prevent OOM. (4) Implement a circuit breaker pattern: after N consecutive proxy failures, bypass claude-cli backend and route to direct API fallback. (5) Add health check alerting (not just Docker internal healthcheck).                                                                        |
| **Test Coverage** | Integration test: kill proxy container during active request, verify `FailoverError` is raised within timeout. Health check test: mock `/health` endpoint returning 503, verify agent-runner does not attempt subprocess spawn. Load test: send 15 req/s sustained for 5 minutes, verify proxy does not OOM or deadlock.                                                                                                                                                                                                                                                             |

---

#### R003: API Key Exposure via Environment Variable Chain

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ADR Source**    | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Category**      | Security                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description**   | The cloud.ru API key flows through multiple exposure vectors: (1) Docker compose environment variable `OPENAI_API_KEY` in `docker-compose.cloudru-proxy.yml`. (2) `.env` file on disk. (3) `ANTHROPIC_API_KEY` replacement value `"cloudru-proxy-key"` in `openclaw.json` under `agents.defaults.cliBackends.claude-cli.env`. (4) Process environment of every Claude Code subprocess via `cli-runner.ts:222-228` which spreads `backend.env` into `process.env`. The `clearEnv` mechanism at line 224 only clears `ANTHROPIC_API_KEY` and `ANTHROPIC_API_KEY_OLD` before applying the new env, but the real cloud.ru key is in `OPENAI_API_KEY` inside the Docker container -- not in the subprocess env. However, the proxy key value `"cloudru-proxy-key"` in openclaw.json could be confused with a real credential and committed to git. Additionally, ADR-001 shows `HOST: "0.0.0.0"` in the Docker compose, which binds the proxy to ALL interfaces, not just localhost, despite the ports mapping being `127.0.0.1:8082:8082`. If the Docker network configuration is misconfigured (e.g., Docker on a VM with bridge networking), the proxy could be accessible externally. |
| **Likelihood**    | **3** - Requires configuration error (committing openclaw.json with proxy key, Docker network misconfiguration, or .env file not in .gitignore). However, these are common mistakes, especially for new users following wizard setup.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**        | **5** - Cloud.ru API key compromise allows unauthorized usage at the owner's expense. Full access to cloud.ru FM API with the compromised key.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Risk Score**    | **15 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Mitigation**    | (1) Wizard MUST add `.env` and `docker-compose.cloudru-proxy.yml` to `.gitignore` automatically. (2) Remove `HOST: "0.0.0.0"` from Docker compose template; use `HOST: "127.0.0.1"` instead (the `HOST` env controls what the proxy listens on INSIDE the container; `0.0.0.0` is needed for Docker port mapping but should be documented clearly). (3) The proxy key in openclaw.json should be a non-secret sentinel value (document this clearly). (4) Add a git pre-commit hook or wizard warning that scans for API key patterns in staged files. (5) Use Docker secrets instead of environment variables for production deployments.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Test Coverage** | Security scan: grep openclaw.json and all config files for API key patterns matching cloud.ru key format. Git hook test: stage a file containing `CLOUDRU_API_KEY=sk-...`, verify pre-commit hook blocks commit. Network test: with proxy running, attempt connection from non-localhost interface, verify connection refused.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

---

#### R004: Serialized Backend Limits Concurrent Users to 1

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **ADR Source**    | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Category**      | Technical / Operational                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description**   | `cli-backends.ts:52` sets `serialize: true` on `DEFAULT_CLAUDE_BACKEND`. In `cli-runner.ts:177-178`, this means `queueKey = backendResolved.id` (i.e., `"claude-cli"`), and `enqueueCliRun()` at line 181 serializes ALL requests behind a single queue key. When multiple users send messages simultaneously, they are processed one at a time. With GLM-4.7 response times of 10-30 seconds per request, a queue of 5 users means the 5th user waits 50-150 seconds. This is a fundamental architectural bottleneck that the ADRs acknowledge but do not resolve. |
| **Likelihood**    | **3** - Occurs whenever > 1 user sends a message within the same response cycle. Probability increases with user count.                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Impact**        | **4** - Severe degradation of user experience. Long wait times. Potential request timeouts. Users may abandon the platform.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Risk Score**    | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Mitigation**    | (1) Override `serialize: false` in the cloudru-fm backend config (requires testing that the proxy handles concurrent requests). (2) If serialization is required, implement a user-facing queue position indicator. (3) Set aggressive timeouts so stalled requests do not block the queue indefinitely. (4) Consider deploying multiple proxy instances behind a load balancer for multi-user scenarios. (5) Document the concurrency limitation prominently in wizard output.                                                                                     |
| **Test Coverage** | Load test: send 5 concurrent requests through the serialized backend, measure P50/P95/P99 latency. Verify no request times out. Concurrency test: set `serialize: false`, send 3 concurrent requests to proxy, verify all complete without corruption. Timeout test: mock a 60s proxy response, verify queue does not block indefinitely.                                                                                                                                                                                                                           |

---

### HIGH RISKS (Score 10-14)

---

#### R005: Type System Breaking Changes on AuthChoice Union Extension

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **ADR Source**    | ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Category**      | Integration / Regression                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description**   | ADR-002 requires adding 3 new values to the `AuthChoice` union type in `onboard-types.ts` (`cloudru-fm-glm47`, `cloudru-fm-flash`, `cloudru-fm-qwen`) and a new value to `AuthChoiceGroupId` (`cloudru-fm`). The `AuthChoice` type currently has 47 members and is used across multiple files: `auth-choice-options.ts`, `configure.gateway-auth.ts`, `auth-choice-prompt.ts`, `onboard-custom.ts`, and `auth-choice.apply.ts`. Any TypeScript switch/case or `if` chain that exhaustively checks `AuthChoice` values will fail to compile or (worse) silently fall through to a default case. The `AuthChoiceGroupId` type is duplicated -- it appears in BOTH `onboard-types.ts:48-66` and `auth-choice-options.ts:10-30` with slightly DIFFERENT members (e.g., `"together"` and `"litellm"` appear in `auth-choice-options.ts` but NOT in `onboard-types.ts`). Adding `"cloudru-fm"` to one but not the other will cause type mismatches. |
| **Likelihood**    | **3** - The duplicated type definition is a known maintenance hazard. The developer must update BOTH files correctly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Impact**        | **4** - Build failure if types diverge. Silent runtime bugs if exhaustive checks are not updated. Wizard flow may route cloudru-fm choices to the wrong handler.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Risk Score**    | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Mitigation**    | (1) Consolidate `AuthChoiceGroupId` to a single definition (eliminate the duplicate). (2) Add exhaustive switch check tests that fail when new AuthChoice values are added without corresponding handler. (3) Use TypeScript `satisfies` or `never` exhaustiveness checks at all dispatch points. (4) Add a compile-time test that verifies `AUTH_CHOICE_GROUP_DEFS` covers all `AuthChoiceGroupId` values.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Test Coverage** | Compile test: `tsc --noEmit` after adding new types, verify zero errors. Unit test: call `promptAuthConfig()` with `authChoice = "cloudru-fm-flash"`, verify it dispatches to the correct handler (not `custom-api-key` or `skip`). Exhaustiveness test: for each AuthChoice value, verify a corresponding handler exists in `applyAuthChoice()`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

---

#### R006: Proxy Protocol Translation Fidelity (Anthropic <-> OpenAI)

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R006                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **ADR Source**    | ADR-001, ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Category**      | Technical                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description**   | The claude-code-proxy must translate between Anthropic API protocol and OpenAI-compatible protocol in both directions. This includes: (1) Request translation: `x-api-key` header to `Authorization: Bearer`, `/messages` to `/v1/chat/completions`, Anthropic message format to OpenAI message format, `tool_use` blocks to `function_calling`. (2) Response translation: OpenAI completion format back to Anthropic message format, function call results back to `tool_result` blocks, streaming SSE format differences. Any edge case in translation (e.g., multi-turn tool use, system prompt handling, image content blocks, thinking mode responses) could produce responses that Claude Code cannot parse, triggering the `parseCliJson()` fallback path or outright failures. |
| **Likelihood**    | **4** - Protocol translation is inherently fragile. Edge cases in message formats, especially around tool calling and streaming, are common. The proxy is a third-party component with its own bug surface.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**        | **3** - Corrupted responses, partial data loss, or parse failures. User receives garbled or incomplete output.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Risk Score**    | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Mitigation**    | (1) Build a protocol conformance test suite that sends known Anthropic-format requests through the proxy and validates the OpenAI-format output (and vice versa for responses). (2) Pin the proxy Docker image version (`legard/claude-code-proxy:v1.x.x` instead of `:latest`). (3) Log full request/response pairs at the proxy level for debugging. (4) Implement response validation in OpenClaw before passing to `parseCliJson()`.                                                                                                                                                                                                                                                                                                                                               |
| **Test Coverage** | Protocol test: send Anthropic `/messages` request with tool_use content through proxy, verify translated OpenAI request matches expected format. Response test: inject known OpenAI completion response into proxy, verify Anthropic-format output parses correctly in `parseCliJson()`. Streaming test: verify SSE translation preserves all content blocks in order.                                                                                                                                                                                                                                                                                                                                                                                                                 |

---

#### R007: `clearEnv` Does Not Cover All Sensitive Variables

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R007                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **ADR Source**    | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Category**      | Security                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Description**   | `cli-backends.ts:51` defines `clearEnv: ["ANTHROPIC_API_KEY", "ANTHROPIC_API_KEY_OLD"]`. At `cli-runner.ts:222-228`, the subprocess environment is built by spreading `process.env` then `backend.env`, then deleting keys in `clearEnv`. However, the host process may have other sensitive environment variables (`OPENAI_API_KEY`, `GOOGLE_API_KEY`, `AWS_SECRET_ACCESS_KEY`, etc.) that leak into every Claude Code subprocess. While Claude Code tools are disabled (so it cannot exfiltrate these via tool calls), the variables are still present in the subprocess environment. If a future ADR enables selective tools, or if a vulnerability in Claude Code or the proxy allows environment inspection, these keys would be exposed. |
| **Likelihood**    | **3** - Common in production environments that have multiple API keys set. The subprocess inherits the full parent environment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**        | **4** - Exposure of unrelated API keys from the host environment to the Claude Code subprocess. Cross-service credential leakage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Risk Score**    | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Mitigation**    | (1) Extend `clearEnv` to include all known sensitive variable patterns (`OPENAI_API_KEY`, `GOOGLE_API_KEY`, `AWS_*`, `AZURE_*`, etc.). (2) Better: invert the approach -- instead of blocklist (`clearEnv`), use an allowlist of environment variables the subprocess needs. (3) Run Claude Code subprocess in a minimal environment (only PATH, HOME, and explicitly configured variables).                                                                                                                                                                                                                                                                                                                                                   |
| **Test Coverage** | Security test: set `OPENAI_API_KEY=test-secret` in parent process, spawn Claude Code subprocess, verify `OPENAI_API_KEY` is NOT in subprocess environment. Unit test: verify `clearEnv` array includes all known sensitive variable patterns.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

---

#### R008: Docker Compose `HOST: "0.0.0.0"` Network Exposure

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R008                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **ADR Source**    | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Category**      | Security                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description**   | ADR-001's Docker compose sets `HOST: "0.0.0.0"` for the proxy container, which means the proxy process inside the container listens on all interfaces. While the Docker port mapping `127.0.0.1:8082:8082` restricts HOST-side access to localhost, this relies on correct Docker networking configuration. In scenarios with: (1) Docker Desktop with VM networking, (2) Docker in WSL2 with port forwarding, (3) Kubernetes/Docker Swarm deployment, or (4) misconfigured Docker daemon with `--iptables=false`, the proxy could be accessible from external networks. The proxy has NO authentication -- any request to port 8082 is forwarded to cloud.ru with the configured API key. |
| **Likelihood**    | **2** - Requires Docker networking misconfiguration, which is uncommon in standard setups but frequent in cloud/VM deployments.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**        | **5** - Unauthenticated proxy access allows arbitrary use of the cloud.ru API key. Attacker can run unlimited LLM queries at victim's expense.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Risk Score**    | **10 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Mitigation**    | (1) Add authentication to the proxy (API key or bearer token requirement). (2) Document the network security requirement prominently in wizard output. (3) Add a wizard verification step that checks if port 8082 is accessible from non-localhost. (4) Add firewall rules in the Docker compose (iptables). (5) Consider using Docker's `network_mode: host` with explicit binding instead.                                                                                                                                                                                                                                                                                              |
| **Test Coverage** | Network test: with proxy running, attempt `curl http://<external-ip>:8082/health`, verify connection refused. Configuration test: verify Docker compose `ports` directive always includes `127.0.0.1:` prefix. Wizard test: verify generated docker-compose always has localhost binding.                                                                                                                                                                                                                                                                                                                                                                                                  |

---

#### R009: Model Fallback Produces Inconsistent Conversation Quality

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R009                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **ADR Source**    | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Description**   | ADR-005 defines fallback chains: `GLM-4.7 -> GLM-4.7-FlashX -> GLM-4.7-Flash -> ERROR`. When a model fails mid-conversation, the fallback mechanism in `runAgentTurnWithFallback()` switches to a lower-tier model. This produces: (1) Quality degradation mid-conversation (user notices response quality drop). (2) Different context window sizes between models (200K vs 128K for Qwen). (3) Different tool calling capabilities between models. (4) No notification to the user that fallback occurred. (5) Session state built on one model's reasoning style may confuse a different model. |
| **Likelihood**    | **3** - GLM-4.7 failures are documented as "Medium" probability in ADR-001. Fallback will be exercised regularly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Impact**        | **3** - Degraded user experience. Confusion from inconsistent response quality. Potential context corruption when session crosses model boundaries.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Risk Score**    | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Mitigation**    | (1) Notify the user when fallback occurs (e.g., "Switched to a faster model due to temporary issues"). (2) Start a new session when falling back (do not resume with a different model). (3) Implement quality monitoring to detect fallback frequency. (4) Set context window limits based on the smallest model in the fallback chain.                                                                                                                                                                                                                                                           |
| **Test Coverage** | Integration test: mock GLM-4.7 returning 503, verify fallback to GLM-4.7-FlashX produces valid response. Session test: verify session ID is handled correctly across fallback (new session vs. resume). Quality test: compare response quality metrics between primary and fallback models for the same prompts.                                                                                                                                                                                                                                                                                   |

---

#### R010: Wizard Flow Dispatch Gap for `cloudru-fm-*` Auth Choices

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R010                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **ADR Source**    | ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Category**      | Regression                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Description**   | `configure.gateway-auth.ts:60-103` dispatches auth choices through `applyAuthChoice()`. The current code at lines 60-63 checks for `custom-api-key` and `skip` explicitly. All other choices go to `applyAuthChoice()`. ADR-002 requires adding a dispatch for `cloudru-fm-*` choices at line 60 (before the existing checks), routing to a new `promptCloudruFmConfig()` function. If the dispatch is added incorrectly (e.g., after the `else if (authChoice !== "skip")` check at line 63), the cloudru-fm choices will flow into the generic `applyAuthChoice()` which has no handler for them, potentially causing a runtime error or silent misconfiguration. |
| **Likelihood**    | **3** - Dispatch order matters. The current code structure makes it easy to add the check in the wrong position.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Impact**        | **3** - Wizard appears to succeed but produces invalid configuration. User cannot connect to cloud.ru FM. Requires manual config editing to fix.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Risk Score**    | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Mitigation**    | (1) Add the cloudru-fm dispatch as the FIRST check in `promptAuthConfig()`, before `custom-api-key`. (2) Add integration test that exercises the wizard with each cloudru-fm choice. (3) Implement a catch-all that logs unhandled auth choices instead of silently falling through.                                                                                                                                                                                                                                                                                                                                                                                |
| **Test Coverage** | Unit test: call `promptAuthConfig()` with each of the 3 cloudru-fm choices, verify `promptCloudruFmConfig()` is invoked. Regression test: call `promptAuthConfig()` with all existing 47 auth choices, verify no regressions. Error test: call with an unknown auth choice, verify error is thrown (not silent pass-through).                                                                                                                                                                                                                                                                                                                                       |

---

#### R011: `mergeBackendConfig()` Shallow Merge Overwrites Critical Fields

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R011                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ADR Source**    | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Category**      | Regression                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Description**   | `cli-backends.ts:95-110` `mergeBackendConfig()` performs a shallow merge with specific handling for `args`, `env`, `modelAliases`, `clearEnv`, `sessionIdFields`, `sessionArgs`, and `resumeArgs`. However, line 102 shows `args: override.args ?? base.args` -- if the user provides ANY `args` override (even partial), the ENTIRE default args array is replaced, not merged. The default args include critical flags: `["-p", "--output-format", "json", "--dangerously-skip-permissions"]`. If a cloudru-fm config override includes `args` with just `["--model", "opus"]`, the essential `-p` and `--output-format json` flags are lost, causing Claude Code to launch in interactive mode or produce non-JSON output that `parseCliJson()` cannot parse. |
| **Likelihood**    | **2** - Requires user to specify `args` in their backend config override, which is not part of the standard wizard flow but could happen via manual config editing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Impact**        | **4** - Complete backend failure. Claude Code launches in wrong mode. Output parsing fails. No obvious error message (just garbled output).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Risk Score**    | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**    | (1) Document clearly that `args` override replaces the entire array (not appends). (2) Add validation in `resolveCliBackendConfig()` that ensures critical flags (`-p`, `--output-format`) are present in the final args. (3) Consider adding an `extraArgs` field that appends instead of replaces. (4) Wizard should NEVER set `args` in the override config.                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Test Coverage** | Unit test: call `mergeBackendConfig()` with override containing `args: ["--model", "opus"]`, verify critical flags are missing (document this behavior). Regression test: verify default backend config always includes `-p` and `--output-format json`. Integration test: send request with merged config, verify JSON output is parseable.                                                                                                                                                                                                                                                                                                                                                                                                                     |

---

#### R012: `--dangerously-skip-permissions` Flag Bypass

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R012                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ADR Source**    | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Category**      | Security                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description**   | `cli-backends.ts:32` includes `--dangerously-skip-permissions` in the default args for Claude Code subprocess. While ADR-003 notes that tools are disabled via system prompt injection (`"Tools are disabled in this session. Do not call tools."`), the `--dangerously-skip-permissions` flag is a process-level permission bypass that operates INDEPENDENTLY of the system prompt. If GLM-4.7 ignores the system prompt instruction (which is a text-level control, not a binary flag) due to attention issues documented in ADR-005 ("Long system prompt attention loss"), the model could attempt tool calls that Claude Code would execute without permission prompts. Combined with R001 (tool calling instability), this creates a path where malformed tool calls could execute arbitrary commands. |
| **Likelihood**    | **2** - Requires GLM-4.7 to ignore the "tools disabled" instruction AND produce a valid tool call format that Claude Code can parse. The proxy translation makes this less likely but not impossible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Impact**        | **5** - Arbitrary command execution in the Claude Code subprocess with the permissions of the OpenClaw process. File system access, network access, etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Risk Score**    | **10 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Mitigation**    | (1) Remove `--dangerously-skip-permissions` and use explicit permission grants for only the needed operations. (2) If the flag must remain, run Claude Code subprocess in a sandboxed environment (Docker, firejail). (3) Add Claude Code's `--allowedTools` flag to explicitly whitelist zero tools. (4) Monitor Claude Code subprocess for any tool execution attempts (grep stderr for tool-related messages).                                                                                                                                                                                                                                                                                                                                                                                            |
| **Test Coverage** | Security test: send a prompt through the full chain that explicitly requests file operations, verify Claude Code does NOT execute any tools. Injection test: craft a message that attempts to trick GLM-4.7 into ignoring the "tools disabled" instruction, verify no tool execution. Audit test: log all Claude Code subprocess stderr, verify zero tool execution entries.                                                                                                                                                                                                                                                                                                                                                                                                                                 |

---

#### R013: Proxy Docker Image `:latest` Tag Causes Unpredictable Updates

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R013                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ADR Source**    | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Description**   | ADR-001 specifies `image: legard/claude-code-proxy:latest` in the Docker compose. The `:latest` tag means any `docker pull` or container restart could fetch a completely different proxy version with breaking changes. ADR-004 notes "No automatic proxy updates (manual image pull)" as a negative consequence, but the `:latest` tag contradicts this -- `docker-compose up` with `--pull always` (or Docker's default behavior on some platforms) WILL pull the latest image. A proxy update that changes protocol translation behavior, adds/removes features, or introduces bugs will silently break the integration. |
| **Likelihood**    | **3** - Container restarts trigger pulls. Developers run `docker-compose pull`. CI/CD pipelines pull latest by default.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Impact**        | **3** - Breaking proxy update causes all requests to fail or produce incorrect results. Debugging is difficult because the change is invisible (same image name, different content).                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Risk Score**    | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Mitigation**    | (1) Pin to a specific version tag (e.g., `legard/claude-code-proxy:v1.2.3`). (2) Add image digest pinning for production deployments. (3) Wizard should record the proxy version used during setup. (4) Add a proxy version check in the health verification step.                                                                                                                                                                                                                                                                                                                                                           |
| **Test Coverage** | Configuration test: verify generated docker-compose uses pinned version tag, not `:latest`. Integration test: test against a specific proxy version, record version in test metadata. Upgrade test: test with N-1 and N proxy versions to detect breaking changes.                                                                                                                                                                                                                                                                                                                                                           |

---

### MEDIUM RISKS (Score 5-9)

---

#### R014: Cloud.ru Rate Limit (15 req/s) Exhaustion

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R014                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ADR Source**    | ADR-001                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description**   | ADR-001 documents a 15 req/s rate limit on the cloud.ru FM API. While `serialize: true` limits concurrent requests from a single OpenClaw instance, multiple instances or a burst of resumed sessions could exceed this limit. Rate limit responses (HTTP 429) from cloud.ru propagate through the proxy as errors that `runCliAgent()` may not handle gracefully (they appear as non-zero exit codes from Claude Code). |
| **Likelihood**    | **2** - Serialization reduces likelihood for single instances. Multi-instance or high-traffic scenarios increase it.                                                                                                                                                                                                                                                                                                     |
| **Impact**        | **3** - Temporary service degradation. Requests fail with 429 errors. Retry storms can worsen the situation.                                                                                                                                                                                                                                                                                                             |
| **Risk Score**    | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Mitigation**    | (1) Implement request rate tracking in OpenClaw (count requests per second to cloud.ru). (2) Add exponential backoff for 429 responses. (3) Classify 429 errors as retriable in `classifyFailoverReason()`. (4) Add rate limit headroom monitoring.                                                                                                                                                                      |
| **Test Coverage** | Rate limit test: mock cloud.ru returning 429 responses, verify OpenClaw retries with backoff. Load test: send requests at 15 req/s, verify no cascading failures. Error classification test: verify `classifyFailoverReason()` correctly identifies rate limit errors.                                                                                                                                                   |

---

#### R015: Subprocess Startup Latency (2-5s Cold Start)

| Field             | Detail                                                                                                                                                                                                                                                                                                 |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R015                                                                                                                                                                                                                                                                                                   |
| **ADR Source**    | ADR-003                                                                                                                                                                                                                                                                                                |
| **Category**      | Technical                                                                                                                                                                                                                                                                                              |
| **Description**   | ADR-003 acknowledges 2-5 second subprocess startup overhead per cold call. Combined with GLM-4.7 response time (5-30s), serialized queue delays, and proxy network latency, total response time for a single message could reach 35+ seconds. This is significantly worse than direct API integration. |
| **Likelihood**    | **4** - Every request incurs subprocess overhead. Cold starts happen after session timeouts.                                                                                                                                                                                                           |
| **Impact**        | **2** - Degraded user experience but functional. Users on messaging platforms (Telegram/WhatsApp) may find 35s response times unacceptable.                                                                                                                                                            |
| **Risk Score**    | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                         |
| **Mitigation**    | (1) Pre-warm Claude Code sessions during idle periods. (2) Implement subprocess pooling (keep-alive). (3) Show typing indicator immediately when request is received (before subprocess spawns). (4) Optimize system prompt size to reduce startup parsing time.                                       |
| **Test Coverage** | Performance test: measure P50/P95 cold start time across 100 requests. Benchmark test: compare end-to-end latency of proxy path vs. direct API call. UX test: verify typing indicator appears within 500ms of user message.                                                                            |

---

#### R016: Session Persistence Across Model Fallbacks

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R016                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **ADR Source**    | ADR-003, ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Category**      | Regression                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Description**   | Claude Code maintains session state via `--session-id` and `--resume` flags. When a model fallback occurs (ADR-005), the session ID persists but the underlying model changes. Claude Code session state may include model-specific reasoning artifacts, tool call history, and context that is incompatible with the fallback model. The `resolveSessionIdToSend()` function at `cli-runner.ts:124-138` does not consider model changes when deciding whether to resume. |
| **Likelihood**    | **2** - Only occurs when fallback is triggered AND the user has an existing session.                                                                                                                                                                                                                                                                                                                                                                                      |
| **Impact**        | **3** - Session corruption. Claude Code may produce errors or incoherent responses when resuming with a different model.                                                                                                                                                                                                                                                                                                                                                  |
| **Risk Score**    | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**    | (1) Generate a new session ID when model changes due to fallback. (2) Store model ID in session metadata to detect mismatches. (3) Add a session-model compatibility check before resume.                                                                                                                                                                                                                                                                                 |
| **Test Coverage** | Session test: create session with GLM-4.7, trigger fallback to GLM-4.7-Flash, verify either new session is created or resume handles model change gracefully. Regression test: verify existing session resume behavior is not broken by model fallback logic.                                                                                                                                                                                                             |

---

#### R017: Wizard Generates Docker Compose but Docker May Not Be Installed

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R017                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **ADR Source**    | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Description**   | ADR-004's wizard flow includes Docker compose generation and deployment. If Docker or docker-compose is not installed on the host, the wizard may fail midway through configuration, leaving the user with partially applied config (cloud.ru provider configured but proxy not running). The wizard's `verifyProxyHealth()` would return `{ok: false}` but there is no rollback mechanism for the already-applied config changes. |
| **Likelihood**    | **2** - Docker is commonly installed on developer machines but not universal. Server deployments may use Podman or other runtimes.                                                                                                                                                                                                                                                                                                 |
| **Impact**        | **3** - Partially configured system. User must manually diagnose why LLM requests fail (proxy not running). Wizard does not rollback provider config.                                                                                                                                                                                                                                                                              |
| **Risk Score**    | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Mitigation**    | (1) Check for Docker installation BEFORE starting cloudru-fm wizard flow. (2) Offer alternative: manual proxy setup instructions or non-Docker proxy deployment. (3) Implement config rollback if proxy deployment fails. (4) Store wizard progress so it can be resumed after Docker installation.                                                                                                                                |
| **Test Coverage** | Prerequisite test: mock Docker not installed, verify wizard reports clear error before config changes. Rollback test: simulate proxy deployment failure, verify no partial config is written.                                                                                                                                                                                                                                      |

---

#### R018: `parseCliJson()` and `parseCliJsonl()` Error Handling for Non-Standard Output

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R018                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **ADR Source**    | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Category**      | Technical                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description**   | `cli-runner.ts:284-285` calls `parseCliJson(stdout, backend)` for JSON output mode. If GLM-4.7 produces output that Claude Code wraps in non-standard JSON (e.g., with thinking blocks, partial tool calls, or stream artifacts), `parseCliJson()` may return `null` (line 285: `parsed ?? { text: stdout }`). In this case, the raw stdout is returned as text, which may contain JSON-like content mixed with debug output, yielding garbled user responses. |
| **Likelihood**    | **3** - GLM-4.7's output format through proxy translation may not perfectly match Claude Code's expected JSON structure.                                                                                                                                                                                                                                                                                                                                       |
| **Impact**        | **3** - User receives malformed or debug-level output instead of a clean response.                                                                                                                                                                                                                                                                                                                                                                             |
| **Risk Score**    | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Mitigation**    | (1) Add robust JSON extraction from stdout (handle prefix/suffix garbage). (2) Log all `parseCliJson()` null returns with the raw stdout for debugging. (3) Add a sanitization layer between raw output and user delivery.                                                                                                                                                                                                                                     |
| **Test Coverage** | Parse test: feed `parseCliJson()` with various malformed outputs (JSON with prefix text, truncated JSON, JSON with thinking blocks), verify graceful handling. Integration test: capture raw Claude Code stdout when backed by proxy, verify parseable JSON.                                                                                                                                                                                                   |

---

#### R019: Model ID Hardcoding Creates Maintenance Burden

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R019                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **ADR Source**    | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description**   | ADR-005 hardcodes cloud.ru model IDs (`zai-org/GLM-4.7`, `Qwen/Qwen3-Coder-480B-A35B-Instruct`, `zai-org/GLM-4.7-Flash`) in Docker compose environment variables. Model IDs are also hardcoded in the wizard (ADR-002) and the fallback chain (ADR-005). When cloud.ru updates model versions, renames models, or deprecates models, ALL these locations must be updated simultaneously. The proxy requires a restart to pick up new model IDs. |
| **Likelihood**    | **3** - Cloud providers regularly update model IDs. Cloud.ru is a newer platform with likely frequent model updates.                                                                                                                                                                                                                                                                                                                            |
| **Impact**        | **2** - Service interruption when old model IDs become invalid. Manual update required across multiple files.                                                                                                                                                                                                                                                                                                                                   |
| **Risk Score**    | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Mitigation**    | (1) Centralize model ID definitions in a single config file. (2) Support model ID aliasing in the proxy (accept `glm-4.7` and resolve to full ID). (3) Add a cloud.ru model availability check in the health verification. (4) Implement a model catalog that can be updated without restart.                                                                                                                                                   |
| **Test Coverage** | Availability test: query cloud.ru FM API for model list, verify all hardcoded model IDs are valid. Update test: change a model ID in config, verify proxy picks up the change (or document restart requirement).                                                                                                                                                                                                                                |

---

#### R020: Streaming Not Supported to End Users

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R020                                                                                                                                                                                                                                                                                                                                                                                                      |
| **ADR Source**    | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Category**      | Technical                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Description**   | ADR-003 lists "No streaming to end user (batch response only)" as a negative consequence. The `runCliAgent()` function waits for the complete subprocess output before returning. For long responses from GLM-4.7 (which can take 30+ seconds for complex reasoning), the user sees nothing until the entire response is generated. This is a significant UX regression compared to direct API streaming. |
| **Likelihood**    | **4** - Every request is affected. Longer prompts produce longer generation times.                                                                                                                                                                                                                                                                                                                        |
| **Impact**        | **2** - Poor user experience (long wait with no feedback) but functional.                                                                                                                                                                                                                                                                                                                                 |
| **Risk Score**    | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**    | (1) Implement subprocess stdout streaming (read Claude Code output incrementally). (2) If full streaming is not feasible, implement a heartbeat/progress indicator. (3) Set aggressive timeouts to prevent indefinite waits. (4) Consider using Claude Code's streaming output mode if available.                                                                                                         |
| **Test Coverage** | UX test: measure time-to-first-byte for user response. Performance test: verify response time does not exceed timeout. Streaming test: if implemented, verify incremental output delivery.                                                                                                                                                                                                                |

---

#### R021: `AUTH_CHOICE_GROUP_DEFS` Array Order Affects UI Presentation

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R021                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **ADR Source**    | ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Category**      | Regression                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Description**   | The `AUTH_CHOICE_GROUP_DEFS` array in `auth-choice-options.ts:44-165` determines the display order of auth providers in the wizard. Adding `cloudru-fm` at a specific position affects the UX of the wizard for ALL users, not just cloud.ru users. If inserted at the top, it may confuse users who expect Anthropic/OpenAI first. If inserted at the bottom, cloud.ru users may not find it. The array currently has 20 groups; adding another increases cognitive load. |
| **Likelihood**    | **2** - Only occurs once during implementation but affects all wizard users permanently.                                                                                                                                                                                                                                                                                                                                                                                   |
| **Impact**        | **2** - Minor UX degradation. Users may be confused by new option or may not find it.                                                                                                                                                                                                                                                                                                                                                                                      |
| **Risk Score**    | **4 (LOW)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Mitigation**    | (1) Add cloudru-fm after the existing major providers (OpenAI, Anthropic, Google) but before niche providers. (2) Add a wizard search/filter capability. (3) Sort by popularity or relevance.                                                                                                                                                                                                                                                                              |
| **Test Coverage** | UI test: verify wizard display order with cloudru-fm group added. Regression test: verify all existing groups still appear in expected order.                                                                                                                                                                                                                                                                                                                              |

---

#### R022: `DISABLE_THINKING=true` Proxy Env May Degrade Response Quality

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                   |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R022                                                                                                                                                                                                                                                                                                                                                                     |
| **ADR Source**    | ADR-005                                                                                                                                                                                                                                                                                                                                                                  |
| **Category**      | Technical                                                                                                                                                                                                                                                                                                                                                                |
| **Description**   | ADR-005's mitigation table recommends `DISABLE_THINKING=true` to address "Thinking mode conflicts." However, thinking/reasoning mode is a key differentiator for GLM-4.7's quality on complex tasks. Disabling it universally reduces the model's reasoning capability across all requests, not just the ones that trigger conflicts. This trades stability for quality. |
| **Likelihood**    | **3** - Will be enabled by default per ADR-005 recommendation. Affects every request.                                                                                                                                                                                                                                                                                    |
| **Impact**        | **2** - Reduced response quality for complex reasoning tasks. May negate the "task quality HIGHER than model quality alone" claim from ADR-003.                                                                                                                                                                                                                          |
| **Risk Score**    | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                           |
| **Mitigation**    | (1) Make thinking mode configurable per request (not a global disable). (2) Test thinking mode ON with common prompts; only disable if failures exceed threshold. (3) Allow wizard to choose thinking mode setting. (4) Monitor quality metrics with and without thinking mode.                                                                                          |
| **Test Coverage** | Quality test: compare response quality (automated metrics) with thinking ON vs OFF for 50 representative prompts. Stability test: run 100 requests with thinking ON, measure failure rate. A/B test: if failure rate is < 5%, keep thinking ON.                                                                                                                          |

---

### LOW RISKS (Score 1-4)

---

#### R023: Wizard New File `onboard-cloudru-fm.ts` Increases Maintenance Surface

| Field             | Detail                                                                                                                                                                                                                                                     |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R023                                                                                                                                                                                                                                                       |
| **ADR Source**    | ADR-002                                                                                                                                                                                                                                                    |
| **Category**      | Integration                                                                                                                                                                                                                                                |
| **Description**   | ADR-002 requires creating `src/commands/onboard-cloudru-fm.ts` (~150 lines) plus modifying 4 existing files. The new file adds to the maintenance surface. When upstream OpenClaw updates its wizard architecture, the cloudru-fm module may need updates. |
| **Likelihood**    | **2** - Upstream wizard changes are infrequent. The module is small and focused.                                                                                                                                                                           |
| **Impact**        | **2** - Maintenance cost. Potential merge conflicts with upstream.                                                                                                                                                                                         |
| **Risk Score**    | **4 (LOW)**                                                                                                                                                                                                                                                |
| **Mitigation**    | (1) Keep the module minimal and well-isolated. (2) Follow existing wizard patterns exactly. (3) Add module-level tests that catch upstream API changes.                                                                                                    |
| **Test Coverage** | Unit test: test all exported functions from `onboard-cloudru-fm.ts`. Integration test: verify wizard flow end-to-end with cloudru-fm selection.                                                                                                            |

---

#### R024: `ANTHROPIC_API_KEY: "cloudru-proxy-key"` Sentinel Value Confusion

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                 |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**       | R024                                                                                                                                                                                                                                                                                                                                                   |
| **ADR Source**    | ADR-001                                                                                                                                                                                                                                                                                                                                                |
| **Category**      | Operational                                                                                                                                                                                                                                                                                                                                            |
| **Description**   | ADR-001 sets `ANTHROPIC_API_KEY: "cloudru-proxy-key"` in the backend env override. This is a sentinel value (the proxy does not validate it) but looks like a real credential. Users may: (1) try to use it as a real Anthropic key, (2) accidentally commit it thinking it's sensitive, (3) be confused about why their Anthropic key was "replaced." |
| **Likelihood**    | **2** - Documentation should clarify this, but user confusion is likely.                                                                                                                                                                                                                                                                               |
| **Impact**        | **2** - User confusion. Time wasted debugging. No security impact (it's not a real key).                                                                                                                                                                                                                                                               |
| **Risk Score**    | **4 (LOW)**                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**    | (1) Use a clearly non-key value like `not-a-real-key-proxy-only` or `proxy-sentinel`. (2) Add a comment in the config explaining this is a placeholder. (3) Wizard should explain this during setup.                                                                                                                                                   |
| **Test Coverage** | Documentation test: verify wizard output explains the sentinel value. Config test: verify the sentinel value is not a valid API key format.                                                                                                                                                                                                            |

---

#### R025: `systemPromptWhen: "first"` May Miss Context on Resumed Sessions

| Field             | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**       | R025                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **ADR Source**    | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Category**      | Regression                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description**   | `cli-backends.ts:50` sets `systemPromptWhen: "first"`, meaning the system prompt (including "Tools are disabled" and OpenClaw's custom instructions) is only sent on the first message of a session. On resumed sessions (`--resume`), the system prompt is NOT re-sent. If Claude Code's session state loses the original system prompt (e.g., context window overflow, compaction), the "Tools are disabled" instruction may be lost. |
| **Likelihood**    | **1** - Claude Code is designed to persist system prompts across session resumption. Context overflow is unlikely within normal conversation lengths.                                                                                                                                                                                                                                                                                   |
| **Impact**        | **3** - If "Tools are disabled" is lost and `--dangerously-skip-permissions` is active, tool execution becomes possible (connects to R012).                                                                                                                                                                                                                                                                                             |
| **Risk Score**    | **3 (LOW)**                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Mitigation**    | (1) Change to `systemPromptWhen: "always"` for the cloudru-fm backend config override. (2) Or verify Claude Code persists system prompts across all session operations.                                                                                                                                                                                                                                                                 |
| **Test Coverage** | Session test: create session, resume 10 times, verify system prompt is still effective on each resume. Security test: after many resumes, attempt tool execution, verify it is blocked.                                                                                                                                                                                                                                                 |

---

## Risk Summary by Category

| Category    | Count | Avg Score | Max Score |
| ----------- | ----- | --------- | --------- |
| Technical   | 8     | 10.4      | 20        |
| Security    | 5     | 12.0      | 15        |
| Operational | 6     | 8.2       | 16        |
| Regression  | 4     | 6.5       | 12        |
| Integration | 2     | 8.0       | 12        |

## Risk Summary by ADR

| ADR     | Risks | Critical | High | Medium | Low |
| ------- | ----- | -------- | ---- | ------ | --- |
| ADR-001 | 14    | 3        | 5    | 4      | 2   |
| ADR-002 | 5     | 0        | 1    | 2      | 2   |
| ADR-003 | 12    | 2        | 5    | 4      | 1   |
| ADR-004 | 6     | 2        | 2    | 2      | 0   |
| ADR-005 | 7     | 1        | 1    | 4      | 1   |

(Note: Many risks span multiple ADRs, so the totals above exceed 25.)

---

## Prioritized Action Items

### Immediate (Before Implementation Begins)

| Priority | Action                                                               | Risks Addressed | Effort |
| -------- | -------------------------------------------------------------------- | --------------- | ------ |
| **P0**   | Pin proxy Docker image to specific version tag                       | R013            | 5 min  |
| **P0**   | Change `HOST: "0.0.0.0"` documentation and add proxy auth discussion | R008            | 30 min |
| **P0**   | Extend `clearEnv` to cover known sensitive variable patterns         | R007            | 30 min |
| **P0**   | Document sentinel value `"cloudru-proxy-key"` clearly                | R024            | 15 min |

### Before First User Deployment

| Priority | Action                                                                    | Risks Addressed | Effort  |
| -------- | ------------------------------------------------------------------------- | --------------- | ------- |
| **P1**   | Implement pre-flight proxy health check in agent-runner routing           | R002            | 2 hours |
| **P1**   | Add Docker prerequisite check to wizard flow                              | R017            | 1 hour  |
| **P1**   | Consolidate `AuthChoiceGroupId` to single type definition                 | R005            | 1 hour  |
| **P1**   | Add exhaustive switch checks for AuthChoice dispatch                      | R005, R010      | 2 hours |
| **P1**   | Test tool calling through full proxy chain (GLM-4.7 + proxy)              | R001, R006      | 4 hours |
| **P1**   | Evaluate `--dangerously-skip-permissions` necessity; add `--allowedTools` | R012            | 2 hours |

### Before Multi-User Deployment

| Priority | Action                                                       | Risks Addressed | Effort  |
| -------- | ------------------------------------------------------------ | --------------- | ------- |
| **P2**   | Evaluate `serialize: false` with proxy concurrency testing   | R004            | 4 hours |
| **P2**   | Implement rate limit detection and backoff for cloud.ru 429s | R014            | 2 hours |
| **P2**   | Build protocol conformance test suite for proxy translation  | R006            | 8 hours |
| **P2**   | Implement user notification for model fallback events        | R009            | 2 hours |
| **P2**   | Add subprocess stdout streaming for incremental responses    | R020            | 8 hours |

### Ongoing

| Priority | Action                                                               | Risks Addressed | Effort     |
| -------- | -------------------------------------------------------------------- | --------------- | ---------- |
| **P3**   | Monitor GLM-4.7 tool calling failure rates in production             | R001            | Continuous |
| **P3**   | Track model ID changes from cloud.ru                                 | R019            | Monthly    |
| **P3**   | A/B test thinking mode ON vs OFF quality impact                      | R022            | 1 week     |
| **P3**   | Implement environment allowlist (replacing blocklist) for subprocess | R007            | 4 hours    |

---

## Cross-ADR Dependency Risks

The 5 ADRs form a tightly coupled dependency chain:

```
ADR-002 (Wizard)
  -> configures -> ADR-001 (Proxy Integration)
    -> deploys -> ADR-004 (Proxy Lifecycle)
      -> runs -> ADR-005 (Model Mapping)
        -> executes via -> ADR-003 (Claude Code Engine)
```

**Chain fragility**: A failure at any link breaks the entire integration. There is no partial-functionality mode. If the proxy fails (ADR-004), model mapping is irrelevant (ADR-005). If the wizard misconfigures (ADR-002), the proxy cannot connect (ADR-001).

**Recommendation**: Implement a diagnostic command (`openclaw doctor cloudru`) that verifies each link in the chain independently and reports the first failure point.

---

## Test Strategy Recommendations

### Unit Tests (Shift-Left Priority: Highest)

1. `mergeBackendConfig()` with all override combinations
2. `resolveCliBackendConfig("claude-cli", ...)` with cloudru-fm env overrides
3. `parseCliJson()` / `parseCliJsonl()` with malformed proxy output
4. AuthChoice dispatch exhaustiveness
5. Type compatibility between `onboard-types.ts` and `auth-choice-options.ts`

### Integration Tests (Shift-Left Priority: High)

1. Full wizard flow: select cloudru-fm -> configure -> verify health
2. Full request flow: message -> runCliAgent -> proxy -> mock cloud.ru -> response
3. Fallback flow: primary model 503 -> fallback model -> valid response
4. Session resume: create session -> fallback -> resume with original model

### Security Tests (Shift-Left Priority: High)

1. Port scanning: verify proxy only accessible on localhost
2. Environment leak: verify subprocess does not expose parent env secrets
3. Sentinel value: verify proxy key is not a real credential format
4. Git scan: verify .env and docker-compose are gitignored

### Performance Tests (Shift-Left Priority: Medium)

1. Cold start latency: measure subprocess spawn time
2. Serialized queue latency: N concurrent requests, measure Pxx
3. Proxy throughput: sustained 15 req/s for 5 minutes
4. Memory: proxy container memory under sustained load

### Chaos Tests (Shift-Left Priority: Medium)

1. Kill proxy during request -> verify error handling
2. Kill cloud.ru connection during request -> verify timeout
3. Corrupt proxy response -> verify parse failure handling
4. Exhaust rate limit -> verify backoff behavior

---

_Analysis generated by QE Regression Risk Analyzer. All risk scores are estimates based on static analysis of ADRs and source code. Production monitoring data should be used to refine likelihood and impact scores after deployment._
