# QCSD Ideation Risk Assessment: SFDIPOT Analysis

## OpenClaw + Claude Code + Cloud.ru FM Integration

**Analyst**: QE Risk Assessor (SFDIPOT Framework)
**Date**: 2026-02-12
**Scope**: ADR-001 through ADR-005
**Method**: SFDIPOT (Structure, Function, Data, Interfaces, Platform, Operations, Time)
**Input**: 5 ADRs, prior Shift-Left Risk Analysis (03-risk-analysis.md)

---

## Executive Summary

This SFDIPOT analysis identifies **35 risks** across 7 dimensions for the OpenClaw + Claude Code + cloud.ru FM integration. Each dimension contributes a minimum of 5 risks, ensuring comprehensive coverage of structural, functional, data, interface, platform, operational, and temporal failure modes.

**Risk Distribution**:

- CRITICAL (score >= 15): 5 risks
- HIGH (score 10-14): 11 risks
- MEDIUM (score 5-9): 14 risks
- LOW (score 1-4): 5 risks

**Top 5 Risks by Score**:

1. S-R03 - Proxy single-container SPOF (Score: 20)
2. F-R01 - Tool calling format translation fidelity (Score: 20)
3. I-R01 - Proxy-to-cloud.ru connection failure cascade (Score: 16)
4. D-R01 - API key traversal through 4 exposure surfaces (Score: 15)
5. T-R01 - Cold start latency stacking (Score: 15)

---

## Risk Scoring Methodology

| Score | Rating   | Threshold                 |
| ----- | -------- | ------------------------- |
| 15-25 | CRITICAL | Likelihood x Impact >= 15 |
| 10-14 | HIGH     | Likelihood x Impact 10-14 |
| 5-9   | MEDIUM   | Likelihood x Impact 5-9   |
| 1-4   | LOW      | Likelihood x Impact 1-4   |

- **Likelihood** (1-5): 1=Rare, 2=Unlikely, 3=Possible, 4=Likely, 5=Almost certain
- **Impact** (1-5): 1=Negligible, 2=Minor, 3=Moderate, 4=Major, 5=Severe

---

## S - Structure

Structural risks arise from the physical and logical arrangement of components: Docker containers, proxy-to-API request flow, configuration merging hierarchy, and file system layout.

### S-R01: Config Merging Hierarchy Produces Silent Override Conflicts

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**     | S-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **ADR Source**  | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description** | `mergeBackendConfig()` in `cli-backends.ts:95-110` applies a shallow merge: defaults then user overrides. The merge hierarchy is `DEFAULT_CLAUDE_BACKEND -> openclaw.json cliBackends -> runtime env`. If a user specifies `args` in their override (e.g., `["--model", "opus"]`), the entire default args array (`["-p", "--output-format", "json", "--dangerously-skip-permissions"]`) is replaced, not appended. The cloudru-fm wizard writes `env` overrides but a manual user editing `openclaw.json` could inadvertently overwrite critical flags. There is no schema validation on the merged result. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Mitigation**  | (1) Add post-merge validation that required flags (`-p`, `--output-format json`) are present. (2) Introduce `extraArgs` field for appending rather than replacing. (3) Emit a warning log when default args are overridden. (4) Schema-validate the final merged config before subprocess spawn.                                                                                                                                                                                                                                                                                                             |

### S-R02: Docker Compose File Outside Version Control Creates Drift

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | S-R02                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description** | ADR-004 specifies that `docker-compose.cloudru-proxy.yml` is NOT committed to git (added to `.gitignore`). This means the proxy configuration diverges between deployments with no change tracking. If a user modifies model mappings, port bindings, or environment variables in the compose file, there is no audit trail. Multiple team members may have different proxy configurations causing inconsistent behavior. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**  | (1) Commit a `docker-compose.cloudru-proxy.yml.template` (without secrets) to version control. (2) Generate the runtime file from template + `.env` substitution. (3) Add a config hash check that detects drift from template. (4) Log the active compose configuration hash at proxy startup.                                                                                                                           |

### S-R03: Proxy Single-Container Architecture is a Complete SPOF

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | S-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Description** | The entire LLM request path flows through one Docker container: `OpenClaw -> Claude Code -> proxy -> cloud.ru`. There is no redundancy, no load balancing, and no failover proxy instance. ADR-004 documents a state machine with a RECOVERING state but provides no mechanism for a hot standby. If the container crashes and Docker restart takes 5-15 seconds, all in-flight requests fail. If the container enters a restart loop (e.g., corrupted config, bad image pull), the outage persists indefinitely. |
| **Likelihood**  | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Impact**      | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Score**       | **20 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Mitigation**  | (1) Deploy two proxy instances behind a lightweight TCP load balancer (e.g., nginx or HAProxy). (2) Implement circuit breaker in OpenClaw: after N consecutive proxy failures, queue requests until recovery. (3) Add container memory limits and CPU limits to prevent resource exhaustion crashes. (4) Implement a watchdog process outside Docker that monitors and restarts the proxy independently.                                                                                                          |

### S-R04: File System Layout Lacks Clear Boundary Between Secrets and Config

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | S-R04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **ADR Source**  | ADR-001, ADR-002, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description** | The integration scatters configuration across multiple files: `openclaw.json` (backend config, model aliases), `.env` (API keys), `docker-compose.cloudru-proxy.yml` (proxy config including model IDs as env vars). The `.env` file contains the real cloud.ru API key. `openclaw.json` contains the sentinel proxy key `"cloudru-proxy-key"`. The Docker compose references `.env` via variable substitution. There is no structural separation between secret-bearing files and safe-to-share config files. A new contributor may not understand which files are safe to share or commit. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Mitigation**  | (1) Establish a clear directory structure: `config/` for shareable config, `secrets/` (gitignored) for credentials. (2) Wizard output should explicitly list which files contain secrets. (3) Add a `.gitignore` validation step in the wizard that verifies secret files are excluded. (4) Use naming convention: files with secrets use `.secret` or `.env` suffix.                                                                                                                                                                                                                        |

### S-R05: No Multi-Instance Deployment Architecture Defined

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | S-R05                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ADR Source**  | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Description** | The ADRs describe a single-instance architecture. There is no guidance for scaling to multiple OpenClaw instances sharing one proxy, or multiple proxies behind a coordinator. The `serialize: true` setting in `cli-backends.ts:52` creates a process-level lock per OpenClaw instance, but multiple instances would each create their own serial queue, potentially overwhelming the proxy and cloud.ru rate limits (15 req/s). |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Score**       | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Mitigation**  | (1) Document single-instance as the only supported deployment for v1. (2) Design a shared rate limiter (Redis-based or similar) for multi-instance scenarios. (3) Add instance identification to proxy requests for debugging. (4) Define a scaling ADR before multi-instance deployment is attempted.                                                                                                                            |

---

## F - Function

Functional risks relate to what the system does: protocol translation, model name mapping, tool calling format conversion, and wizard auth configuration.

### F-R01: Tool Calling Format Translation Produces Unparseable Responses

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | F-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **ADR Source**  | ADR-001, ADR-003, ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description** | Claude Code internally uses Anthropic `tool_use` / `tool_result` format for its reasoning pipeline. The proxy must translate these bidirectionally to OpenAI `function_calling` format. GLM-4.7 has known tool calling instabilities (sglang #15721). The translation chain is: Claude Code emits Anthropic tool_use -> proxy translates to OpenAI function_call -> GLM-4.7 processes (possibly producing malformed function calls) -> proxy translates response back to Anthropic tool_result -> Claude Code parses. Any fidelity loss at any translation step produces responses that `parseCliJson()` cannot handle. |
| **Likelihood**  | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Impact**      | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Score**       | **20 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Mitigation**  | (1) Build a translation conformance test suite with 50+ tool calling patterns. (2) Add proxy-side response validation before returning to Claude Code. (3) Implement retry with `DISABLE_THINKING=true` as a fallback when tool call parsing fails. (4) Log all translation failures with full request/response payloads for post-mortem analysis. (5) Fall back to GLM-4.7-Flash which may have better tool calling stability.                                                                                                                                                                                         |

### F-R02: Model Name Mapping Table Has No Runtime Validation

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | F-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ADR Source**  | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description** | The proxy maps Claude model tiers (Opus/Sonnet/Haiku) to cloud.ru model IDs via environment variables (`BIG_MODEL`, `MIDDLE_MODEL`, `SMALL_MODEL`). If an environment variable is misspelled, empty, or contains an invalid model ID, the proxy will forward requests to cloud.ru which will return 404 or 400 errors. There is no startup validation that verifies the model IDs exist on cloud.ru. The health check (`/health`) only verifies the proxy process is running, not that it can reach cloud.ru or that configured models are available. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Mitigation**  | (1) Add a startup validation call to cloud.ru `/v1/models` endpoint to verify all configured model IDs exist. (2) Extend the health check to include model availability verification. (3) Wizard should validate model IDs against the cloud.ru API before writing config. (4) Log the active model mapping at proxy startup for debugging.                                                                                                                                                                                                           |

### F-R03: Wizard Auth Flow Does Not Validate API Key Before Persisting

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | F-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ADR Source**  | ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Description** | ADR-002's wizard flow (Step 3: "API Key -> [paste cloud.ru API key]") collects the API key and writes it to `.env`. The wizard then checks proxy health (Step 4) but the health check only verifies the proxy process is running. There is no step that validates the API key against the cloud.ru API (e.g., a lightweight `/v1/models` call). A user could enter an invalid, expired, or wrong-tenant API key and complete the wizard successfully, only to discover failures when sending their first message. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Mitigation**  | (1) Add a key validation step in the wizard: call cloud.ru `/v1/models` with the provided key and verify 200 response. (2) If validation fails, prompt the user to re-enter the key. (3) Display which models are available with the key so the user can confirm access. (4) Store validation timestamp in config for future reference.                                                                                                                                                                           |

### F-R04: Fallback Chain Execution Has No Context Window Size Guard

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | F-R04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **ADR Source**  | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Description** | The fallback chain `GLM-4.7 (200K) -> GLM-4.7-FlashX -> GLM-4.7-Flash (200K)` and `Qwen3-Coder (128K) -> GLM-4.7 (200K) -> GLM-4.7-Flash (200K)` switches between models with different context window sizes. If a conversation has accumulated 150K tokens of context on Qwen3-Coder (128K max but running close to limit) and falls back to GLM-4.7-Flash (200K), the context fits. But if the reverse occurs, context built on a 200K model may not fit in a 128K fallback target. `runAgentTurnWithFallback()` does not check context size against the fallback model's limit before attempting the request. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Score**       | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**  | (1) Track conversation context size and compare against fallback model limits before attempting fallback. (2) Set the effective context limit to the minimum across the entire fallback chain. (3) Implement context truncation strategy when falling back to a smaller-window model. (4) Warn users when context is approaching the smallest fallback model's limit.                                                                                                                                                                                                                                            |

### F-R05: RLHF Refusal Patterns in GLM-4.7 Bypass System Prompt Mitigations

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | F-R05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **ADR Source**  | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description** | ADR-005's mitigation table lists "RLHF refusals" with mitigation "Anti-refusal in system prompt." GLM-4.7 may refuse certain requests based on its RLHF training. The anti-refusal system prompt is a text-based mitigation that the model may not consistently follow, especially under adversarial inputs or when the refusal pattern is deeply embedded in the model's training. If GLM-4.7 refuses a legitimate request, Claude Code's reasoning pipeline stalls because it receives a refusal instead of the expected response format. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Mitigation**  | (1) Detect refusal patterns in proxy responses (e.g., "I cannot", "I'm sorry, I can't") and retry with rephrased prompt. (2) Log refusal occurrences with the triggering prompt for pattern analysis. (3) Maintain a refusal bypass prompt library tuned for GLM-4.7. (4) Fall back to alternative model when refusal is detected.                                                                                                                                                                                                          |

---

## D - Data

Data risks concern the lifecycle and integrity of data flowing through the system: API keys, model mapping tables, session IDs, and configuration schemas.

### D-R01: API Key Traverses 4 Distinct Exposure Surfaces

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | D-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Description** | The cloud.ru API key flows through: (1) User input during wizard Step 3 (terminal history). (2) `.env` file on disk (plaintext). (3) Docker Compose environment variable interpolation (visible in `docker inspect`). (4) Proxy process environment (visible in `/proc/<pid>/environ`). Each surface is an independent exposure risk. Terminal history persists across sessions. `docker inspect` output includes all environment variables in plaintext. The `/proc` filesystem exposes environment to any process running as the same user. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Impact**      | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Score**       | **15 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Mitigation**  | (1) Clear terminal history entry after key input (or use a secure input method that does not echo). (2) Set restrictive file permissions on `.env` (chmod 600). (3) Use Docker secrets instead of environment variables for production. (4) Document all exposure surfaces in wizard output so users understand the risk. (5) Consider encrypting the key at rest with a machine-specific key.                                                                                                                                                |

### D-R02: Session ID Collision Across Multiple Users

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | D-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Description** | `resolveSessionIdToSend()` in `cli-runner.ts:124-138` generates or reuses session IDs for Claude Code subprocess calls. If the session ID generation does not incorporate user-specific entropy, two users could theoretically receive the same session ID, causing Claude Code to merge their conversation histories. The `sessionIdFields` in `cli-backends.ts:47` determines which fields compose the session ID, but the exact composition is not specified in the ADRs. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Score**       | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Mitigation**  | (1) Verify that session ID generation includes user-specific identifiers (user ID, chat ID). (2) Add uniqueness check: log warning if a session ID is reused across different user contexts. (3) Include a random component in session ID generation. (4) Add integration test that spawns two concurrent users and verifies session isolation.                                                                                                                              |

### D-R03: Model Mapping Table Integrity Not Verified at Runtime

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | D-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **ADR Source**  | ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Description** | The model mapping (`Opus -> GLM-4.7`, `Sonnet -> Qwen3-Coder`, `Haiku -> GLM-4.7-Flash`) is set via Docker environment variables at container start. If the proxy image is updated and the mapping env var names change (e.g., `BIG_MODEL` renamed to `PRIMARY_MODEL`), the proxy falls back to internal defaults which may not match cloud.ru models. There is no checksum or version verification between the compose file's env vars and the proxy's expected configuration schema. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Score**       | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Mitigation**  | (1) Pin proxy image to a specific version (not `:latest`). (2) Add a startup log line in the proxy that prints the active model mapping. (3) Include model mapping in the health check response so OpenClaw can verify it. (4) Test the compose file against the pinned proxy version in CI.                                                                                                                                                                                           |

### D-R04: Config Schema Has No Formal Validation

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | D-R04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **ADR Source**  | ADR-001, ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description** | The wizard writes configuration to `openclaw.json` including nested objects (`models.providers.cloudru-fm`, `agents.defaults.cliBackends.claude-cli.env`, `agents.defaults.model.primary`). There is no JSON Schema or Zod/Joi validation on the output. A typo in a key name (e.g., `cliBackend` instead of `cliBackends`) would produce a config that loads without error but silently falls back to defaults. The `resolveCliBackendConfig()` function returns null for unknown backends, and `cli-runner.ts` throws `"Unknown CLI backend"` -- but only at request time, not at startup. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Mitigation**  | (1) Add a JSON Schema for the cloudru-fm configuration section. (2) Validate config at application startup, not just at request time. (3) Wizard should verify the written config by re-reading and validating it. (4) Add a `openclaw doctor cloudru` diagnostic command that validates the full config chain.                                                                                                                                                                                                                                                                              |

### D-R05: Conversation Data Leaks Through Proxy Logs

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | D-R05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Description** | The claude-code-proxy processes all request and response bodies in transit. Depending on the proxy's logging configuration, it may log full message payloads including user conversation content, system prompts, and tool call data. These logs persist in Docker's log driver (default: json-file) with no rotation or encryption. In multi-user scenarios, conversation data from all users flows through the same proxy and potentially the same log files, creating a data aggregation risk. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Mitigation**  | (1) Configure proxy to log only metadata (status codes, latency) not payloads. (2) Set Docker log rotation (`max-size`, `max-file` in compose). (3) If payload logging is needed for debugging, add a redaction layer for PII. (4) Document data flow for GDPR/privacy compliance assessment.                                                                                                                                                                                                     |

---

## I - Interfaces

Interface risks arise at communication boundaries: OpenClaw-to-Claude-Code, Claude-Code-to-Proxy, Proxy-to-cloud.ru, and Wizard-to-User.

### I-R01: Proxy-to-Cloud.ru Connection Failure Produces Opaque Errors

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | I-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Description** | When the proxy cannot reach cloud.ru FM API (DNS failure, TLS error, firewall block, cloud.ru outage), it returns an error to Claude Code. Claude Code wraps this in its own error handling and exits with a non-zero exit code. `runCliAgent()` captures stderr and stdout, but the original cloud.ru error is buried under multiple layers of error wrapping (cloud.ru HTTP error -> proxy error response -> Claude Code stderr -> subprocess exit code). The user sees a generic "Agent execution failed" message with no actionable information. The error chain is: `cloud.ru 5xx -> proxy JSON error -> Claude Code "API error" in stderr -> subprocess exit code 1 -> FailoverError`. |
| **Likelihood**  | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Score**       | **16 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**  | (1) Parse Claude Code stderr for known error patterns (connection refused, timeout, 5xx, 401, 429) and surface them to the user as specific error messages. (2) Add a direct cloud.ru health check in OpenClaw that bypasses the proxy (call `/v1/models` directly) for diagnostics. (3) Implement structured error codes at each interface boundary. (4) Add a `--verbose` flag to `runCliAgent()` that preserves the full error chain for debugging.                                                                                                                                                                                                                                       |

### I-R02: Claude Code Subprocess stdio Parsing is Fragile

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | I-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description** | `runCliAgent()` in `cli-runner.ts` communicates with Claude Code via subprocess stdout/stderr. The expected format is JSON (`--output-format json`). However, Claude Code may emit warnings, progress indicators, or debug output to stdout before the JSON payload. GLM-4.7 responses through the proxy may include extra whitespace, BOM characters, or partial JSON. `parseCliJson()` attempts to extract valid JSON from stdout but falls back to `{ text: stdout }` on failure, returning raw output to the user. If Claude Code emits JSONL (multiple JSON objects) instead of a single JSON blob, `parseCliJsonl()` must be used instead. The choice between these parsers is not well-documented. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**  | (1) Add a JSON boundary detector that strips non-JSON prefix/suffix from stdout. (2) Log all `parseCliJson()` failures with the raw stdout for pattern analysis. (3) Standardize on JSONL output and use `parseCliJsonl()` exclusively. (4) Add a response sanitization layer before delivering output to users.                                                                                                                                                                                                                                                                                                                                                                                          |

### I-R03: Wizard Interactive Prompts Fail in Non-TTY Environments

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                     |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | I-R03                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **ADR Source**  | ADR-002                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description** | ADR-002's wizard uses interactive prompts (`promptAuthChoiceGrouped`, `promptCloudruFmConfig`) via inquirer or similar prompt library. These prompts require a TTY (terminal) for user input. In CI/CD pipelines, Docker containers, or headless server environments, TTY is not available. The wizard would either hang waiting for input or crash. There is no non-interactive configuration path for cloud.ru FM setup. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                             |
| **Mitigation**  | (1) Support a `--non-interactive` flag that accepts all configuration via command-line arguments or environment variables. (2) Support a `--config-file` flag that reads wizard answers from a JSON file. (3) Detect non-TTY environment and provide clear instructions instead of hanging. (4) Document the non-interactive setup path for server deployments.                                                            |

### I-R04: OpenClaw-to-Claude-Code Subprocess Interface Lacks Health Signaling

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**     | I-R04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **ADR Source**  | ADR-003, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Description** | The interface between OpenClaw and Claude Code is a subprocess spawn. There is no readiness signal: OpenClaw spawns the subprocess and waits for output. If Claude Code starts but cannot reach the proxy (e.g., proxy is still starting), the subprocess blocks until its internal timeout, then exits with an error. OpenClaw has no way to distinguish between "Claude Code is starting up" and "Claude Code is stuck waiting for proxy" without parsing stderr in real-time. The `serialize: true` queue means this stuck subprocess blocks all subsequent requests. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**  | (1) Implement pre-flight proxy health check BEFORE spawning Claude Code subprocess. (2) Set a subprocess timeout (`REQUEST_TIMEOUT`) that is shorter than the user-facing timeout. (3) Add a startup sentinel output from Claude Code that OpenClaw can detect (e.g., first line of stderr). (4) Implement subprocess watchdog that kills stalled processes after a configurable timeout.                                                                                                                                                                                |

### I-R05: Anthropic API Version Header May Not Be Translated Correctly

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | I-R05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ADR Source**  | ADR-001                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description** | Claude Code sends `anthropic-version` header with its API requests (a required Anthropic protocol header). The proxy must strip this header and not forward it to cloud.ru (which speaks OpenAI protocol and would reject unknown headers). If the proxy passes the `anthropic-version` header through, cloud.ru may return 400 Bad Request. Conversely, if Claude Code requires a specific `anthropic-version` in the response, the proxy must synthesize it. The proxy's header translation behavior is not documented in the ADRs. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Score**       | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Mitigation**  | (1) Add a protocol conformance test that captures all headers sent by Claude Code and verifies the proxy strips/translates them correctly. (2) Document the proxy's header handling behavior. (3) Test with the specific Claude Code version that will be deployed. (4) Add header logging at the proxy for debugging.                                                                                                                                                                                                                |

---

## P - Platform

Platform risks relate to the runtime environment: Docker, Node.js, network configuration, and OS-level dependencies.

### P-R01: Docker Runtime Dependency is Not Universally Available

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**     | P-R01                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Description** | The entire proxy layer depends on Docker. The wizard assumes Docker is installed and `docker-compose` (or `docker compose` v2) is available. On systems without Docker (e.g., minimal server installs, restricted corporate environments, some CI runners), the integration cannot function. There is no alternative proxy deployment method documented. Podman, containerd, or native process alternatives are not addressed. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Mitigation**  | (1) Check Docker availability at wizard start; provide clear error if missing. (2) Document alternative: run proxy as a native Node.js process without Docker. (3) Support Podman as a Docker alternative (compatible CLI). (4) Provide a pre-built binary or npm package for the proxy that does not require Docker.                                                                                                          |

### P-R02: Node.js Subprocess Spawning Has OS-Specific Behavior

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | P-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Description** | `runCliAgent()` spawns Claude Code as a subprocess via Node.js `child_process`. Subprocess behavior varies across platforms: (1) On Windows, `claude` command may need `.cmd` or `.exe` suffix. (2) On macOS, process limits differ from Linux. (3) Signal handling (SIGTERM, SIGKILL) for cleanup varies. (4) Environment variable inheritance and `PATH` resolution differ. The ADRs target Docker/Linux but OpenClaw may be installed on developer machines running macOS or Windows. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Score**       | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **Mitigation**  | (1) Document supported platforms explicitly (Linux recommended, macOS supported, Windows experimental). (2) Use `cross-spawn` or similar library for cross-platform subprocess spawning. (3) Add platform-specific integration tests in CI. (4) Handle SIGTERM/SIGKILL cleanup consistently across platforms.                                                                                                                                                                            |

### P-R03: Localhost Network Binding Assumption Breaks in Container-in-Container

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Risk ID**     | P-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Description** | The architecture assumes `localhost:8082` connects OpenClaw to the proxy. This works when both run on the same host. However, if OpenClaw itself runs inside a Docker container (common in production), `localhost` inside the container refers to the container's own network, not the host where the proxy runs. Docker-in-Docker or Docker Compose networking requires using service names or Docker network IPs instead of `localhost`. The `ANTHROPIC_BASE_URL=http://localhost:8082` setting in `openclaw.json` would be wrong in this scenario. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Mitigation**  | (1) Document the container-in-container networking requirement. (2) Support a configurable proxy URL (not hardcoded to localhost). (3) Provide a Docker Compose template that includes both OpenClaw and proxy in the same Docker network with service name routing. (4) Wizard should detect if running inside Docker and adjust the proxy URL accordingly.                                                                                                                                                                                           |

### P-R04: Docker Container Runs with Default Security Profile

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | P-R04                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Description** | ADR-004 notes the container "runs with default Docker security profile." The default profile grants extensive capabilities. The proxy container processes untrusted data (API responses from cloud.ru) and could be exploited if a vulnerability exists in the proxy code. With default capabilities, a compromised container could: access the Docker socket (if mounted), read host filesystem mounts, or escalate privileges. |
| **Likelihood**  | 1                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**      | 5                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Score**       | **5 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**  | (1) Add `security_opt: ["no-new-privileges:true"]` to compose. (2) Drop all capabilities and add back only needed ones (`cap_drop: ALL`). (3) Run as non-root user inside the container (`user: "1000:1000"`). (4) Set read-only root filesystem (`read_only: true`) if the proxy does not need write access. (5) Add AppArmor or seccomp profile.                                                                               |

### P-R05: OS-Level Environment Variables Leak Into Subprocess

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | P-R05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Description** | `cli-runner.ts:222-228` builds subprocess env by spreading `process.env` (the OpenClaw process's full environment) then applying backend-specific overrides and `clearEnv` deletions. The `clearEnv` only removes `ANTHROPIC_API_KEY` and `ANTHROPIC_API_KEY_OLD`. All other environment variables from the host process leak into the Claude Code subprocess, including: `OPENAI_API_KEY`, `GOOGLE_API_KEY`, `AWS_SECRET_ACCESS_KEY`, database URLs, internal service tokens. While tools are disabled, these values exist in the subprocess memory and `/proc/<pid>/environ`. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**  | (1) Switch from blocklist (`clearEnv`) to allowlist: only pass `PATH`, `HOME`, `NODE_PATH`, and explicitly configured variables to the subprocess. (2) Extend `clearEnv` to include all known sensitive variable patterns as an interim fix. (3) Document the environment inheritance behavior so operators can remove sensitive variables from the host process. (4) Add a security audit that scans subprocess environment for known key patterns.                                                                                                                            |

---

## O - Operations

Operational risks cover deployment workflows, health monitoring, fallback execution, and error recovery procedures.

### O-R01: No Automated Rollback if Wizard Deployment Fails Mid-Flow

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | O-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **ADR Source**  | ADR-002, ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Description** | The wizard flow (ADR-002, Steps 1-5) applies configuration incrementally: first writes provider config to `openclaw.json`, then deploys Docker compose, then verifies health. If the Docker deployment fails (Step 4) or health check fails (after Step 5), the already-written provider config in `openclaw.json` points to a non-functional proxy. The wizard has no rollback mechanism. The user is left with a partially configured system that routes requests to a dead proxy, producing errors instead of falling back to the previous working configuration. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Mitigation**  | (1) Implement transactional config updates: backup `openclaw.json` before modification, restore on failure. (2) Do not write backend config until proxy health is verified. (3) Implement a `--rollback` wizard command that undoes the last wizard run. (4) Write config atomically: build the complete new config in memory, validate, then write once.                                                                                                                                                                                                            |

### O-R02: Health Monitoring Has No Alerting or Escalation Path

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | O-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Description** | ADR-004 defines a proxy state machine (RUNNING -> UNHEALTHY -> RECOVERING) and a health check endpoint. However, there is no alerting mechanism. Docker's internal healthcheck updates the container status, but nobody is notified. OpenClaw's proposed pre-flight health check (ADR-004 Section 3) only checks health at request time. Between requests, the proxy could be down for hours with no notification. There is no log aggregation, no metric export, and no integration with monitoring systems (Prometheus, Grafana, PagerDuty). |
| **Likelihood**  | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Mitigation**  | (1) Add a periodic health check (cron or background task) that runs independently of user requests. (2) Emit health metrics in Prometheus format from the proxy. (3) Add a webhook notification when health check fails N consecutive times. (4) Log health status transitions for audit trail. (5) Document integration with common monitoring stacks.                                                                                                                                                                                        |

### O-R03: Proxy Image Update Requires Manual Pull and Restart

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | O-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Description** | ADR-004 notes "No automatic proxy updates (manual image pull)" as a negative consequence. The proxy is a third-party component (`legard/claude-code-proxy`) that may receive security patches, bug fixes, or breaking changes. There is no update notification mechanism. If a critical vulnerability is discovered in the proxy, users have no way to know they need to update. Using `:latest` tag (per ADR-001) means `docker pull` gets the newest version, but running containers are not automatically updated. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Mitigation**  | (1) Pin to a specific version tag and document the update procedure. (2) Add a version check command (`openclaw proxy version`) that compares running version against latest available. (3) Add Watchtower or similar auto-update mechanism for non-breaking updates. (4) Subscribe to the proxy repo's release notifications.                                                                                                                                                                                        |

### O-R04: Error Recovery From Cloud.ru Outage Has No Graceful Degradation

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | O-R04                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **ADR Source**  | ADR-001, ADR-005                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Description** | If cloud.ru FM API has a complete outage, all three models in the fallback chain fail. The fallback chain terminates at ERROR with no further recovery path. The user receives an error message. There is no graceful degradation mode (e.g., cached responses, offline mode, alternative provider). For a user-facing application like OpenClaw (Telegram/WhatsApp bot), complete unavailability means all conversations stop. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Impact**      | 5                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Score**       | **10 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**  | (1) Add a secondary provider configuration (e.g., local model, alternative API) as a last-resort fallback. (2) Implement a "service unavailable" message that is user-friendly and includes estimated recovery time. (3) Add response caching for repeated queries during outages. (4) Monitor cloud.ru status page and pre-emptively notify users of known outages.                                                            |

### O-R05: No Observability Into Proxy Request/Response Metrics

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | O-R05                                                                                                                                                                                                                                                                                                                                                                                               |
| **ADR Source**  | ADR-001, ADR-004                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description** | The proxy sits between Claude Code and cloud.ru but exposes only a binary health check (`/health`). There are no metrics for: request count, error rate, latency distribution, model-specific failure rates, token usage, or rate limit proximity. Without these metrics, operators cannot: detect gradual degradation, plan capacity, identify which model tier is causing issues, or track costs. |
| **Likelihood**  | 4                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Impact**      | 2                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Score**       | **8 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                      |
| **Mitigation**  | (1) Add a `/metrics` endpoint to the proxy (or a sidecar) that exposes Prometheus-format metrics. (2) Track: requests_total, errors_total, latency_histogram, tokens_used, rate_limit_remaining per model. (3) Add a simple dashboard template for Grafana. (4) Log structured request metadata (request ID, model, latency, status) for analysis.                                                  |

---

## T - Time

Temporal risks relate to latency, timeouts, session expiration, startup timing, and ordering dependencies.

### T-R01: Cold Start Latency Stacking Produces 35+ Second Response Times

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | T-R01                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Description** | A cold request stacks multiple latency components: (1) OpenClaw message processing: ~100ms. (2) Serial queue wait (if other requests pending): 0-30s. (3) Claude Code subprocess spawn: 2-5s. (4) Claude Code startup and proxy connection: ~1s. (5) Proxy request to cloud.ru: ~200ms. (6) GLM-4.7 model inference: 5-30s. (7) Proxy response translation: ~100ms. (8) Claude Code output processing: ~500ms. Total worst case: 67s. Even typical case: 15-35s. For a Telegram bot, responses over 10s feel broken. WhatsApp has a 24-hour window but user patience is finite. |
| **Likelihood**  | 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Score**       | **15 (CRITICAL)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Mitigation**  | (1) Send typing indicator immediately upon receiving user message (before subprocess spawn). (2) Pre-warm Claude Code sessions during idle periods. (3) Implement subprocess connection pooling to eliminate cold start. (4) Use GLM-4.7-Flash (faster inference) as the default model. (5) Set user expectations with a "thinking..." message. (6) Implement request deduplication to avoid redundant spawns.                                                                                                                                                                  |

### T-R02: Request Timeout Mismatch Between Layers Creates Zombie Processes

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | T-R02                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **ADR Source**  | ADR-001, ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Description** | The system has multiple timeout configurations at different layers: (1) OpenClaw's user-facing timeout (platform-specific, e.g., Telegram webhook timeout). (2) `runCliAgent()` subprocess timeout (configured via `REQUEST_TIMEOUT` or default). (3) Proxy's request timeout to cloud.ru. (4) Cloud.ru's server-side timeout. If the OpenClaw timeout fires before the subprocess timeout, the user receives an error but the subprocess continues running, consuming resources and potentially completing a response that is never delivered. If the subprocess timeout fires before the proxy timeout, the subprocess dies but the proxy connection to cloud.ru remains open. These zombie processes and connections accumulate. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Impact**      | 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Score**       | **12 (HIGH)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Mitigation**  | (1) Align timeouts in descending order: cloud.ru < proxy < subprocess < OpenClaw. (2) Implement proper subprocess cleanup: when OpenClaw times out, send SIGTERM to subprocess, wait 5s, then SIGKILL. (3) Set proxy timeout shorter than subprocess timeout. (4) Monitor for orphaned subprocess processes. (5) Add a process reaper that cleans up stale Claude Code processes.                                                                                                                                                                                                                                                                                                                                                   |

### T-R03: Docker Container Restart Timing Creates Request Black Hole

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | T-R03                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Description** | When the proxy container crashes and Docker restarts it (`restart: unless-stopped`), there is a window of 5-30 seconds where the container is not accepting connections. Requests arriving during this window fail. Docker's health check (`interval: 30s, timeout: 10s, retries: 3`) takes up to 120 seconds to mark the container as unhealthy. During this 120-second window, Docker reports the container as "starting" (not unhealthy), so orchestration tools may not trigger alerts. Requests are silently dropped with connection refused errors. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Score**       | **9 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Mitigation**  | (1) Reduce health check interval to 10s and retries to 2 for faster failure detection. (2) Add a TCP connection check in OpenClaw before spawning subprocess (faster than HTTP health check). (3) Implement request queuing during proxy restart window. (4) Add a "last healthy" timestamp to the health check response for staleness detection.                                                                                                                                                                                                         |

### T-R04: Session Expiration Not Synchronized Between OpenClaw and Claude Code

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | T-R04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **ADR Source**  | ADR-003                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **Description** | Claude Code sessions have their own expiration/eviction policy. OpenClaw tracks sessions via `sessionMode: "always"` and `--session-id`. If Claude Code evicts a session (due to inactivity, disk space, or version upgrade) but OpenClaw still references it via `--resume`, the subprocess either: (1) starts a new session silently (losing context), (2) returns an error, or (3) hangs trying to load a non-existent session. There is no synchronization protocol between OpenClaw's session tracking and Claude Code's session storage. |
| **Likelihood**  | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Impact**      | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Score**       | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Mitigation**  | (1) Handle the "session not found" case gracefully: detect it in stderr and start a fresh session. (2) Add a session validation step before `--resume` (check if session file exists). (3) Set explicit session TTL in OpenClaw config and clean up expired references. (4) Log session lifecycle events for debugging.                                                                                                                                                                                                                        |

### T-R05: Ordering Dependency Between Proxy Start and First Request

| Field           | Detail                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Risk ID**     | T-R05                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **ADR Source**  | ADR-004                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Description** | The proxy must be running and healthy before any LLM request can be processed. After a system reboot, the proxy Docker container starts automatically (`restart: unless-stopped`) but may not be ready when the first user message arrives. OpenClaw starts independently and may receive messages before the proxy is healthy. There is no dependency ordering between OpenClaw startup and proxy readiness. The wizard deploys the proxy, but after a reboot, the proxy starts based on Docker's restart policy timing, which may be after OpenClaw begins accepting messages. |
| **Likelihood**  | 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Impact**      | 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Score**       | **6 (MEDIUM)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Mitigation**  | (1) Add a startup health gate in OpenClaw: do not accept cloudru-fm requests until proxy health check passes. (2) Queue incoming messages during proxy startup with a "service starting" response. (3) If both run via Docker Compose, use `depends_on` with `condition: service_healthy`. (4) Implement exponential backoff retry on first request failure.                                                                                                                                                                                                                     |

---

## Risk Summary by SFDIPOT Dimension

| Dimension          | Count  | Critical | High  | Medium | Low   | Avg Score |
| ------------------ | ------ | -------- | ----- | ------ | ----- | --------- |
| **S - Structure**  | 5      | 1        | 1     | 3      | 0     | 11.6      |
| **F - Function**   | 5      | 1        | 1     | 3      | 0     | 11.6      |
| **D - Data**       | 5      | 1        | 0     | 4      | 0     | 9.8       |
| **I - Interfaces** | 5      | 1        | 1     | 3      | 0     | 10.4      |
| **P - Platform**   | 5      | 0        | 3     | 2      | 0     | 9.4       |
| **O - Operations** | 5      | 0        | 2     | 3      | 0     | 9.6       |
| **T - Time**       | 5      | 1        | 1     | 3      | 0     | 9.6       |
| **TOTAL**          | **35** | **5**    | **9** | **21** | **0** | **10.3**  |

---

## Risk Heatmap

```
                    Impact
                1       2       3       4       5
            +-------+-------+-------+-------+-------+
         5  |       | T-R01 |       |       | F-R01 |
            |       |       |       |       | S-R03 |
Likelihood  +-------+-------+-------+-------+-------+
         4  |       | O-R05 |       | I-R01 |       |
            |       |       |       | I-R04 |       |
            |       |       |       | T-R02 |       |
            |       |       |       | O-R02 |       |
            +-------+-------+-------+-------+-------+
         3  |       |       | S-R02 | S-R01 | D-R01 |
            |       |       | S-R04 | F-R02 |       |
            |       |       | F-R03 | P-R03 |       |
            |       |       | F-R05 | P-R05 |       |
            |       |       | D-R04 |       |       |
            |       |       | D-R05 |       |       |
            |       |       | I-R02 |       |       |
            |       |       | I-R03 |       |       |
            |       |       | O-R01 |       |       |
            |       |       | O-R03 |       |       |
            |       |       | T-R03 |       |       |
            +-------+-------+-------+-------+-------+
         2  |       |       | D-R02 | D-R03 | O-R04 |
            |       |       | I-R05 | F-R04 |       |
            |       |       | P-R02 | S-R05 |       |
            |       |       | T-R04 |       |       |
            |       |       | T-R05 |       |       |
            +-------+-------+-------+-------+-------+
         1  |       |       |       |       | P-R04 |
            +-------+-------+-------+-------+-------+
```

---

## Cross-Reference: SFDIPOT vs ADR

| Risk ID | S   | F   | D   | I   | P   | O   | T   | ADR-001 | ADR-002 | ADR-003 | ADR-004 | ADR-005 |
| ------- | --- | --- | --- | --- | --- | --- | --- | ------- | ------- | ------- | ------- | ------- |
| S-R01   | X   |     |     |     |     |     |     | X       |         | X       |         |         |
| S-R02   | X   |     |     |     |     |     |     |         |         |         | X       |         |
| S-R03   | X   |     |     |     |     |     |     | X       |         |         | X       |         |
| S-R04   | X   |     | X   |     |     |     |     | X       | X       |         | X       |         |
| S-R05   | X   |     |     |     |     |     |     | X       |         | X       |         |         |
| F-R01   |     | X   |     |     |     |     |     | X       |         | X       |         | X       |
| F-R02   |     | X   | X   |     |     |     |     |         |         |         |         | X       |
| F-R03   |     | X   |     | X   |     |     |     |         | X       |         |         |         |
| F-R04   |     | X   |     |     |     |     |     |         |         |         |         | X       |
| F-R05   |     | X   |     |     |     |     |     |         |         |         |         | X       |
| D-R01   |     |     | X   |     |     |     |     | X       |         |         | X       |         |
| D-R02   |     |     | X   |     |     |     |     |         |         | X       |         |         |
| D-R03   |     |     | X   |     |     |     |     |         |         |         |         | X       |
| D-R04   |     |     | X   |     |     |     |     | X       | X       |         |         |         |
| D-R05   |     |     | X   |     |     |     |     | X       |         |         | X       |         |
| I-R01   |     |     |     | X   |     |     |     | X       |         |         | X       |         |
| I-R02   |     |     |     | X   |     |     |     |         |         | X       |         |         |
| I-R03   |     |     |     | X   |     |     |     |         | X       |         |         |         |
| I-R04   |     |     |     | X   |     |     |     |         |         | X       | X       |         |
| I-R05   |     |     |     | X   |     |     |     | X       |         |         |         |         |
| P-R01   |     |     |     |     | X   |     |     |         |         |         | X       |         |
| P-R02   |     |     |     |     | X   |     |     |         |         | X       |         |         |
| P-R03   |     |     |     |     | X   |     |     | X       |         |         | X       |         |
| P-R04   |     |     |     |     | X   |     |     |         |         |         | X       |         |
| P-R05   |     |     |     |     | X   |     |     |         |         | X       |         |         |
| O-R01   |     |     |     |     |     | X   |     |         | X       |         | X       |         |
| O-R02   |     |     |     |     |     | X   |     |         |         |         | X       |         |
| O-R03   |     |     |     |     |     | X   |     |         |         |         | X       |         |
| O-R04   |     |     |     |     |     | X   |     | X       |         |         |         | X       |
| O-R05   |     |     |     |     |     | X   |     | X       |         |         | X       |         |
| T-R01   |     |     |     |     |     |     | X   |         |         | X       |         |         |
| T-R02   |     |     |     |     |     |     | X   | X       |         | X       |         |         |
| T-R03   |     |     |     |     |     |     | X   |         |         |         | X       |         |
| T-R04   |     |     |     |     |     |     | X   |         |         | X       |         |         |
| T-R05   |     |     |     |     |     |     | X   |         |         |         | X       |         |

---

## Relationship to Prior Shift-Left Analysis

This SFDIPOT analysis complements the prior Shift-Left Risk Analysis (03-risk-analysis.md, 25 risks) by applying a structured dimensional framework. Key relationships:

| SFDIPOT Risk | Shift-Left Risk | Relationship                                 |
| ------------ | --------------- | -------------------------------------------- |
| S-R03        | R002            | Same risk, expanded structural perspective   |
| F-R01        | R001, R006      | Combines tool calling + protocol translation |
| D-R01        | R003            | Same risk, deeper data lifecycle analysis    |
| P-R05        | R007            | Same risk, platform perspective              |
| T-R01        | R015            | Same risk, full latency stacking analysis    |
| I-R01        | R002 (partial)  | New: error propagation through interfaces    |
| O-R02        | R002 (partial)  | New: monitoring gap in operations            |
| T-R02        | New             | New: timeout mismatch analysis               |
| P-R03        | New             | New: container networking assumption         |
| D-R05        | New             | New: conversation data privacy in logs       |

**New risks not in prior analysis**: 20 of the 35 SFDIPOT risks are either new or significantly expanded from the prior analysis, demonstrating the value of dimensional coverage.

---

## Prioritized Mitigation Roadmap

### Phase 0: Before Implementation (Week 0)

| Priority | Mitigation                                                | Risks Addressed     | Effort  |
| -------- | --------------------------------------------------------- | ------------------- | ------- |
| P0       | Pin proxy Docker image to specific version                | S-R03, D-R03, O-R03 | 5 min   |
| P0       | Switch to environment allowlist for subprocess            | P-R05               | 2 hours |
| P0       | Add pre-flight proxy health check before subprocess spawn | I-R04, T-R05        | 2 hours |
| P0       | Set chmod 600 on `.env` file in wizard                    | D-R01               | 15 min  |
| P0       | Add post-merge config validation for critical flags       | S-R01               | 1 hour  |

### Phase 1: Before First User (Week 1-2)

| Priority | Mitigation                                               | Risks Addressed | Effort  |
| -------- | -------------------------------------------------------- | --------------- | ------- |
| P1       | Build tool calling translation conformance tests         | F-R01           | 8 hours |
| P1       | Implement wizard API key validation against cloud.ru     | F-R03           | 2 hours |
| P1       | Implement wizard rollback on failure                     | O-R01           | 4 hours |
| P1       | Align timeout hierarchy across all layers                | T-R02           | 4 hours |
| P1       | Add typing indicator on message receipt                  | T-R01           | 1 hour  |
| P1       | Add Docker prerequisite check in wizard                  | P-R01           | 1 hour  |
| P1       | Support configurable proxy URL (not hardcoded localhost) | P-R03           | 2 hours |
| P1       | Add container security hardening to compose              | P-R04           | 1 hour  |

### Phase 2: Before Multi-User (Week 3-4)

| Priority | Mitigation                                   | Risks Addressed | Effort  |
| -------- | -------------------------------------------- | --------------- | ------- |
| P2       | Deploy redundant proxy instances             | S-R03           | 8 hours |
| P2       | Add periodic health monitoring with alerting | O-R02           | 4 hours |
| P2       | Implement proxy metrics endpoint             | O-R05           | 4 hours |
| P2       | Add config schema validation at startup      | D-R04           | 4 hours |
| P2       | Handle session-not-found gracefully          | T-R04           | 2 hours |
| P2       | Implement refusal detection and retry        | F-R05           | 4 hours |
| P2       | Add non-interactive wizard mode              | I-R03           | 4 hours |

### Phase 3: Ongoing Improvements

| Priority | Mitigation                                       | Risks Addressed | Effort  |
| -------- | ------------------------------------------------ | --------------- | ------- |
| P3       | Implement response caching for outage resilience | O-R04           | 8 hours |
| P3       | Add context window size tracking for fallback    | F-R04           | 4 hours |
| P3       | Monitor proxy logs for conversation data leakage | D-R05           | 2 hours |
| P3       | Track model ID changes from cloud.ru             | D-R03, F-R02    | Monthly |
| P3       | Add session collision detection                  | D-R02           | 2 hours |
| P3       | Cross-platform subprocess testing                | P-R02           | 4 hours |

---

## Test Strategy by SFDIPOT Dimension

### Structure Tests

1. Config merge validation: test all override combinations, verify critical flags preserved
2. File system layout: verify secret files are gitignored, config files are schema-valid
3. Single-instance vs multi-instance: verify behavior under both deployment modes

### Function Tests

1. Protocol translation conformance: 50+ test cases covering all message formats
2. Model mapping validation: verify all configured model IDs exist on cloud.ru
3. Fallback chain execution: test each transition in the fallback chain
4. Refusal detection: test with 20+ known refusal patterns from GLM-4.7

### Data Tests

1. API key exposure scan: verify key not present in logs, config, git history
2. Session ID uniqueness: spawn 100 concurrent sessions, verify zero collisions
3. Config schema validation: test with valid, invalid, and edge-case configurations

### Interface Tests

1. Error propagation: inject failures at each interface, verify actionable error surfaces
2. stdio parsing: test with 30+ stdout variations (clean JSON, prefixed, truncated, JSONL)
3. Header translation: capture all headers at each interface, verify correct transformation

### Platform Tests

1. Docker availability: test wizard with Docker missing, verify clear error
2. Container networking: test localhost, Docker-in-Docker, and Compose network modes
3. Subprocess environment: verify only allowlisted variables reach Claude Code

### Operations Tests

1. Wizard rollback: fail at each wizard step, verify clean rollback
2. Health monitoring: simulate proxy failure, verify detection within 30 seconds
3. Update procedure: test proxy version update, verify no service interruption

### Time Tests

1. Latency budget: measure each latency component, verify total under threshold
2. Timeout cascade: verify timeouts fire in correct order across all layers
3. Startup ordering: reboot simulation, verify no requests lost during startup
4. Session expiration: test resume after various idle periods

---

_SFDIPOT analysis generated by QE Risk Assessor. All 35 risks scored using Likelihood (1-5) x Impact (1-5). This analysis complements the prior Shift-Left analysis (03-risk-analysis.md) by applying structured dimensional coverage. Risk scores are estimates based on ADR analysis; production data should refine these estimates after deployment._
