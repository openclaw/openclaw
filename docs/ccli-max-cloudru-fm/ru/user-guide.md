# Руководство пользователя

## Что такое OpenClaw + MAX?

OpenClaw — это AI-шлюз, который подключает интеллектуальных AI-ассистентов к мессенджерам. Расширение MAX Messenger позволяет общаться с AI-ботом прямо в мессенджере MAX — суперприложении от VK Group, предустановленном на все смартфоны в России.

Вы пишете боту в MAX — он отвечает с помощью AI-модели (Claude, GPT, и других).

---

## Быстрый старт

### Шаг 1: Создайте бота в MAX

1. Откройте [dev.max.ru](https://dev.max.ru) в браузере
2. Войдите с аккаунтом MAX или VK
3. Перейдите в раздел "Боты"
4. Нажмите "Создать бота"
5. Задайте имя и описание
6. **Скопируйте токен бота** — он понадобится на следующем шаге

### Шаг 2: Настройте OpenClaw

Откройте файл конфигурации `~/.openclaw/openclaw.json` и добавьте секцию MAX:

```json5
{
  channels: {
    max: {
      enabled: true,
      botToken: "вставьте-ваш-токен-сюда",
    },
  },
}
```

Или используйте переменную окружения:

```bash
export MAX_BOT_TOKEN="ваш-токен"
```

### Шаг 3: Запустите шлюз

```bash
openclaw gateway
```

Вы увидите:

```
[default] starting MAX provider (@имя_вашего_бота)
```

### Шаг 4: Начните диалог

1. Откройте MAX на телефоне или компьютере
2. Найдите вашего бота по имени
3. Напишите любое сообщение
4. Бот ответит кодом сопряжения (если включён режим `pairing`)
5. Подтвердите код:
   ```bash
   openclaw pairing approve max <КОД>
   ```
6. Готово! Теперь бот будет отвечать на ваши сообщения через AI

---

## Режимы доступа

### Режим "Pairing" (по умолчанию)

Самый безопасный режим. Каждый новый пользователь должен получить одобрение:

1. Пользователь пишет боту -> получает код сопряжения
2. Вы одобряете код -> пользователь добавляется в разрешённый список
3. Дальше бот отвечает автоматически

```json5
{
  channels: {
    max: {
      dmPolicy: "pairing",
    },
  },
}
```

### Режим "Allowlist"

Только заранее указанные пользователи могут общаться с ботом:

```json5
{
  channels: {
    max: {
      dmPolicy: "allowlist",
      allowFrom: [123456789, 987654321], // ID пользователей MAX
    },
  },
}
```

Узнать свой MAX ID можно из логов бота при первом обращении.

### Режим "Open"

Любой пользователь MAX может писать боту:

```json5
{
  channels: {
    max: {
      dmPolicy: "open",
      allowFrom: ["*"], // обязательно указать
    },
  },
}
```

> **Внимание:** Используйте с осторожностью — бот будет отвечать всем.

---

## Работа в группах

### Добавление бота в группу

1. Откройте групповой чат в MAX
2. Добавьте бота как участника
3. Укажите группу в конфигурации:

```json5
{
  channels: {
    max: {
      groupPolicy: "allowlist",
      groupAllowFrom: [-100123456789], // ID группы (отрицательное число)
    },
  },
}
```

### Общение в группе

В групповых чатах бот реагирует **только при @упоминании**:

```
@имя_бота Расскажи про квантовые компьютеры
```

Это предотвращает спам — бот не будет отвечать на каждое сообщение в группе.

Для автоответа на все сообщения (не рекомендуется):

```json5
{
  channels: {
    max: {
      groupPolicy: "open",
    },
  },
}
```

---

## Форматирование сообщений

Бот поддерживает **Markdown** в ответах:

- **Жирный текст**: `**жирный**`
- _Курсив_: `*курсив*`
- `Код`: `` `код` ``
- Блоки кода с подсветкой синтаксиса
- Списки, заголовки, ссылки

По умолчанию используется Markdown. Для HTML:

```json5
{
  channels: {
    max: {
      format: "html",
    },
  },
}
```

---

## Стриминг ответов

Длинные ответы AI отправляются **по частям** — вы начинаете читать ещё до завершения генерации.

Настройки стриминга:

| Параметр         | По умолчанию | Описание                     |
| ---------------- | ------------ | ---------------------------- |
| `blockStreaming` | `true`       | Включить блочный стриминг    |
| `minChars`       | 1500         | Мин. символов в блоке        |
| `idleMs`         | 1000         | Отправить через N мс простоя |

Для более частых обновлений (быстрее, но больше сообщений):

```json5
{
  channels: {
    max: {
      blockStreamingCoalesce: {
        minChars: 500,
        idleMs: 500,
      },
    },
  },
}
```

Для отключения стриминга (бот отправит весь ответ одним сообщением):

```json5
{
  channels: {
    max: {
      blockStreaming: false,
    },
  },
}
```

---

## Нативные команды

MAX-бот автоматически поддерживает нативные команды, которые отображаются в меню бота. Команды настраиваются через OpenClaw и появляются при нажатии кнопки "/" в поле ввода MAX.

---

## Несколько ботов

Можно запустить несколько ботов MAX одновременно:

```json5
{
  channels: {
    max: {
      accounts: {
        поддержка: {
          botToken: "токен-бота-поддержки",
          dmPolicy: "open",
          allowFrom: ["*"],
        },
        внутренний: {
          botToken: "токен-внутреннего-бота",
          dmPolicy: "allowlist",
          allowFrom: [111111111],
        },
      },
    },
  },
}
```

Каждый бот работает независимо со своими настройками доступа.

---

## Управление сопряжениями

### Просмотр ожидающих запросов

```bash
openclaw pairing list max
```

Выводит список пользователей, ожидающих одобрения, с кодами и временем запроса.

### Одобрение

```bash
openclaw pairing approve max ABC123
```

Пользователь получит уведомление и сможет общаться с ботом.

### Отклонение

```bash
openclaw pairing reject max ABC123
```

### Важно

- Код сопряжения действителен **1 час**
- Максимум **3 ожидающих запроса** одновременно
- После одобрения ID пользователя сохраняется в `allowFrom`

---

## Проверка статуса

### Общий статус

```bash
openclaw status
```

### Статус MAX-канала

```bash
openclaw status max
```

Пример вывода:

```
MAX Channel Status:
  Account: default
  Bot: @my_bot (ID: 12345)
  Mode: polling
  Running: yes
  Token source: config
  Last inbound: 2 min ago
  Last outbound: 1 min ago
```

### Детальная диагностика

```bash
openclaw status --deep
```

---

## Webhook vs Long Polling

|                  | Long Polling  | Webhook             |
| ---------------- | ------------- | ------------------- |
| **Настройка**    | Автоматически | Нужен публичный URL |
| **Задержка**     | Минимальная   | Минимальная         |
| **Надёжность**   | Хорошая       | Отличная            |
| **Сервер**       | Не нужен      | Нужен HTTPS         |
| **NAT/Firewall** | Работает      | Нужен открытый порт |
| **Рекомендация** | Разработка    | Продакшн            |

### Переключение на Webhook

```json5
{
  channels: {
    max: {
      webhookUrl: "https://ваш-сервер.example.com/max/webhook",
      webhookSecret: "секретный-ключ",
    },
  },
}
```

---

## Использование прокси

Если MAX API недоступен напрямую (корпоративная сеть, VPN):

```json5
{
  channels: {
    max: {
      proxy: "http://proxy.company.com:8080",
    },
  },
}
```

---

## Хранение токена (безопасность)

### Для разработки

Токен в конфиге или переменной окружения:

```bash
export MAX_BOT_TOKEN="ваш-токен"
```

### Для продакшна

Токен в отдельном файле:

```json5
{
  channels: {
    max: {
      tokenFile: "/run/secrets/max-bot-token",
    },
  },
}
```

Файл должен содержать только токен (без пробелов и переносов строк).

---

## Отключение MAX-канала

Временное отключение (конфигурация сохраняется):

```json5
{
  channels: {
    max: {
      enabled: false,
    },
  },
}
```

Полное удаление:

```bash
openclaw logout max
```

---

## FAQ

### Где взять ID пользователя MAX?

ID отображается в логах бота при получении сообщения:

```
[max:default] received update from user 123456789
```

Или в запросе на сопряжение:

```bash
openclaw pairing list max
# Sender ID: 123456789
```

### Почему бот не отвечает?

1. Проверьте, запущен ли шлюз: `openclaw status`
2. Проверьте логи: `openclaw logs --follow`
3. Убедитесь, что пользователь одобрен (при `dmPolicy: "pairing"`)
4. В группе — упомяните бота через @

### Как сменить токен бота?

```json5
{
  channels: {
    max: {
      botToken: "новый-токен",
    },
  },
}
```

Канал перезапустится автоматически.

### Можно ли использовать бота без интернета?

Нет. Бот требует доступа к `platform-api.max.ru` для получения и отправки сообщений. Для сетей с ограниченным доступом используйте прокси.

### Как ограничить бота только определёнными пользователями?

```json5
{
  channels: {
    max: {
      dmPolicy: "allowlist",
      allowFrom: [111111111, 222222222, 333333333],
    },
  },
}
```

### Бот отвечает слишком медленно

1. Уменьшите параметры стриминга для более частых обновлений
2. Проверьте скорость AI-модели в настройках OpenClaw
3. Проверьте латентность до `platform-api.max.ru`:
   ```bash
   curl -o /dev/null -s -w '%{time_total}\n' https://platform-api.max.ru/me
   ```

### Нужна ли верификация юрлица?

- Для **создания** и **тестирования** бота — нет
- Для **публикации** бота (видимость в каталоге MAX) — да, требуется верифицированное российское юридическое лицо
