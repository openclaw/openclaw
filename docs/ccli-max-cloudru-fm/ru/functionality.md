# Функциональность расширения MAX Messenger

## Обзор возможностей

Расширение MAX Messenger превращает OpenClaw в AI-шлюз для мессенджера MAX — суперприложения от VK Group, предустановленного на все смартфоны, продаваемые в России с сентября 2025 года. Бот MAX принимает сообщения от пользователей, обрабатывает их через AI-модель и отправляет ответы обратно.

---

## 1. Типы чатов

| Тип                       | Поддержка | Описание                                       |
| ------------------------- | --------- | ---------------------------------------------- |
| **Личные сообщения (DM)** | Да        | Приватный диалог пользователя с ботом          |
| **Групповые чаты**        | Да        | Бот в групповом чате, реагирует на @упоминания |

---

## 2. Приём сообщений (inbound)

### Режимы приёма

| Режим                           | Описание                                          | Когда использовать               |
| ------------------------------- | ------------------------------------------------- | -------------------------------- |
| **Long Polling** (по умолчанию) | Бот периодически запрашивает обновления у MAX API | Разработка, внутренние сети, NAT |
| **Webhook**                     | MAX API доставляет обновления на указанный URL    | Продакшн, публичные серверы      |

### Обрабатываемые события

| Событие MAX        | Описание                              |
| ------------------ | ------------------------------------- |
| `message_created`  | Новое сообщение от пользователя       |
| `message_callback` | Нажатие на inline-кнопку              |
| `message_edited`   | Пользователь отредактировал сообщение |
| `message_removed`  | Пользователь удалил сообщение         |
| `bot_started`      | Пользователь начал диалог с ботом     |
| `bot_added`        | Бот добавлен в группу                 |
| `bot_removed`      | Бот удалён из группы                  |
| `user_added`       | Пользователь добавлен в группу        |
| `user_removed`     | Пользователь покинул группу           |

---

## 3. Отправка сообщений (outbound)

### Текстовые сообщения

- Отправка через `POST /messages?chat_id=<id>` на `platform-api.max.ru`
- Поддержка форматов: **Markdown** (по умолчанию) и **HTML**
- Максимальный размер сообщения: **4000 символов** (автоматическое разбиение на части)
- Разбиение текста с сохранением Markdown-структуры (chunkMarkdownText)
- Возможность ответа на конкретное сообщение (`replyToMessageId`)
- Управление preview ссылок (`disable_link_preview`)
- Тихая отправка без уведомления (`notify: false`)

### Медиа-сообщения

Двухшаговый процесс:

1. Загрузка файла через `POST /uploads?type=<тип>` (FormData)
2. Отправка сообщения с прикреплённым файлом через `POST /messages`

| Тип медиа | Описание          |
| --------- | ----------------- |
| `photo`   | Изображение       |
| `video`   | Видео             |
| `audio`   | Аудио             |
| `file`    | Произвольный файл |

### Inline-кнопки

Поддержка кнопок с callback-данными для интерактивного взаимодействия:

```json
{
  "attachments": [
    {
      "type": "inline_keyboard",
      "payload": {
        "buttons": [
          [
            { "type": "callback", "text": "Да", "payload": "yes" },
            { "type": "callback", "text": "Нет", "payload": "no" }
          ]
        ]
      }
    }
  ]
}
```

---

## 4. Блочный стриминг (Block Streaming)

Потоковые ответы AI-модели буферизируются и отправляются блоками:

| Параметр         | Значение по умолчанию | Описание                                  |
| ---------------- | --------------------- | ----------------------------------------- |
| `blockStreaming` | `true`                | Включён по умолчанию                      |
| `minChars`       | 1500                  | Минимальный размер блока (символов)       |
| `idleMs`         | 1000                  | Задержка перед отправкой при простое (мс) |

Как это работает:

1. AI-модель генерирует текст порциями
2. BlockReplyCoalescer накапливает текст в буфере
3. Когда буфер >= `minChars` ИЛИ прошло `idleMs` без новых данных — блок отправляется
4. Пользователь получает ответ по частям, а не целиком после полной генерации

Это значительно улучшает UX для длинных ответов — пользователь начинает читать ещё до завершения генерации.

---

## 5. Нативные команды

MAX автоматически получает нативные команды бота (аналог BotCommands в Telegram). Нативные команды отображаются в меню бота в интерфейсе MAX и автоматически включены для канала MAX.

---

## 6. Контроль доступа

### Политика личных сообщений (DM Policy)

| Политика                 | Поведение                                                                                                        |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------- |
| `pairing` (по умолчанию) | Незнакомые отправители получают код сопряжения. Владелец подтверждает через `openclaw pairing approve max <КОД>` |
| `allowlist`              | Только ID из `allowFrom` могут писать боту                                                                       |
| `open`                   | Любой пользователь может писать боту. Требует `allowFrom: ["*"]`                                                 |

### Политика групп (Group Policy)

| Политика                   | Поведение                                       |
| -------------------------- | ----------------------------------------------- |
| `allowlist` (по умолчанию) | Только группы из `groupAllowFrom` обслуживаются |
| `open`                     | Все группы, в которых состоит бот               |

### Упоминания в группах

В групповых чатах бот по умолчанию реагирует **только на @упоминания** (`requireMention: true`). Это предотвращает спам-реакции на каждое сообщение в группе.

### Механизм сопряжения (Pairing)

1. Пользователь пишет боту в MAX
2. Бот отвечает кодом сопряжения (действителен 1 час)
3. Владелец утверждает код: `openclaw pairing approve max <КОД>`
4. Пользователь добавляется в `allowFrom`
5. Последующие сообщения обрабатываются автоматически

---

## 7. Мультиаккаунт

Поддержка нескольких ботов MAX с одного шлюза:

```json5
{
  channels: {
    max: {
      dmPolicy: "pairing", // общие настройки
      accounts: {
        support: { botToken: "token-1", dmPolicy: "open", allowFrom: ["*"] },
        internal: { botToken: "token-2", allowFrom: [123456789] },
      },
    },
  },
}
```

- Каждый аккаунт наследует базовые настройки и может переопределить любой параметр
- Аккаунты запускаются параллельно как независимые polling/webhook-процессы
- `MAX_BOT_TOKEN` из env применяется только к аккаунту по умолчанию
- Аккаунты можно включать/выключать через `enabled: false`

---

## 8. Аутентификация и безопасность

### Источники токена (приоритет)

1. `tokenFile` — файл с токеном (рекомендуется для продакшна)
2. `botToken` — токен в конфиге (удобно для разработки)
3. `MAX_BOT_TOKEN` — переменная окружения (только для аккаунта по умолчанию)

### Верификация Webhook

MAX отправляет заголовок `X-Max-Bot-Api-Secret` с каждым webhook-запросом. OpenClaw проверяет совпадение с `webhookSecret` из конфигурации.

### Авторизация MAX Bot API

MAX использует **сырой токен** в заголовке `Authorization` (без префикса "Bot" или "Bearer"):

```
Authorization: <token>
```

---

## 9. Retry и обработка ошибок

### Retry при отправке

| Параметр              | Значение                             |
| --------------------- | ------------------------------------ |
| Попытки               | 3                                    |
| Мин. задержка         | 500 мс                               |
| Макс. задержка        | 30 000 мс                            |
| Повторяемые ошибки    | HTTP 429, timeout, connection errors |
| Поддержка retry_after | Да (из тела ответа 429)              |

Retry включается через опцию `retry` в параметрах отправки — по умолчанию выключен.

### Retry при polling

При сбое long polling используется экспоненциальный backoff:

| Параметр              | Значение  |
| --------------------- | --------- |
| Начальная задержка    | 2000 мс   |
| Максимальная задержка | 30 000 мс |
| Фактор роста          | 1.8x      |
| Jitter                | 25%       |

### Retry при проверке бота (probe)

Функция `probeMax` делает до 3 попыток вызова `GET /me` с задержкой 1 секунда между попытками.

---

## 10. Проверка состояния (Status)

Расширение предоставляет детальный статус каждого аккаунта:

| Поле             | Описание                                      |
| ---------------- | --------------------------------------------- |
| `accountId`      | Идентификатор аккаунта                        |
| `enabled`        | Включён ли аккаунт                            |
| `configured`     | Есть ли токен                                 |
| `tokenSource`    | Откуда взят токен (env/config/tokenFile/none) |
| `running`        | Работает ли polling/webhook                   |
| `mode`           | Режим: "polling" или "webhook"                |
| `lastStartAt`    | Время последнего запуска                      |
| `lastStopAt`     | Время последней остановки                     |
| `lastError`      | Последняя ошибка                              |
| `lastInboundAt`  | Время последнего входящего сообщения          |
| `lastOutboundAt` | Время последнего исходящего сообщения         |
| `probe`          | Результат `GET /me` (имя бота, username, ID)  |

---

## 11. Мастер настройки (Onboarding)

Интерактивный мастер проведёт пользователя через первоначальную настройку:

1. Проверяет наличие `MAX_BOT_TOKEN` в окружении
2. Если найден — предлагает использовать его
3. Если нет — запрашивает ввод токена
4. Записывает конфигурацию в `~/.openclaw/openclaw.json`
5. Устанавливает политику DM

Инструкция, показываемая пользователю:

```
1) Перейдите в MAX -> Настройки -> Платформа ботов (или dev.max.ru)
2) Создайте бота и скопируйте его токен
3) Укажите токен ниже или установите переменную MAX_BOT_TOKEN
```

---

## 12. Конфигурация через Reload

Изменение конфигурации с префиксом `channels.max` автоматически перезапускает канал MAX без перезагрузки всего шлюза. Это позволяет менять настройки (токен, политики, webhook URL) на лету.

---

## 13. Прокси-поддержка

Все HTTP-запросы к MAX API поддерживают прокси через параметр `proxy`:

```json5
{
  channels: {
    max: {
      proxy: "http://proxy.corp.example.com:8080",
    },
  },
}
```

Прокси применяется к:

- Проверке бота (`probeMax`)
- Отправке сообщений (`sendMessageMax`, `sendMediaMax`)
- Webhook-подписке (`monitorMaxProvider`)
- Long polling (через `@maxhub/max-bot-api`)

---

## Сравнение с другими каналами OpenClaw

| Функция             | MAX | Telegram | Discord | Signal |
| ------------------- | --- | -------- | ------- | ------ |
| DM                  | Да  | Да       | Да      | Да     |
| Группы              | Да  | Да       | Да      | Да     |
| Медиа               | Да  | Да       | Да      | Да     |
| Нативные команды    | Да  | Да       | Да      | Нет    |
| Block Streaming     | Да  | Да       | Да      | Да     |
| Inline-кнопки       | Да  | Да       | Да      | Нет    |
| Webhook             | Да  | Да       | Нет     | Нет    |
| Long Polling        | Да  | Да       | Нет     | Нет    |
| Мультиаккаунт       | Да  | Да       | Да      | Да     |
| Markdown            | Да  | Да       | Да      | Да     |
| Retry/Rate Limit    | Да  | Да       | Да      | Нет    |
| Draft Streaming     | Нет | Да       | Нет     | Нет    |
| Голосовые сообщения | Нет | Да       | Нет     | Нет    |
