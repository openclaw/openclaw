# A2A Protocol v0.3.0 — Method and Field Renames

**Дата:** 2026-02-19
**Компонент:** `src/ai-fabric/cloudru-a2a-client.ts`

## Симптомы

- JSON-RPC вызов `/ask-agent` возвращал ошибку "method not found"
- Агент Cloud.ru AI Fabric отклонял запросы с методом `tasks/send`
- Ответы не содержали `sessionId`, многоходовые разговоры не работали

## Суть проблемы

A2A спецификация v0.3.0 переименовала ключевые элементы протокола:

- Метод: `tasks/send` → `message/send`
- Поле типа части: `type: "text"` → `kind: "text"`
- Идентификатор сессии: `sessionId` → `contextId`
- Добавлен обязательный `kind: "message"` на конверте сообщения
- `id` задачи заменён на `messageId` внутри объекта сообщения

Клиент был написан по старому черновику спецификации.

## Решение

Обновили `CloudruA2AClient.sendMessage()`:

1. Метод `tasks/send` → `message/send`
2. Тело запроса: убрали top-level `id`, добавили `messageId` внутри message
3. Parts: `{ type: "text" }` → `{ kind: "text" }`
4. Конверт: добавили `kind: "message"`
5. Параметры: `sessionId` → `contextId`
6. Парсинг ответа: `result.sessionId` → `result.contextId ?? result.sessionId` (обратная совместимость)
7. Типы в `types.ts`: добавлены `kind`, `contextId`, `artifactId`

## Ключевые файлы

- `src/ai-fabric/cloudru-a2a-client.ts` — основные изменения протокола
- `src/ai-fabric/types.ts` — обновлённые типы `A2AMessagePart`, `A2ATaskResponse`
- `src/ai-fabric/agent-status.ts` — адаптация к новому формату ответа
