---
summary: "การตรวจสอบคอนฟิกแบบเข้มงวด + การย้ายข้อมูลผ่าน doctor เท่านั้น"
read_when:
  - ออกแบบหรือพฤติกรรมการตรวจสอบคอนฟิก
  - ทำงานเกี่ยวกับการย้ายคอนฟิกหรือเวิร์กโฟลว์ของ doctor
  - จัดการสคีมาคอนฟิกของปลั๊กอินหรือการควบคุมการโหลดปลั๊กอิน
title: "การตรวจสอบคอนฟิกแบบเข้มงวด"
---

# การตรวจสอบคอนฟิกแบบเข้มงวด(การย้ายข้อมูลผ่าน doctor เท่านั้น)

## เป้าหมาย

- **ปฏิเสธคีย์คอนฟิกที่ไม่รู้จักทั้งหมด** (ระดับรากและซ้อน).
- **ปฏิเสธคอนฟิกของปลั๊กอินที่ไม่มีสคีมา**; ไม่โหลดปลั๊กอินนั้น.
- **ยกเลิกการย้ายข้อมูลอัตโนมัติแบบเดิมขณะโหลด**; การย้ายข้อมูลต้องรันผ่าน doctor เท่านั้น.
- **รัน doctor อัตโนมัติ(dry-run)เมื่อเริ่มต้น**; หากไม่ถูกต้องให้บล็อกคำสั่งที่ไม่ใช่เชิงวินิจฉัย.

## สิ่งที่ไม่อยู่ในขอบเขต

- ความเข้ากันได้ย้อนหลังขณะโหลด (คีย์เดิมจะไม่ถูกย้ายอัตโนมัติ).
- การทิ้งคีย์ที่ไม่รู้จักแบบเงียบๆ.

## กฎการตรวจสอบแบบเข้มงวด

- คอนฟิกต้องตรงกับสคีมาอย่างสมบูรณ์ในทุกระดับ.
- คีย์ที่ไม่รู้จักถือเป็นข้อผิดพลาดในการตรวจสอบ (ไม่มีการ passthrough ทั้งระดับรากหรือซ้อน).
- `plugins.entries.<id>.config` ต้องถูกตรวจสอบโดยสคีมาของปลั๊กอิน.
  - หากปลั๊กอินไม่มีสคีมา **ให้ปฏิเสธการโหลดปลั๊กอิน** และแสดงข้อผิดพลาดที่ชัดเจน.
- คีย์ `channels.<id>` ที่ไม่รู้จักถือเป็นข้อผิดพลาด เว้นแต่ manifest ของปลั๊กอินจะประกาศ channel id.
- จำเป็นต้องมี plugin manifest (`openclaw.plugin.json`) สำหรับปลั๊กอินทุกตัว.

## การบังคับใช้สคีมาของปลั๊กอิน

- ปลั๊กอินแต่ละตัวต้องมี JSON Schema แบบเข้มงวดสำหรับคอนฟิกของตน(ฝังอยู่ใน manifest).
- ลำดับการโหลดปลั๊กอิน:
  1. แก้ไข plugin manifest + สคีมา (`openclaw.plugin.json`).
  2. ตรวจสอบการตั้งค่ากับสคีมา
  3. หากขาดสคีมาหรือคอนฟิกไม่ถูกต้อง: บล็อกการโหลดปลั๊กอินและบันทึกข้อผิดพลาด.
- ข้อความข้อผิดพลาดประกอบด้วย:
  - plugin id
  - เหตุผล (ขาดสคีมา / คอนฟิกไม่ถูกต้อง)
  - เส้นทาง(path)ที่ตรวจสอบไม่ผ่าน
- ปลั๊กอินที่ปิดใช้งานจะยังคงเก็บคอนฟิกไว้ แต่ Doctor และบันทึกจะแสดงคำเตือน.

## โฟลว์ของ Doctor

- Doctor จะรัน **ทุกครั้ง** ที่มีการโหลดคอนฟิก(dry-run เป็นค่าเริ่มต้น).
- หากคอนฟิกไม่ถูกต้อง:
  - พิมพ์สรุป + ข้อผิดพลาดที่นำไปแก้ไขได้
  - แนะนำ: `openclaw doctor --fix`.
- `openclaw doctor --fix`:
  - ใช้การย้ายข้อมูล.
  - ลบคีย์ที่ไม่รู้จัก.
  - เขียนคอนฟิกที่อัปเดตแล้ว.

## การควบคุมคำสั่ง(เมื่อคอนฟิกไม่ถูกต้อง)

อนุญาต(เฉพาะการวินิจฉัย):

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

อย่างอื่นทั้งหมดต้องล้มเหลวทันทีพร้อมข้อความ: “Config invalid. Run `openclaw doctor --fix`.”

## รูปแบบ UX ของข้อผิดพลาด

- ส่วนหัวสรุปเพียงหนึ่งรายการ.
- ส่วนที่จัดกลุ่ม:
  - คีย์ที่ไม่รู้จัก(เส้นทางเต็ม)
  - คีย์เดิม / ต้องมีการย้ายข้อมูล
  - ความล้มเหลวในการโหลดปลั๊กอิน(plugin id + เหตุผล + path)

## จุดที่ต้องแตะในการทำงาน

- `src/config/zod-schema.ts`: ลบ root passthrough; ใช้วัตถุแบบเข้มงวดทุกที่.
- `src/config/zod-schema.providers.ts`: ตรวจให้แน่ใจว่าสคีมาของช่องทางเป็นแบบเข้มงวด.
- `src/config/validation.ts`: ล้มเหลวเมื่อพบคีย์ที่ไม่รู้จัก; อย่าใช้การย้ายข้อมูลแบบเดิม.
- `src/config/io.ts`: ลบการย้ายข้อมูลอัตโนมัติแบบเดิม; รัน doctor แบบ dry-run เสมอ.
- `src/config/legacy*.ts`: ย้ายการใช้งานไปไว้ที่ doctor เท่านั้น.
- `src/plugins/*`: เพิ่ม registry ของสคีมาและการควบคุมการโหลด.
- การควบคุมคำสั่ง CLI ใน `src/cli`.

## การทดสอบ

- การปฏิเสธคีย์ที่ไม่รู้จัก(ระดับรากและซ้อน).
- ปลั๊กอินขาดสคีมา → บล็อกการโหลดปลั๊กอินพร้อมข้อผิดพลาดที่ชัดเจน.
- คอนฟิกไม่ถูกต้อง → การเริ่มต้น Gateway ถูกบล็อก ยกเว้นคำสั่งวินิจฉัย.
- Doctor แบบ dry-run อัตโนมัติ; `doctor --fix` เขียนคอนฟิกที่แก้ไขแล้ว.
