---
summary: "อ้างอิง: กฎการทำความสะอาดและซ่อมแซมทรานสคริปต์เฉพาะผู้ให้บริการ"
read_when:
  - คุณกำลังแก้ไขปัญหาการปฏิเสธคำขอของผู้ให้บริการที่ผูกกับรูปทรงของทรานสคริปต์
  - คุณกำลังเปลี่ยนตรรกะการทำความสะอาดทรานสคริปต์หรือการซ่อมแซมการเรียกเครื่องมือ
  - คุณกำลังตรวจสอบความไม่ตรงกันของ id การเรียกเครื่องมือข้ามผู้ให้บริการ
title: "สุขอนามัยของทรานสคริปต์"
---

# 36. สุขอนามัยของทรานสคริปต์ (การแก้ไขฝั่งผู้ให้บริการ)

37. เอกสารนี้อธิบาย **การแก้ไขเฉพาะผู้ให้บริการ** ที่นำไปใช้กับทรานสคริปต์ก่อนการรัน
    (การสร้างบริบทของโมเดล) 38. สิ่งเหล่านี้คือการปรับแก้แบบ **ในหน่วยความจำ** ที่ใช้เพื่อให้เป็นไปตาม
    ข้อกำหนดที่เข้มงวดของผู้ให้บริการ เอกสารนี้อธิบาย**การแก้ไขเฉพาะผู้ให้บริการ**ที่ถูกนำไปใช้กับทรานสคริปต์ก่อนการรัน
    (การสร้างบริบทของโมเดล) การปรับเหล่านี้เป็นการปรับแบบ**ในหน่วยความจำ**ที่ใช้เพื่อให้เป็นไปตามข้อกำหนดที่เข้มงวดของผู้ให้บริการ ขั้นตอนสุขอนามัยเหล่านี้**จะไม่**เขียนทับทรานสคริปต์ JSONL ที่เก็บบนดิสก์ อย่างไรก็ตาม จะมีขั้นตอนซ่อมแซมไฟล์เซสชันแยกต่างหากซึ่งอาจเขียนทับไฟล์ JSONL ที่ผิดรูปแบบโดยการทิ้งบรรทัดที่ไม่ถูกต้องก่อนโหลดเซสชัน เมื่อมีการซ่อมแซม ไฟล์ต้นฉบับจะถูกสำรองไว้ควบคู่กับไฟล์เซสชัน 39. เมื่อมีการซ่อมแซม ไฟล์ต้นฉบับจะถูกสำรองไว้
    ข้าง ๆ ไฟล์เซสชัน

ขอบเขตรวมถึง:

- การทำความสะอาด id การเรียกเครื่องมือ
- การตรวจสอบความถูกต้องของอินพุตการเรียกเครื่องมือ
- การซ่อมแซมการจับคู่ผลลัพธ์ของเครื่องมือ
- การตรวจสอบ/การจัดลำดับเทิร์น
- การทำความสะอาดลายเซ็นความคิด
- การทำความสะอาดเพย์โหลดรูปภาพ

หากต้องการรายละเอียดการจัดเก็บทรานสคริปต์ ดูที่:

- [/reference/session-management-compaction](/reference/session-management-compaction)

---

## 40. ที่ที่สิ่งนี้รัน

สุขอนามัยของทรานสคริปต์ทั้งหมดถูกรวมศูนย์อยู่ใน embedded runner:

- การเลือกนโยบาย: `src/agents/transcript-policy.ts`
- การนำการทำความสะอาด/การซ่อมแซมไปใช้: `sanitizeSessionHistory` ใน `src/agents/pi-embedded-runner/google.ts`

นโยบายใช้ `provider`, `modelApi` และ `modelId` เพื่อตัดสินใจว่าจะนำอะไรไปใช้

แยกจากสุขอนามัยของทรานสคริปต์ ไฟล์เซสชันจะถูกซ่อมแซม(หากจำเป็น)ก่อนโหลด:

- `repairSessionFileIfNeeded` ใน `src/agents/session-file-repair.ts`
- ถูกเรียกจาก `run/attempt.ts` และ `compact.ts` (embedded runner)

---

## กฎสากล: การทำความสะอาดรูปภาพ

เพย์โหลดรูปภาพจะถูกทำความสะอาดเสมอเพื่อป้องกันการปฏิเสธจากฝั่งผู้ให้บริการเนื่องจากขีดจำกัดขนาด
(ย่อขนาด/บีบอัดรูป base64 ที่มีขนาดเกิน)

การนำไปใช้:

- `sanitizeSessionMessagesImages` ใน `src/agents/pi-embedded-helpers/images.ts`
- `sanitizeContentBlocksImages` ใน `src/agents/tool-images.ts`

---

## กฎสากล: การเรียกเครื่องมือที่ผิดรูปแบบ

บล็อกการเรียกเครื่องมือของผู้ช่วยที่ขาดทั้ง `input` และ `arguments` จะถูกทิ้ง
ก่อนสร้างบริบทของโมเดล สิ่งนี้ช่วยป้องกันการปฏิเสธจากผู้ให้บริการที่เกิดจากการเรียกเครื่องมือที่ถูกบันทึกไว้ไม่สมบูรณ์
(เช่น หลังจากความล้มเหลวจากการจำกัดอัตรา) 41. สิ่งนี้ช่วยป้องกันการถูกปฏิเสธจากผู้ให้บริการเนื่องจากการเรียกเครื่องมือที่ถูกบันทึกไว้เพียงบางส่วน
(เช่น หลังจากล้มเหลวเพราะจำกัดอัตรา)

การนำไปใช้:

- `sanitizeToolCallInputs` ใน `src/agents/session-transcript-repair.ts`
- นำไปใช้ใน `sanitizeSessionHistory` ใน `src/agents/pi-embedded-runner/google.ts`

---

## เมทริกซ์ผู้ให้บริการ(พฤติกรรมปัจจุบัน)

**OpenAI / OpenAI Codex**

- ทำความสะอาดรูปภาพเท่านั้น
- เมื่อสลับโมเดลไปยัง OpenAI Responses/Codex ให้ทิ้งลายเซ็นเหตุผลที่กำพร้า(รายการเหตุผลเดี่ยวๆที่ไม่มีบล็อกเนื้อหาตามมา)
- ไม่มีการทำความสะอาด id การเรียกเครื่องมือ
- ไม่มีการซ่อมแซมการจับคู่ผลลัพธ์ของเครื่องมือ
- ไม่มีการตรวจสอบหรือจัดลำดับเทิร์น
- ไม่มีผลลัพธ์เครื่องมือสังเคราะห์
- ไม่มีการตัดลายเซ็นความคิด

**Google (Generative AI / Gemini CLI / Antigravity)**

- การทำความสะอาด id การเรียกเครื่องมือ: อักขระตัวอักษรและตัวเลขอย่างเคร่งครัด
- การซ่อมแซมการจับคู่ผลลัพธ์ของเครื่องมือและผลลัพธ์เครื่องมือสังเคราะห์
- การตรวจสอบเทิร์น(การสลับเทิร์นแบบสไตล์ Gemini)
- การแก้ไขลำดับเทิร์นของ Google(เติม user bootstrap ขนาดเล็กไว้ด้านหน้า หากประวัติเริ่มด้วยผู้ช่วย)
- Antigravity Claude: ทำให้ลายเซ็นการคิดเป็นมาตรฐาน; ทิ้งบล็อกการคิดที่ไม่มีลายเซ็น

**Anthropic / Minimax (เข้ากันได้กับ Anthropic)**

- การซ่อมแซมการจับคู่ผลลัพธ์ของเครื่องมือและผลลัพธ์เครื่องมือสังเคราะห์
- การตรวจสอบเทิร์น(รวมเทิร์นผู้ใช้ที่ต่อเนื่องกันเพื่อให้เป็นไปตามการสลับที่เข้มงวด)

**Mistral (รวมถึงการตรวจจับตาม model-id)**

- การทำความสะอาด id การเรียกเครื่องมือ: strict9 (อักขระตัวอักษรและตัวเลข ความยาว 9)

**OpenRouter Gemini**

- การทำความสะอาดลายเซ็นความคิด: ตัดค่าที่ไม่ใช่ base64 ของ `thought_signature`(คงไว้เฉพาะ base64)

**อื่นๆทั้งหมด**

- ทำความสะอาดรูปภาพเท่านั้น

---

## พฤติกรรมในอดีต(ก่อน 2026.1.22)

ก่อนรีลีส 2026.1.22 OpenClaw ใช้หลายชั้นของสุขอนามัยทรานสคริปต์:

- มี**ส่วนขยาย transcript-sanitize**ทำงานทุกครั้งที่สร้างบริบทและสามารถ:
  - ซ่อมแซมการจับคู่การใช้เครื่องมือ/ผลลัพธ์
  - ทำความสะอาด id การเรียกเครื่องมือ(รวมถึงโหมดไม่เคร่งครัดที่คง `_`/`-`)
- runner ยังทำการทำความสะอาดเฉพาะผู้ให้บริการ ซึ่งซ้ำซ้อนกับงานเดิม
- มีการกลายพันธุ์เพิ่มเติมเกิดขึ้นนอกนโยบายผู้ให้บริการ รวมถึง:
  - ตัดแท็ก `<final>` ออกจากข้อความผู้ช่วยก่อนการบันทึกถาวร
  - ทิ้งเทิร์นข้อผิดพลาดของผู้ช่วยที่ว่างเปล่า
  - ตัดเนื้อหาผู้ช่วยหลังการเรียกเครื่องมือ

42. ความซับซ้อนนี้ก่อให้เกิดการถดถอยข้ามผู้ให้บริการ (โดยเฉพาะ `openai-responses`
    การจับคู่ `call_id|fc_id`) ความซับซ้อนนี้ทำให้เกิดรีเกรสชันข้ามผู้ให้บริการ(โดยเฉพาะการจับคู่ `openai-responses`
    `call_id|fc_id`) การทำความสะอาดใน 2026.1.22 ได้ลบส่วนขยายออก รวมศูนย์ตรรกะไว้ใน runner และทำให้ OpenAI เป็นแบบ**ไม่แตะต้อง**ยกเว้นการทำความสะอาดรูปภาพ
