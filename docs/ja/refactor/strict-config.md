---
summary: "厳格な設定バリデーション + doctor 専用マイグレーション"
read_when:
  - 設定バリデーションの挙動を設計または実装する場合
  - 設定マイグレーションや doctor ワークフローに取り組む場合
  - プラグイン設定スキーマやプラグイン読み込みのゲーティングを扱う場合
title: "厳格な設定バリデーション"
---

# 厳格な設定バリデーション（doctor 専用マイグレーション）

## 目標

- **未知の設定キーをあらゆる場所で拒否**（ルート + ネスト）。
- **スキーマのないプラグイン設定を拒否**；そのプラグインは読み込まない。
- **読み込み時のレガシー自動マイグレーションを削除**；マイグレーションは doctor のみで実行。
- **起動時に doctor（ドライラン）を自動実行**；無効な場合は診断以外のコマンドをブロック。

## 非目標

- 読み込み時の後方互換性（レガシーキーは自動マイグレーションしない）。
- 未認識キーのサイレントな破棄。

## 厳格なバリデーション規則

- 設定はすべてのレベルでスキーマと**完全一致**している必要があります。
- 未知のキーはバリデーションエラーです（ルートやネストでのパススルーは不可）。
- `plugins.entries.<id>.config` はプラグインのスキーマで検証されなければなりません。
  - プラグインにスキーマがない場合、**プラグインの読み込みを拒否**し、明確なエラーを表示します。
- 未知の `channels.<id>` キーは、プラグインマニフェストがチャンネル ID を宣言していない限りエラーです。
- プラグインマニフェスト（`openclaw.plugin.json`）はすべてのプラグインで必須です。

## プラグインスキーマの強制

- 各プラグインは、その設定用の厳格な JSON Schema を提供します（マニフェスト内にインラインで定義）。
- プラグイン読み込みフロー:
  1. プラグインマニフェスト + スキーマを解決（`openclaw.plugin.json`）。
  2. 設定をスキーマに対して検証。
  3. スキーマ欠如または無効な設定の場合：プラグインの読み込みをブロックし、エラーを記録。
- エラーメッセージに含める内容:
  - プラグイン ID
  - 理由（スキーマ欠如 / 無効な設定）
  - バリデーションに失敗したパス
- 無効化されたプラグインは設定を保持しますが、Doctor とログで警告を表示します。

## Doctor フロー

- Doctor は設定が読み込まれる**たびに**実行されます（デフォルトはドライラン）。
- 設定が無効な場合:
  - サマリーと実行可能なエラーを表示します。
  - 指示：`openclaw doctor --fix`。
- `openclaw doctor --fix`:
  - 移行を適用します。
  - 未知のキーを削除。
  - 更新された設定を書き込み。

## コマンドのゲーティング（設定が無効な場合）

許可（診断専用）:

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

それ以外はすべて失敗しなければなりません。「設定が無効です。 `openclaw doctor --fix` を実行します。

## エラー UX 形式

- 単一のサマリーヘッダー。
- グループ化されたセクション:
  - 未知のキー（完全パス）
  - レガシーキー / 必要なマイグレーション
  - プラグイン読み込み失敗（プラグイン ID + 理由 + パス）

## 実装のタッチポイント

- `src/config/zod-schema.ts`: ルートのパススルーを削除；すべてを厳格なオブジェクトに。
- `src/config/zod-schema.providers.ts`: 厳格なチャンネルスキーマを保証。
- `src/config/validation.ts`: 未知のキーで失敗；レガシー マイグレーションは適用しない。
- `src/config/io.ts`: レガシー自動マイグレーションを削除；常に doctor のドライランを実行。
- `src/config/legacy*.ts`: 利用箇所を doctor のみに移行。
- `src/plugins/*`: スキーマ レジストリ + ゲーティングを追加。
- `src/cli` で CLI コマンドのゲーティング。

## テスト

- 未知キーの拒否（ルート + ネスト）。
- プラグインにスキーマがない → 明確なエラーでプラグイン読み込みがブロックされる。
- 無効な設定 → 診断コマンド以外はゲートウェイの起動がブロックされる。
- Doctor のドライランは自動；`doctor --fix` が修正済みの設定を書き込む。
