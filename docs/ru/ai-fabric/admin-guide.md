# Cloud.ru AI Fabric — Руководство администратора

> **Платформа:** Cloud.ru Evolution AI Factory
> **Версия документа:** 1.0
> **Дата:** Февраль 2026

---

## Управление API-ключами

### Создание ключей

Каждый сервис AI Factory требует отдельного API-ключа:

| Сервис            | Scope ключа       | Эндпоинт                                     |
| ----------------- | ----------------- | -------------------------------------------- |
| Foundation Models | Foundation Models | `https://foundation-models.api.cloud.ru/v1/` |
| AI Agents         | AI Agents         | `https://ai-agents.api.cloud.ru/api/v1/`     |
| Managed RAG       | Managed RAG       | Через MCP-сервер или REST API                |

**Процедура:**

1. **Evolution → [Сервис] → Учётные данные доступа → Создать API-ключ**
2. Задать имя и описание
3. Выбрать scope (сервис)
4. Сохранить Key Secret (однократно!)

### Ротация ключей

1. Создать новый ключ
2. Обновить конфигурацию приложения
3. Убедиться в работоспособности с новым ключом
4. Удалить старый ключ

### Аутентификация агентов

Два механизма доступа к AI-агентам:

| Метод          | Описание               | Формат                                               |
| -------------- | ---------------------- | ---------------------------------------------------- |
| **Access Key** | Ключ доступа через IAM | `Authorization: Bearer <token>` (через IAM API)      |
| **API Key**    | Прямой API-ключ        | `X-API-Key: <key>` или `Authorization: Bearer <key>` |

---

## Управление Foundation Models

### Мониторинг использования

- Количество запросов в секунду (текущий RPS)
- Потребление токенов (input / output)
- Ошибки и latency

### Rate Limiting

- **Лимит:** 15 запросов/секунду на API-ключ
- Для высоконагруженных приложений — создать несколько API-ключей
- Обязательно реализовать exponential backoff:

```python
import time
from openai import OpenAI, RateLimitError

client = OpenAI(
    base_url="https://foundation-models.api.cloud.ru/v1/",
    api_key="ваш-api-key"
)

def request_with_retry(messages, max_retries=3):
    for attempt in range(max_retries):
        try:
            return client.chat.completions.create(
                model="zai-org/GLM-4.7-Flash",
                messages=messages,
                max_tokens=500
            )
        except RateLimitError:
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)
            else:
                raise
```

### Выбор моделей

| Сценарий              | Модель           | Обоснование                     |
| --------------------- | ---------------- | ------------------------------- |
| Продакшен (русский)   | GigaChat-2-Max   | Лучшее понимание русского языка |
| Генерация кода        | Qwen3-Coder-480B | Специализация на коде           |
| Бесплатная разработка | GLM-4.7-Flash    | Бесплатный тир                  |
| Длинные документы     | GLM-4.7 (200K)   | Максимальный контекст           |
| Reasoning-задачи      | DeepSeek-R1      | Reasoning-first архитектура     |

---

## Управление AI-агентами

### Жизненный цикл агента

```
Создание → Настройка → Тестирование → Деплой → Мониторинг → Обновление
```

### Масштабирование

**Serverless-режим (Min Instances = 0):**

- Инстансы создаются по запросу
- Оплата за фактическое использование
- Cold start 10–30 секунд
- Подходит для непиковых нагрузок и разработки

**Постоянный режим (Min Instances >= 1):**

- Всегда готовые инстансы
- Нулевой cold start
- Постоянная оплата
- Для продакшен-сервисов с SLA

### Логирование

Включение логирования при создании агента:

- Входящие запросы и ответы
- Вызовы инструментов и MCP-запросы
- Метрики производительности (latency, tokens)
- Хранение в Cloud.ru Logging

### Подключение MCP-серверов

```json
{
  "mcpServers": [
    {
      "id": "managed-rag-server-id",
      "name": "Корпоративная база знаний"
    },
    {
      "id": "custom-api-server-id",
      "name": "Внутренний API компании"
    }
  ]
}
```

---

## Управление Managed RAG

### Создание базы знаний

1. Создать коллекцию в Managed RAG
2. Загрузить документы (PDF, DOCX, TXT, Markdown, HTML)
3. Дождаться индексации (автоматическая векторизация)
4. Подключить MCP-сервер к агентам

### Обновление базы знаний

- Добавление новых документов — автоматическая переиндексация
- Удаление устаревших документов
- Мониторинг размера коллекции и качества поиска

---

## Сетевая инфраструктура

### Рекомендуемая топология

```
Evolution VM (OpenClaw)
        │
        │ Private Network
        ▼
    Magic Router
        │
   ┌────┼────┬──────────┐
   ▼    ▼    ▼          ▼
  FM  Agents  RAG    ML Inf.
```

### Настройка

1. **Magic Router** — связность ресурсов в частной сети
2. **Load Balancer v2** — балансировка между зонами доступности
3. **Firewall** — ограничить доступ к API по IP адресам VM
4. **Private Network** — все вызовы AI-сервисов через внутреннюю сеть

### Оптимизация задержек

- VM и AI-сервисы в одной зоне доступности
- Вызовы API через частную сеть (не через интернет)
- Выделенные сетевые интерфейсы при высокой нагрузке

---

## Безопасность

### API-ключи

- Хранить в переменных окружения или secrets manager
- Никогда не коммитить в git
- Ротировать периодически
- Ограничивать scope до необходимых сервисов

### Сетевая безопасность

- Использовать частные сети для внутренних вызовов
- Настроить firewall-правила на VM
- Ограничить доступ к API по IP
- Включить Cloud.ru сервисы защиты данных

### Защита данных

- Все данные хранятся на территории РФ
- Соответствие ФЗ-152 и ФСТЭК
- Шифрование Object Storage
- Application-level шифрование для критичных данных

---

## Стоимость и оптимизация

### Бесплатные ресурсы

| Ресурс          | Лимит                                       |
| --------------- | ------------------------------------------- |
| GLM-4.7-Flash   | Бесплатный тир (без ограничения по времени) |
| Object Storage  | 15 ГБ бесплатно                             |
| Стартовый грант | Доступен для новых пользователей            |

### Оптимизация затрат

- Использовать serverless-режим (Min Instances = 0) для непиковых нагрузок
- Выбирать модели по соотношению качество/цена (GLM-4.7-Flash для разработки)
- Shared GPU ресурсы ML Inference вместо dedicated
- Managed RAG вместо отдельной векторной БД

---

## Мониторинг

### Ключевые метрики

| Метрика      | Описание                       | Порог алерта    |
| ------------ | ------------------------------ | --------------- |
| API Latency  | Время ответа Foundation Models | > 5 сек         |
| Error Rate   | Процент ошибочных запросов     | > 5%            |
| RPS Usage    | Текущий RPS vs лимит           | > 80% от лимита |
| Token Usage  | Потребление токенов            | По бюджету      |
| Agent Health | Статус здоровья агентов        | Любой unhealthy |

### Алертинг

- Настроить уведомления через Cloud.ru Logging
- Мониторить rate limit приближение
- Отслеживать cold start частоту (для serverless)

---

## Ссылки

- [Cloud.ru Documentation Portal](https://cloud.ru/docs)
- [Foundation Models API Reference](https://cloud.ru/docs/foundation-models/ug/topics/api-ref)
- [AI Agents — Создание агента](https://cloud.ru/docs/ai-agents/ug/topics/guides__create-agent)
- [Managed RAG](https://cloud.ru/docs/rag/ug/index)
- [Evolution AI Factory](https://cloud.ru/products/evolution-ai-factory)
