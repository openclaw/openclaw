---
summary: "Справка: правила очистки и восстановления транскриптов для конкретных провайдеров"
read_when:
  - Вы отлаживаете отклонения запросов провайдерами, связанные с формой транскрипта
  - Вы изменяете логику очистки транскрипта или восстановления вызовов инструментов
  - Вы исследуете несоответствия идентификаторов вызовов инструментов между провайдерами
title: "Гигиена транскрипта"
---

# Гигиена транскрипта (исправления для провайдеров)

Этот документ описывает **исправления, специфичные для провайдеров**, которые применяются к транскриптам перед запуском
(построением контекста модели). Это **in-memory**-корректировки, используемые для соблюдения строгих
требований провайдеров. Эти шаги гигиены **не** переписывают сохранённый на диске JSONL‑транскрипт; однако
отдельный проход восстановления файлов сеанса может переписать повреждённые JSONL‑файлы,
удаляя недопустимые строки до загрузки сеанса. При выполнении восстановления исходный файл
сохраняется в резервной копии рядом с файлом сеанса.

Область охвата включает:

- очистку идентификаторов вызовов инструментов
- валидацию входных данных вызовов инструментов
- восстановление сопоставления результатов инструментов
- валидацию ходов / упорядочивание
- очистку сигнатур мыслей
- очистку полезной нагрузки изображений

Если вам нужны детали хранения транскриптов, см.:

- [/reference/session-management-compaction](/reference/session-management-compaction)

---

## Где это выполняется

Вся гигиена транскрипта централизована во встроенном раннере:

- Выбор политики: `src/agents/transcript-policy.ts`
- Применение очистки/восстановления: `sanitizeSessionHistory` в `src/agents/pi-embedded-runner/google.ts`

Политика использует `provider`, `modelApi` и `modelId` для определения применяемых действий.

Отдельно от гигиены транскрипта, файлы сеансов при необходимости восстанавливаются перед загрузкой:

- `repairSessionFileIfNeeded` в `src/agents/session-file-repair.ts`
- Вызывается из `run/attempt.ts` и `compact.ts` (встроенный раннер)

---

## Глобальное правило: очистка изображений

Полезные нагрузки изображений всегда очищаются, чтобы предотвратить отклонение со стороны провайдера
из‑за ограничений по размеру
(уменьшение размера/повторное сжатие слишком больших base64‑изображений).

Реализация:

- `sanitizeSessionMessagesImages` в `src/agents/pi-embedded-helpers/images.ts`
- `sanitizeContentBlocksImages` в `src/agents/tool-images.ts`

---

## Глобальное правило: повреждённые вызовы инструментов

Блоки вызовов инструментов ассистента, в которых отсутствуют оба поля `input` и `arguments`,
удаляются до построения контекста модели. Это предотвращает отклонения со стороны провайдера,
вызванные частично сохранёнными вызовами инструментов
(например, после сбоя из‑за лимита запросов).

Реализация:

- `sanitizeToolCallInputs` в `src/agents/session-transcript-repair.ts`
- Применяется в `sanitizeSessionHistory` в `src/agents/pi-embedded-runner/google.ts`

---

## Матрица провайдера (текущее поведение)

**OpenAI / OpenAI Codex**

- Только очистка изображений.
- При переключении модели на OpenAI Responses/Codex удаляются осиротевшие сигнатуры рассуждений
  (самостоятельные элементы рассуждений без последующего блока контента).
- Нет очистки идентификаторов вызовов инструментов.
- Нет восстановления сопоставления результатов инструментов.
- Нет валидации или переупорядочивания ходов.
- Нет синтетических результатов инструментов.
- Никакой продуманной подписи не размывается.

**Google (Generative AI / Gemini CLI / Antigravity)**

- Очистка идентификаторов вызовов инструментов: строгий буквенно‑цифровой формат.
- Восстановление сопоставления результатов инструментов и синтетические результаты инструментов.
- Валидация ходов (чередование ходов в стиле Gemini).
- Исправление порядка ходов Google (добавление небольшого пользовательского bootstrap,
  если история начинается с ассистента).
- Antigravity Claude: нормализация сигнатур размышлений; удаление неподписанных блоков размышлений.

**Anthropic / Minimax (Anthropic‑совместимые)**

- Восстановление сопоставления результатов инструментов и синтетические результаты инструментов.
- Валидация ходов (объединение последовательных пользовательских ходов для соблюдения строгого чередования).

**Mistral (включая определение по model‑id)**

- Очистка идентификаторов вызовов инструментов: strict9 (буквенно‑цифровые, длина 9).

**OpenRouter Gemini**

- Очистка сигнатур мыслей: удаление значений `thought_signature`, не являющихся base64 (base64 сохраняются).

**Все остальные**

- Только очистка изображений.

---

## Историческое поведение (до 2026.1.22)

До релиза 2026.1.22 OpenClaw применял несколько уровней гигиены транскрипта:

- **Расширение очистки транскрипта** запускалось при каждом построении контекста и могло:
  - Восстанавливать сопоставление использования инструмента и результата.
  - Очищать идентификаторы вызовов инструментов (включая нестрогий режим, сохранявший `_`/`-`).
- Раннер также выполнял очистку, специфичную для провайдеров, что дублировало работу.
- Дополнительные мутации происходили вне политики провайдера, включая:
  - Удаление тегов `<final>` из текста ассистента перед сохранением.
  - Удаление пустых ходов ошибок ассистента.
  - Обрезку контента ассистента после вызовов инструментов.

Эта сложность приводила к регрессиям между провайдерами (в частности, к проблемам сопоставления `openai-responses`
`call_id|fc_id`). Очистка в версии 2026.1.22 удалила расширение, централизовала
логику в раннере и сделала OpenAI **no-touch**, за исключением очистки изображений.
