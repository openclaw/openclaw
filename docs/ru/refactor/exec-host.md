---
summary: "План рефакторинга: маршрутизация exec-хоста, подтверждения узлов и headless‑раннер"
read_when:
  - Проектирование маршрутизации exec-хоста или подтверждений exec
  - Реализация раннера узла + UI IPC
  - Добавление режимов безопасности exec-хоста и slash‑команд
title: "Рефакторинг Exec хоста"
---

# План рефакторинга exec‑хоста

## Цели

- Добавить `exec.host` + `exec.security` для маршрутизации выполнения между **sandbox**, **gateway** и **node**.
- Сохранить **безопасные** значения по умолчанию: никакого межхостового выполнения, если оно явно не включено.
- Разделить выполнение на **headless‑службу раннера** с необязательным UI (приложение для macOS) через локальный IPC.
- Предоставить **per-agent** политику, список разрешённых, режимы запроса и привязку к узлу.
- Поддержать **режимы запроса**, работающие _с_ или _без_ списков разрешённых.
- Кроссплатформенность: Unix‑сокет + токенная аутентификация (паритет macOS/Linux/Windows).

## Не цели

- Нет миграции устаревших списков разрешённых или поддержки устаревших схем.
- Нет PTY/потоковой передачи для exec на узле (только агрегированный вывод).
- Нет нового сетевого слоя сверх существующих Bridge + Gateway (шлюз).

## Решения (зафиксированы)

- **Ключи конфига:** `exec.host` + `exec.security` (допускается per-agent переопределение).
- **Повышение прав:** сохранить `/elevated` как алиас полного доступа Gateway (шлюз).
- **Ask по умолчанию:** `on-miss`.
- **Хранилище подтверждений:** `~/.openclaw/exec-approvals.json` (JSON, без миграции легаси).
- **Раннер:** headless системная служба; UI‑приложение хостит Unix‑сокет для подтверждений.
- **Идентичность узла:** использовать существующий `nodeId`.
- **Аутентификация сокета:** Unix‑сокет + токен (кроссплатформенно); при необходимости разделить позже.
- **Состояние хоста узла:** `~/.openclaw/node.json` (id узла + токен сопряжения).
- **exec‑хост macOS:** запускать `system.run` внутри приложения для macOS; сервис хоста узла пересылает запросы по локальному IPC.
- **Без XPC‑помощника:** придерживаться Unix‑сокета + токена + проверок пиров.

## Ключевые понятия

### Хост

- `sandbox`: Docker exec (текущее поведение).
- `gateway`: exec на хосте Gateway (шлюз).
- `node`: exec на раннере узла через Bridge (`system.run`).

### Режим безопасности

- `deny`: всегда блокировать.
- `allowlist`: разрешать только совпадения.
- `full`: разрешать всё (эквивалент повышенных прав).

### Режим запроса (Ask)

- `off`: никогда не спрашивать.
- `on-miss`: спрашивать только если список разрешённых не совпал.
- `always`: спрашивать каждый раз.

Ask **независим** от списка разрешённых; список разрешённых можно использовать с `always` или `on-miss`.

### Разрешение политики (на каждый exec)

1. Определить `exec.host` (параметр инструмента → per-agent переопределение → глобальное значение по умолчанию).
2. Определить `exec.security` и `exec.ask` (та же приоритетность).
3. Если хост — `sandbox`, выполнить локальный sandbox exec.
4. Если хост — `gateway` или `node`, применить политику безопасности + ask на этом хосте.

## Безопасность по умолчанию

- По умолчанию `exec.host = sandbox`.
- По умолчанию `exec.security = deny` для `gateway` и `node`.
- По умолчанию `exec.ask = on-miss` (актуально только если безопасность разрешает).
- Если привязка к узлу не задана, **агент может нацеливаться на любой узел**, но только если политика это допускает.

## Поверхность конфигурации

### Параметры инструмента

- `exec.host` (необязательно): `sandbox | gateway | node`.
- `exec.security` (необязательно): `deny | allowlist | full`.
- `exec.ask` (необязательно): `off | on-miss | always`.
- `exec.node` (необязательно): id/имя узла для использования, когда `host=node`.

### Ключи конфига (глобально)

- `tools.exec.host`
- `tools.exec.security`
- `tools.exec.ask`
- `tools.exec.node` (привязка узла по умолчанию)

### Ключи конфига (per agent)

- `agents.list[].tools.exec.host`
- `agents.list[].tools.exec.security`
- `agents.list[].tools.exec.ask`
- `agents.list[].tools.exec.node`

### Алиасы

- `/elevated on` = установить `tools.exec.host=gateway`, `tools.exec.security=full` для сессии агента.
- `/elevated off` = восстановить предыдущие настройки exec для сессии агента.

## Хранилище подтверждений (JSON)

Путь: `~/.openclaw/exec-approvals.json`

Назначение:

- Локальная политика + списки разрешённых для **хоста выполнения** (Gateway (шлюз) или раннер узла).
- Резервный ask, когда UI недоступен.
- Учетные данные IPC для UI‑клиентов.

Предлагаемая схема (v1):

```json
{
  "version": 1,
  "socket": {
    "path": "~/.openclaw/exec-approvals.sock",
    "token": "base64-opaque-token"
  },
  "defaults": {
    "security": "deny",
    "ask": "on-miss",
    "askFallback": "deny"
  },
  "agents": {
    "agent-id-1": {
      "security": "allowlist",
      "ask": "on-miss",
      "allowlist": [
        {
          "pattern": "~/Projects/**/bin/rg",
          "lastUsedAt": 0,
          "lastUsedCommand": "rg -n TODO",
          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"
        }
      ]
    }
  }
}
```

Примечания:

- Нет форматов списков разрешённых легаси.
- `askFallback` применяется только когда требуется `ask` и UI недостижим.
- Права доступа к файлу: `0600`.

## Служба раннера (headless)

### Роль

- Локально обеспечивать `exec.security` + `exec.ask`.
- Выполнять системные команды и возвращать вывод.
- Генерировать события Bridge для жизненного цикла exec (необязательно, но рекомендуется).

### Жизненный цикл службы

- Launchd/daemon на macOS; системная служба на Linux/Windows.
- JSON подтверждений локален для хоста выполнения.
- UI хостит локальный Unix‑сокет; раннеры подключаются по требованию.

## Интеграция с UI (приложение для macOS)

### IPC

- Unix‑сокет по адресу `~/.openclaw/exec-approvals.sock` (0600).
- Токен хранится в `exec-approvals.json` (0600).
- Проверки пира: только тот же UID.
- Challenge/response: nonce + HMAC(token, request‑hash) для защиты от повторов.
- Короткий TTL (например, 10с) + максимальный размер полезной нагрузки + ограничение частоты.

### Поток ask (exec‑хост macOS)

1. Служба узла получает `system.run` от Gateway (шлюз).
2. Служба узла подключается к локальному сокету и отправляет запрос на подтверждение/exec.
3. Приложение валидирует пира + токен + HMAC + TTL, затем при необходимости показывает диалог.
4. Приложение выполняет команду в UI‑контексте и возвращает вывод.
5. Служба узла возвращает вывод в Gateway (шлюз).

Если UI отсутствует:

- Применить `askFallback` (`deny|allowlist|full`).

### Диаграмма (SCI)

```
Agent -> Gateway -> Bridge -> Node Service (TS)
                         |  IPC (UDS + token + HMAC + TTL)
                         v
                     Mac App (UI + TCC + system.run)
```

## Идентичность узла + привязка

- Использовать существующий `nodeId` из сопряжения Bridge.
- Модель привязки:
  - `tools.exec.node` ограничивает агента конкретным узлом.
  - Если не задано, агент может выбрать любой узел (политика всё равно применяет значения по умолчанию).
- Разрешение выбора узла:
  - `nodeId` точное совпадение
  - `displayName` (нормализованное)
  - `remoteIp`
  - `nodeId` префикс (≥ 6 символов)

## События

### Кто видит события

- Системные события **per session** и показываются агенту при следующем запросе.
- Хранятся в in‑memory очереди Gateway (шлюз) (`enqueueSystemEvent`).

### Текст событий

- `Exec started (node=<id>, id=<runId>)`
- `Exec finished (node=<id>, id=<runId>, code=<code>)` + необязательный хвост вывода
- `Exec denied (node=<id>, id=<runId>, <reason>)`

### Транспорт

Вариант A (рекомендуется):

- Раннер отправляет кадры Bridge `event` `exec.started` / `exec.finished`.
- Gateway (шлюз) `handleBridgeEvent` сопоставляет их с `enqueueSystemEvent`.

Вариант B:

- Инструмент Gateway (шлюз) `exec` обрабатывает жизненный цикл напрямую (только синхронно).

## Потоки Exec

### Sandbox‑хост

- Существующее поведение `exec` (Docker или хост при отключённом sandbox).
- PTY поддерживается только в несandbox‑режиме.

### Gateway‑хост

- Процесс Gateway (шлюз) выполняется на своей машине.
- Применяет локальные `exec-approvals.json` (безопасность/ask/список разрешённых).

### Хост узла

- Gateway (шлюз) вызывает `node.invoke` с `system.run`.
- Бегун требует местных одобрений.
- Раннер возвращает агрегированный stdout/stderr.
- Необязательные события Bridge для start/finish/deny.

## Записей вывода

- Ограничить суммарный stdout+stderr до **200k**; сохранять **хвост 20k** для событий.
- Обрезать с понятным суффиксом (например, `"… (truncated)"`).

## Slash‑команды

- `/exec host=<sandbox|gateway|node> security=<deny|allowlist|full> ask=<off|on-miss|always> node=<id>`
- Per‑agent, per‑session переопределения; непостоянные, если не сохранены через конфиг.
- `/elevated on|off|ask|full` остаётся сокращением для `host=gateway security=full` (при `full` подтверждения пропускаются).

## Кросс-платформенная история

- Служба раннера — переносимая цель выполнения.
- UI необязателен; если отсутствует, применяется `askFallback`.
- Windows/Linux поддерживают тот же JSON подтверждений + протокол сокета.

## Этапы реализации

### Этап 1: конфиг + маршрутизация exec

- Добавить схему конфига для `exec.host`, `exec.security`, `exec.ask`, `exec.node`.
- Обновить прокладку инструментов с учётом `exec.host`.
- Добавить slash‑команду `/exec` и сохранить алиас `/elevated`.

### Этап 2: хранилище подтверждений + применение на Gateway

- Реализовать reader/writer `exec-approvals.json`.
- Применять списки разрешённых + режимы ask для хоста `gateway`.
- Добавить ограничения вывода.

### Этап 3: применение на раннере узла

- Обновить раннер узла для применения списков разрешённых + ask.
- Добавить мост запросов Unix‑сокета к UI приложения macOS.
- Подключить `askFallback`.

### Этап 4: события

- Добавить события Bridge узел → Gateway (шлюз) для жизненного цикла exec.
- Сопоставить с `enqueueSystemEvent` для подсказок агенту.

### Этап 5: полировка UI

- Приложение Mac: редактор списков разрешённых, переключатель per‑agent, UI политики ask.
- Элементы управления привязкой узла (необязательно).

## План тестирования

- Юнит‑тесты: сопоставление списков разрешённых (glob + без учёта регистра).
- Юнит‑тесты: приоритет разрешения политики (параметр инструмента → per‑agent переопределение → глобально).
- Интеграционные тесты: потоки deny/allow/ask раннера узла.
- Тесты событий Bridge: маршрутизация node event → system event.

## Открытые риски

- Недоступность UI: обеспечить соблюдение `askFallback`.
- Долгие команды: полагаться на тайм‑аут + ограничения вывода.
- Неоднозначность нескольких узлов: ошибка, если нет привязки узла или явного параметра узла.

## Связанная документация

- [Exec tool](/tools/exec)
- [Exec approvals](/tools/exec-approvals)
- [Nodes](/nodes)
- [Elevated mode](/tools/elevated)
