---
summary: "Строгая валидация конфига + миграции только через Doctor"
read_when:
  - Проектирование или реализация поведения валидации конфига
  - Работа над миграциями конфига или рабочими процессами Doctor
  - Обработка схем конфига плагинов или контроль загрузки плагинов
title: "Строгая проверка конфигурации"
---

# Строгая валидация конфига (миграции только через Doctor)

## Цели

- **Отклонять неизвестные ключи конфига везде** (на корневом и вложенных уровнях).
- **Отклонять конфиг плагина без схемы**; такой плагин не загружать.
- **Убрать устаревшую автомиграцию при загрузке**; миграции выполняются только через Doctor.
- **Автоматически запускать Doctor (dry-run) при старте**; при невалидном конфиге блокировать недиагностические команды.

## Не цели

- Обратная совместимость при загрузке (устаревшие ключи не мигрируются автоматически).
- Тихое удаление нераспознанных ключей.

## Правила строгой валидации

- Конфиг должен **точно** соответствовать схеме на каждом уровне.
- Неизвестные ключи — это ошибки валидации (без «пропуска» на корневом или вложенных уровнях).
- `plugins.entries.<id>.config` должен валидироваться схемой плагина.
  - Если у плагина нет схемы, **отклонять загрузку плагина** и показывать понятную ошибку.
- Неизвестные ключи `channels.<id>` считаются ошибками, если манифест плагина не объявляет идентификатор канала.
- Манифесты плагинов (`openclaw.plugin.json`) обязательны для всех плагинов.

## Принуждение к использованию схем плагинов

- Каждый плагин предоставляет строгую JSON Schema для своего конфига (встроенную в манифест).
- Поток загрузки плагина:
  1. Разрешить манифест плагина + схему (`openclaw.plugin.json`).
  2. Провалидировать конфиг по схеме.
  3. При отсутствии схемы или невалидном конфиге: заблокировать загрузку плагина, зафиксировать ошибку.
- Сообщение об ошибке включает:
  - идентификатор плагина
  - причину (отсутствует схема / невалидный конфиг)
  - Путь(ы), которые не прошли проверку
- Отключённые плагины сохраняют свой конфиг, но Doctor и логи выводят предупреждение.

## Поток Doctor

- Doctor запускается **каждый раз**, когда загружается конфиг (по умолчанию dry-run).
- Если конфиг невалиден:
  - Печатает сводку + практические ошибки.
  - Инструктирует: `openclaw doctor --fix`.
- `openclaw doctor --fix`:
  - Применяет миграции.
  - Удаляет неизвестные ключи.
  - Записывает обновлённый конфиг.

## Ограничение команд (когда конфиг невалиден)

Разрешены (только диагностические):

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

Все остальные должны жёстко завершаться с сообщением: «Config invalid. Run `openclaw doctor --fix`.»

## Формат UX ошибок

- Один заголовок-сводка.
- Сгруппированные разделы:
  - Неизвестные ключи (полные пути)
  - Устаревшие ключи / требуемые миграции
  - Сбои загрузки плагинов (идентификатор плагина + причина + путь)

## Точки реализации

- `src/config/zod-schema.ts`: убрать «пропуск» на корне; строгие объекты везде.
- `src/config/zod-schema.providers.ts`: обеспечить строгие схемы каналов.
- `src/config/validation.ts`: падать на неизвестных ключах; не применять устаревшие миграции.
- `src/config/io.ts`: убрать устаревшие автомиграции; всегда запускать Doctor в режиме dry-run.
- `src/config/legacy*.ts`: перенести использование только в Doctor.
- `src/plugins/*`: добавить реестр схем + контроль загрузки.
- Ограничение CLI-команд в `src/cli`.

## Тесты

- Отклонение неизвестных ключей (корень + вложенные).
- Отсутствует схема плагина → загрузка плагина заблокирована с понятной ошибкой.
- Невалидный конфиг → запуск Gateway (шлюз) заблокирован, кроме диагностических команд.
- Doctor автоматически в режиме dry-run; `doctor --fix` записывает исправленный конфиг.
