---
summary: "خطة إعادة هيكلة: توجيه مضيف التنفيذ، موافقات العُقد، والمُشغِّل عديم الواجهة"
read_when:
  - عند تصميم توجيه مضيف التنفيذ أو موافقات التنفيذ
  - عند تنفيذ مُشغِّل العُقدة + IPC لواجهة المستخدم
  - إضافة الأوضاع الأمنية للمضيف الخارجي وأوامر Slash
title: "إعادة هيكلة مضيف التنفيذ"
---

# خطة إعادة هيكلة مضيف التنفيذ

## الأهداف

- إضافة `exec.host` + `exec.security` لتوجيه التنفيذ عبر **sandbox** و**gateway** و**node**.
- الإبقاء على الإعدادات الافتراضية **آمنة**: لا تنفيذ عبر مضيفين مختلفين إلا عند التمكين الصريح.
- فصل التنفيذ إلى **خدمة مُشغِّل عديمة الواجهة** مع واجهة مستخدم اختيارية (تطبيق macOS) عبر IPC محلي.
- توفير سياسة **لكل وكيل**، وقائمة سماح، ووضع سؤال، وربط بالعُقدة.
- دعم **أوضاع السؤال** التي تعمل _مع_ أو _بدون_ قوائم السماح.
- دعم متعدد المنصات: مقبس Unix + مصادقة بالرمز (تكافؤ macOS/Linux/Windows).

## غير الأهداف

- لا ترحيل لقوائم السماح القديمة أو دعم لمخططات قديمة.
- لا PTY/بثّ للتنفيذ على العُقد (مخرجات مجمّعة فقط).
- لا طبقة شبكة جديدة beyond Bridge + Gateway الحالية.

## القرارات (مقفلة)

- **مفاتيح التهيئة:** `exec.host` + `exec.security` (مسموح بالتجاوز لكل وكيل).
- **الرفع:** الإبقاء على `/elevated` كاسم مستعار للوصول الكامل إلى Gateway.
- **الافتراضي للسؤال:** `on-miss`.
- **مخزن الموافقات:** `~/.openclaw/exec-approvals.json` (JSON، دون ترحيل قديم).
- **المُشغِّل:** خدمة نظام عديمة الواجهة؛ تطبيق واجهة المستخدم يستضيف مقبس Unix للموافقات.
- **هوية العُقدة:** استخدام `nodeId` القائم.
- **مصادقة المقبس:** مقبس Unix + رمز (عبر المنصات)؛ يمكن الفصل لاحقًا إذا لزم.
- **حالة مضيف العُقدة:** `~/.openclaw/node.json` (معرّف العُقدة + رمز الاقتران).
- **مضيف التنفيذ على macOS:** تشغيل `system.run` داخل تطبيق macOS؛ خدمة مضيف العُقدة تُمرِّر الطلبات عبر IPC محلي.
- **لا مساعد XPC:** الالتزام بمقبس Unix + رمز + تحققات النظير.

## المفاهيم الأساسية

### المضيف

- `sandbox`: تنفيذ Docker (السلوك الحالي).
- `gateway`: تنفيذ على مضيف Gateway.
- `node`: تنفيذ على مُشغِّل العُقدة عبر Bridge (`system.run`).

### وضع الأمان

- `deny`: حظر دائمًا.
- `allowlist`: السماح فقط بالمطابقات.
- `full`: السماح بكل شيء (مكافئ للوضع المُرفَع).

### وضع السؤال

- `off`: لا تسأل أبدًا.
- `on-miss`: اسأل فقط عندما لا تطابق قائمة السماح.
- `always`: اسأل في كل مرة.

السؤال **مستقل** عن قائمة السماح؛ يمكن استخدام قائمة السماح مع `always` أو `on-miss`.

### حلّ السياسة (لكل تنفيذ)

1. حلّ `exec.host` (معلمة الأداة → تجاوز الوكيل → الافتراضي العام).
2. حلّ `exec.security` و`exec.ask` (نفس الأسبقية).
3. إذا كان المضيف هو `sandbox`، تابع تنفيذ sandbox المحلي.
4. إذا كان المضيف هو `gateway` أو `node`، طبّق سياسة الأمان والسؤال على ذلك المضيف.

## الأمان الافتراضي

- الافتراضي `exec.host = sandbox`.
- الافتراضي `exec.security = deny` لـ `gateway` و`node`.
- الافتراضي `exec.ask = on-miss` (ذو صلة فقط إذا سمح الأمان).
- إذا لم يتم تعيين ربط عُقدة، **يمكن للوكيل استهداف أي عُقدة**، ولكن فقط إذا سمحت السياسة بذلك.

## سطح التهيئة

### معلمات الأداة

- `exec.host` (اختياري): `sandbox | gateway | node`.
- `exec.security` (اختياري): `deny | allowlist | full`.
- `exec.ask` (اختياري): `off | on-miss | always`.
- `exec.node` (اختياري): معرّف/اسم العُقدة للاستخدام عند `host=node`.

### مفاتيح التهيئة (عام)

- `tools.exec.host`
- `tools.exec.security`
- `tools.exec.ask`
- `tools.exec.node` (ربط العُقدة الافتراضي)

### مفاتيح التهيئة (لكل وكيل)

- `agents.list[].tools.exec.host`
- `agents.list[].tools.exec.security`
- `agents.list[].tools.exec.ask`
- `agents.list[].tools.exec.node`

### Alias

- `/elevated on` = تعيين `tools.exec.host=gateway` و`tools.exec.security=full` لجلسة الوكيل.
- `/elevated off` = استعادة إعدادات التنفيذ السابقة لجلسة الوكيل.

## مخزن الموافقات (JSON)

المسار: `~/.openclaw/exec-approvals.json`

الغرض:

- سياسة محلية + قوائم سماح لـ **مضيف التنفيذ** (Gateway أو مُشغِّل العُقدة).
- احتياطي للسؤال عندما لا تتوفر واجهة مستخدم.
- بيانات اعتماد IPC لعملاء واجهة المستخدم.

المخطط المقترح (v1):

```json
{
  "version": 1,
  "socket": {
    "path": "~/.openclaw/exec-approvals.sock",
    "token": "base64-opaque-token"
  },
  "defaults": {
    "security": "deny",
    "ask": "on-miss",
    "askFallback": "deny"
  },
  "agents": {
    "agent-id-1": {
      "security": "allowlist",
      "ask": "on-miss",
      "allowlist": [
        {
          "pattern": "~/Projects/**/bin/rg",
          "lastUsedAt": 0,
          "lastUsedCommand": "rg -n TODO",
          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"
        }
      ]
    }
  }
}
```

ملاحظات:

- لا تنسيقات قوائم سماح قديمة.
- ينطبق `askFallback` فقط عندما يكون `ask` مطلوبًا ولا يمكن الوصول إلى واجهة مستخدم.
- أذونات الملف: `0600`.

## خدمة المُشغِّل (عديمة الواجهة)

### الدور

- فرض `exec.security` + `exec.ask` محليًا.
- تنفيذ أوامر النظام وإرجاع المخرجات.
- بث أحداث Bridge لدورة حياة التنفيذ (اختياري لكنه مُوصى به).

### دورة حياة الخدمة

- Launchd/daemon على macOS؛ خدمة نظام على Linux/Windows.
- ملف موافقات JSON محلي لمضيف التنفيذ.
- واجهة المستخدم تستضيف مقبس Unix؛ يتصل المُشغِّلون عند الطلب.

## تكامل واجهة المستخدم (تطبيق macOS)

### IPC

- مقبس Unix عند `~/.openclaw/exec-approvals.sock` (0600).
- الرمز مخزّن في `exec-approvals.json` (0600).
- تحققات النظير: نفس UID فقط.
- تحدّي/استجابة: nonce + HMAC(token, request-hash) لمنع إعادة التشغيل.
- مدة صلاحية قصيرة (مثلًا 10 ثوانٍ) + حد أقصى للحِمل + تحديد المعدّل.

### تدفّق السؤال (مضيف تنفيذ تطبيق macOS)

1. تتلقى خدمة العُقدة `system.run` من Gateway.
2. تتصل خدمة العُقدة بالمقبس المحلي وترسل طلب السؤال/التنفيذ.
3. يتحقق التطبيق من النظير + الرمز + HMAC + مدة الصلاحية، ثم يعرض الحوار عند الحاجة.
4. ينفّذ التطبيق الأمر في سياق واجهة المستخدم ويعيد المخرجات.
5. تعيد خدمة العُقدة المخرجات إلى Gateway.

في حال غياب واجهة المستخدم:

- تطبيق `askFallback` (`deny|allowlist|full`).

### مخطط (SCI)

```
Agent -> Gateway -> Bridge -> Node Service (TS)
                         |  IPC (UDS + token + HMAC + TTL)
                         v
                     Mac App (UI + TCC + system.run)
```

## هوية العُقدة + الربط

- استخدام `nodeId` القائم من اقتران Bridge.
- نموذج الربط:
  - `tools.exec.node` يقيّد الوكيل بعُقدة محددة.
  - إذا لم يُعيَّن، يمكن للوكيل اختيار أي عُقدة (مع استمرار فرض الافتراضيات عبر السياسة).
- حل اختيار العُقدة:
  - تطابق تام `nodeId`
  - `displayName` (مُطبَّع)
  - `remoteIp`
  - بادئة `nodeId` (≥ 6 أحرف)

## الأحداث

### من يرى الأحداث

- أحداث النظام **لكل جلسة** وتُعرض للوكيل عند الطلب التالي.
- مخزّنة في طابور الذاكرة داخل Gateway (`enqueueSystemEvent`).

### نص الحدث

- `Exec started (node=<id>, id=<runId>)`
- `Exec finished (node=<id>, id=<runId>, code=<code>)` + ذيل مخرجات اختياري
- `Exec denied (node=<id>, id=<runId>, <reason>)`

### النقل

الخيار A (موصى به):

- يرسل المُشغِّل إطارات Bridge `event` `exec.started` / `exec.finished`.
- تقوم Gateway بـ `handleBridgeEvent` وتحويلها إلى `enqueueSystemEvent`.

الخيار B:

- تتولى أداة Gateway `exec` دورة الحياة مباشرة (متزامن فقط).

## التدفقات الخارجية

### مضيف Sandbox

- السلوك القائم `exec` (Docker أو المضيف عند عدم العزل).
- دعم PTY في وضع غير sandbox فقط.

### مضيف Gateway

- تنفّذ عملية Gateway على جهازها الخاص.
- تفرض `exec-approvals.json` المحلي (الأمان/السؤال/قائمة السماح).

### مضيف العُقدة

- تستدعي Gateway `node.invoke` مع `system.run`.
- يفرض المُشغِّل الموافقات المحلية.
- يعيد المُشغِّل stdout/stderr مُجمّعين.
- أحداث Bridge اختيارية للبداية/الإنهاء/الرفض.

## حدود المخرجات

- حد أقصى لمجموع stdout+stderr قدره **200k**؛ الاحتفاظ بذيل **20k** للأحداث.
- اقتطاع مع لاحقة واضحة (مثلًا `"… (truncated)"`).

## tools/slash-commands.md

- `/exec host=<sandbox|gateway|node> security=<deny|allowlist|full> ask=<off|on-miss|always> node=<id>`
- تجاوزات لكل وكيل ولكل جلسة؛ غير دائمة ما لم تُحفَظ عبر التهيئة.
- يبقى `/elevated on|off|ask|full` اختصارًا لـ `host=gateway security=full` (مع `full` لتجاوز الموافقات).

## القصة متعددة المنصات

- خدمة المُشغِّل هي هدف التنفيذ القابل للنقل.
- واجهة المستخدم اختيارية؛ عند غيابها يُطبَّق `askFallback`.
- يدعم Windows/Linux نفس ملف موافقات JSON وبروتوكول المقبس.

## مراحل التنفيذ

### المرحلة 1: التهيئة + توجيه التنفيذ

- إضافة مخطط التهيئة لـ `exec.host` و`exec.security` و`exec.ask` و`exec.node`.
- تحديث ربط الأداة لاحترام `exec.host`.
- إضافة أمر شرطة مائلة `/exec` والإبقاء على الاسم المستعار `/elevated`.

### المرحلة 2: مخزن الموافقات + فرض Gateway

- تنفيذ قارئ/كاتب `exec-approvals.json`.
- تفعيل السماح بقائمة + طلب أوضاع المضيف 'بوابة'.
- إضافة حدود المخرجات.

### المرحلة 3: فرض مُشغِّل العُقدة

- تحديث مُشغِّل العُقدة لفرض قائمة السماح + السؤال.
- إضافة جسر مطالبة بمقبس Unix إلى واجهة تطبيق macOS.
- توصيل `askFallback`.

### المرحلة 4: الأحداث

- إضافة أحداث Bridge من العُقدة → Gateway لدورة حياة التنفيذ.
- تحويلها إلى `enqueueSystemEvent` لطلبات الوكيل.

### المرحلة 5: صقل واجهة المستخدم

- تطبيق Mac: محرّر قوائم السماح، مُبدّل لكل وكيل، واجهة سياسة السؤال.
- عناصر تحكم ربط العُقدة (اختياري).

## خطة الاختبار

- اختبارات وحدات: مطابقة قوائم السماح (glob + غير حساس لحالة الأحرف).
- اختبارات وحدات: أسبقية حلّ السياسة (معلمة الأداة → تجاوز الوكيل → العام).
- اختبارات تكامل: تدفّقات الرفض/السماح/السؤال لمُشغِّل العُقدة.
- اختبارات أحداث Bridge: توجيه حدث العُقدة → حدث النظام.

## المخاطر المفتوحة

- عدم توفر واجهة المستخدم: التأكد من احترام `askFallback`.
- أوامر طويلة الأمد: الاعتماد على المهلة وحدود المخرجات.
- غموض تعدد العُقد: خطأ ما لم يتم ربط العُقدة أو تمرير معلمة عُقدة صريحة.

## مستندات ذات صلة

- [أداة Exec](/tools/exec)
- [موافقات Exec](/tools/exec-approvals)
- [العُقد](/nodes)
- [الوضع المُرفَع](/tools/elevated)
