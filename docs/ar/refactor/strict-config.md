---
summary: "التحقق الصارم من التهيئة + عمليات الترحيل عبر Doctor فقط"
read_when:
  - تصميم أو تنفيذ سلوك التحقق من التهيئة
  - العمل على عمليات ترحيل التهيئة أو مسارات Doctor
  - التعامل مع مخططات تهيئة الإضافات أو تقييد تحميل الإضافات
title: "التحقق الصارم من التهيئة"
---

# التحقق الصارم من التهيئة (عمليات الترحيل عبر Doctor فقط)

## الأهداف

- **رفض مفاتيح التهيئة غير المعروفة في كل مكان** (الجذر + المتداخل).
- - - رفض تهيئة الملحق بدون مخطط\*\*؛ لا تقم بتحميل هذه الإضافة.
- **إزالة الترحيل التلقائي القديم عند التحميل**؛ تُشغَّل عمليات الترحيل عبر Doctor فقط.
- **تشغيل Doctor تلقائيًا (وضع المحاكاة الجافة) عند بدء التشغيل**؛ وإذا كانت التهيئة غير صالحة، يتم حظر الأوامر غير التشخيصية.

## غير الأهداف

- التوافق مع الإصدارات السابقة عند التحميل (لا يتم ترحيل المفاتيح القديمة تلقائيًا).
- إسقاط المفاتيح غير المعترف بها بصمت.

## قواعد التحقق الصارم

- يجب أن تطابق التهيئة المخطط بدقة في كل مستوى.
- المفاتيح غير المعروفة تُعد أخطاء تحقق (لا تمرير في الجذر أو المتداخل).
- يجب التحقق من `plugins.entries.<id>.config` بواسطة مخطط الإضافة.
  - إذا كانت الإضافة تفتقر إلى مخطط، **يُرفَض تحميل الإضافة** ويُعرَض خطأ واضح.
- مفاتيح `channels.<id>` غير المعروفة تُعد أخطاء ما لم يعلن بيان الإضافة عن معرّف القناة.
- بيانات الإضافات (`openclaw.plugin.json`) مطلوبة لجميع الإضافات.

## فرض مخطط الإضافة

- توفر كل إضافة مخطط JSON صارم لتهيئتها (مضمّنًا داخل البيان).
- تدفق تحميل الإضافة:
  1. حلّ بيان الإضافة + المخطط (`openclaw.plugin.json`).
  2. التحقق من التهيئة مقابل المخطط.
  3. في حال غياب المخطط أو عدم صلاحية التهيئة: حظر تحميل الإضافة وتسجيل الخطأ.
- تتضمن رسالة الخطأ:
  - معرف الإضافة
  - السبب (غياب المخطط / تهيئة غير صالحة)
  - المسارات التي فشل التحقق عندها
- تحتفظ الإضافات المعطّلة بتهيئتها، لكن Doctor + السجلات تُظهر تحذيرًا.

## تدفق Doctor

- يعمل Doctor **في كل مرة** يتم فيها تحميل التهيئة (وضع المحاكاة الجافة افتراضيًا).
- إذا كانت التهيئة غير صالحة:
  - طباعة ملخص + أخطاء قابلة للتنفيذ.
  - توجيه: `openclaw doctor --fix`.
- `openclaw doctor --fix`:
  - يطبّق عمليات الترحيل.
  - يزيل المفاتيح غير المعروفة.
  - يكتب التهيئة المحدّثة.

## تقييد الأوامر (عندما تكون التهيئة غير صالحة)

المسموح به (تشخيصي فقط):

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

يجب أن تفشل كل الأوامر الأخرى فشلًا صارمًا مع: «التهيئة غير صالحة. شغّل `openclaw doctor --fix`.»

## Error UX format

- عنوان ملخص واحد.
- أقسام مجمّعة:
  - مفاتيح غير معروفة (المسارات الكاملة)
  - مفاتيح قديمة / عمليات ترحيل مطلوبة
  - فشل تحميل الإضافات (معرّف الإضافة + السبب + المسار)

## نقاط اللمس في التنفيذ

- `src/config/zod-schema.ts`: إزالة تمرير الجذر؛ كائنات صارمة في كل مكان.
- `src/config/zod-schema.providers.ts`: ضمان مخططات قنوات صارمة.
- `src/config/validation.ts`: الفشل عند المفاتيح غير المعروفة؛ عدم تطبيق عمليات الترحيل القديمة.
- `src/config/io.ts`: إزالة الترحيلات التلقائية القديمة؛ تشغيل Doctor دائمًا بوضع المحاكاة الجافة.
- `src/config/legacy*.ts`: نقل الاستخدام إلى Doctor فقط.
- `src/plugins/*`: إضافة سجل مخططات + التقييد.
- تقييد أوامر CLI في `src/cli`.

## الاختبارات

- رفض المفاتيح غير المعروفة (الجذر + المتداخل).
- غياب مخطط الإضافة → حظر تحميل الإضافة مع خطأ واضح.
- تهيئة غير صالحة → حظر بدء تشغيل Gateway باستثناء الأوامر التشخيصية.
- تشغيل Doctor بوضع المحاكاة الجافة تلقائيًا؛ `doctor --fix` يكتب التهيئة المصحّحة.
