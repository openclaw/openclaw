---
summary: "إعادة هيكلة Clawnet: توحيد بروتوكول الشبكة، والأدوار، والمصادقة، والموافقات، والهوية"
read_when:
  - التخطيط لبروتوكول شبكة موحّد للعُقد + عملاء المشغّل
  - إعادة العمل على الموافقات، والاقتران، وTLS، والحضور عبر الأجهزة
title: "إعادة هيكلة Clawnet"
---

# إعادة هيكلة Clawnet (توحيد البروتوكول + المصادقة)

## مرحبًا

مرحبا بيتر - اتجاه عظيم؛ هذا يفتح أبسطه UX + أمان أقوى.

## الغرض

وثيقة واحدة صارمة من أجل:

- الحالة الحالية: البروتوكولات، التدفقات، حدود الثقة.
- نقاط الألم: الموافقات، التوجيه متعدد القفزات، ازدواجية واجهة المستخدم.
- الحالة الجديدة المقترحة: بروتوكول واحد، أدوار مُحددة النطاق، مصادقة/اقتران موحّدان، تثبيت TLS.
- نموذج الهوية: معرّفات ثابتة + أسماء لطيفة.
- خطة الترحيل، المخاطر، الأسئلة المفتوحة.

## الأهداف (من النقاش)

- بروتوكول واحد لجميع العملاء (تطبيق mac، CLI، iOS، Android، عُقدة بلا واجهة).
- مصادقة واقتران لكل مشارك في الشبكة.
- وضوح الأدوار: العقد مقابل المشغلين.
- توجيه الموافقات مركزيًا إلى حيث يوجد المستخدم.
- تشفير TLS + تثبيت اختياري لجميع الحركة البعيدة.
- تقليل ازدواجية الشيفرة.
- يجب أن يظهر الجهاز الواحد مرة واحدة فقط (من دون إدخال واجهة/عُقدة مكرر).

## غير الأهداف (صراحةً)

- إزالة فصل الصلاحيات (ما زال مبدأ أقل امتياز مطلوبًا).
- كشف مستوى التحكم الكامل للبوابة دون فحوصات النطاق.
- جعل المصادقة تعتمد على تسميات بشرية (تظل الأسماء اللطيفة غير أمنية).

---

# الحالة الحالية (كما هي)

## بروتوكولان

### 1. Gateway WebSocket (مستوى التحكم)

- سطح API كامل: التهيئة، القنوات، النماذج، الجلسات، تشغيل الوكلاء، السجلات، العُقد، إلخ.
- الربط الافتراضي: loopback. الوصول البعيد عبر SSH/Tailscale.
- المصادقة: رمز/كلمة مرور عبر `connect`.
- لا يوجد تثبيت TLS (يعتمد على loopback/النفق).
- الشيفرة:
  - `src/gateway/server/ws-connection/message-handler.ts`
  - `src/gateway/client.ts`
  - `docs/gateway/protocol.md`

### 2. Bridge (نقل العُقد)

- سطح مسموح ضيق، هوية العُقدة + الاقتران.
- JSONL عبر TCP؛ TLS اختياري + تثبيت بصمة الشهادة.
- يعلن TLS عن البصمة في اكتشاف TXT.
- الشيفرة:
  - `src/infra/bridge/server/connection.ts`
  - `src/gateway/server-bridge.ts`
  - `src/node-host/bridge-client.ts`
  - `docs/gateway/bridge-protocol.md`

## عملاء مستوى التحكم اليوم

- CLI → Gateway WS عبر `callGateway` (`src/gateway/call.ts`).
- واجهة تطبيق macOS → Gateway WS (`GatewayConnection`).
- واجهة التحكم الويب → Gateway WS.
- ACP → Gateway WS.
- تحكم المتصفح يستخدم خادم تحكم HTTP خاصًا به.

## العُقد اليوم

- تطبيق macOS في وضع العُقدة يتصل بـ Gateway bridge (`MacNodeBridgeSession`).
- تطبيقات iOS/Android تتصل بـ Gateway bridge.
- الاقتران + رمز لكل عُقدة مخزّن على البوابة.

## تدفق الموافقة الحالي (تنفيذ)

- يستخدم الوكيل `system.run` عبر Gateway.
- تستدعي Gateway العُقدة عبر bridge.
- يقرر وقت تشغيل العُقدة الموافقة.
- يظهر تنبيه واجهة المستخدم بواسطة تطبيق mac (عندما تكون العُقدة == تطبيق mac).
- تعيد العُقدة `invoke-res` إلى Gateway.
- متعدد القفزات، وواجهة المستخدم مرتبطة بمضيف العُقدة.

## الحضور + الهوية اليوم

- إدخالات حضور Gateway من عملاء WS.
- إدخالات حضور العُقدة من bridge.
- يمكن لتطبيق mac إظهار إدخالين للجهاز نفسه (واجهة + عُقدة).
- هوية العُقدة مخزّنة في مخزن الاقتران؛ وهوية الواجهة منفصلة.

---

# المشكلات / نقاط الألم

- مجموعتا بروتوكول للصيانة (WS + Bridge).
- الموافقات على العُقد البعيدة: يظهر التنبيه على مضيف العُقدة، لا حيث يوجد المستخدم.
- تثبيت TLS موجود فقط في bridge؛ يعتمد WS على SSH/Tailscale.
- ازدواجية الهوية: يظهر الجهاز نفسه كنسخ متعددة.
- أدوار غامضة: قدرات الواجهة + العُقدة + CLI غير مفصولة بوضوح.

---

# الحالة الجديدة المقترحة (Clawnet)

## بروتوكول واحد، دوران

بروتوكول WS واحد مع دور + نطاق.

- **الدور: عُقدة** (مضيف القدرات)
- **الدور: مشغّل** (مستوى التحكم)
- **نطاق** اختياري للمشغّل:
  - `operator.read` (الحالة + العرض)
  - `operator.write` (تشغيل الوكيل، الإرسال)
  - `operator.admin` (التهيئة، القنوات، النماذج)

### سلوكيات الأدوار

**العُقدة**

- يمكنها تسجيل القدرات (`caps`، `commands`، الأذونات).
- يمكنها تلقي أوامر `invoke` (`system.run`، `camera.*`، `canvas.*`، `screen.record`، إلخ).
- يمكنها إرسال أحداث: `voice.transcript`، `agent.request`، `chat.subscribe`.
- لا يمكنها استدعاء واجهات مستوى التحكم للتهيئة/النماذج/القنوات/الجلسات/الوكيل.

**المشغّل**

- وصول كامل لواجهات مستوى التحكم، مُقيّد بالنطاق.
- يتلقى جميع الموافقات.
- لا ينفّذ إجراءات نظام التشغيل مباشرة؛ يوجّهها إلى العُقد.

### قاعدة أساسية

الدور لكل اتصال، لا لكل جهاز. قد يفتح الجهاز الدورين، كلٌ على حدة.

---

# المصادقة + الاقتران الموحّدان

## هوية العميل

يوفّر كل عميل:

- `deviceId` (ثابت، مشتق من مفتاح الجهاز).
- `displayName` (اسم بشري).
- `role` + `scope` + `caps` + `commands`.

## تدفق الاقتران (موحّد)

- يتصل العميل دون مصادقة.
- تنشئ Gateway **طلب اقتران** لهذا `deviceId`.
- يتلقى المشغّل تنبيهًا؛ يوافق/يرفض.
- تصدر Gateway بيانات اعتماد مرتبطة بـ:
  - المفتاح العام للجهاز
  - الدور/الأدوار
  - نطاق(ات)
  - القدرات/الأوامر
- يحفظ العميل الرمز ويعيد الاتصال مصادقًا.

## مصادقة مرتبطة بالجهاز (تجنّب إعادة تشغيل رموز الحامل)

المفضّل: أزواج مفاتيح للجهاز.

- ينشئ الجهاز زوج مفاتيح مرة واحدة.
- `deviceId = fingerprint(publicKey)`.
- ترسل Gateway قيمة nonce؛ يوقّعها الجهاز؛ تتحقق Gateway.
- تُصدر الرموز لمفتاح عام (إثبات الحيازة)، لا لسلسلة نصية.

بدائل:

- mTLS (شهادات عميل): الأقوى، لكن بتعقيد تشغيلي أعلى.
- رموز حامل قصيرة العمر فقط كمرحلة مؤقتة (تدوير + إبطال مبكر).

## الموافقة الصامتة (استدلال SSH)

حدّدها بدقة لتجنب حلقة ضعيفة. يُفضّل أحدها:

- **محلي فقط**: اقتران تلقائي عند اتصال العميل عبر loopback/مقبس Unix.
- **تحدّي عبر SSH**: تُصدر Gateway قيمة nonce؛ يثبت العميل SSH بجلبها.
- **نافذة حضور مادي**: بعد موافقة محلية على واجهة مضيف Gateway، السماح بالاقتران التلقائي لفترة قصيرة (مثل 10 دقائق).

دائمًا سجّل واحتفظ بسجل الموافقات التلقائية.

---

# TLS في كل مكان (التطوير + الإنتاج)

## إعادة استخدام TLS الخاص بالـ bridge

استخدم وقت تشغيل TLS الحالي + تثبيت البصمة:

- `src/infra/bridge/server/tls.ts`
- منطق التحقق من البصمة في `src/node-host/bridge-client.ts`

## تطبيقه على WS

- يدعم خادم WS TLS بنفس الشهادة/المفتاح + البصمة.
- يمكن لعملاء WS تثبيت البصمة (اختياري).
- يعلن الاكتشاف عن TLS + البصمة لجميع النهايات.
  - الاكتشاف مجرد تلميحات تحديد موقع؛ وليس مرساة ثقة.

## لماذا

- تقليل الاعتماد على SSH/Tailscale للسرية.
- جعل الاتصالات البعيدة على الأجهزة المحمولة آمنة افتراضيًا.

---

# إعادة تصميم الموافقات (مركزية)

## الحالي

تحدث الموافقة على مضيف العُقدة (وقت تشغيل عُقدة تطبيق mac). يظهر التنبيه حيث تعمل العُقدة.

## المقترح

الموافقة **مستضافة على Gateway**، وتُسلَّم الواجهة إلى عملاء المشغّل.

### التدفق الجديد

1. تستقبل Gateway نية `system.run` (وكيل).
2. تنشئ Gateway سجل موافقة: `approval.requested`.
3. Operator UI(s) show prompt.
4. يُرسل قرار الموافقة إلى Gateway: `approval.resolve`.
5. تستدعي Gateway أمر العُقدة إذا تمت الموافقة.
6. تنفّذ العُقدة وتعيد `invoke-res`.

### دلالات الموافقة (تعزيز)

- البث إلى جميع المشغّلين؛ واجهة واحدة نشطة فقط تعرض نافذة منبثقة (والبقية إشعارًا).
- أول قرار يُحسم؛ ترفض Gateway القرارات اللاحقة باعتبارها محسومة.
- مهلة افتراضية: الرفض بعد N ثانية (مثل 60 ثانية)، مع تسجيل السبب.
- يتطلب الحسم نطاق `operator.approvals`.

## الفوائد

- يظهر التنبيه حيث يوجد المستخدم (mac/الهاتف).
- موافقات متسقة للعُقد البعيدة.
- يبقى وقت تشغيل العُقدة بلا واجهة؛ دون اعتماد على UI.

---

# أمثلة على وضوح الأدوار

## تطبيق iPhone

- **دور العُقدة** لـ: الميكروفون، الكاميرا، الدردشة الصوتية، الموقع، الضغط للتحدث.
- **operator.read** اختياري للحالة وعرض الدردشة.
- **operator.write/admin** اختياري فقط عند التمكين الصريح.

## تطبيق macOS

- دور المشغّل افتراضيًا (واجهة التحكم).
- دور العُقدة عند تمكين «Mac node» (system.run، الشاشة، الكاميرا).
- نفس deviceId لكلا الاتصالين → إدخال واجهة موحّد.

## CLI

- دور المشغّل دائمًا.
- النطاق مشتق من الأمر الفرعي:
  - `status`، `logs` → قراءة
  - `agent`، `message` → كتابة
  - `config`، `channels` → إدارة
  - الموافقات + الاقتران → `operator.approvals` / `operator.pairing`

---

# الهوية + الأسماء اللطيفة

## معرف الثبات

مطلوب للمصادقة؛ لا يتغير أبدًا.
المفضّل:

- بصمة زوج المفاتيح (تجزئة المفتاح العام).

## سبار لطيف (الجلدة)

تسمية بشرية فقط.

- مثال: `scarlet-claw`، `saltwave`، `mantis-pinch`.
- مخزّن في سجل Gateway، قابل للتحرير.
- معالجة التعارض: `-2`، `-3`.

## تجميع واجهة المستخدم

نفس `deviceId` عبر الأدوار → صف «مثيل» واحد:

- شارة: `operator`، `node`.
- يعرض القدرات + آخر ظهور.

---

# استراتيجية الترحيل

## المرحلة 0: التوثيق + المواءمة

- نشر هذه الوثيقة.
- جرد جميع استدعاءات البروتوكول + تدفقات الموافقات.

## المرحلة 1: إضافة الأدوار/النطاقات إلى WS

- توسيع معاملات `connect` بـ `role`، `scope`، `deviceId`.
- إضافة تقييد قائمة السماح لدور العُقدة.

## المرحلة 2: توافقية Bridge

- الإبقاء على bridge يعمل.
- إضافة دعم عُقدة WS بالتوازي.
- حجب الميزات خلف علم تهيئة.

## المرحلة 3: موافقات مركزية

- إضافة طلب الموافقة + أحداث الحسم في WS.
- تحديث واجهة تطبيق mac لعرض التنبيه والاستجابة.
- يتوقف وقت تشغيل العُقدة عن عرض واجهة المستخدم.

## المرحلة 4: توحيد TLS

- إضافة تهيئة TLS لـ WS باستخدام وقت تشغيل TLS الخاص بالـ bridge.
- إضافة التثبيت إلى العملاء.

## المرحلة 5: إهمال bridge

- ترحيل عُقد iOS/Android/mac إلى WS.
- الإبقاء على bridge كبديل؛ إزالته بعد الاستقرار.

## المرحلة 6: مصادقة مرتبطة بالجهاز

- فرض هوية قائمة على المفاتيح لجميع الاتصالات غير المحلية.
- إضافة إلغاء + واجهة التدوير

---

# ملاحظات أمنية

- يُفرض الدور/قائمة السماح عند حد Gateway.
- لا يحصل أي عميل على API «كامل» دون نطاق المشغّل.
- الاقتران مطلوب لـ _كل_ الاتصالات.
- TLS + التثبيت يقللان مخاطر MITM على الأجهزة المحمولة.
- الموافقة الصامتة عبر SSH هي ملاءمة؛ لكنها مسجلة وقابلة للإبطال.
- الاكتشاف ليس مرساة ثقة أبدًا.
- تُتحقق ادعاءات القدرات مقابل قوائم السماح الخادمية حسب المنصة/النوع.

# البثّ + الحمولة الكبيرة (وسائط العُقد)

مستوى التحكم عبر WS مناسب للرسائل الصغيرة، لكن العُقد تقوم أيضًا بـ:

- مقاطع الكاميرا
- تسجيلات الشاشة
- تدفقات الصوت

الخيارات:

1. إطارات WS ثنائية + تجزئة + قواعد ضغط عكسي.
2. نقطة بث منفصلة (مع TLS + مصادقة).
3. الإبقاء على bridge مدة أطول لأوامر كثيفة الوسائط، والترحيل أخيرًا.

اختر واحدًا قبل التنفيذ لتجنب الانجراف.

# سياسة القدرات + الأوامر

- تُعامل القدرات/الأوامر المبلّغ عنها من العُقد كـ **ادعاءات**.
- تفرض Gateway قوائم سماح حسب المنصة.
- أي أمر جديد يتطلب موافقة المشغّل أو تغييرًا صريحًا في قائمة السماح.
- تدقيق التغييرات مع الطوابع الزمنية.

# التدقيق + تحديد المعدّل

- التسجيل: طلبات الاقتران، الموافقات/الرفض، إصدار/تدوير/إبطال الرموز.
- تحديد المعدّل لرسائل الاقتران المزعجة وتنبيهات الموافقات.

# نظافة البروتوكول

- إصدار بروتوكول صريح + رموز أخطاء.
- قواعد إعادة الاتصال + سياسة نبضات القلب.
- وجود TTL و آخر لفظات شاهدة.

---

# أسئلة مفتوحة

1. جهاز واحد يشغّل الدورين: نموذج الرمز
   - التوصية: رموز منفصلة لكل دور (عُقدة مقابل مشغّل).
   - نفس deviceId؛ نطاقات مختلفة؛ إبطال أوضح.

2. نطاق حبيبة المشغل
   - قراءة/كتابة/إدارة + موافقات + اقتران (حد أدنى قابل للتطبيق).
   - النظر في نطاقات لكل ميزة لاحقًا.

3. تدوير الرمز + إلغاء UX
   - تدوير تلقائي عند تغيير الدور.
   - واجهة لإبطال حسب deviceId + الدور.

4. الاكتشاف
   - توسيع TXT لـ Bonjour الحالي ليشمل بصمة TLS لـ WS + تلميحات الدور.
   - اعتباره تلميحات تحديد موقع فقط.

5. الموافقة عبر الشبكات
   - البث إلى جميع عملاء المشغّل؛ الواجهة النشطة تعرض نافذة منبثقة.
   - أول استجابة تفوز؛ تفرض Gateway الذرّية.

---

# الخلاصة (TL;DR)

- اليوم: مستوى تحكم WS + نقل عُقد عبر Bridge.
- الألم: الموافقات + الازدواجية + مكدّسان.
- المقترح: بروتوكول WS واحد بأدوار ونطاقات صريحة، اقتران موحّد + تثبيت TLS، موافقات مستضافة على Gateway، معرّفات أجهزة ثابتة + أسماء لطيفة.
- النتيجة: تجربة استخدام أبسط، أمن أقوى، ازدواجية أقل، وتوجيه أفضل للأجهزة المحمولة.
