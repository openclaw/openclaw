---
summary: "الوكلاء الفرعيون: إنشاء تشغيلات وكلاء معزولة تُعلن النتائج مرة أخرى إلى قناة الدردشة الخاصة بالطالب"
read_when:
  - تريد تنفيذ عمل في الخلفية/بالتوازي عبر الوكيل
  - تقوم بتغيير سياسة sessions_spawn أو أداة الوكيل الفرعي
title: "الوكلاء الفرعيون"
x-i18n:
  source_path: tools/subagents.md
  source_hash: 3c83eeed69a65dbb
  provider: openai
  model: gpt-5.2-chat-latest
  workflow: v1
  generated_at: 2026-02-08T10:49:00Z
---

# الوكلاء الفرعيون

الوكلاء الفرعيون هم تشغيلات وكلاء في الخلفية يتم إنشاؤها من تشغيل وكيل موجود. يعملون في جلسة خاصة بهم (`agent:<agentId>:subagent:<uuid>`)، وعند الانتهاء، **يُعلنون** نتائجهم مرة أخرى إلى قناة دردشة الطالب.

## أمر الشرطة المائلة

استخدم `/subagents` لفحص أو التحكم في تشغيلات الوكيل الفرعي للجلسة **الحالية**:

- `/subagents list`
- `/subagents stop <id|#|all>`
- `/subagents log <id|#> [limit] [tools]`
- `/subagents info <id|#>`
- `/subagents send <id|#> <message>`

يعرض `/subagents info` بيانات التعريف الخاصة بالتشغيل (الحالة، الطوابع الزمنية، معرّف الجلسة، مسار النص الحرفي، التنظيف).

الأهداف الأساسية:

- تنفيذ أعمال «البحث / المهام الطويلة / الأدوات البطيئة» بالتوازي دون حجب التشغيل الرئيسي.
- إبقاء الوكلاء الفرعيين معزولين افتراضيًا (فصل الجلسات + sandboxing اختياري).
- جعل سطح الأدوات صعب سوء الاستخدام: الوكلاء الفرعيون **لا** يحصلون على أدوات الجلسة افتراضيًا.
- تجنّب التفريع المتداخل: لا يمكن للوكلاء الفرعيين إنشاء وكلاء فرعيين.

ملاحظة التكلفة: لكل وكيل فرعي **سياقه الخاص** واستخدامه للرموز. للمهام الثقيلة أو المتكررة،
اضبط نموذجًا أقل تكلفة للوكلاء الفرعيين وأبقِ وكيلك الرئيسي على نموذج أعلى جودة.
يمكنك تهيئة ذلك عبر `agents.defaults.subagents.model` أو عبر تجاوزات لكل وكيل.

## الأداة

استخدم `sessions_spawn`:

- يبدأ تشغيل وكيل فرعي (`deliver: false`، المسار العام: `subagent`)
- ثم يُشغِّل خطوة الإعلان وينشر رد الإعلان إلى قناة دردشة الطالب
- النموذج الافتراضي: يرث من المُستدعي ما لم تضبط `agents.defaults.subagents.model` (أو لكل وكيل `agents.list[].subagents.model`)؛ يظل `sessions_spawn.model` الصريح هو الغالب.
- التفكير الافتراضي: يرث من المُستدعي ما لم تضبط `agents.defaults.subagents.thinking` (أو لكل وكيل `agents.list[].subagents.thinking`)؛ يظل `sessions_spawn.thinking` الصريح هو الغالب.

معلمات الأداة:

- `task` (مطلوب)
- `label?` (اختياري)
- `agentId?` (اختياري؛ الإنشاء تحت معرّف وكيل آخر إذا كان مسموحًا)
- `model?` (اختياري؛ يتجاوز نموذج الوكيل الفرعي؛ تُتجاهل القيم غير الصالحة ويعمل الوكيل الفرعي على النموذج الافتراضي مع تحذير في نتيجة الأداة)
- `thinking?` (اختياري؛ يتجاوز مستوى التفكير لتشغيل الوكيل الفرعي)
- `runTimeoutSeconds?` (الافتراضي `0`؛ عند التعيين، يتم إيقاف تشغيل الوكيل الفرعي بعد N ثانية)
- `cleanup?` (`delete|keep`، الافتراضي `keep`)

قائمة السماح:

- `agents.list[].subagents.allowAgents`: قائمة بمعرّفات الوكلاء التي يمكن استهدافها عبر `agentId` (`["*"]` للسماح بأي). الافتراضي: وكيل الطالب فقط.

الاكتشاف:

- استخدم `agents_list` لمعرفة معرّفات الوكلاء المسموح بها حاليًا لـ `sessions_spawn`.

الأرشفة التلقائية:

- تتم أرشفة جلسات الوكيل الفرعي تلقائيًا بعد `agents.defaults.subagents.archiveAfterMinutes` (الافتراضي: 60).
- تستخدم الأرشفة `sessions.delete` وتُعيد تسمية النص الحرفي إلى `*.deleted.<timestamp>` (المجلد نفسه).
- `cleanup: "delete"` يُؤرشف فورًا بعد الإعلان (مع الاحتفاظ بالنص الحرفي عبر إعادة التسمية).
- الأرشفة التلقائية «أفضل جهد»؛ تُفقد المؤقتات المعلّقة إذا أُعيد تشغيل Gateway.
- `runTimeoutSeconds` لا يُؤرشف تلقائيًا؛ يوقف التشغيل فقط. تبقى الجلسة حتى الأرشفة التلقائية.

## المصادقة

تُحل مصادقة الوكيل الفرعي بحسب **معرّف الوكيل**، وليس بحسب نوع الجلسة:

- مفتاح جلسة الوكيل الفرعي هو `agent:<agentId>:subagent:<uuid>`.
- يتم تحميل مخزن المصادقة من `agentDir` الخاص بذلك الوكيل.
- تُدمج ملفات تعريف مصادقة الوكيل الرئيسي كـ **احتياطي**؛ وتتغلب ملفات تعريف الوكيل على ملفات تعريف الرئيسي عند التعارض.

ملاحظة: الدمج إضافي، لذا تكون ملفات تعريف الرئيسي متاحة دائمًا كاحتياطي. المصادقة المعزولة بالكامل لكل وكيل غير مدعومة بعد.

## الإعلان

يُبلِّغ الوكلاء الفرعيون النتائج عبر خطوة إعلان:

- تعمل خطوة الإعلان داخل جلسة الوكيل الفرعي (وليس جلسة الطالب).
- إذا ردّ الوكيل الفرعي حرفيًا بـ `ANNOUNCE_SKIP`، فلا يُنشر شيء.
- بخلاف ذلك، يُنشر رد الإعلان إلى قناة دردشة الطالب عبر استدعاء متابعة `agent` (`deliver=true`).
- تحافظ ردود الإعلان على توجيه الخيوط/الموضوعات عند توفره (خيوط Slack، موضوعات Telegram، خيوط Matrix).
- تُطبَّع رسائل الإعلان إلى قالب مستقر:
  - `Status:` مشتق من نتيجة التشغيل (`success`، `error`، `timeout`، أو `unknown`).
  - `Result:` محتوى الملخص من خطوة الإعلان (أو `(not available)` إذا كان مفقودًا).
  - `Notes:` تفاصيل الخطأ وسياق مفيد آخر.
- لا يتم استنتاج `Status` من مخرجات النموذج؛ بل يأتي من إشارات نتيجة وقت التشغيل.

تتضمن حمولات الإعلان سطر إحصاءات في النهاية (حتى عند التغليف):

- زمن التشغيل (مثلًا `runtime 5m12s`)
- استخدام الرموز (إدخال/إخراج/إجمالي)
- التكلفة التقديرية عند تهيئة تسعير النموذج (`models.providers.*.models[].cost`)
- `sessionKey`، `sessionId`، ومسار النص الحرفي (حتى يتمكن الوكيل الرئيسي من جلب السجل عبر `sessions_history` أو فحص الملف على القرص)

## سياسة الأداة (أدوات الوكيل الفرعي)

افتراضيًا، يحصل الوكلاء الفرعيون على **جميع الأدوات باستثناء أدوات الجلسة**:

- `sessions_list`
- `sessions_history`
- `sessions_send`
- `sessions_spawn`

التجاوز عبر التهيئة:

```json5
{
  agents: {
    defaults: {
      subagents: {
        maxConcurrent: 1,
      },
    },
  },
  tools: {
    subagents: {
      tools: {
        // deny wins
        deny: ["gateway", "cron"],
        // if allow is set, it becomes allow-only (deny still wins)
        // allow: ["read", "exec", "process"]
      },
    },
  },
}
```

## التزامن

يستخدم الوكلاء الفرعيون مسار قائمة انتظار مخصص داخل العملية:

- اسم المسار: `subagent`
- التزامن: `agents.defaults.subagents.maxConcurrent` (الافتراضي `8`)

## الإيقاف

- إرسال `/stop` في دردشة الطالب يُجهض جلسة الطالب ويوقف أي تشغيلات وكلاء فرعيين نشطة تم إنشاؤها منها.

## القيود

- إعلان الوكيل الفرعي «أفضل جهد». إذا أُعيد تشغيل Gateway، تُفقد أعمال «الإعلان الرجوعي» المعلّقة.
- ما يزال الوكلاء الفرعيون يشتركون في موارد عملية Gateway نفسها؛ تعامل مع `maxConcurrent` كصمام أمان.
- `sessions_spawn` دائمًا غير حاجز: يُعيد `{ status: "accepted", runId, childSessionKey }` فورًا.
- سياق الوكيل الفرعي يحقن فقط `AGENTS.md` + `TOOLS.md` (ولا يشمل `SOUL.md`، `IDENTITY.md`، `USER.md`، `HEARTBEAT.md`، أو `BOOTSTRAP.md`).
