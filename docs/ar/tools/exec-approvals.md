---
summary: "موافقات exec، قوائم السماح، ومطالبات الهروب من sandbox"
read_when:
  - تهيئة موافقات exec أو قوائم السماح
  - تنفيذ تجربة مستخدم موافقات exec في تطبيق macOS
  - مراجعة مطالبات الهروب من sandbox وتداعياتها
title: "موافقات Exec"
---

# موافقات Exec

موافقات exec هي **حاجز أمان التطبيق المُرافِق / مضيف العُقدة** الذي يسمح لوكيل يعمل داخل sandbox
بتشغيل أوامر على مضيف حقيقي (`gateway` أو `node`). يمكن التفكير فيها كقفل أمان:
لا يُسمح بالأوامر إلا عندما تتوافق السياسة + قائمة السماح + (اختياريًا) موافقة المستخدم جميعًا.
تُعد موافقات exec **إضافةً** إلى سياسة الأداة والتحكم المُعزَّز (إلا إذا كان elevated مضبوطًا على `full`، والذي يتجاوز الموافقات).
السياسة الفعّالة هي **الأكثر صرامة** بين `tools.exec.*` وافتراضيات الموافقات؛ وإذا أُهمل حقل من حقول الموافقات، تُستخدم قيمة `tools.exec`.

إذا كانت واجهة التطبيق المُرافِق **غير متاحة**، فإن أي طلب يتطلب مطالبة
يُحسم عبر **ask fallback** (الافتراضي: الرفض).

## حيثما ينطبق

تُفرض موافقات exec محليًا على مضيف التنفيذ:

- **gateway host** → عملية `openclaw` على جهاز Gateway
- **node host** → مُشغِّل العُقدة (تطبيق macOS المُرافِق أو مضيف عُقدة دون واجهة)

انقسام macOS:

- **خدمة مضيف العُقدة** تُمرِّر `system.run` إلى **تطبيق macOS** عبر IPC محلي.
- **تطبيق macOS** يفرض الموافقات + ينفّذ الأمر ضمن سياق واجهة المستخدم.

## الإعدادات والتخزين

تُخزَّن الموافقات في ملف JSON محلي على مضيف التنفيذ:

`~/.openclaw/exec-approvals.json`

مخطط مثال:

```json
{
  "version": 1,
  "socket": {
    "path": "~/.openclaw/exec-approvals.sock",
    "token": "base64url-token"
  },
  "defaults": {
    "security": "deny",
    "ask": "on-miss",
    "askFallback": "deny",
    "autoAllowSkills": false
  },
  "agents": {
    "main": {
      "security": "allowlist",
      "ask": "on-miss",
      "askFallback": "deny",
      "autoAllowSkills": true,
      "allowlist": [
        {
          "id": "B0C8C0B3-2C2D-4F8A-9A3C-5A4B3C2D1E0F",
          "pattern": "~/Projects/**/bin/rg",
          "lastUsedAt": 1737150000000,
          "lastUsedCommand": "rg -n TODO",
          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"
        }
      ]
    }
  }
}
```

## مقابض السياسة

### الأمان (`exec.security`)

- **deny**: حظر جميع طلبات exec على المضيف.
- **allowlist**: السماح فقط بالأوامر المدرجة في قائمة السماح.
- **full**: السماح بكل شيء (مكافئ للوضع المُعزَّز).

### السؤال (`exec.ask`)

- **off**: عدم المطالبة أبدًا.
- **on-miss**: المطالبة فقط عندما لا تتطابق قائمة السماح.
- **always**: المطالبة عند كل أمر.

### بديل السؤال (`askFallback`)

إذا كانت المطالبة مطلوبة ولكن لا توجد واجهة مستخدم يمكن الوصول إليها، يحدد البديل القرار:

- **deny**: الحظر.
- **allowlist**: السماح فقط إذا تطابقت قائمة السماح.
- **full**: السماح.

## قائمة السماح (لكل وكيل)

قوائم السماح تكون **لكل وكيل**. إذا وُجد عدة وكلاء، بدّل الوكيل الذي تعدّل إعداداته في تطبيق macOS. الأنماط هي **مطابقات glob غير حسّاسة لحالة الأحرف**.
يجب أن تُحلّ الأنماط إلى **مسارات ثنائيات** (تجاهَل الإدخالات التي تقتصر على اسم الملف).
تُرحَّل إدخالات `agents.default` القديمة إلى `agents.main` عند التحميل.

أمثلة:

- `~/Projects/**/bin/peekaboo`
- `~/.local/bin/*`
- `/opt/homebrew/bin/rg`

يتتبع كل إدخال في قائمة السماح ما يلي:

- **id**: UUID ثابت يُستخدم لهوية الواجهة (اختياري)
- **آخر استخدام**: طابع زمني
- **آخر أمر مستخدم**
- **آخر مسار محلول**

## السماح التلقائي لأدوات Skills عبر CLI

عند تمكين **Auto-allow skill CLIs**، تُعامَل الملفات التنفيذية المشار إليها بواسطة Skills المعروفة
على أنها مُدرجة في قائمة السماح على العُقد (عُقدة macOS أو مضيف عُقدة دون واجهة). يستخدم ذلك
`skills.bins` عبر استدعاء RPC لـ Gateway لجلب قائمة ثنائيات Skills. عطّل هذا الخيار إذا كنت تريد قوائم سماح يدوية صارمة.

## الثنائيات الآمنة (stdin-only)

يعرّف `tools.exec.safeBins` قائمة صغيرة من الثنائيات **التي تعمل على stdin فقط** (على سبيل المثال `jq`)
والتي يمكن تشغيلها في وضع قائمة السماح **من دون** إدخالات صريحة في قائمة السماح. ترفض الثنائيات الآمنة
وسائط الملفات الموضعية والرموز الشبيهة بالمسارات، لذا لا يمكنها إلا العمل على الدفق الوارد.
لا يُسمح تلقائيًا بتسلسل الأوامر وإعادة التوجيه في وضع قائمة السماح.

يُسمح بتسلسل الأوامر (`&&`، `||`، `;`) عندما يلبّي كل مقطع علوي متطلبات قائمة السماح
(بما في ذلك الثنائيات الآمنة أو السماح التلقائي للـ Skills). تظل عمليات إعادة التوجيه غير مدعومة في وضع قائمة السماح.
يُرفض استبدال الأوامر (`$()` / backticks) أثناء تحليل قائمة السماح، بما في ذلك داخل
علامات الاقتباس المزدوجة؛ استخدم علامات الاقتباس المفردة إذا احتجت نص `$()` حرفيًا.

الثنائيات الآمنة الافتراضية: `jq`، `grep`، `cut`، `sort`، `uniq`، `head`، `tail`، `tr`، `wc`.

## تحرير واجهة التحكم

استخدم بطاقة **Control UI → Nodes → Exec approvals** لتحرير الافتراضيات،
وتجاوزات كل وكيل، وقوائم السماح. اختر نطاقًا (الافتراضيات أو وكيلًا)، وعدّل السياسة،
وأضِف/أزِل أنماط قائمة السماح، ثم **احفظ**. تعرض الواجهة بيانات **آخر استخدام**
لكل نمط لمساعدتك على إبقاء القائمة مرتبة.

يختار محدِّد الهدف **Gateway** (موافقات محلية) أو **Node**. يجب على العُقد
الإعلان عن `system.execApprovals.get/set` (تطبيق macOS أو مضيف عُقدة دون واجهة).
إذا لم تُعلن العُقدة عن موافقات exec بعد، حرّر ملفها المحلي
`~/.openclaw/exec-approvals.json` مباشرةً.

CLI: يدعم `openclaw approvals` التحرير على Gateway أو العُقدة (انظر [Approvals CLI](/cli/approvals)).

## تدفّق الموافقة

عند الحاجة إلى مطالبة، يبثّ Gateway `exec.approval.requested` إلى عملاء المشغّلين.
تحسم واجهة التحكم وتطبيق macOS الأمر عبر `exec.approval.resolve`، ثم يمرّر Gateway
الطلب المُعتمد إلى مضيف العُقدة.

عند طلب الموافقات، تعيد أداة exec فورًا مُعرّف موافقة. استخدم هذا المعرّف
للربط مع أحداث النظام اللاحقة (`Exec finished` / `Exec denied`). إذا لم يصل قرار قبل
انقضاء المهلة، يُعامَل الطلب كمهلة موافقة ويُعرض كسبب للرفض.

يتضمن مربع حوار التأكيد:

- الأمر + الوسائط
- cwd
- معرّف الوكيل
- مسار الملف التنفيذي المُحلول
- بيانات تعريف المضيف + السياسة

الإجراءات:

- **Allow once** → التنفيذ الآن
- **Always allow** → الإضافة إلى قائمة السماح + التنفيذ
- **Deny** → الحظر

## تمرير الموافقات إلى قنوات الدردشة

يمكنك تمرير مطالبات موافقات exec إلى أي قناة دردشة (بما في ذلك قنوات الإضافات)
والموافقة عليها باستخدام `/approve`. يستخدم ذلك خط تسليم الإخراج الاعتيادي.

التهيئة:

```json5
{
  approvals: {
    exec: {
      enabled: true,
      mode: "session", // "session" | "targets" | "both"
      agentFilter: ["main"],
      sessionFilter: ["discord"], // substring or regex
      targets: [
        { channel: "slack", to: "U12345678" },
        { channel: "telegram", to: "123456789" },
      ],
    },
  },
}
```

الرد في الدردشة:

```
/approve <id> allow-once
/approve <id> allow-always
/approve <id> deny
```

### تدفّق IPC على macOS

```
Gateway -> Node Service (WS)
                 |  IPC (UDS + token + HMAC + TTL)
                 v
             Mac App (UI + approvals + system.run)
```

ملاحظات أمنية:

- وضع مقبس Unix `0600`، مع تخزين الرمز في `exec-approvals.json`.
- فحص النظير بذات UID.
- تحدّي/استجابة (nonce + رمز HMAC + تجزئة الطلب) + مدة صلاحية قصيرة.

## أحداث النظام

تظهر دورة حياة Exec كرسائل للنظام:

- `Exec running` (فقط إذا تجاوز الأمر عتبة إشعار التشغيل)
- `Exec finished`
- `Exec denied`

تُنشر هذه الرسائل في جلسة الوكيل بعد أن تُبلّغ العُقدة بالحدث.
تُصدر موافقات exec على مضيف Gateway أحداث دورة الحياة نفسها عند اكتمال الأمر (واختياريًا عند التشغيل لفترة أطول من العتبة).
تعيد عمليات exec المقيّدة بالموافقة استخدام مُعرّف الموافقة كـ `runId` في هذه الرسائل لتسهيل الربط.

## التداعيات

- **full** قوي؛ فضّل قوائم السماح عندما يكون ذلك ممكنًا.
- **ask** يُبقيك على اطّلاع مع السماح بموافقات سريعة.
- قوائم السماح لكل وكيل تمنع تسرّب موافقات وكيل إلى آخر.
- تنطبق الموافقات فقط على طلبات exec على المضيف من **مرسلين مُخوّلين**. لا يمكن للمرسلين غير المُخوّلين إصدار `/exec`.
- `/exec security=full` وسيلة راحة على مستوى الجلسة للمشغّلين المُخوّلين ويتجاوز الموافقات تصميميًا.
  لحظر exec على المضيف حظرًا صارمًا، اضبط أمان الموافقات على `deny` أو امنع أداة `exec` عبر سياسة الأدوات.

ذو صلة:

- [Exec tool](/tools/exec)
- [Elevated mode](/tools/elevated)
- [Skills](/tools/skills)
