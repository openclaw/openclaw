---
summary: "مرجع: قواعد تنقية وإصلاح نصوص المحادثات الخاصة بكل موفّر"
read_when:
  - أنت تقوم بتصحيح حالات رفض طلبات الموفّر المرتبطة ببنية النص
  - أنت تغيّر منطق تنقية نصوص المحادثات أو إصلاح استدعاءات الأدوات
  - أنت تحقق في عدم تطابق معرّفات استدعاءات الأدوات عبر الموفّرين
title: "reference/transcript-hygiene.md"
---

# Transcript Hygiene (Provider Fixups)

يصف هذا المستند **إصلاحات خاصة بكل موفّر** تُطبَّق على نصوص المحادثات قبل التشغيل
(بناء سياق النموذج). هذه تعديلات **في الذاكرة** تُستخدم لتلبية متطلبات صارمة
لدى الموفّرين. لا تقوم خطوات النظافة هذه **بإعادة كتابة** ملف JSONL المخزَّن
على القرص؛ ومع ذلك، قد تقوم مرحلة إصلاح منفصلة لملفات الجلسة بإعادة كتابة ملفات
JSONL المشوّهة عبر إسقاط الأسطر غير الصالحة قبل تحميل الجلسة. عند حدوث إصلاح،
يتم إنشاء نسخة احتياطية من الملف الأصلي إلى جانب ملف الجلسة.

يشمل النطاق:

- تسريحية معرف أداة الاتصال
- التحقق من مدخلات استدعاءات الأدوات
- إصلاح اقتران نتائج الأدوات
- التحقق من الأدوار / الترتيب
- تنظيف تواقيع الأفكار
- تسلية حمولة الصورة

إذا كنت بحاجة إلى تفاصيل تخزين نصوص المحادثات، فراجع:

- [/reference/session-management-compaction](/reference/session-management-compaction)

---

## أين يتم التنفيذ

تتم مركزة جميع عمليات نظافة نصوص المحادثات في المشغّل المضمّن:

- اختيار السياسة: `src/agents/transcript-policy.ts`
- تطبيق التنقية/الإصلاح: `sanitizeSessionHistory` في `src/agents/pi-embedded-runner/google.ts`

تستخدم السياسة `provider` و`modelApi` و`modelId` لتحديد ما يجب تطبيقه.

وبشكل منفصل عن نظافة نصوص المحادثات، يتم إصلاح ملفات الجلسة (عند الحاجة) قبل التحميل:

- `repairSessionFileIfNeeded` في `src/agents/session-file-repair.ts`
- يتم استدعاؤه من `run/attempt.ts` و`compact.ts` (المشغّل المضمّن)

---

## قاعدة عامة: تنقية الصور

تُعقَّم حمولات الصور دائمًا لمنع الرفض من جانب الموفّر بسبب حدود الحجم
(تصغير/إعادة ضغط صور base64 كبيرة الحجم).

التنفيذ:

- `sanitizeSessionMessagesImages` في `src/agents/pi-embedded-helpers/images.ts`
- `sanitizeContentBlocksImages` في `src/agents/tool-images.ts`

---

## قاعدة عامة: استدعاءات الأدوات المشوّهة

تُسقَط كتل استدعاء الأدوات من المساعد التي تفتقد كِلا `input` و`arguments`
قبل بناء سياق النموذج. يمنع ذلك حالات الرفض من الموفّر الناتجة عن استدعاءات أدوات
مُحفوظة جزئيًا (على سبيل المثال، بعد فشل بسبب حدّ المعدّل).

التنفيذ:

- `sanitizeToolCallInputs` في `src/agents/session-transcript-repair.ts`
- يُطبَّق في `sanitizeSessionHistory` في `src/agents/pi-embedded-runner/google.ts`

---

## مصفوفة الموفّرين (السلوك الحالي)

**OpenAI / OpenAI Codex**

- تنقية الصور فقط.
- عند التبديل إلى OpenAI Responses/Codex، يتم إسقاط تواقيع التفكير اليتيمة (عناصر تفكير مستقلة بلا كتلة محتوى لاحقة).
- لا توجد تنقية لمعرّفات استدعاءات الأدوات.
- لا يوجد إصلاح لاقتران نتائج الأدوات.
- لا يوجد تحقق من الأدوار أو إعادة ترتيب.
- لا توجد نتائج أدوات تركيبية.
- لا يوجد تفكير بتجريد من التوقيعات.

**Google (Generative AI / Gemini CLI / Antigravity)**

- أداة تسمى التسلية الشخصية: أبجدية رقمية صارمة.
- إصلاح اقتران نتائج الأدوات وإنشاء نتائج أدوات تركيبية.
- التحقق من الأدوار (تناوب الأدوار بنمط Gemini).
- إصلاح ترتيب الأدوار لدى Google (إضافة تمهيد مستخدم صغير جدًا إذا بدأ السجل بالمساعد).
- Antigravity Claude: توحيد تواقيع التفكير؛ إسقاط كتل التفكير غير الموقَّعة.

**Anthropic / Minimax (متوافق مع Anthropic)**

- إصلاح اقتران نتائج الأدوات وإنشاء نتائج أدوات تركيبية.
- التحقق من الأدوار (دمج أدوار المستخدم المتتالية للالتزام بالتناوب الصارم).

**Mistral (بما في ذلك الكشف المعتمد على معرّف النموذج)**

- تنقية معرّفات استدعاءات الأدوات: strict9 (طول 9 أبجدي-رقمي).

**OpenRouter Gemini**

- تنظيف تواقيع الأفكار: نزع قيم `thought_signature` غير base64 (والاحتفاظ بـ base64).

**غير ذلك**

- تنقية الصور فقط.

---

## السلوك التاريخي (قبل 2026.1.22)

قبل إصدار 2026.1.22، كان OpenClaw يطبّق طبقات متعددة من نظافة نصوص المحادثات:

- كانت هناك **إضافة transcript-sanitize** تعمل عند كل بناء للسياق ويمكنها:
  - إصلاح اقتران استخدام/نتيجة الأدوات.
  - تنقية معرّفات استدعاءات الأدوات (بما في ذلك وضع غير صارم يحافظ على `_`/`-`).
- كما كان المشغّل ينفّذ تنقية خاصة بالموفّرين، ما أدى إلى تكرار العمل.
- حدثت طفرات إضافية خارج سياسة الموفّر، بما في ذلك:
  - نزع وسوم `<final>` من نص المساعد قبل التخزين.
  - إسقاط أدوار أخطاء المساعد الفارغة.
  - اقتطاع محتوى المساعد بعد استدعاءات الأدوات.

تسببت هذه التعقيدات في تراجعات عبر الموفّرين (ولا سيما اقتران `openai-responses`
`call_id|fc_id`). أزال تنظيف 2026.1.22 الإضافة، وركّز المنطق في المشغّل،
وجعل OpenAI **دون لمس** باستثناء تنقية الصور.
