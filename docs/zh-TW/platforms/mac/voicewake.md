---
summary: "Mac 應用程式中的語音喚醒與一鍵發言 (Push-to-talk) 模式及路由詳情"
read_when:
  - 處理語音喚醒或 PTT 路徑時
title: "語音喚醒"
---

# 語音喚醒與一鍵發言 (Push-to-Talk)

## 模式

- **喚醒詞模式**（預設）：持續運行的語音識別器等待觸發詞 (`swabbleTriggerWords`)。匹配時開始擷取，顯示帶有部分文字的懸浮視窗，並在靜音後自動傳送。
- **一鍵發言 (Push-to-talk) (按住右側 Option 鍵)**：按住右側 Option 鍵立即開始擷取——無需觸發詞。按住時會出現懸浮視窗；放開後會完成輸入，並在短暫延遲後轉發，以便您調整文字。

## 執行階段行為 (喚醒詞)

- 語音識別器位於 `VoiceWakeRuntime` 中。
- 僅當喚醒詞與下一個詞之間存在**有意義的停頓**（約 0.55 秒間隔）時才會觸發。懸浮視窗/提示音甚至可以在指令開始前的停頓處啟動。
- 靜音窗口：說話流暢時為 2.0 秒，若僅聽到觸發詞則為 5.0 秒。
- 強制停止：120 秒，以防止失控的工作階段。
- 工作階段間的防抖 (Debounce)：350 毫秒。
- 懸浮視窗透過 `VoiceWakeOverlayController` 驅動，具有已提交/不穩定文字的著色。
- 傳送後，識別器會乾淨地重新啟動以監聽下一次觸發。

## 生命週期不變量

- 若已啟用語音喚醒並授予權限，喚醒詞識別器應始終處於監聽狀態（執行明確的一鍵發言擷取時除外）。
- 懸浮視窗的可見性（包括透過 X 按鈕手動關閉）絕對不能阻止識別器恢復。

## 懸浮視窗卡住故障模式（先前）

先前，若懸浮視窗卡在可見狀態且您手動關閉它，語音喚醒可能會顯得「失效」，因為運行時的重新啟動嘗試可能會被懸浮視窗的可見性阻擋，且未安排後續的重新啟動。

強化措施：

- 喚醒運行時的重新啟動不再受懸浮視窗可見性阻擋。
- 懸浮視窗關閉完成會透過 `VoiceSessionCoordinator` 觸發 `VoiceWakeRuntime.refresh(...)`，因此手動 X 關閉一律會恢復監聽。

## 一鍵發言細節

- 熱鍵偵測使用全域 `.flagsChanged` 監視器監控**右側 Option** (`keyCode 61` + `.option`)。我們僅觀察事件（不攔截）。
- 擷取流程位於 `VoicePushToTalk`：立即啟動語音識別，將部分內容串流傳輸至懸浮視窗，並在放開時呼叫 `VoiceWakeForwarder`。
- 當一鍵發言開始時，我們會暫停喚醒詞運行時，以避免音訊擷取衝突；放開後會自動重新啟動。
- 權限：需要麥克風與語音識別；查看事件需要「輔助功能」/「輸入監控」核准。
- 外部鍵盤：某些鍵盤可能無法如預期顯示右側 Option 鍵——若使用者回報遺漏，請提供備用快捷鍵。

## 使用者介面設定

- **語音喚醒**開關：啟用喚醒詞運行時。
- **按住 Cmd+Fn 發言**：啟用一鍵發言監視器。在 macOS < 26 版本中禁用。
- 語言與麥克風選取器、即時音量表、觸發詞表格、測試器（僅限本地，不轉發）。
- 若裝置斷開連接，麥克風選取器會保留最後一次選擇，顯示斷開提示，並暫時切換回系統預設值，直到裝置返回。
- **聲音**：偵測到觸發與傳送時播放鈴聲；預設為 macOS 的「Glass」系統音效。您可以為每個事件選擇任何可由 `NSSound` 載入的檔案（例如 MP3/WAV/AIFF），或選擇**無聲音**。

## 轉發行為

- 啟用語音喚醒後，逐字稿會轉發至啟用的 Gateway/智慧代理（與 Mac 應用程式其餘部分使用的本地 vs 遠端模式相同）。
- 回覆將傳送至**最後使用的主要供應商** (WhatsApp/Telegram/Discord/WebChat)。若傳送失敗，則會記錄錯誤，且該次執行仍可透過 WebChat/工作階段日誌查看。

## 轉發承載資料 (Payload)

- `VoiceWakeForwarder.prefixedTranscript(_:)` 在傳送前會在逐字稿前加上機器提示。由喚醒詞與一鍵發言路徑共用。

## 快速驗證

- 開啟一鍵發言，按住 Cmd+Fn，說話，放開：懸浮視窗應顯示部分文字後傳送。
- 按住時，選單列的耳朵圖示應保持放大狀態（使用 `triggerVoiceEars(ttl:nil)`）；放開後則縮小。
