---
summary: "Mac App 中的語音喚醒和按鈕通話模式以及路由詳細資訊"
read_when:
  - 處理語音喚醒或 PTT 路徑時
title: "語音喚醒"
---

# 語音喚醒與按鈕通話

## 模式

- **喚醒詞模式** (預設)：始終開啟的語音辨識器等待觸發語音 (`swabbleTriggerWords`)。當匹配時，它會開始擷取、顯示帶有部分文字的疊層，並在靜音後自動傳送。
- **按鈕通話 (按住右側 Option 鍵)**：按住右側 Option 鍵可立即擷取——無需觸發。疊層會在按住時出現；釋放後會在短暫延遲後完成並轉發，以便您可以修改文字。

## 運行行為 (喚醒詞)

- 語音辨識器位於 `VoiceWakeRuntime` 中。
- 觸發只會在喚醒詞和下一個詞之間有**有意義的停頓**（約 0.55 秒的間隔）時觸發。疊層/提示音甚至可以在命令開始前的停頓時開始。
- 靜音視窗：語音流暢時為 2.0 秒，如果只聽到觸發語音則為 5.0 秒。
- 硬性停止：120 秒，以防止會話失控。
- 會話間的防抖動：350 毫秒。
- 疊層由 `VoiceWakeOverlayController` 驅動，具有提交/暫時的顏色。
- 傳送後，辨識器會重新啟動，以清晰地聆聽下一個觸發語音。

## 生命週期不變性

- 如果語音喚醒已啟用並已授予權限，喚醒詞辨識器應處於監聽狀態（除了明確的按鈕通話擷取期間）。
- 疊層的可見性（包括透過 X 按鈕手動關閉）絕不能阻止辨識器恢復。

## 黏性疊層故障模式 (舊版)

以前，如果疊層卡住可見並手動關閉它，語音喚醒可能會顯示為「停止運作」，因為運行的重新啟動嘗試可能會被疊層可見性阻止，並且沒有安排後續重新啟動。

強化：

- 喚醒運行重新啟動不再被疊層可見性阻止。
- 疊層關閉完成會透過 `VoiceSessionCoordinator` 觸發 `VoiceWakeRuntime.refresh(...)`，因此手動 X 關閉總是會恢復監聽。

## 按鈕通話細節

- 熱鍵偵測使用針對**右側 Option 鍵** (`keyCode 61` + `.option`) 的全域 `.flagsChanged` 監視器。我們只觀察事件（不吞噬）。
- 擷取管線位於 `VoicePushToTalk` 中：立即啟動語音，將部分文字串流到疊層，並在釋放時呼叫 `VoiceWakeForwarder`。
- 當按鈕通話開始時，我們會暫停喚醒詞運行，以避免音訊衝突；它會在釋放後自動重新啟動。
- 權限：需要麥克風 + 語音；查看事件需要輔助使用/輸入監控批准。
- 外接鍵盤：某些鍵盤可能無法如預期般顯示右側 Option 鍵——如果使用者報告遺漏，則提供備用快捷方式。

## 使用者設定

- **語音喚醒**開關：啟用喚醒詞運行。
- **按住 Cmd+Fn 說話**：啟用按鈕通話監視器。在 macOS < 26 上禁用。
- 語言和麥克風選擇器、即時音量表、觸發詞表、測試器（僅限本地；不轉發）。
- 如果裝置斷開連接，麥克風選擇器會保留上次選擇，顯示斷開連接提示，並暫時恢復到系統預設值，直到它返回。
- **聲音**：在偵測到觸發語音和傳送時發出提示音；預設為 macOS「Glass」系統聲音。您可以為每個事件選擇任何 `NSSound` 可加載檔案（例如 MP3/WAV/AIFF），或選擇**無聲音**。

## 轉發行為

- 當語音喚醒啟用時，轉錄會轉發到活動的 Gateway/智慧代理（與 Mac App 其餘部分使用的本地與遠端模式相同）。
- 回覆會傳遞到**上次使用的主供應商** (WhatsApp/Telegram/Discord/WebChat)。如果傳遞失敗，則會記錄錯誤，並且仍可透過 WebChat/會話日誌查看運行。

## 轉發負載

- `VoiceWakeForwarder.prefixedTranscript(_:)` 在傳送前預置機器提示。在喚醒詞和按鈕通話路徑之間共享。

## 快速驗證

- 開啟按鈕通話，按住 Cmd+Fn，說話，釋放：疊層應顯示部分文字然後傳送。
- 按住時，選單列耳朵應保持放大（使用 `triggerVoiceEars(ttl:nil)`）；釋放後它們會縮小。
