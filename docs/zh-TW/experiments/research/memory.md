---
summary: "研究筆記：Clawd 工作區的離線記憶體系統（Markdown 真實來源 + 衍生索引）"
read_when:
  - 設計超越每日 Markdown 日誌的工作區記憶體（~/.openclaw/workspace）
  - 決定：獨立 CLI 與深度 OpenClaw 整合
  - 新增離線回溯 + 反思（保留/回溯/反思）
title: "工作區記憶體研究"
---

# 工作區記憶體 v2 (離線)：研究筆記

目標：Clawd 樣式工作區（`agents.defaults.workspace`，預設 `~/.openclaw/workspace`），其中「記憶體」以每天一個 Markdown 檔案（`memory/YYYY-MM-DD.md`）加上一小組穩定檔案（例如 `memory.md`、`SOUL.md`）的形式儲存。

本文件提出一種**離線優先**的記憶體架構，該架構將 Markdown 保留為規範的、可審查的真實來源，但透過衍生索引新增了**結構化回溯**（搜尋、實體摘要、信心更新）。

## 為何變更？

目前的設定（每天一個檔案）非常適合：

- 「僅新增」日誌
- 人工編輯
- 由 git 支援的持久性 + 可稽核性
- 低摩擦的擷取（「只需寫下來」）

它在以下方面較弱：

- 高回溯檢索（「我們對 X 做了什麼決定？」，「上次我們嘗試 Y？」）
- 以實體為中心的答案（「告訴我關於 Alice / The Castle / warelay 的資訊」），而無需重新閱讀許多檔案
- 意見/偏好穩定性（以及變更時的證據）
- 時間限制（「2025 年 11 月有哪些真實資訊？」）和衝突解決

## 設計目標

- **離線**：無需網路即可運作；可在筆記型電腦/Castle 上執行；無雲端依賴。
- **可解釋性**：檢索到的項目應可歸因（檔案 + 位置），並可與推斷分離。
- **低儀式**：每日日誌保持 Markdown 格式，無需繁重的綱要工作。
- **增量**：v1 僅使用 FTS 即可發揮作用；語義/向量和圖形是可選升級。
- **對智慧代理友善**：使「在權杖預算內回溯」變得容易（返回小捆事實）。

## 北極星模型 (Hindsight × Letta)

兩部分結合：

1.  **Letta/MemGPT 樣式控制迴圈**

- 始終在上下文中小而「核心」的內容（人物誌 + 關鍵使用者事實）
- 其他所有內容都在上下文之外，並透過工具檢索
- 記憶體寫入是明確的工具呼叫（新增/取代/插入），持久化，然後在下一個回合中重新注入

2.  **Hindsight 樣式記憶體底層**

- 分離觀察到的內容、相信的內容和摘要的內容
- 支援保留/回溯/反思
- 具有信心值的意見，可隨證據演變
- 實體感知檢索 + 時間查詢（即使沒有完整的知識圖譜）

## 建議架構 (Markdown 真實來源 + 衍生索引)

### 規範儲存 (對 git 友善)

將 `~/.openclaw/workspace` 保留為規範的人類可讀記憶體。

建議的工作區佈局：

```
~/.openclaw/workspace/
  memory.md                    # 小：持久事實 + 偏好（核心）
  memory/
    YYYY-MM-DD.md              # 每日日誌（新增；敘事）
  bank/                        # 「型別化」記憶體頁面（穩定，可審查）
    world.md                   # 關於世界的客觀事實
    experience.md              # 智慧代理做了什麼（第一人稱）
    opinions.md                # 主觀偏好/判斷 + 信心 + 證據指標
    entities/
      Peter.md
      The-Castle.md
      warelay.md
      ...
```

筆記：

- **每日日誌保持每日日誌**。無需將其轉換為 JSON。
- `bank/` 檔案是經過**策劃**的，由反思工作產生，仍可手動編輯。
- `memory.md` 保持「小而核心」：您希望 Clawd 在每個工作階段中看到的事物。

### 衍生儲存 (機器回溯)

在工作區下新增一個衍生索引（不一定由 git 追蹤）：

```
~/.openclaw/workspace/.memory/index.sqlite
```

支援：

- 用於事實 + 實體連結 + 意見中繼資料的 SQLite 綱要
- SQLite **FTS5** 用於詞彙回溯（快速、輕巧、離線）
- 可選的嵌入表格用於語義回溯（仍為離線）

該索引始終**可從 Markdown 重建**。

## 保留 / 回溯 / 反思 (操作迴圈)

### 保留：將每日日誌正規化為「事實」

Hindsight 在此處的關鍵見解：儲存**敘事性的、自包含的事實**，而不是微小的片段。

`memory/YYYY-MM-DD.md` 的實用規則：

- 在一天結束時（或期間），新增一個 `## Retain` 部分，其中包含 2–5 個項目，它們是：
  - 敘事性的（保留跨回合上下文）
  - 自包含的（獨立存在有意義）
  - 標記了型別 + 實體提及

範例：

```
## Retain
- W @Peter: Currently in Marrakech (Nov 27–Dec 1, 2025) for Andy’s birthday.
- B @warelay: I fixed the Baileys WS crash by wrapping connection.update handlers in try/catch (see memory/2025-11-27.md).
- O(c=0.95) @Peter: Prefers concise replies (&lt;1500 chars) on WhatsApp; long content goes into files.
```

最小解析：

- 型別前綴：`W` (世界)、`B` (經驗/傳記)、`O` (意見)、`S` (觀察/摘要；通常由生成)
- 實體：` @Peter`、` @warelay` 等（slugs 映射到 `bank/entities/*.md`）
- 意見信心：`O(c=0.0..1.0)` 可選

如果您不希望作者考慮它：反思工作可以從日誌的其餘部分推斷這些項目，但明確的 `## Retain` 部分是最簡單的「品質槓桿」。

### 回溯：對衍生索引進行查詢

回溯應支援：

- **詞彙**：「尋找確切的術語/名稱/命令」（FTS5）
- **實體**：「告訴我關於 X 的資訊」（實體頁面 + 實體連結的事實）
- **時間**：「11 月 27 日左右發生了什麼」/「自上週以來」
- **意見**：「Peter 偏好什麼？」（帶有信心 + 證據）

返回格式應對智慧代理友善並引用來源：

- `kind` (`world|experience|opinion|observation`)
- `timestamp` (來源日期，或存在的提取時間範圍)
- `entities` (`["Peter","warelay"]`)
- `content` (敘事事實)
- `source` (`memory/2025-11-27.md#L12` 等)

### 反思：產生穩定頁面 + 更新信念

反思是一項排程工作（每日或心跳 `ultrathink`），它：

- 從最近的事實更新 `bank/entities/*.md`（實體摘要）
- 根據強化/矛盾更新 `bank/opinions.md` 的信心
- 可選地建議編輯 `memory.md`（「核心」持久事實）

意見演變（簡單，可解釋）：

- 每個意見都有：
  - 陳述
  - 信心 `c ∈ [0,1]`
  - last_updated
  - 證據連結（支持 + 矛盾的事實 ID）
- 當新事實到來時：
  - 透過實體重疊 + 相似性（FTS 優先，嵌入稍後）尋找候選意見
  - 透過小增量更新信心；大跳躍需要強烈的矛盾 + 重複證據

## CLI 整合：獨立與深度整合

建議：**深度整合到 OpenClaw 中**，但保留可分離的核心程式庫。

### 為何整合到 OpenClaw 中？

- OpenClaw 已知曉：
  - 工作區路徑（`agents.defaults.workspace`）
  - 工作階段模型 + 心跳
  - 日誌記錄 + 疑難排解模式
- 您希望智慧代理本身呼叫工具：
  - `openclaw memory recall "…" --k 25 --since 30d`
  - `openclaw memory reflect --since 7d`

### 為何仍要拆分程式庫？

- 在沒有 Gateway/執行階段的情況下保持記憶體邏輯可測試
- 從其他上下文（本地指令碼、未來的桌面應用程式等）重用

形式：
記憶體工具旨在成為一個小型 CLI + 程式庫層，但這僅限於探索性。

## 「S-Collide」/ SuCo：何時使用它 (研究)

如果「S-Collide」指的是 **SuCo (Subspace Collision)**：這是一種 ANN 檢索方法，旨在透過在子空間中使用學習/結構化衝突來實現強大的召回率/延遲權衡（論文：arXiv 2411.14754, 2024）。

`~/.openclaw/workspace` 的實用方法：

- **不要從** SuCo 開始。
- 從 SQLite FTS + (可選) 簡單嵌入開始；您將立即獲得大多數 UX 優勢。
- 僅在以下情況才考慮 SuCo/HNSW/ScaNN 級別的解決方案：
  - 語料庫很大（數萬到數十萬個區塊）
  - 暴力嵌入搜尋變得太慢
  - 召回品質因詞彙搜尋而明顯受阻

離線友善的替代方案（複雜性遞增）：

- SQLite FTS5 + 中繼資料過濾器（零機器學習）
- 嵌入 + 暴力搜尋（如果區塊計數較低，效果出奇地好）
- HNSW 索引（常見、穩健；需要程式庫繫結）
- SuCo（研究級；如果有一個可靠的實作可以嵌入，則很有吸引力）

開放問題：

- 您的機器（筆記型電腦 + 桌上型電腦）上「個人助理記憶體」的**最佳**離線嵌入模型是什麼？
  - 如果您已經有 Ollama：使用本地模型嵌入；否則在工具鏈中提供一個小型嵌入模型。

## 最小實用試點

如果您想要一個最小但仍實用的版本：

- 在每日日誌中新增 `bank/` 實體頁面和 `## Retain` 部分。
- 使用 SQLite FTS 進行回溯，並提供引用（路徑 + 行號）。
- 僅在回溯品質或規模要求時才新增嵌入。

## 參考資料

- Letta / MemGPT 概念：「核心記憶體區塊」+「檔案記憶體」+ 工具驅動的自我編輯記憶體。
- Hindsight 技術報告：「保留/回溯/反思」、四網路記憶體、敘事事實提取、意見信心演變。
- SuCo：arXiv 2411.14754 (2024)：「Subspace Collision」近似最近鄰檢索。
