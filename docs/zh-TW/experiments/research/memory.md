---
summary: "研究筆記：Clawd 工作空間的離線記憶體系統 (以 Markdown 為單一事實來源 + 衍生索引)"
read_when:
  - 在設計除了每日 Markdown 日誌之外的工作空間記憶體 (~/.openclaw/workspace) 時
  - 在決定：獨立 CLI 與深度 OpenClaw 整合之間時
  - 在增加離線回想與反思（留存/回想/反思）功能時
title: "工作空間記憶體研究"
---

# 工作空間記憶體 v2 (離線)：研究筆記

目標：Clawd 風格的工作空間 (`agents.defaults.workspace`，預設為 `~/.openclaw/workspace`)，其中「記憶體」以每天一個 Markdown 檔案的形式儲存 (`memory/YYYY-MM-DD.md`)，外加一組穩定的檔案（例如 `memory.md`, `SOUL.md`）。

本文件提出了一種**離線優先**的記憶體架構，將 Markdown 保持為正規且可供審閱的單一事實來源，同時透過衍生索引增加**結構化回想**（搜尋、實體摘要、信心值更新）。

## 為什麼要改變？

目前的設定（每天一個檔案）非常適合：

- 「僅限附加」的日誌記錄
- 人工編輯
- git 支援的持久性與可稽核性
- 低摩擦的擷取（「寫下來就好」）

但它在以下方面表現較弱：

- 高回想率的檢索（「關於 X 我們決定了什麼？」、「上次我們嘗試 Y 的結果？」）
- 以實體為中心的回答（「告訴我關於 Alice / The Castle / warelay 的資訊」），而不需要重新閱讀許多檔案
- 觀點/偏好的穩定性（以及當它改變時的證據）
- 時間限制（「2025 年 11 月期間什麼是正確的？」）以及衝突解決

## 設計目標

- **離線**：無需網路即可運作；可以在筆記型電腦/Castle 上執行；無雲端依賴。
- **可解釋性**：檢索到的項目應該是可溯源的（檔案 + 位置），且與推論分離。
- **低儀式感**：每日日誌保持 Markdown 格式，不需要沉重的 Schema 定義工作。
- **漸進式**：v1 僅使用 FTS（全文檢索）即具實用性；語意/向量與圖譜是可選的升級項目。
- **智慧代理友善**：讓「在 Token 預算內回想」變得容易（傳回小束的事實）。

## 北極星模型 (Hindsight × Letta)

混合兩個部分：

1. **Letta/MemGPT 風格的控制迴圈**

- 在上下文 (Context) 中始終保留一小部分「核心」（人格特質 + 關鍵使用者事實）
- 其他所有內容都在上下文之外，並透過工具檢索
- 記憶體寫入是顯式的工具呼叫（附加/取代/插入），持久化後在下一回合重新注入

2. **Hindsight 風格的記憶體基質**

- 將觀察到的內容、相信的內容與總結的內容分開
- 支援留存/回想/反思
- 帶有信心值的觀點，可隨證據演進
- 實體感知檢索 + 時間查詢（即使沒有完整的知識圖譜）

## 建議架構 (Markdown 為單一事實來源 + 衍生索引)

### 正規儲存庫 (Git 友善)

保持 `~/.openclaw/workspace` 作為正規的人類可讀記憶體。

建議的工作空間佈局：

```
~/.openclaw/workspace/
  memory.md                    # 小型：持久的事實 + 偏好（核心性質）
  memory/
    YYYY-MM-DD.md              # 每日日誌（附加；敘事性）
  bank/                        # 「具類型」的記憶體頁面（穩定、可審閱）
    world.md                   # 關於世界的客觀事實
    experience.md              # 智慧代理做了什麼（第一人稱）
    opinions.md                # 主觀偏好/判斷 + 信心值 + 證據指標
    entities/
      Peter.md
      The-Castle.md
      warelay.md
      ...
```

注意事項：

- **每日日誌保持為每日日誌**。不需要將其轉換為 JSON。
- `bank/` 檔案是**經過精選的**，由反思任務產生，且仍可手動編輯。
- `memory.md` 保持「小型且核心性質」：你希望 Clawd 在每個工作階段都能看到的內容。

### 衍生儲存庫 (機器回想)

在工作空間下增加一個衍生索引（不一定要由 git 追蹤）：

```
~/.openclaw/workspace/.memory/index.sqlite
```

其背後支援：

- 用於事實 + 實體連結 + 觀點元資料的 SQLite Schema
- 用於詞彙回想的 SQLite **FTS5**（快速、微型、離線）
- 可選的用於語意回想的嵌入 (Embeddings) 資料表（仍為離線）

該索引始終可以**從 Markdown 重新建置**。

## 留存 / 回想 / 反思 (操作迴圈)

### 留存：將每日日誌正規化為「事實」

Hindsight 的關鍵見解在此非常重要：儲存**敘事性的、自帶上下文的事實**，而不是微小的片段。

`memory/YYYY-MM-DD.md` 的實踐規則：

- 在一天結束時（或期間），增加一個 `## Retain` 區段，包含 2-5 個點列式項目，且具備：
  - 敘事性（保留跨回合的上下文）
  - 自帶上下文（以後單獨看也有意義）
  - 標記類型 + 實體提及

範例：

```
## Retain
- W @Peter：目前在馬拉喀什（2025 年 11 月 27 日至 12 月 1 日）慶祝 Andy 的生日。
- B @warelay：我透過將 connection.update 處理程式包裝在 try/catch 中，修復了 Baileys WS 的當機問題（參見 memory/2025-11-27.md）。
- O(c=0.95) @Peter：在 WhatsApp 上偏好簡潔的回覆（<1500 字元）；長內容則放入檔案中。
```

最小化解析：

- 類型前綴：`W` (世界), `B` (經歷/傳記), `O` (觀點), `S` (觀察/總結；通常由系統產生)
- 實體：` @Peter`, ` @warelay` 等（代稱對應至 `bank/entities/*.md`）
- 觀點信心值：可選的 `O(c=0.0..1.0)`

如果你不希望作者考慮這些：反思任務可以從日誌的其餘部分推論出這些點列式項目，但擁有一個顯式的 `## Retain` 區段是最簡單的「品質槓桿」。

### 回想：對衍生索引進行查詢

回想應支援：

- **詞彙**：「尋找精確的詞彙 / 名稱 / 指令」(FTS5)
- **實體**：「告訴我關於 X 的資訊」（實體頁面 + 與實體連結的事實）
- **時間**：「11 月 27 日左右發生了什麼」/「自上週以來」
- **觀點**：「Peter 的偏好是什麼？」 (帶有信心值 + 證據)

回傳格式應對智慧代理友善並引用來源：

- `kind` (`world|experience|opinion|observation`)
- `timestamp` (來源日期，或擷取到的時間範圍)
- `entities` (`["Peter","warelay"]`)
- `content` (敘事性事實)
- `source` (`memory/2025-11-27.md#L12` 等)

### 反思：產生穩定頁面 + 更新信念

反思是一個排程任務（每日或心跳 `ultrathink`），負責：

- 根據最近的事實更新 `bank/entities/*.md`（實體摘要）
- 根據強化/矛盾情況更新 `bank/opinions.md` 的信心值
- 可選地建議對 `memory.md` 的編輯（「核心性質」的持久事實）

觀點演進（簡單、可解釋）：

- 每個觀點都有：
  - 陳述
  - 信心值 `c ∈ [0,1]`
  - 最後更新時間 (last_updated)
  - 證據連結（支持 + 矛盾的事實 ID）
- 當新事實到達時：
  - 透過實體重疊 + 相似度尋找候選觀點（先 FTS，後嵌入）
  - 透過微小的增量更新信心值；巨大的跳躍需要強烈的矛盾 + 重複的證據

## CLI 整合：獨立 vs 深度整合

建議：**在 OpenClaw 中進行深度整合**，但保留一個可分離的核心函式庫。

### 為什麼整合到 OpenClaw 中？

- OpenClaw 已經知道：
  - 工作空間路徑 (`agents.defaults.workspace`)
  - 工作階段模型 + 心跳
  - 日誌記錄 + 疑難排解模式
- 你希望智慧代理本身能呼叫這些工具：
  - `openclaw memory recall "…" --k 25 --since 30d`
  - `openclaw memory reflect --since 7d`

### 為什麼仍要拆分函式庫？

- 在沒有 Gateway/執行環境的情況下保持記憶體邏輯的可測試性
- 從其他上下文重複使用（本地指令稿、未來的桌面應用程式等）

形式：
記憶體工具旨在成為一個小型 CLI + 函式庫層，但這僅為探索性質。

## “S-Collide” / SuCo：何時使用 (研究)

如果 “S-Collide” 指的是 **SuCo (Subspace Collision)**：這是一種近似最近鄰 (ANN) 檢索方法，透過在子空間中使用學習/結構化碰撞來平衡強回想率與延遲 (論文：arXiv 2411.14754, 2024)。

對於 `~/.openclaw/workspace` 的務實看法：

- **不要從 SuCo 開始**。
- 從 SQLite FTS +（可選）簡單的嵌入開始；你將立即獲得大部分使用者體驗上的提升。
- 僅在以下情況考慮 SuCo/HNSW/ScaNN 等級的解決方案：
  - 語料庫龐大（數萬/數十萬個片段）
  - 暴力嵌入搜尋變得太慢
  - 回想品質受到詞彙搜尋的明顯瓶頸

離線友善的替代方案（複雜度遞增）：

- SQLite FTS5 + 元資料過濾（無需機器學習）
- 嵌入 + 暴力搜尋（如果片段數量較少，效果出奇地好）
- HNSW 索引（常見、穩健；需要函式庫綁定）
- SuCo（研究等級；如果有穩定的實作可供嵌入，則很有吸引力）

待解決問題：

- 對於你機器（筆記型電腦 + 桌上型電腦）上的「個人助理記憶體」，**最佳**的離線嵌入模型是什麼？
  - 如果你已經有 Ollama：使用本地模型進行嵌入；否則在工具鏈中隨附一個小型嵌入模型。

## 最小可用原型 (Pilot)

如果你想要一個最小化但仍具實用性的版本：

- 在每日日誌中增加 `bank/` 實體頁面和 `## Retain` 區段。
- 使用 SQLite FTS 進行帶有引用的回想（路徑 + 行號）。
- 僅在回想品質或規模有需求時才增加嵌入。

## 參考資料

- Letta / MemGPT 概念：「核心記憶體區塊」+「封存記憶體」+ 工具驅動的自我編輯記憶體。
- Hindsight 技術報告：「留存 / 回想 / 反思」、四網路記憶體、敘事性事實擷取、觀點信心值演進。
- SuCo: arXiv 2411.14754 (2024): 「子空間碰撞」(Subspace Collision) 近似最近鄰檢索。
