---
summary: "Clawnet 重構：統一網路協定、角色、身份驗證、核准、身份"
read_when:
  - 規劃節點 + 操作員用戶端的統一網路協定時
  - 重新設計跨裝置的核准、配對、TLS 和存在狀態
title: "Clawnet 重構"
---

# Clawnet 重構 (協定 + 身份驗證統一)

## 嗨

嗨 Peter — 方向很棒；這將解鎖更簡單的使用者體驗 + 更強大的安全性。

## 目的

一份嚴謹的單一檔案，用於：

- 現狀：協定、流程、信任邊界。
- 痛點：核准、多跳路由、使用者介面重複。
- 提議的新狀態：單一協定、有範圍的角色、統一的身份驗證/配對、TLS 釘選。
- 身份模型：穩定 ID + 可愛代稱。
- 遷移計畫、風險、待解決問題。

## 目標 (來自討論)

- 所有用戶端的單一協定 (mac 應用程式、命令列介面、iOS、Android、無頭節點)。
- 每個網路參與者都經過身份驗證 + 配對。
- 角色清晰度：節點 vs 操作員。
- 中央核准路由到使用者所在的位置。
- 所有遠端流量的 TLS 加密 + 可選釘選。
- 最小化程式碼重複。
- 單一機器應僅出現一次 (無使用者介面/節點重複條目)。

## 非目標 (明確)

- 移除功能分離 (仍需要最小權限)。
- 在沒有範圍檢查的情況下，公開完整的 Gateway 控制平面。
- 使身份驗證依賴於人工標籤 (代稱仍是非安全相關)。

---

# 現狀 (如現有)

## 兩種協定

### 1) Gateway WebSocket (控制平面)

- 完整的 API 表面：設定、通道、模型、會話、代理程式執行、日誌、節點等。
- 預設綁定：迴路。透過 SSH/Tailscale 遠端存取。
- 身份驗證：透過 `connect` 的權杖/密碼。
- 無 TLS 釘選 (依賴迴路/通道)。
- 程式碼：
  - `src/gateway/server/ws-connection/message-handler.ts`
  - `src/gateway/client.ts`
  - `docs/gateway/protocol.md`

### 2) Bridge (節點傳輸)

- 狹窄的允許清單表面、節點身份 + 配對。
- 透過 TCP 的 JSONL；可選的 TLS + 憑證指紋釘選。
- TLS 在發現 TXT 中廣告指紋。
- 程式碼：
  - `src/infra/bridge/server/connection.ts`
  - `src/gateway/server-bridge.ts`
  - `src/node-host/bridge-client.ts`
  - `docs/gateway/bridge-protocol.md`

## 今日的控制平面用戶端

- 命令列介面 (CLI) → 透過 `callGateway` 的 Gateway WS (`src/gateway/call.ts`)。
- macOS 應用程式使用者介面 → Gateway WS (`GatewayConnection`)。
- 網頁控制使用者介面 → Gateway WS。
- ACP → Gateway WS。
- 瀏覽器控制使用其自己的 HTTP 控制伺服器。

## 今日的節點

- 節點模式下的 macOS 應用程式連接到 Gateway 橋接 (`MacNodeBridgeSession`)。
- iOS/Android 應用程式連接到 Gateway 橋接。
- 配對 + 每節點權杖儲存在 Gateway 上。

## 目前的核准流程 (執行)

- 代理程式透過 Gateway 使用 `system.run`。
- Gateway 透過橋接呼叫節點。
- 節點執行時期決定核准。
- mac 應用程式顯示使用者介面提示 (當節點 == mac 應用程式時)。
- 節點將 `invoke-res` 返回給 Gateway。
- 多跳，使用者介面綁定到節點主機。

## 今日的存在狀態 + 身份

- 來自 WS 用戶端的 Gateway 存在狀態條目。
- 來自橋接的節點存在狀態條目。
- mac 應用程式可以顯示同一機器的兩個條目 (使用者介面 + 節點)。
- 節點身份儲存在配對儲存中；使用者介面身份獨立。

---

# 問題 / 痛點

- 兩個協定堆疊需要維護 (WS + Bridge)。
- 遠端節點上的核准：提示出現在節點主機上，而不是使用者所在的位置。
- TLS 釘選僅存在於橋接；WS 依賴 SSH/Tailscale。
- 身份重複：同一機器顯示為多個實例。
- 模糊的角色：使用者介面 + 節點 + 命令列介面功能未明確分離。

---

# 提議的新狀態 (Clawnet)

## 單一協定，兩種角色

具有角色 + 範圍的單一 WS 協定。

- **角色：節點** (功能主機)
- **角色：操作員** (控制平面)
- 操作員的可選**範圍**：
  - `operator.read` (狀態 + 檢視)
  - `operator.write` (代理程式執行、發送)
  - `operator.admin` (設定、通道、模型)

### 角色行為

**節點**

- 可以註冊功能 (`caps`、`commands`、權限)。
- 可以接收 `invoke` 命令 (`system.run`、`camera.*`、`canvas.*`、`screen.record` 等)。
- 可以發送事件：`voice.transcript`、`agent.request`、`chat.subscribe`。
- 不能呼叫設定/模型/通道/會話/代理程式控制平面 API。

**操作員**

- 完整的控制平面 API，由範圍閘控。
- 接收所有核准。
- 不直接執行作業系統動作；路由到節點。

### 關鍵規則

角色是每個連線，而不是每個裝置。一個裝置可以分別開啟兩種角色。

---

# 統一身份驗證 + 配對

## 用戶端身份

每個用戶端提供：

- `deviceId` (穩定，來自裝置金鑰)。
- `displayName` (人類名稱)。
- `role` + `scope` + `caps` + `commands`。

## 配對流程 (統一)

- 用戶端未驗證連接。
- Gateway 為該 `deviceId` 建立一個 **配對請求**。
- 操作員收到提示；核准/拒絕。
- Gateway 發行憑證綁定到：
  - 裝置公開金鑰
  - 角色
  - 範圍
  - 功能/命令
- 用戶端持續儲存權杖，重新連接並驗證。

## 裝置綁定身份驗證 (避免 Bearer 權杖重放)

首選：裝置金鑰對。

- 裝置僅生成一次金鑰對。
- `deviceId = fingerprint(publicKey)`。
- Gateway 發送亂數；裝置簽名；Gateway 驗證。
- 權杖發行給公開金鑰 (佔有證明)，而不是字串。

替代方案：

- mTLS (用戶端憑證)：最強大，操作複雜度更高。
- 短期 Bearer 權杖僅作為臨時階段 (盡早輪換 + 撤銷)。

## 靜默核准 (SSH 啟發式)

精確定義以避免弱點。優先選擇一個：

- **僅限本地**：當用戶端透過迴路/Unix socket 連接時自動配對。
- **透過 SSH 挑戰**：gateway 發送亂數；用戶端透過擷取它來證明 SSH。
- **實體存在視窗**：在 gateway 主機使用者介面上進行本地核准後，允許自動配對一小段時間 (例如 10 分鐘)。

始終記錄 + 儲存自動核准。

---

# 無處不在的 TLS (開發 + 生產)

## 重用現有的橋接 TLS

使用目前的 TLS 執行時期 + 指紋釘選：

- `src/infra/bridge/server/tls.ts`
- `src/node-host/bridge-client.ts` 中的指紋驗證邏輯

## 應用於 WS

- WS 伺服器支援具有相同憑證/金鑰 + 指紋的 TLS。
- WS 用戶端可以釘選指紋 (可選)。
- 發現針對所有端點廣告 TLS + 指紋。
  - 發現僅為定位提示；絕非信任錨點。

## 原因

- 減少對 SSH/Tailscale 的機密性依賴。
- 預設使遠端行動連線安全。

---

# 核准重新設計 (集中化)

## 現行

核准發生在節點主機上 (mac 應用程式節點執行時期)。提示出現在節點執行的地方。

## 提議

核准由 **Gateway 託管**，使用者介面傳遞給操作員用戶端。

### 新流程

1. Gateway 接收 `system.run` 意圖 (代理程式)。
2. Gateway 建立核准記錄：`approval.requested`。
3. 操作員使用者介面顯示提示。
4. 核准決定發送到 gateway：`approval.resolve`。
5. 如果核准，Gateway 呼叫節點命令。
6. 節點執行，返回 `invoke-res`。

### 核准語義 (強化)

- 廣播給所有操作員；只有活動的使用者介面顯示彈出視窗 (其他收到通知)。
- 首次解決獲勝；gateway 拒絕後續的解決，因為已解決。
- 預設逾時：N 秒 (例如 60 秒) 後拒絕，記錄原因。
- 解決需要 `operator.approvals` 範圍。

## 優點

- 提示出現在使用者所在的位置 (mac/手機)。
- 遠端節點的一致核准。
- 節點執行時期保持無頭；無使用者介面依賴。

---

# 角色清晰度範例

## iPhone 應用程式

- **節點角色**用於：麥克風、相機、語音聊天、位置、一鍵通話。
- 可選的 **operator.read** 用於狀態和聊天檢視。
- 可選的 **operator.write/admin** 僅在明確啟用時。

## macOS 應用程式

- 預設為操作員角色 (控制使用者介面)。
- 啟用「Mac 節點」時的節點角色 (system.run, screen, camera)。
- 兩個連線的相同 deviceId → 合併的使用者介面條目。

## 命令列介面 (CLI)

- 始終為操作員角色。
- 範圍由子命令推導：
  - `status`、`logs` → 讀取
  - `agent`、`message` → 寫入
  - `config`、`channels` → 管理
  - 核准 + 配對 → `operator.approvals` / `operator.pairing`

---

# 身份 + 代稱

## 穩定 ID

身份驗證所需；永不改變。
首選：

- 金鑰對指紋 (公開金鑰雜湊)。

## 可愛代稱 (龍蝦主題)

僅限人類標籤。

- 範例：`scarlet-claw`、`saltwave`、`mantis-pinch`。
- 儲存在 Gateway 註冊表，可編輯。
- 衝突處理：`-2`、`-3`。

## 使用者介面分組

跨角色的相同 `deviceId` → 單一「實例」行：

- 徽章：`operator`、`node`。
- 顯示功能 + 最後上線。

---

# 遷移策略

## 階段 0：文件 + 對齊

- 發布此文件。
- 盤點所有協定呼叫 + 核准流程。

## 階段 1：為 WS 添加角色/範圍

- 使用 `role`、`scope`、`deviceId` 擴展 `connect` 參數。
- 為節點角色添加允許清單閘控。

## 階段 2：橋接相容性

- 保持橋接執行。
- 同時添加 WS 節點支援。
- 透過設定旗標閘控功能。

## 階段 3：中央核准

- 在 WS 中添加核准請求 + 解決事件。
- 更新 mac 應用程式使用者介面以提示 + 回應。
- 節點執行時期停止提示使用者介面。

## 階段 4：TLS 統一

- 使用橋接 TLS 執行時期為 WS 添加 TLS 設定。
- 為用戶端添加釘選。

## 階段 5：廢棄橋接

- 將 iOS/Android/mac 節點遷移到 WS。
- 將橋接保留為備用；穩定後移除。

## 階段 6：裝置綁定身份驗證

- 所有非本地連線都需要基於金鑰的身份。
- 添加撤銷 + 輪換使用者介面。

---

# 安全性注意事項

- 角色/允許清單在 Gateway 邊界強制執行。
- 沒有操作員範圍的用戶端無法獲得「完整」API。
- _所有_ 連線都需要配對。
- TLS + 釘選減少行動裝置的 MITM 風險。
- SSH 靜默核准是一種便利；仍被記錄 + 可撤銷。
- 發現絕非信任錨點。
- 功能聲明由伺服器允許清單按平台/類型驗證。

# 串流 + 大型酬載 (節點媒體)

WS 控制平面適用於小型訊息，但節點也執行：

- 相機片段
- 螢幕錄影
- 音訊串流

選項：

1. WS 二進位框架 + 分塊 + 背壓規則。
2. 獨立的串流端點 (仍為 TLS + 身份驗證)。
3. 對於媒體繁重的命令，將橋接保留更長時間，最後遷移。

在實作前選擇一個以避免偏差。

# 功能 + 命令策略

- 節點報告的功能/命令被視為 **聲明**。
- Gateway 針對每個平台強制執行允許清單。
- 任何新命令都需要操作員核准或明確的允許清單變更。
- 審核帶有時間戳記的變更。

# 審核 + 速率限制

- 記錄：配對請求、核准/拒絕、權杖發行/輪換/撤銷。
- 限制配對垃圾郵件和核准提示的速率。

# 協定衛生

- 明確的協定版本 + 錯誤代碼。
- 重新連線規則 + 心跳策略。
- 存在狀態 TTL 和最後上線語義。

---

# 待解決問題

1. 單一裝置執行兩種角色：權杖模型
   - 建議每個角色 (節點 vs 操作員) 使用獨立權杖。
   - 相同的 deviceId；不同的範圍；更清晰的撤銷。

2. 操作員範圍粒度
   - 讀取/寫入/管理 + 核准 + 配對 (最小可行)。
   - 稍後考慮每個功能範圍。

3. 權杖輪換 + 撤銷使用者體驗
   - 角色變更時自動輪換。
   - 依 deviceId + 角色撤銷的使用者介面。

4. 發現
   - 擴展目前的 Bonjour TXT 以包含 WS TLS 指紋 + 角色提示。
   - 僅視為定位提示。

5. 跨網路核准
   - 廣播給所有操作員用戶端；活動使用者介面顯示彈出視窗。
   - 首次回應獲勝；Gateway 強制原子性。

---

# 總結 (懶人包)

- 現況：WS 控制平面 + 橋接節點傳輸。
- 痛點：核准 + 重複 + 兩個堆疊。
- 提議：單一 WS 協定，具有明確的角色 + 範圍、統一的配對 + TLS 釘選、Gateway 託管的核准、穩定的裝置 ID + 可愛代稱。
- 結果：更簡單的使用者體驗、更強大的安全性、更少的重複、更好的行動路由。
