---
summary: "嚴格設定驗證 + 僅醫生模式遷移"
read_when:
  - 設計或實作設定驗證行為時
  - 處理設定遷移或醫生模式工作流程時
  - 處理外掛設定綱要或外掛載入門禁時
title: "嚴格設定驗證"
---

# 嚴格設定驗證（僅醫生模式遷移）

## 目標

- **全面拒絕未知設定鍵**（根層級 + 巢狀層級），根層級 `$schema` 元資料除外。
- **拒絕無綱要的外掛設定**；不載入該外掛。
- **移除載入時的舊有自動遷移**；遷移僅透過醫生模式執行。
- **啟動時自動執行醫生模式（預演模式）**；如果無效，則阻擋非診斷指令。

## 非目標

- 載入時的向下相容性（舊有鍵不會自動遷移）。
- 靜默丟棄無法識別的鍵。

## 嚴格驗證規則

- 設定必須在每個層級完全符合綱要。
- 未知鍵會造成驗證錯誤（根層級或巢狀層級均無透過），根層級 `$schema` 為字串時除外。
- `plugins.entries.<id>.config` 必須由外掛的綱要驗證。
  - 如果外掛缺少綱要，**拒絕外掛載入**並顯示明確錯誤。
- 未知 `channels.<id>` 鍵會造成錯誤，除非外掛清單宣告了該通道 ID。
- 所有外掛都需要外掛清單 (`openclaw.plugin.json`)。

## 外掛綱要強制執行

- 每個外掛都為其設定提供嚴格的 JSON 綱要（內聯於清單中）。
- 外掛載入流程：
  1. 解析外掛清單 + 綱要 (`openclaw.plugin.json`)。
  2. 根據綱要驗證設定。
  3. 如果缺少綱要或設定無效：阻擋外掛載入，記錄錯誤。
- 錯誤訊息包含：
  - 外掛 ID
  - 原因（缺少綱要 / 設定無效）
  - 驗證失敗的路徑
- 已停用的外掛會保留其設定，但 Doctor + 日誌會顯示警告。

## 醫生模式流程

- 每次載入設定時，Doctor 都會執行（預設為預演模式）。
- 如果設定無效：
  - 列印摘要 + 可操作的錯誤。
  - 指示：`openclaw doctor --fix`。
- `openclaw doctor --fix`：
  - 應用遷移。
  - 移除未知鍵。
  - 寫入更新後的設定。

## 指令門禁（當設定無效時）

允許（僅診斷）：

- `openclaw doctor`
- `openclaw logs`
- `openclaw health`
- `openclaw help`
- `openclaw status`
- `openclaw gateway status`

所有其他指令必須因：「設定無效。請執行 `openclaw doctor --fix`。」而硬性失敗。

## 錯誤使用者體驗格式

- 單一摘要標頭。
- 分組區段：
  - 未知鍵（完整路徑）
  - 舊有鍵 / 需要遷移
  - 外掛載入失敗（外掛 ID + 原因 + 路徑）

## 實作接觸點

- `src/config/zod-schema.ts`：移除根層級透過；全面嚴格物件。
- `src/config/zod-schema.providers.ts`：確保嚴格的通道綱要。
- `src/config/validation.ts`：未知鍵時失敗；不應用舊有遷移。
- `src/config/io.ts`：移除舊有自動遷移；始終執行醫生預演模式。
- `src/config/legacy*.ts`：將使用方式僅移至醫生模式。
- `src/plugins/*`：新增綱要註冊表 + 門禁。
- `src/cli` 中的 CLI 指令門禁。

## 測試

- 未知鍵拒絕（根層級 + 巢狀層級）。
- 外掛缺少綱要 → 外掛載入被明確錯誤阻擋。
- 無效設定 → Gateway 啟動被阻擋，診斷指令除外。
- 醫生模式自動預演；`doctor --fix` 寫入更正後的設定。
