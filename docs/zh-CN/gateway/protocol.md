---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
read_when:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 实现或更新 Gateway 网关 WS 客户端（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 调试协议不匹配或连接失败（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 重新生成协议模式/模型（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
summary: Gateway 网关 WebSocket 协议：握手、帧、版本控制（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
title: Gateway 网关协议（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
x-i18n:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  generated_at: "2026-02-03T07:48:42Z"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  model: claude-opus-4-5（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  provider: pi（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_hash: bdafac40d53565901b2df450617287664d77fe4ff52681fa00cab9046b2fd850（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_path: gateway/protocol.md（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  workflow: 15（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
# Gateway 网关协议（WebSocket）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
Gateway 网关 WS 协议是 OpenClaw 的**单一控制平面 + 节点传输**。所有客户端（CLI、Web UI、macOS 应用、iOS/Android 节点、无头节点）都通过 WebSocket 连接，并在握手时声明其**角色** + **作用域**。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 传输（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- WebSocket，带有 JSON 负载的文本帧。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 第一帧**必须**是 `connect` 请求。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 握手（connect）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
Gateway 网关 → 客户端（连接前质询）：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "type": "event",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "event": "connect.challenge",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "payload": { "nonce": "…", "ts": 1737264000000 }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
客户端 → Gateway 网关：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "type": "req",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "id": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "method": "connect",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "params": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "minProtocol": 3,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "maxProtocol": 3,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "client": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "id": "cli",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "version": "1.2.3",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "platform": "macos",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "mode": "operator"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "role": "operator",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "scopes": ["operator.read", "operator.write"],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "caps": [],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "commands": [],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "permissions": {},（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "auth": { "token": "…" },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "locale": "en-US",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "userAgent": "openclaw-cli/1.2.3",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "device": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "id": "device_fingerprint",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "publicKey": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "signature": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "signedAt": 1737264000000,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "nonce": "…"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
Gateway 网关 → 客户端：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "type": "res",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "id": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "ok": true,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "payload": { "type": "hello-ok", "protocol": 3, "policy": { "tickIntervalMs": 15000 } }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
当颁发设备令牌时，`hello-ok` 还包含：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "auth": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "deviceToken": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "role": "operator",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "scopes": ["operator.read", "operator.write"]（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 节点示例（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "type": "req",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "id": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "method": "connect",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "params": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "minProtocol": 3,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "maxProtocol": 3,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "client": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "id": "ios-node",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "version": "1.2.3",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "platform": "ios",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "mode": "node"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "role": "node",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "scopes": [],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "caps": ["camera", "canvas", "screen", "location", "voice"],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "commands": ["camera.snap", "canvas.navigate", "screen.record", "location.get"],（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "permissions": { "camera.capture": true, "screen.record": false },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "auth": { "token": "…" },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "locale": "en-US",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "userAgent": "openclaw-ios/1.2.3",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "device": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "id": "device_fingerprint",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "publicKey": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "signature": "…",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "signedAt": 1737264000000,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "nonce": "…"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 帧格式（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **Request**：`{type:"req", id, method, params}`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **Response**：`{type:"res", id, ok, payload|error}`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **Event**：`{type:"event", event, payload, seq?, stateVersion?}`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
有副作用的方法需要**幂等键**（见模式）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 角色 + 作用域（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 角色（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator` = 控制平面客户端（CLI/UI/自动化）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `node` = 能力宿主（camera/screen/canvas/system.run）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 作用域（operator）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
常用作用域：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator.read`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator.write`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator.admin`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator.approvals`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `operator.pairing`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 能力/命令/权限（node）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
节点在连接时声明能力声明：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `caps`：高级能力类别。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `commands`：invoke 的命令允许列表。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `permissions`：细粒度开关（例如 `screen.record`、`camera.capture`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
Gateway 网关将这些视为**声明**并强制执行服务器端允许列表。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 在线状态（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `system-presence` 返回以设备身份为键的条目。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 在线状态条目包含 `deviceId`、`roles` 和 `scopes`，以便 UI 可以为每个设备显示单行，（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  即使它同时以 **operator** 和 **node** 身份连接。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 节点辅助方法（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 节点可以调用 `skills.bins` 来获取当前的 skill 可执行文件列表，（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  用于自动允许检查。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## Exec 审批（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 当 exec 请求需要审批时，Gateway 网关广播 `exec.approval.requested`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 操作者客户端通过调用 `exec.approval.resolve` 来解决（需要 `operator.approvals` 作用域）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 版本控制（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `PROTOCOL_VERSION` 在 `src/gateway/protocol/schema.ts` 中。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 客户端发送 `minProtocol` + `maxProtocol`；服务器拒绝不匹配的。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 模式 + 模型从 TypeBox 定义生成：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `pnpm protocol:gen`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `pnpm protocol:gen:swift`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `pnpm protocol:check`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 认证（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 如果设置了 `OPENCLAW_GATEWAY_TOKEN`（或 `--token`），`connect.params.auth.token`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  必须匹配，否则套接字将被关闭。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 配对后，Gateway 网关会颁发一个作用于连接角色 + 作用域的**设备令牌**。它在 `hello-ok.auth.deviceToken` 中返回，（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  客户端应将其持久化以供将来连接使用。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 设备令牌可以通过 `device.token.rotate` 和 `device.token.revoke` 轮换/撤销（需要 `operator.pairing` 作用域）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 设备身份 + 配对（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 节点应包含从密钥对指纹派生的稳定设备身份（`device.id`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Gateway 网关为每个设备 + 角色颁发令牌。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 新设备 ID 需要配对批准，除非启用了本地自动批准。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **本地**连接包括 loopback 和 Gateway 网关主机自身的 tailnet 地址（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  （因此同主机 tailnet 绑定仍可自动批准）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 所有 WS 客户端在 `connect` 期间必须包含 `device` 身份（operator + node）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  控制 UI **仅**在启用 `gateway.controlUi.allowInsecureAuth` 时可以省略它（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  （或使用 `gateway.controlUi.dangerouslyDisableDeviceAuth` 用于紧急情况）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 非本地连接必须签署服务器提供的 `connect.challenge` nonce。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## TLS + 固定（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- WS 连接支持 TLS。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 客户端可以选择性地固定 Gateway 网关证书指纹（见 `gateway.tls`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  配置加上 `gateway.remote.tlsFingerprint` 或 CLI `--tls-fingerprint`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 范围（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
此协议暴露**完整的 Gateway 网关 API**（status、channels、models、chat、（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
agent、sessions、nodes、approvals 等）。确切的接口由 `src/gateway/protocol/schema.ts` 中的 TypeBox 模式定义。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
