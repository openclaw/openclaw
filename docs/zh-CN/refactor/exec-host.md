---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
read_when:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 设计 exec 主机路由或 exec 批准（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 实现节点运行器 + UI IPC（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 添加 exec 主机安全模式和斜杠命令（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
summary: 重构计划：exec 主机路由、节点批准和无头运行器（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
title: Exec 主机重构（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
x-i18n:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  generated_at: "2026-02-03T07:54:43Z"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  model: claude-opus-4-5（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  provider: pi（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_hash: 53a9059cbeb1f3f1dbb48c2b5345f88ca92372654fef26f8481e651609e45e3a（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_path: refactor/exec-host.md（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  workflow: 15（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
# Exec 主机重构计划（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 目标（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加 `exec.host` + `exec.security` 以在**沙箱**、**Gateway 网关**和**节点**之间路由执行。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 保持默认**安全**：除非明确启用，否则不进行跨主机执行。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 将执行拆分为**无头运行器服务**，通过本地 IPC 连接可选的 UI（macOS 应用）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 提供**每智能体**策略、允许列表、询问模式和节点绑定。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 支持*与*或*不与*允许列表一起使用的**询问模式**。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 跨平台：Unix socket + token 认证（macOS/Linux/Windows 一致性）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 非目标（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 无遗留允许列表迁移或遗留 schema 支持。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 节点 exec 无 PTY/流式传输（仅聚合输出）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 除现有 Bridge + Gateway 网关外无新网络层。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 决定（已锁定）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **配置键：** `exec.host` + `exec.security`（允许每智能体覆盖）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **提升：** 保留 `/elevated` 作为 Gateway 网关完全访问的别名。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **询问默认：** `on-miss`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **批准存储：** `~/.openclaw/exec-approvals.json`（JSON，无遗留迁移）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **运行器：** 无头系统服务；UI 应用托管 Unix socket 用于批准。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **节点身份：** 使用现有 `nodeId`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **Socket 认证：** Unix socket + token（跨平台）；如需要稍后拆分。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **节点主机状态：** `~/.openclaw/node.json`（节点 id + 配对 token）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **macOS exec 主机：** 在 macOS 应用内运行 `system.run`；节点主机服务通过本地 IPC 转发请求。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **无 XPC helper：** 坚持使用 Unix socket + token + 对等检查。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 关键概念（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 主机（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `sandbox`：Docker exec（当前行为）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `gateway`：在 Gateway 网关主机上执行。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `node`：通过 Bridge 在节点运行器上执行（`system.run`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 安全模式（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `deny`：始终阻止。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `allowlist`：仅允许匹配项。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `full`：允许一切（等同于提升模式）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 询问模式（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `off`：从不询问。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `on-miss`：仅在允许列表不匹配时询问。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `always`：每次都询问。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
询问**独立于**允许列表；允许列表可与 `always` 或 `on-miss` 一起使用。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 策略解析（每次执行）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
1. 解析 `exec.host`（工具参数 → 智能体覆盖 → 全局默认）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
2. 解析 `exec.security` 和 `exec.ask`（相同优先级）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
3. 如果主机是 `sandbox`，继续本地沙箱执行。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
4. 如果主机是 `gateway` 或 `node`，在该主机上应用安全 + 询问策略。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 默认安全（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 默认 `exec.host = sandbox`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `gateway` 和 `node` 默认 `exec.security = deny`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 默认 `exec.ask = on-miss`（仅在安全允许时相关）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 如果未设置节点绑定，**智能体可以定向任何节点**，但仅在策略允许时。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 配置表面（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 工具参数（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `exec.host`（可选）：`sandbox | gateway | node`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `exec.security`（可选）：`deny | allowlist | full`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `exec.ask`（可选）：`off | on-miss | always`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `exec.node`（可选）：当 `host=node` 时使用的节点 id/名称。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 配置键（全局）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `tools.exec.host`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `tools.exec.security`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `tools.exec.ask`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `tools.exec.node`（默认节点绑定）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 配置键（每智能体）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `agents.list[].tools.exec.host`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `agents.list[].tools.exec.security`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `agents.list[].tools.exec.ask`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `agents.list[].tools.exec.node`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 别名（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `/elevated on` = 为智能体会话设置 `tools.exec.host=gateway`、`tools.exec.security=full`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `/elevated off` = 为智能体会话恢复之前的 exec 设置。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 批准存储（JSON）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
路径：`~/.openclaw/exec-approvals.json`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
用途：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- **执行主机**（Gateway 网关或节点运行器）的本地策略 + 允许列表。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 无 UI 可用时的询问回退。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- UI 客户端的 IPC 凭证。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
建议的 schema（v1）：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```json（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
{（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "version": 1,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "socket": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "path": "~/.openclaw/exec-approvals.sock",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "token": "base64-opaque-token"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "defaults": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "security": "deny",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "ask": "on-miss",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "askFallback": "deny"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  },（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  "agents": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    "agent-id-1": {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "security": "allowlist",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "ask": "on-miss",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      "allowlist": [（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          "pattern": "~/Projects/**/bin/rg",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          "lastUsedAt": 0,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          "lastUsedCommand": "rg -n TODO",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          "lastResolvedPath": "/Users/user/Projects/.../bin/rg"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      ]（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  }（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
}（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
注意事项：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 无遗留允许列表格式。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `askFallback` 仅在需要 `ask` 且无法访问 UI 时应用。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 文件权限：`0600`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 运行器服务（无头）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 角色（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 在本地强制执行 `exec.security` + `exec.ask`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 执行系统命令并返回输出。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 为 exec 生命周期发出 Bridge 事件（可选但推荐）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 服务生命周期（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- macOS 上的 Launchd/daemon；Linux/Windows 上的系统服务。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 批准 JSON 是执行主机本地的。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- UI 托管本地 Unix socket；运行器按需连接。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## UI 集成（macOS 应用）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### IPC（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Unix socket 位于 `~/.openclaw/exec-approvals.sock`（0600）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Token 存储在 `exec-approvals.json`（0600）中。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 对等检查：仅同 UID。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 挑战/响应：nonce + HMAC(token, request-hash) 防止重放。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 短 TTL（例如 10s）+ 最大负载 + 速率限制。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 询问流程（macOS 应用 exec 主机）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
1. 节点服务从 Gateway 网关接收 `system.run`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
2. 节点服务连接到本地 socket 并发送提示/exec 请求。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
3. 应用验证对等 + token + HMAC + TTL，然后在需要时显示对话框。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
4. 应用在 UI 上下文中执行命令并返回输出。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
5. 节点服务将输出返回给 Gateway 网关。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
如果 UI 缺失：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 应用 `askFallback`（`deny|allowlist|full`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 图示（SCI）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
Agent -> Gateway -> Bridge -> Node Service (TS)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
                         |  IPC (UDS + token + HMAC + TTL)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
                         v（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
                     Mac App (UI + TCC + system.run)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 节点身份 + 绑定（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 使用 Bridge 配对中的现有 `nodeId`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 绑定模型：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `tools.exec.node` 将智能体限制为特定节点。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 如果未设置，智能体可以选择任何节点（策略仍强制执行默认值）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 节点选择解析：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `nodeId` 精确匹配（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `displayName`（规范化）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `remoteIp`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - `nodeId` 前缀（>= 6 字符）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 事件（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 谁看到事件（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 系统事件是**每会话**的，在下一个提示时显示给智能体。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 存储在 Gateway 网关内存队列中（`enqueueSystemEvent`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 事件文本（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `Exec started (node=<id>, id=<runId>)`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `Exec finished (node=<id>, id=<runId>, code=<code>)` + 可选输出尾部（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `Exec denied (node=<id>, id=<runId>, <reason>)`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 传输（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
选项 A（推荐）：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行器发送 Bridge `event` 帧 `exec.started` / `exec.finished`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Gateway 网关 `handleBridgeEvent` 将这些映射到 `enqueueSystemEvent`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
选项 B：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Gateway 网关 `exec` 工具直接处理生命周期（仅同步）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## Exec 流程（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 沙箱主机（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 现有 `exec` 行为（Docker 或无沙箱时的主机）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 仅在非沙箱模式下支持 PTY。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### Gateway 网关主机（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Gateway 网关进程在其自己的机器上执行。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 强制执行本地 `exec-approvals.json`（安全/询问/允许列表）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 节点主机（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Gateway 网关调用 `node.invoke` 配合 `system.run`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行器强制执行本地批准。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行器返回聚合的 stdout/stderr。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 可选的 Bridge 事件用于开始/完成/拒绝。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 输出上限（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 组合 stdout+stderr 上限为 **200k**；为事件保留**尾部 20k**。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 使用清晰的后缀截断（例如 `"… (truncated)"`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 斜杠命令（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `/exec host=<sandbox|gateway|node> security=<deny|allowlist|full> ask=<off|on-miss|always> node=<id>`（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 每智能体、每会话覆盖；除非通过配置保存，否则非持久。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `/elevated on|off|ask|full` 仍然是 `host=gateway security=full` 的快捷方式（`full` 跳过批准）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 跨平台方案（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行器服务是可移植的执行目标。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- UI 是可选的；如果缺失，应用 `askFallback`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Windows/Linux 支持相同的批准 JSON + socket 协议。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 实现阶段（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 1：配置 + exec 路由（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 为 `exec.host`、`exec.security`、`exec.ask`、`exec.node` 添加配置 schema。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 更新工具管道以遵守 `exec.host`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加 `/exec` 斜杠命令并保留 `/elevated` 别名。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 2：批准存储 + Gateway 网关强制执行（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 实现 `exec-approvals.json` 读取器/写入器。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 为 `gateway` 主机强制执行允许列表 + 询问模式。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加输出上限。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 3：节点运行器强制执行（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 更新节点运行器以强制执行允许列表 + 询问。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加 Unix socket 提示桥接到 macOS 应用 UI。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 连接 `askFallback`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 4：事件（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 为 exec 生命周期添加节点 → Gateway 网关 Bridge 事件。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 映射到 `enqueueSystemEvent` 用于智能体提示。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 5：UI 完善（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Mac 应用：允许列表编辑器、每智能体切换器、询问策略 UI。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 节点绑定控制（可选）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 测试计划（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 单元测试：允许列表匹配（glob + 不区分大小写）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 单元测试：策略解析优先级（工具参数 → 智能体覆盖 → 全局）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 集成测试：节点运行器拒绝/允许/询问流程。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- Bridge 事件测试：节点事件 → 系统事件路由。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 开放风险（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- UI 不可用：确保遵守 `askFallback`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 长时间运行的命令：依赖超时 + 输出上限。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 多节点歧义：除非有节点绑定或显式节点参数，否则报错。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 相关文档（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- [Exec 工具](/tools/exec)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- [执行批准](/tools/exec-approvals)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- [节点](/nodes)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- [提升模式](/tools/elevated)（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
