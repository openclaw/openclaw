---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
read_when:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 定义或重构插件架构（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  - 将渠道连接器迁移到插件 SDK/运行时（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
summary: 计划：为所有消息连接器提供一套统一的插件 SDK + 运行时（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
title: 插件 SDK 重构（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
x-i18n:（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  generated_at: "2026-02-01T21:36:45Z"（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  model: claude-opus-4-5（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  provider: pi（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_hash: d1964e2e47a19ee1d42ddaaa9cf1293c80bb0be463b049dc8468962f35bb6cb0（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  source_path: refactor/plugin-sdk.md（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  workflow: 15（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
---（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
# 插件 SDK + 运行时重构计划（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
目标：每个消息连接器都是一个插件（内置或外部），使用统一稳定的 API。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
插件不直接从 `src/**` 导入任何内容。所有依赖项均通过 SDK 或运行时获取。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 为什么现在做（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 当前连接器混用多种模式：直接导入核心模块、仅 dist 的桥接方式以及自定义辅助函数。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 这使得升级变得脆弱，并阻碍了干净的外部插件接口。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 目标架构（两层）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 1）插件 SDK（编译时，稳定，可发布）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
范围：类型、辅助函数和配置工具。无运行时状态，无副作用。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
内容（示例）：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 类型：`ChannelPlugin`、适配器、`ChannelMeta`、`ChannelCapabilities`、`ChannelDirectoryEntry`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 配置辅助函数：`buildChannelConfigSchema`、`setAccountEnabledInConfigSection`、`deleteAccountFromConfigSection`、（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  `applyAccountNameToChannelSection`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 配对辅助函数：`PAIRING_APPROVED_MESSAGE`、`formatPairingApproveHint`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 新手引导辅助函数：`promptChannelAccessConfig`、`addWildcardAllowFrom`、新手引导类型。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 工具参数辅助函数：`createActionGate`、`readStringParam`、`readNumberParam`、`readReactionParams`、`jsonResult`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 文档链接辅助函数：`formatDocsLink`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
交付方式：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 以 `openclaw/plugin-sdk` 发布（或从核心以 `openclaw/plugin-sdk` 导出）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 使用语义化版本控制，提供明确的稳定性保证。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 2）插件运行时（执行层，注入式）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
范围：所有涉及核心运行时行为的内容。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
通过 `OpenClawPluginApi.runtime` 访问，确保插件永远不会导入 `src/**`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
建议的接口（最小但完整）：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```ts（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
export type PluginRuntime = {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  channel: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    text: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      chunkMarkdownText(text: string, limit: number): string[];（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveTextChunkLimit(cfg: OpenClawConfig, channel: string, accountId?: string): number;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      hasControlCommand(text: string, cfg: OpenClawConfig): boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    reply: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      dispatchReplyWithBufferedBlockDispatcher(params: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        ctx: unknown;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        cfg: unknown;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        dispatcherOptions: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          deliver: (payload: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
            text?: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
            mediaUrls?: string[];（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
            mediaUrl?: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          }) => void | Promise<void>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
          onError?: (err: unknown, info: { kind: string }) => void;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      }): Promise<void>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      createReplyDispatcherWithTyping?: unknown; // adapter for Teams-style flows（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    routing: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveAgentRoute(params: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        cfg: unknown;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        channel: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        accountId: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        peer: { kind: RoutePeerKind; id: string };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      }): { sessionKey: string; accountId: string };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    pairing: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      buildPairingReply(params: { channel: string; idLine: string; code: string }): string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      readAllowFromStore(channel: string): Promise<string[]>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      upsertPairingRequest(params: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        channel: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        id: string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        meta?: { name?: string };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      }): Promise<{ code: string; created: boolean }>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    media: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      fetchRemoteMedia(params: { url: string }): Promise<{ buffer: Buffer; contentType?: string }>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      saveMediaBuffer(（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        buffer: Uint8Array,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        contentType: string | undefined,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        direction: "inbound" | "outbound",（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        maxBytes: number,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      ): Promise<{ path: string; contentType?: string }>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    mentions: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      buildMentionRegexes(cfg: OpenClawConfig, agentId?: string): RegExp[];（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      matchesMentionPatterns(text: string, regexes: RegExp[]): boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    groups: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveGroupPolicy(（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        cfg: OpenClawConfig,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        channel: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        accountId: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        groupId: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      ): {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        allowlistEnabled: boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        allowed: boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        groupConfig?: unknown;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        defaultConfig?: unknown;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveRequireMention(（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        cfg: OpenClawConfig,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        channel: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        accountId: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        groupId: string,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        override?: boolean,（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      ): boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    debounce: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      createInboundDebouncer<T>(opts: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        debounceMs: number;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        buildKey: (v: T) => string | null;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        shouldDebounce: (v: T) => boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        onFlush: (entries: T[]) => Promise<void>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        onError?: (err: unknown) => void;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      }): { push: (v: T) => void; flush: () => Promise<void> };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveInboundDebounceMs(cfg: OpenClawConfig, channel: string): number;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    commands: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      resolveCommandAuthorizedFromAuthorizers(params: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        useAccessGroups: boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
        authorizers: Array<{ configured: boolean; allowed: boolean }>;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
      }): boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  logging: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    shouldLogVerbose(): boolean;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    getChildLogger(name: string): PluginLogger;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  state: {（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
    resolveStateDir(cfg: OpenClawConfig): string;（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
  };（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
};（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
```（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
备注：（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行时是访问核心行为的唯一方式。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- SDK 故意保持小巧和稳定。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 每个运行时方法都映射到现有的核心实现（无重复代码）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 迁移计划（分阶段，安全）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 0：基础搭建（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 引入 `openclaw/plugin-sdk`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 在 `OpenClawPluginApi` 中添加带有上述接口的 `api.runtime`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 在过渡期内保留现有导入方式（添加弃用警告）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 1：桥接清理（低风险）（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 用 `api.runtime` 替换每个扩展中的 `core-bridge.ts`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 优先迁移 BlueBubbles、Zalo、Zalo Personal（已经接近完成）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 移除重复的桥接代码。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 2：轻度直接导入的插件（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 将 Matrix 迁移到 SDK + 运行时。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 验证新手引导、目录、群组提及逻辑。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 3：重度直接导入的插件（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 迁移 Microsoft Teams（使用运行时辅助函数最多的插件）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 确保回复/正在输入的语义与当前行为一致。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 4：iMessage 插件化（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 将 iMessage 移入 `extensions/imessage`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 用 `api.runtime` 替换直接的核心调用。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 保持配置键、CLI 行为和文档不变。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
### 阶段 5：强制执行（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加 lint 规则 / CI 检查：禁止 `extensions/**` 从 `src/**` 导入。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 添加插件 SDK/版本兼容性检查（运行时 + SDK 语义化版本）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 兼容性与版本控制（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- SDK：语义化版本控制，已发布，变更有文档记录。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行时：按核心版本进行版本控制。添加 `api.runtime.version`。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 插件声明所需的运行时版本范围（例如 `openclawRuntime: ">=2026.2.0"`）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 测试策略（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 适配器级单元测试（使用真实核心实现验证运行时函数）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 每个插件的黄金测试：确保行为无偏差（路由、配对、允许列表、提及过滤）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- CI 中使用单个端到端插件示例（安装 + 运行 + 冒烟测试）。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 待解决问题（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- SDK 类型托管在哪里：独立包还是核心导出？（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 运行时类型分发：在 SDK 中（仅类型）还是在核心中？（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 如何为内置插件与外部插件暴露文档链接？（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 过渡期间是否允许仓库内插件有限地直接导入核心模块？（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
## 成功标准（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 所有渠道连接器都是使用 SDK + 运行时的插件。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- `extensions/**` 不再从 `src/**` 导入。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 新连接器模板仅依赖 SDK + 运行时。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
- 外部插件可以在无需访问核心源码的情况下进行开发和更新。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
相关文档：[插件](/tools/plugin)、[渠道](/channels/index)、[配置](/gateway/configuration)。（轉為繁體中文）（轉為繁體中文）（轉為繁體中文）
