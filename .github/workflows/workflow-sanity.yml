name: Workflow Sanity

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: workflow-sanity-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  docs-change-scope:
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.scope.outputs.docs_only }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect docs-only changes
        id: scope
        uses: ./.github/actions/detect-docs-only

  no-tabs:
    needs: docs-change-scope
    if: needs.docs-change-scope.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail on tabs in workflow files
        run: |
          python - <<'PY'
          from __future__ import annotations

          import pathlib
          import sys

          root = pathlib.Path(".github/workflows")
          bad: list[str] = []
          for path in sorted(root.rglob("*.yml")):
            if b"\t" in path.read_bytes():
              bad.append(str(path))

          for path in sorted(root.rglob("*.yaml")):
            if b"\t" in path.read_bytes():
              bad.append(str(path))

          if bad:
            print("Tabs found in workflow file(s):")
            for path in bad:
              print(f"- {path}")
            sys.exit(1)
          PY
