name: Upstream Sync

on:
  workflow_dispatch:
  schedule:
    # Monday 15:00 UTC
    - cron: "0 15 * * 1"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git
        run: |
          git config user.name "openclaw-sync-bot"
          git config user.email "openclaw-sync-bot@users.noreply.github.com"

      - name: Configure auth token for push and PR
        env:
          SYNC_PAT: ${{ secrets.OPENCLAW_SYNC_PAT }}
          FALLBACK_GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TOKEN="${SYNC_PAT}"
          if [[ -z "${TOKEN}" ]]; then
            TOKEN="${FALLBACK_GH_TOKEN}"
          fi
          echo "SYNC_TOKEN=${TOKEN}" >> "$GITHUB_ENV"
          git config --local --unset-all http.https://github.com/.extraheader || true
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Add upstream and fetch
        env:
          OPENCLAW_UPSTREAM_URL: ${{ vars.OPENCLAW_UPSTREAM_URL }}
        run: |
          set -euo pipefail
          UPSTREAM_REPO_URL="${OPENCLAW_UPSTREAM_URL:-https://github.com/openclaw/openclaw.git}"
          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream "${UPSTREAM_REPO_URL}"
          else
            git remote add upstream "${UPSTREAM_REPO_URL}"
          fi
          git fetch upstream main
          git fetch origin main

      - name: Check if sync is needed
        id: check
        run: |
          set -euo pipefail
          if git merge-base --is-ancestor upstream/main origin/main; then
            echo "needs_sync=false" >> "$GITHUB_OUTPUT"
            echo "origin/main already contains upstream/main; skipping."
          else
            echo "needs_sync=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create sync branch and merge upstream/main
        if: steps.check.outputs.needs_sync == 'true'
        run: |
          set -euo pipefail
          BRANCH="sync/upstream-main-$(date -u +%Y%m%d)-${GITHUB_RUN_ID}"
          git checkout -B "${BRANCH}" origin/main
          BASE_SHA="$(git rev-parse HEAD)"
          git merge --no-ff upstream/main -m "chore(sync): merge upstream/main"
          if [[ "$(git rev-parse HEAD)" == "${BASE_SHA}" ]]; then
            echo "SYNC_CREATED=false" >> "$GITHUB_ENV"
            echo "Merge produced no changes; skipping PR creation."
            exit 0
          fi
          git push -u origin "${BRANCH}"
          echo "SYNC_BRANCH=${BRANCH}" >> "$GITHUB_ENV"
          echo "SYNC_CREATED=true" >> "$GITHUB_ENV"

      - name: Open PR
        if: steps.check.outputs.needs_sync == 'true' && env.SYNC_CREATED == 'true'
        env:
          GH_TOKEN: ${{ env.SYNC_TOKEN }}
        run: |
          set -euo pipefail
          gh pr create \
            --head "${SYNC_BRANCH}" \
            --base main \
            --title "chore(sync): merge upstream/main (${SYNC_BRANCH})" \
            --body "Automated upstream sync PR."
