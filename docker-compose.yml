services:
  # --- Ollama 本地模型服务 ---
  #  ollama:
  #    container_name: openclaw-ollama
  #    image: ollama/ollama:latest
  #    restart: always
  #    environment:
  #      - OLLAMA_NUM_CTX=4096       # 强制限制上下文窗口为 4k，匹配你现在的报错上限
  #      - OLLAMA_MAX_LOADED_MODELS=1 # 强制只加载一个模型，节省切换开销
  #      - OLLAMA_MAX_QUEUE=5        # 队列限制，防止堆积导致崩溃
  #      - OLLAMA_KEEP_ALIVE=24h  # 让模型在内存中保留24小时
  #      - OLLAMA_NUM_CTX=8192    # 内存够大，可以支撑更大的上下文（从4k提升到8k）
  #    volumes:
  #      - ./ollama_data:/root/.ollama
  #    networks:
  #      - proxy
  #    # 针对甲骨文 4核 ARM 的优化：限制 CPU 资源，防止推理时宿主机完全卡死
  #    deploy:
  #      resources:
  #        limits:
  #          cpus: '3.5'

  # --- OpenClaw 网关 ---
  gateway:
    build:
      context: .
      args:
        # 在这里显式要求安装 ffmpeg 和必要的图片库
        - OPENCLAW_DOCKER_APT_PACKAGES=ffmpeg libvips-dev
    container_name: openclaw-gateway
    image: ${OPENCLAW_IMAGE:-openclaw-local:latest}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always
    init: true
    depends_on:
      # - ollama
      - sandbox
    command:
      - "node"
      - "dist/index.js"
      - "gateway"
      - "--bind"
      - "lan"
      - "--port"
      - "${VIRTUAL_PORT:-18789}"
    environment:
      NODE_ENV: production
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      VIRTUAL_HOST: ${DOMAIN}
      VIRTUAL_PORT: ${VIRTUAL_PORT}
      LETSENCRYPT_HOST: ${DOMAIN}
      LETSENCRYPT_EMAIL: ${EMAIL}
      BROWSER_PROVIDER: ${BROWSER_PROVIDER}
      BROWSER_ENDPOINT: ${BROWSER_ENDPOINT}
      OPENCLAW_PROFILE: ${OPENCLAW_PROFILE}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      AUTH_TOKEN: ${AUTH_TOKEN}
      WX_WEBHOOK_URL: ${WX_WEBHOOK_URL}
      WX_WEBHOOK_TOKEN: ${WX_WEBHOOK_TOKEN}
    volumes:
      - openclaw-data:/home/node/.openclaw
      - ./send_wechat.mjs:/app/scripts/send_wechat.mjs
    networks:
      - proxy

  # --- 浏览器沙箱 (用于 WhatsApp 登录) ---
  sandbox:
    container_name: openclaw-sandbox
    image: openclaw-sandbox:latest
    restart: always
    tmpfs:
      - /tmp
    ports:
      - "9222:9222" # 浏览器控制端口
      - "6080:6080" # 网页查看窗口 (NoVNC)
    shm_size: "4gb" # 浏览器非常吃缓存，建议加大
    networks:
      - proxy
    deploy:
      resources:
        limits:
          # 限制使用 2 个核心（甲骨文 4 核 ARM 留 2 核给系统和 Gateway 比较稳妥）
          cpus: "2.0"
          # 限制内存使用，防止浏览器内存泄漏撑爆宿主机
          memory: 4G
        reservations:
          # 预留最少 1G 内存
          memory: 1G

  cli:
    image: ${OPENCLAW_IMAGE:-openclaw-local:latest}
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
    volumes:
      - openclaw-data:/home/node/.openclaw
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]
networks:
  proxy:
    external: true

volumes:
  openclaw-data:
