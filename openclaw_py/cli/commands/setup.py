"""Setup command - initial setup wizard."""

import typer

from openclaw_py.cli.utils import confirm, error_exit, info, prompt, success
from openclaw_py.config.loader import load_config_sync as load_config
from openclaw_py.config.paths import resolve_config_path


def setup_cmd() -> None:
    """Run initial setup wizard for OpenClaw."""
    info("Welcome to OpenClaw setup! ðŸ¦ž")
    info("This wizard will help you configure OpenClaw for first use.\n")

    # Check if config already exists
    config_path = resolve_config_path()
    if config_path.exists():
        if not confirm(f"Config file already exists at {config_path}. Overwrite?", default=False):
            info("Setup cancelled.")
            raise typer.Exit(0)

    # Ask basic questions
    info("\n[1/3] Agent Configuration")
    agent_name = prompt("Agent name (default: main)", default="main")

    info("\n[2/3] Channel Configuration")
    use_telegram = confirm("Enable Telegram bot?", default=True)

    telegram_token = None
    if use_telegram:
        telegram_token = prompt("Telegram bot token", password=True)

    info("\n[3/3] AI Provider Configuration")
    use_anthropic = confirm("Use Anthropic (Claude)?", default=True)
    use_openai = confirm("Use OpenAI (GPT)?", default=False)

    api_key = None
    if use_anthropic:
        api_key = prompt("Anthropic API key", password=True)
    elif use_openai:
        api_key = prompt("OpenAI API key", password=True)

    # Generate basic config
    config_content = f"""# OpenClaw Configuration
# Generated by setup wizard

# Agent configuration
agents:
  list:
    - id: {agent_name}
      default: true
      name: "{agent_name.capitalize()}"

# Channel configuration
"""

    if use_telegram and telegram_token:
        config_content += f"""telegram:
  token: "{telegram_token}"
"""

    # Provider configuration
    if use_anthropic and api_key:
        config_content += f"""
# AI Provider configuration
models:
  anthropic:
    apiKey: "{api_key}"
"""
    elif use_openai and api_key:
        config_content += f"""
# AI Provider configuration
models:
  openai:
    apiKey: "{api_key}"
"""

    config_content += """
# Gateway configuration
gateway:
  http:
    port: 3420
  ws:
    port: 3421

# Session configuration
session:
  dm_scope: main
"""

    # Write config
    config_path.parent.mkdir(parents=True, exist_ok=True)
    config_path.write_text(config_content)

    success(f"Configuration saved to {config_path}")
    info("\nNext steps:")
    info("  1. Review and edit the config file if needed")
    info("  2. Run 'openclaw gateway start' to start the server")
    if use_telegram:
        info("  3. Run 'openclaw telegram start' to start the Telegram bot")
    info("\nFor help, run 'openclaw --help'")
