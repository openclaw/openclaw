openapi: 3.0.3
info:
  title: dispatch-api (v0)
  version: 0.1.0
  description: |
    Enforcement service for AI-first dispatch.
    All state mutations happen via command endpoints with idempotency and audit events.
servers:
  - url: http://localhost:8080
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
  /tickets:
    post:
      summary: Create a ticket (work order)
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TicketCreate' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Ticket' }
  /tickets/{ticketId}:
    get:
      summary: Get ticket
      parameters:
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Ticket' }

  /tickets/{ticketId}/triage:
    post:
      summary: Triage ticket (classify, set priority, incident type, SLA)
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TicketTriage' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Ticket' }}}}

  /tickets/{ticketId}/schedule/propose:
    post:
      summary: Propose schedule options
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SchedulePropose' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/schedule/confirm:
    post:
      summary: Confirm chosen schedule
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ScheduleConfirm' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Ticket' }}}}

  /tickets/{ticketId}/assignment/dispatch:
    post:
      summary: Assign and dispatch to technician/provider
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DispatchAssign' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Ticket' }}}}

  /tickets/{ticketId}/tech/check-in:
    post:
      summary: Technician check-in (on-site)
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TechCheckIn' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/tech/request-change:
    post:
      summary: Request change (NTE increase/proposal)
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChangeRequest' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/approval/decide:
    post:
      summary: Approve or deny change request
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ApprovalDecision' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/tech/complete:
    post:
      summary: Complete work (requires evidence)
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CompleteWork' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/qa/verify:
    post:
      summary: Verify completion (QA/customer acceptance)
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/QAVerify' }
      responses:
        '200': { description: OK }

  /tickets/{ticketId}/billing/generate-invoice:
    post:
      summary: Generate invoice from verified work
      parameters:
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200': { description: OK }

components:
  parameters:
    TicketId:
      name: ticketId
      in: path
      required: true
      schema: { type: string, format: uuid }
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema: { type: string, format: uuid }
  schemas:
    TicketCreate:
      type: object
      required: [account_id, site_id, summary]
      properties:
        account_id: { type: string, format: uuid }
        site_id: { type: string, format: uuid }
        asset_id: { type: string, format: uuid, nullable: true }
        summary: { type: string }
        description: { type: string }
        requester_contact: { type: object, additionalProperties: true }
        channel: { type: string }
        attachments: { type: array, items: { type: object, additionalProperties: true } }
    TicketTriage:
      type: object
      required: [priority, incident_type]
      properties:
        priority: { type: string, enum: [EMERGENCY, URGENT, ROUTINE] }
        incident_type: { type: string }
        risk_flags: { type: array, items: { type: string } }
        nte_cents: { type: integer }
        notes: { type: string }
    SchedulePropose:
      type: object
      required: [options]
      properties:
        options:
          type: array
          items:
            type: object
            required: [start, end]
            properties:
              start: { type: string, format: date-time }
              end: { type: string, format: date-time }
    ScheduleConfirm:
      type: object
      required: [start, end]
      properties:
        start: { type: string, format: date-time }
        end: { type: string, format: date-time }
    DispatchAssign:
      type: object
      required: [tech_id]
      properties:
        tech_id: { type: string, format: uuid }
        provider_id: { type: string, format: uuid, nullable: true }
        notes: { type: string }
    TechCheckIn:
      type: object
      required: [timestamp]
      properties:
        timestamp: { type: string, format: date-time }
        location: { type: object, additionalProperties: true }
    ChangeRequest:
      type: object
      required: [approval_type, reason]
      properties:
        approval_type: { type: string, enum: [NTE_INCREASE, PROPOSAL] }
        amount_delta_cents: { type: integer }
        reason: { type: string }
        evidence_refs: { type: array, items: { type: string } }
    ApprovalDecision:
      type: object
      required: [approval_id, decision]
      properties:
        approval_id: { type: string, format: uuid }
        decision: { type: string, enum: [APPROVED, DENIED] }
        notes: { type: string }
    CompleteWork:
      type: object
      required: [timestamp, completion_notes, evidence_refs]
      properties:
        timestamp: { type: string, format: date-time }
        completion_notes: { type: string }
        evidence_refs: { type: array, items: { type: string } }
        signature_ref: { type: string, nullable: true }
        no_signature_reason: { type: string, nullable: true }
    QAVerify:
      type: object
      required: [timestamp, result]
      properties:
        timestamp: { type: string, format: date-time }
        result: { type: string, enum: [PASS, FAIL] }
        notes: { type: string }
    Ticket:
      type: object
      properties:
        id: { type: string, format: uuid }
        account_id: { type: string, format: uuid }
        site_id: { type: string, format: uuid }
        asset_id: { type: string, format: uuid, nullable: true }
        state: { type: string }
        priority: { type: string }
        incident_type: { type: string }
        summary: { type: string }
        description: { type: string }
        nte_cents: { type: integer }
        scheduled_start: { type: string, format: date-time, nullable: true }
        scheduled_end: { type: string, format: date-time, nullable: true }
        version: { type: integer }
