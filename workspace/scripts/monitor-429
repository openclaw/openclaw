#!/bin/bash
#
# ğŸš¨ MONITOR-429 - 429 éŒ¯èª¤ç›£æ§å‘Šè­¦
#
# ç›£æ§ 429 éŒ¯èª¤ï¼Œè¶…éé–¾å€¼æ™‚ç™¼é€ Telegram å‘Šè­¦
#
# Usage:
#   ./monitor-429              # å–®æ¬¡æª¢æŸ¥
#   ./monitor-429 watch        # æŒçºŒç›£æ§ï¼ˆæ¯ 5 åˆ†é˜ï¼‰
#   ./monitor-429 reset        # é‡ç½®è¨ˆæ•¸
#

CONTAINER="moltbot-core.router.wuji.01-stg"
LOG_BOT_TOKEN="8415477831:AAFeyWZS8iAPqrQxYG_e3CxDWR2IrgIxw68"
LOG_CHAT_ID="-5266835049"
STATE_FILE="/tmp/monitor-429-state"
THRESHOLD=10  # 5 åˆ†é˜å…§è¶…éæ­¤æ•¸é‡å‰‡å‘Šè­¦

# é¡è‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

send_alert() {
  local message="$1"
  curl -s -X POST "https://api.telegram.org/bot${LOG_BOT_TOKEN}/sendMessage" \
    -d "chat_id=${LOG_CHAT_ID}" \
    -d "text=${message}" \
    -d "parse_mode=HTML" > /dev/null
}

check_429() {
  # ç²¾ç¢ºåŒ¹é…çœŸæ­£çš„ 429 HTTP éŒ¯èª¤ï¼ˆæ’é™¤ç¾¤çµ„ ID ä¸­çš„ 429ï¼‰
  local count
  count=$(docker logs "$CONTAINER" --since "5m" 2>&1 | grep -cE "(429 - |429 Too Many|rate.?limit)" 2>/dev/null)
  count=${count:-0}
  local line_count
  line_count=$(docker logs "$CONTAINER" --since "5m" 2>&1 | grep -c "\[line\].*429" 2>/dev/null)
  line_count=${line_count:-0}

  echo -e "${YELLOW}ğŸ“Š æœ€è¿‘ 5 åˆ†é˜ 429 çµ±è¨ˆ${NC}"
  echo "  ç¸½è¨ˆ: $count æ¬¡"
  echo "  LINE: $line_count æ¬¡"

  # è®€å–ä¸Šæ¬¡è¨ˆæ•¸
  local last_count=0
  [ -f "$STATE_FILE" ] && last_count=$(cat "$STATE_FILE")

  # ä¿å­˜ç•¶å‰è¨ˆæ•¸
  echo "$count" > "$STATE_FILE"

  # æª¢æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
  if [ "$count" -ge "$THRESHOLD" ] && [ "$count" -gt "$last_count" ]; then
    echo -e "${RED}ğŸš¨ è¶…éé–¾å€¼ï¼ç™¼é€å‘Šè­¦...${NC}"
    send_alert "ğŸš¨ <b>429 å‘Šè­¦</b>

æœ€è¿‘ 5 åˆ†é˜å…§ç™¼ç”Ÿ $count æ¬¡ 429 éŒ¯èª¤
LINE ç›¸é—œ: $line_count æ¬¡

å¯èƒ½åŸå› :
- LINE Push Message é¡åº¦ç”¨ç›¡
- Agent ä½¿ç”¨ message å·¥å…·è€Œéç›´æ¥å›è¦†

å»ºè­°:
- æª¢æŸ¥ Agent æ˜¯å¦éµå®ˆ TOOLS.md è¦å‰‡
- ç­‰å¾… Push é¡åº¦é‡ç½®
- è€ƒæ…®å‡ç´š LINE æ–¹æ¡ˆ"
    echo -e "${GREEN}âœ… å‘Šè­¦å·²ç™¼é€${NC}"
  elif [ "$count" -eq 0 ]; then
    echo -e "${GREEN}âœ… ç„¡ 429 éŒ¯èª¤${NC}"
  else
    echo -e "${YELLOW}âš ï¸ æœ‰ $count æ¬¡éŒ¯èª¤ï¼Œä½†æœªè¶…éé–¾å€¼ ($THRESHOLD)${NC}"
  fi
}

watch_mode() {
  echo -e "${GREEN}ğŸ‘ï¸ é–‹å§‹æŒçºŒç›£æ§ï¼ˆæ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼‰${NC}"
  echo "æŒ‰ Ctrl+C åœæ­¢"
  echo ""

  while true; do
    echo "---"
    date
    check_429
    sleep 300
  done
}

reset_state() {
  rm -f "$STATE_FILE"
  echo -e "${GREEN}âœ… è¨ˆæ•¸å·²é‡ç½®${NC}"
}

# ä¸»å…¥å£
case "$1" in
  watch)
    watch_mode
    ;;
  reset)
    reset_state
    ;;
  *)
    check_429
    ;;
esac
