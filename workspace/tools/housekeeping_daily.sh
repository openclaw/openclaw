#!/usr/bin/env bash
set -euo pipefail

# Convenience wrapper around tools/housekeeping.sh
# Goal: standardize report naming so we don't accumulate dash/underscore variants.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

TOP_N=15
TS=0
OUT_DIR="$ROOT_DIR/memory"

usage() {
  cat <<'EOF'
Usage: bash tools/housekeeping_daily.sh [--top N] [--timestamp] [--out-dir DIR]

Writes a housekeeping report to a standardized path.

Default output:
  memory/housekeeping-YYYY-MM-DD.md

If --timestamp is set:
  memory/housekeeping-YYYY-MM-DD-HHMM.md

Options:
  --top N        Largest dirs/files to show (default: 15)
  --timestamp    Add HHMM to the filename
  --out-dir DIR  Output directory (default: memory/)
  -h, --help     Show this help
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --top) TOP_N="${2:-}"; shift 2;;
    --timestamp) TS=1; shift;;
    --out-dir) OUT_DIR="${2:-}"; shift 2;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1"; usage; exit 2;;
  esac
done

mkdir -p "$OUT_DIR"

if [[ $TS -eq 1 ]]; then
  OUT_PATH="$OUT_DIR/housekeeping-$(date +%F-%H%M).md"
else
  OUT_PATH="$OUT_DIR/housekeeping-$(date +%F).md"
fi

bash "$ROOT_DIR/tools/housekeeping.sh" --report-md --top "$TOP_N" --out "$OUT_PATH"

# Update memory/housekeeping_index.md (idempotent)
INDEX_PATH="$ROOT_DIR/memory/housekeeping_index.md"
DAY="$(date +%F)"
BASE="$(basename -- "$OUT_PATH")"
REL="memory/$BASE"

mkdir -p "$(dirname -- "$INDEX_PATH")"
if [[ ! -f "$INDEX_PATH" ]]; then
  {
    echo "# housekeeping reports index"
    echo
    echo "## Naming convention (suggested)"
    echo "- Prefer: \\`housekeeping-YYYY-MM-DD.md\\` (one per day)"
    echo "- If multiple exist for a day (underscores/dashes), keep all unless explicitly asked to consolidate."
    echo
  } > "$INDEX_PATH"
fi

# Ensure day section exists
if ! grep -q "^## $DAY$" "$INDEX_PATH"; then
  {
    echo
    echo "## $DAY"
  } >> "$INDEX_PATH"
fi

# Add bullet if missing
if ! grep -Fq -- "- \`$REL\`" "$INDEX_PATH"; then
  BULLET="- \`$REL\` â€” generated by tools/housekeeping_daily.sh"
  TMP_PATH="$(mktemp)"

  # Insert the bullet directly under the matching day header.
  # If something is weird and the header can't be found, fall back to appending
  # a new section at the end (safe, non-destructive).
  awk -v day="$DAY" -v bullet="$BULLET" '
    BEGIN { inserted=0 }
    {
      if ($0 == "## " day && inserted == 0) {
        print $0
        print bullet
        inserted=1
        next
      }
      print $0
    }
    END {
      if (inserted == 0) {
        print ""
        print "## " day
        print bullet
      }
    }
  ' "$INDEX_PATH" > "$TMP_PATH"

  mv "$TMP_PATH" "$INDEX_PATH"
fi

echo "Wrote: $OUT_PATH"