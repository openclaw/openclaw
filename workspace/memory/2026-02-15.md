# 2026-02-15 — Tally Prime Integration Work

## Tally Setup
- Tally Prime EDU running on localhost:9000 (XML API)
- Companies: PAVISHA POLYMERS (from Apr 2019), PAVISHA PET INDUSTRIES (from Apr 2022), Proforma Invoice (from Jan 2026)
- Company data at `C:\Users\Public\TallyPrime\data\` (copied from pendrive E:\Data)
- Financial year: Jan-Dec (not Apr-Mar) — Current Period was 1-Jan-26 to 31-Dec-26

## What We Did
- Verified both companies loaded, data intact via XML API
- PAVISHA POLYMERS: 170 ledgers, 114 stock items, 42 vouchers
- PAVISHA PET INDUSTRIES: 230 ledgers, 95 stock items, 109 vouchers
- Read sales register PDF from pendrive (`E:\sale poly.pdf`) — PAVISHA POLYMERS sales Jul 2025 - Jan 2026, ₹31.87L total, 61 invoices (#38-#98)
- Extracted BOMs from both companies — PET Industries uses ASPET resin as base; Polymers uses PET PREFORMS (blowing operation)
- **81 out of 114 items in PAVISHA POLYMERS have BOM configured** (all use PET PREFORMS as main raw material)

## Task: Create Manufacturing Journals
- Goal: For each sale (non-charge items), create Manufacturing Journal dated 1 day before sale
- Skip items with "Charge" in name (blowing charges are service, not products)
- First non-charge sale: Invoice #43, 23-Jul-25, Arun Book Depo (47gm bottle + 45gm flip top cap)
- Manufacturing Journal needs: output items (INVENTORYENTRIESIN) + consumed raw materials (INVENTORYENTRIESOUT) based on BOM

## Problems Encountered
- **GUI automation partially works**: AttachThreadInput + SendInput gets focus, but Tally's custom text fields don't accept typed input. WM_CHAR works for menu navigation but not text fields.
- **Period restriction**: EDU mode locks the period; API can set SVFROMDATE/SVTODATE but vouchers outside GUI period silently fail to persist
- **Feature changes broke voucher creation**: After enabling Cost Centres, Cost Tracking, Job Costing via F11, ALL voucher creation via API broke with "Voucher date is missing... retry Split" error — even after reverting features and restarting Tally
- **Likely data corruption**: The Split error persists regardless of voucher type, date, or settings. Company data may need to be restored from pendrive backup.

## Tools Installed
- pyautogui, pygetwindow, keyboard (Python) for GUI automation
- BOM extraction scripts at `D:\openclaw\workspace\extract_bom.py` and `extract_poly_bom.py`
- Full stock item exports saved at `pet_stockitems_full.xml` and `poly_stockitems_full.xml`

## Session 2 — Company Alter Timeout Issue
- Attempted to enable BOM/Manufacturing Journal via API company alter (`USEMANUFJOURNAL=Yes`, `ISBILLOFMATERIALSENABLED=Yes`)
- **Request timed out after 30s** — Tally likely showing a GUI confirmation dialog that blocks the API response
- Screenshot saved to `D:/openclaw/workspace/tally_now.png` for diagnosis
- Only 2 companies visible now: PAVISHA POLYMERS and "Proforma Invoice - (from 1-Jan-26)" — user was supposed to delete Proforma Invoice
- User agreed to use today's date (15-Feb-2026) for all manufacturing journals to avoid EDU mode period restrictions

## Tally Skill Created ✅
- Location: `workspace/skills/tally/` (SKILL.md, scripts/tally.py, references/)
- **Single Python script** handles both XML API and GUI keyboard automation
- JSON file interface (`--file request.json`) — zero escaping issues for any model
- Key sequence DSL: `ESC*5 F2 type:15-02-2026 ENTER ALT+D` — expressive, compact
- Actions: list_companies, list_ledgers, list_stock_items, list_vouchers, get_bom, create_voucher, create_master, alter_company, export_report, export_collection, raw_xml, gui_keys, gui_escape, gui_screenshot, gui_navigate
- Fixed: Tally XML contains invalid char refs (`&#4;`) — sanitizer strips them
- Tested: list_companies (1 company), list_stock_items (114 items parsed correctly)
- Committed to git

## Next Steps (when resuming)
1. Check screenshot `tally_now.png` — if Tally shows confirmation dialog, dismiss it (Enter/Y key)
2. Enable BOM/Manufacturing Journal in PAVISHA POLYMERS
3. Map sales items to BOMs (81/114 items already have BOM in Polymers)
4. Create test Manufacturing Journal for Invoice #43 items
5. Batch-create all remaining Manufacturing Journals
6. Clean up test vouchers (PERIOD-TEST stock journal still exists)
7. Delete Proforma Invoice company
