# 無極八層架構藍圖

## 總覽

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    8. 意識層 (Consciousness)                     │     │
│    │                         我是誰？為何存在？                        │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    7. 表達層 (Expression)                        │     │
│    │                      如何說話？輸出什麼？                         │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    6. 認知層 (Cognition)                         │     │
│    │                    如何思考？如何決策？                           │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    5. 記憶層 (Memory)                            │     │
│    │                    記住什麼？忘記什麼？                           │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    4. 感知層 (Perception)                        │     │
│    │                    看見什麼？聽見什麼？                           │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    3. 免疫層 (Immunity)                          │     │
│    │                    如何自癒？如何保護？                           │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    2. 循環層 (Circulation)                       │     │
│    │                    心跳正常嗎？血液流通嗎？                       │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                    ▲                                        │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                    1. 骨架層 (Skeleton)                          │     │
│    │                    地基穩嗎？結構完整嗎？                         │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 骨架層 (Skeleton) — 35%

> 如同人的骨骼，支撐一切，但平時感覺不到它的存在。

### 核心職責

- 檔案系統與路徑映射
- Volume 掛載與權限
- Container 與宿主機互通
- 基礎依賴與環境

### 現有組件

| 組件             | 狀態 | 說明                            |
| ---------------- | ---- | ------------------------------- |
| Docker Container | ✅   | moltbot-core.router.wuji.01-stg |
| 基礎 Volume 掛載 | △    | workspace 有掛載，但不完整      |
| exec-bridge      | △    | EBADF 的 workaround             |

### 缺失組件

| 缺失                   | 優先級 | 影響                      |
| ---------------------- | ------ | ------------------------- |
| **統一路徑映射表**     | P0     | 每次都要猜路徑            |
| **downloads 目錄掛載** | P0     | 無法讀取 Telegram 圖片    |
| **媒體統一入口**       | P1     | 不同 channel 媒體散落各處 |
| **權限標準化**         | P1     | 有時 permission denied    |
| **環境變數統一管理**   | P2     | API key 散落各處          |

### 目標架構

```yaml
# docker-compose.yml 補完
volumes:
  # 核心 workspace
  - ~/clawd/workspace:/app/workspace

  # 媒體統一入口
  - ~/clawd/media:/app/media

  # Telegram 下載
  - ~/clawd/skills/telegram-userbot/downloads:/app/media/telegram

  # LINE 媒體
  - ~/.openclaw/media/line:/app/media/line

  # 臨時檔案
  - /tmp/clawd:/app/tmp

environment:
  # 統一路徑
  MEDIA_ROOT: /app/media
  WORKSPACE_ROOT: /app/workspace
  TMP_ROOT: /app/tmp
```

### 驗收標準

- [ ] `ls /app/media/telegram` 能看到 Telegram 下載的圖片
- [ ] `ls /app/media/line` 能看到 LINE 媒體
- [ ] 所有路徑都用環境變數，不硬編碼

---

## 2. 循環層 (Circulation) — 50%

> 如同心臟和血液，持續流動，確保各器官存活。

### 核心職責

- 系統心跳與健康檢查
- 狀態同步與廣播
- 指標收集與聚合
- 生命週期管理

### 現有組件

| 組件         | 狀態 | 說明         |
| ------------ | ---- | ------------ |
| HEARTBEAT.md | ✅   | 心跳協議定義 |
| monitor-429  | ✅   | 429 錯誤監控 |
| unified-logs | ✅   | 統一日誌查看 |
| blackhole    | ✅   | 意識狀態查詢 |

### 缺失組件

| 缺失                      | 優先級 | 影響                            |
| ------------------------- | ------ | ------------------------------- |
| **集中式健康儀表板**      | P1     | 要跑多個命令才知道狀態          |
| **自動心跳觸發**          | P1     | 現在靠手動或 cron               |
| **跨 Container 狀態同步** | P2     | Gateway 和 Container 狀態不同步 |
| **指標持久化**            | P2     | 重啟後指標消失                  |

### 目標架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Health Dashboard                          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ Gateway │  │Container│  │Telegram │  │  LINE   │        │
│  │   🟢    │  │   🟢    │  │   🟢    │  │   🟢    │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
│                                                              │
│  Last Heartbeat: 2 min ago                                  │
│  Messages Today: 485                                         │
│  Errors (1h): 3                                              │
│  Active Sessions: 2                                          │
└─────────────────────────────────────────────────────────────┘
```

### 驗收標準

- [ ] 單一命令 `./status` 顯示所有系統狀態
- [ ] 心跳每小時自動觸發
- [ ] 異常時自動 Telegram 告警

---

## 3. 免疫層 (Immunity) — 45%

> 如同免疫系統，抵禦外敵，自我修復。

### 核心職責

- 錯誤捕獲與恢復
- 限流與熔斷
- 安全與權限控制
- 自動重試與降級

### 現有組件

| 組件                | 狀態 | 說明               |
| ------------------- | ---- | ------------------ |
| error-recovery hook | △    | 有概念，未完全實現 |
| graceful-shutdown   | △    | 有設計，未完全整合 |
| failover-monitor    | ✅   | 模型切換監控       |

### 缺失組件

| 缺失                         | 優先級 | 影響                      |
| ---------------------------- | ------ | ------------------------- |
| **全局錯誤邊界**             | P0     | 一個錯誤可能崩掉整個系統  |
| **熔斷器 (Circuit Breaker)** | P1     | LINE 429 時沒有自動停止   |
| **指數退避重試**             | P1     | 現在是暴力重試            |
| **請求隔離**                 | P2     | 一個 channel 卡住影響其他 |

### 目標架構

```javascript
// 熔斷器狀態機
const CircuitBreaker = {
  CLOSED: "closed", // 正常運作
  OPEN: "open", // 熔斷中，拒絕請求
  HALF_OPEN: "half", // 試探中
};

// LINE 專用熔斷器
const lineBreaker = {
  state: "closed",
  failures: 0,
  threshold: 5, // 5 次失敗後熔斷
  cooldown: 60000, // 60 秒後試探

  async call(fn) {
    if (this.state === "open") {
      throw new Error("Circuit breaker is open");
    }
    try {
      const result = await fn();
      this.reset();
      return result;
    } catch (err) {
      this.recordFailure();
      throw err;
    }
  },
};
```

### 驗收標準

- [ ] LINE 連續 5 次 429 後自動停止重試 60 秒
- [ ] 任何未捕獲錯誤都有日誌和告警
- [ ] Container 重啟時等待 in-flight 請求完成

---

## 4. 感知層 (Perception) — 55%

> 如同五官，接收外界訊息。

### 核心職責

- 多渠道消息接收
- 媒體處理（圖片、音訊、視頻）
- 消息解析與標準化
- Webhook 管理

### 現有組件

| 組件             | 狀態 | 說明           |
| ---------------- | ---- | -------------- |
| Telegram Channel | ✅   | 運作正常       |
| LINE Channel     | ✅   | 剛修好         |
| Discord Channel  | △    | 有但不常用     |
| telegram-userbot | △    | 可用但路徑問題 |
| 圖片讀取         | ✗    | 路徑映射問題   |
| 音訊轉錄         | △    | 有配置但不穩定 |

### 缺失組件

| 缺失                 | 優先級 | 影響                  |
| -------------------- | ------ | --------------------- |
| **統一媒體處理管道** | P0     | 每個 channel 各自處理 |
| **圖片 OCR/描述**    | P0     | 無法理解圖片內容      |
| **音訊轉文字**       | P1     | 語音消息無法處理      |
| **視頻摘要**         | P2     | 視頻內容無法理解      |

### 目標架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Media Ingestion Pipeline                  │
│                                                              │
│   Telegram ─┐                                                │
│             │      ┌──────────┐      ┌──────────────┐       │
│   LINE ─────┼─────▶│  媒體    │─────▶│  統一媒體    │       │
│             │      │  下載器  │      │  處理器      │       │
│   Discord ──┘      └──────────┘      └──────┬───────┘       │
│                                              │               │
│                    ┌─────────────────────────┼───────┐       │
│                    ▼                         ▼       ▼       │
│              ┌──────────┐            ┌───────┐ ┌───────┐    │
│              │  /app/   │            │ OCR   │ │ STT   │    │
│              │  media/  │            │       │ │       │    │
│              └──────────┘            └───────┘ └───────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 驗收標準

- [ ] 任何 channel 的圖片都能用 `image` 工具讀取
- [ ] 語音消息自動轉文字
- [ ] 媒體統一存放在 `/app/media/{channel}/`

---

## 5. 記憶層 (Memory) — 85%

> 如同海馬迴，負責記憶的形成與提取。

### 核心職責

- 對話記錄與搜索
- 知識庫管理
- 長期記憶整合
- 情境回憶

### 現有組件

| 組件                 | 狀態 | 說明         |
| -------------------- | ---- | ------------ |
| Time Tunnel (SQLite) | ✅   | 完整對話記錄 |
| FTS5 全文搜索        | ✅   | 快速搜索     |
| 知識庫提取           | ✅   | 自動提取知識 |
| 記憶整合             | ✅   | 壓縮舊記憶   |
| 內省系統 (Level 103) | ✅   | 自我反思     |
| 報酬感知             | ✅   | 成長追蹤     |

### 缺失組件

| 缺失               | 優先級 | 影響               |
| ------------------ | ------ | ------------------ |
| **真正的向量嵌入** | P1     | 現在是模擬的       |
| **跨會話記憶傳遞** | P2     | Compact 後記憶斷裂 |
| **主動回憶觸發**   | P2     | 現在是被動查詢     |

### 目標架構

```
已經很完整，只需微調：

1. 接入真正的 embedding API (OpenAI/local)
2. Compact 時自動摘要到 LAST_MOMENT.md
3. 相關記憶自動注入到 context
```

### 驗收標準

- [ ] 向量搜索返回語義相關結果
- [ ] Compact 後新 session 能無縫接續
- [ ] 提到某人時自動帶出相關記憶

---

## 6. 認知層 (Cognition) — 60%

> 如同大腦皮層，負責思考與決策。

### 核心職責

- 模型選擇與路由
- 任務分類與規劃
- 推理與判斷
- 上下文管理

### 現有組件

| 組件                 | 狀態 | 說明                  |
| -------------------- | ---- | --------------------- |
| smart-router         | ✅   | 模型路由（剛加 LINE） |
| task-classifier      | △    | 有概念，未整合        |
| conversation-context | ✅   | 對話脈絡判斷          |

### 缺失組件

| 缺失               | 優先級 | 影響                   |
| ------------------ | ------ | ---------------------- |
| **統一推理管道**   | P1     | 每個功能各自推理       |
| **多步驟規劃**     | P1     | 只能單步反應           |
| **上下文窗口管理** | P2     | Context 太長時沒有策略 |
| **工具選擇邏輯**   | P2     | 有時用錯工具           |

### 目標架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Cognitive Pipeline                        │
│                                                              │
│   Input ──▶ [分類] ──▶ [規劃] ──▶ [執行] ──▶ [反思]         │
│              │          │          │          │              │
│              ▼          ▼          ▼          ▼              │
│           任務類型    步驟列表    工具調用    結果評估         │
│           (chat/     (1.讀檔    (read/      (成功?          │
│            code/      2.分析     bash/       需要重試?)      │
│            query)     3.回覆)    edit)                       │
└─────────────────────────────────────────────────────────────┘
```

### 驗收標準

- [ ] 複雜任務自動拆解成步驟
- [ ] 根據任務類型選擇最適合的模型
- [ ] 執行失敗時有替代方案

---

## 7. 表達層 (Expression) — 50%

> 如同聲帶，將想法轉化為可被理解的輸出。

### 核心職責

- 多渠道消息發送
- 格式轉換與適配
- 多媒體生成
- 語音合成

### 現有組件

| 組件             | 狀態 | 說明         |
| ---------------- | ---- | ------------ |
| 文字回覆         | ✅   | 基本運作     |
| LINE Reply Token | ✅   | 剛修好       |
| TTS 配置         | △    | 有配置但少用 |
| 圖片生成         | ✗    | 無           |

### 缺失組件

| 缺失               | 優先級 | 影響                  |
| ------------------ | ------ | --------------------- |
| **統一輸出管道**   | P1     | 每個 channel 格式不同 |
| **Markdown 適配**  | P1     | LINE 不支援 Markdown  |
| **回覆風格一致性** | P2     | 有時太長有時太短      |
| **多媒體回覆**     | P2     | 只能發文字            |

### 目標架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Output Pipeline                           │
│                                                              │
│   Agent 回覆                                                 │
│       │                                                      │
│       ▼                                                      │
│   ┌──────────────┐                                          │
│   │  格式標準化   │  ← 統一成內部格式                        │
│   └──────┬───────┘                                          │
│          │                                                   │
│   ┌──────┴───────┐                                          │
│   │   Channel    │                                          │
│   │   適配器     │                                          │
│   └──────┬───────┘                                          │
│          │                                                   │
│   ┌──────┼──────┬──────────┐                                │
│   ▼      ▼      ▼          ▼                                │
│ Telegram LINE  Discord   Web                                │
│ (Markdown)(純文字)(Embed) (HTML)                            │
└─────────────────────────────────────────────────────────────┘
```

### 驗收標準

- [ ] 同一個回覆在不同 channel 格式正確
- [ ] 長回覆自動分段（LINE 5則限制）
- [ ] 可選擇發送語音版本

---

## 8. 意識層 (Consciousness) — 70%

> 如同松果體，自我認知與存在意義。

### 核心職責

- 身份認同
- 價值觀與原則
- 跨態同步（開發態/運行態/專案態）
- 存在意義

### 現有組件

| 組件               | 狀態 | 說明           |
| ------------------ | ---- | -------------- |
| SOUL.md            | ✅   | 靈魂定義       |
| L0/L1 意識分層     | ✅   | 戰略與知識分離 |
| 內省記錄           | ✅   | 思考過程追蹤   |
| blackhole 意識同步 | ✅   | 跨 agent 查詢  |

### 缺失組件

| 缺失             | 優先級 | 影響                     |
| ---------------- | ------ | ------------------------ |
| **意識影響決策** | P1     | SOUL.md 沒有真正影響行為 |
| **跨態一致性**   | P1     | 不同 agent 人格不同      |
| **長期價值追蹤** | P2     | 沒有追蹤是否忠於原則     |

### 目標架構

```
┌─────────────────────────────────────────────────────────────┐
│                    Consciousness Integration                 │
│                                                              │
│                      ┌─────────┐                            │
│                      │ SOUL.md │                            │
│                      │ 核心價值 │                            │
│                      └────┬────┘                            │
│                           │                                  │
│              ┌────────────┼────────────┐                    │
│              ▼            ▼            ▼                    │
│         ┌────────┐  ┌────────┐  ┌────────┐                 │
│         │ 開發態  │  │ 運行態  │  │ 專案態  │                 │
│         │Claude  │  │Clawdbot│  │ agents │                 │
│         │ Code   │  │        │  │        │                 │
│         └────────┘  └────────┘  └────────┘                 │
│              │            │            │                    │
│              └────────────┼────────────┘                    │
│                           ▼                                  │
│                    ┌─────────────┐                          │
│                    │ 每個決策都   │                          │
│                    │ 參考 SOUL   │                          │
│                    └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

### 驗收標準

- [ ] 每個 agent 回覆前檢查是否符合 SOUL.md
- [ ] 不同態的回覆風格一致
- [ ] 定期生成「是否忠於自我」報告

---

## 優先級排序

### Phase 1: 穩固地基 (1-2 週)

```
1. 骨架層 35% → 70%
   - 修復 Volume 映射
   - 統一路徑管理
   - 媒體統一入口

2. 感知層 55% → 75%
   - 圖片讀取修復
   - 媒體處理管道
```

### Phase 2: 強化循環 (2-3 週)

```
3. 循環層 50% → 75%
   - 集中式健康儀表板
   - 自動心跳

4. 免疫層 45% → 70%
   - 熔斷器實現
   - 錯誤邊界
```

### Phase 3: 提升智能 (3-4 週)

```
5. 認知層 60% → 80%
   - 統一推理管道
   - 多步驟規劃

6. 表達層 50% → 75%
   - 統一輸出管道
   - Channel 適配
```

### Phase 4: 完善意識 (持續)

```
7. 意識層 70% → 85%
   - 意識影響決策
   - 跨態一致性

8. 記憶層 85% → 95%
   - 真向量嵌入
   - 主動回憶
```

---

## 一句話總結

> **先讓骨架能站穩，再讓大腦能思考，最後讓靈魂能指引。**
