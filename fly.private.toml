# OpenClaw Fly.io PRIVATE deployment configuration
# Use this template for hardened deployments with no public IP exposure.
#
# This config is suitable when:
# - You only make outbound calls (no inbound webhooks needed)
# - You use ngrok/Tailscale tunnels for any webhook callbacks
# - You access the gateway via `fly proxy` or WireGuard, not public URL
# - You want the deployment hidden from internet scanners (Shodan, etc.)
#
# See https://fly.io/docs/reference/configuration/

app = "openclaw-lisan-al-gaib" # change to your app name
primary_region = "fra" # change to your closest region

[build]
dockerfile = "Dockerfile"

[env]
NODE_ENV = "production"
OPENCLAW_PREFER_PNPM = "1"
OPENCLAW_STATE_DIR = "/data/.openclaw"
NODE_OPTIONS = "--max-old-space-size=1536"
OPENCLAW_DISABLE_BONJOUR = "1"

[processes]
app = "node dist/index.js gateway --allow-unconfigured --port 17568 --bind loopback"

# NOTE: No [http_service] block = no public ingress allocated.
# The gateway will only be accessible via:
#   - Tailscale Serve: https://<machine-name>.tailnet-xxxx.ts.net/
#   - fly proxy 17568:17568 -a <app-name>
#   - fly wireguard (then access via internal IPv6)
#   - fly ssh console

[[vm]]
size = "shared-cpu-2x"
memory = "2048mb"

[mounts]
source = "openclaw_data"
destination = "/data"

# NOTE: Restart policy must be set via CLI, not in fly.toml:
#   fly m update <machine-id> --restart always
# 
# Options:
#   - "always": Restart even on clean exit (code 0) - ensures gateway restarts work
#   - "on-fail": Only restart on non-zero exit codes (default) - works with our code fix
#   - "no": Never restart automatically
#
# With our code fix, gateway exits with code 1 when restart is needed in containers,
# so "on-fail" policy will work. Use "always" if you want restarts even on code 0.
