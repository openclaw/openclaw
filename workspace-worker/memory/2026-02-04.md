# 2026-02-04

## CP-2026-02-04-013: sessions_send idle session timeout investigation

### Root Cause Analysis

**Problem:** `sessions_send` times out when sending to idle sessions, but `sessions_spawn` works fine.

**Root Cause:** The `nested` command lane is not configured with a concurrency limit, defaulting to `maxConcurrent: 1`.

#### Technical Details

1. **Lane Usage:**
   - `sessions_send` → `AGENT_LANE_NESTED` → `CommandLane.Nested`
   - `sessions_spawn` → `AGENT_LANE_SUBAGENT` → `CommandLane.Subagent`

2. **Lane Configuration in `server-lanes.ts`:**

   ```typescript
   setCommandLaneConcurrency(CommandLane.Cron, cfg.cron?.maxConcurrentRuns ?? 1);
   setCommandLaneConcurrency(CommandLane.Main, resolveAgentMaxConcurrent(cfg)); // default 4
   setCommandLaneConcurrency(CommandLane.Subagent, resolveSubagentMaxConcurrent(cfg)); // default 8
   // CommandLane.Nested is NOT configured! Defaults to 1
   ```

3. **Queue Behavior in `command-queue.ts`:**

   ```typescript
   function getLaneState(lane: string): LaneState {
     const created: LaneState = {
       ...
       maxConcurrent: 1,  // DEFAULT IS 1
     };
   }
   ```

4. **Flow When sessions_send is Called:**
   - Main agent (on Main lane) calls `sessions_send` tool
   - Tool calls gateway with `method: "agent"` and `lane: "nested"`
   - Gateway starts target agent run
   - Target agent enqueues on Nested lane (only 1 slot!)
   - Main agent waits via `agent.wait`
   - If Nested lane busy, target run queues behind existing nested task
   - `agent.wait` times out

5. **Why sessions_spawn Works:**
   - Uses Subagent lane which is configured with concurrency 8
   - Higher concurrency = less blocking
   - Also: spawn doesn't wait for completion by default (returns immediately with runId)

### Proposed Fix

**Option A (Minimal):** Add nested lane concurrency in `server-lanes.ts`:

```typescript
// Add to server-lanes.ts
const DEFAULT_NESTED_MAX_CONCURRENT = 8; // Same as subagent

export function applyGatewayLaneConcurrency(cfg: ReturnType<typeof loadConfig>) {
  setCommandLaneConcurrency(CommandLane.Cron, cfg.cron?.maxConcurrentRuns ?? 1);
  setCommandLaneConcurrency(CommandLane.Main, resolveAgentMaxConcurrent(cfg));
  setCommandLaneConcurrency(CommandLane.Subagent, resolveSubagentMaxConcurrent(cfg));
  setCommandLaneConcurrency(CommandLane.Nested, DEFAULT_NESTED_MAX_CONCURRENT); // ADD THIS
}
```

**Option B (Full):** Add config option `agents.defaults.nested.maxConcurrent`:

- Update schema in `zod-schema.agent-defaults.ts`
- Add resolver in `agent-limits.ts`
- Wire up in `server-lanes.ts`

### Files to Modify

1. `src/gateway/server-lanes.ts` - Add nested lane configuration
2. `src/gateway/server-reload-handlers.ts` - Add reload handler for nested
3. `src/config/agent-limits.ts` - Add `resolveNestedMaxConcurrent()` (if Option B)
4. `src/config/zod-schema.agent-defaults.ts` - Add schema (if Option B)
5. `src/config/types.agent-defaults.ts` - Add type (if Option B)

### Recommendation

Option A is sufficient for immediate fix. The nested lane is used for agent-to-agent messaging and should have similar concurrency to subagent lane since both represent "background" agent work.

---

Investigation completed at ~21:15 EST.
