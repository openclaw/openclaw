services:
  openclaw:
    image: h4x3rotab/openclaw-cvm@sha256:36f85260e6720e7201aaeef111d24f77e50d84047cd9b645a125806fcc6713fc
    # For local builds, uncomment below and comment out image:
    # build:
    #   context: ..
    #   dockerfile: phala-deploy/Dockerfile
    container_name: openclaw
    privileged: true
    ports:
      - "1022:22"
      - "18789:18789"
    volumes:
      - /home/root/.ssh:/root/.ssh:ro
      - openclaw_data:/data
      - docker_data:/var/lib/docker

    environment:
      NODE_ENV: production
      # Master key — derives rclone crypt passwords + gateway auth token via HKDF
      MASTER_KEY: ${MASTER_KEY:-}
      # Redpill AI provider
      REDPILL_API_KEY: ${REDPILL_API_KEY:-}
      # Encrypted S3 storage (optional — omit S3_BUCKET to use local volume)
      S3_BUCKET: ${S3_BUCKET:-}
      S3_PREFIX: ${S3_PREFIX:-openclaw-data}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_PROVIDER: ${S3_PROVIDER:-Other}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      # Override derived crypt passwords (optional — only if not using MASTER_KEY)
      RCLONE_CRYPT_PASSWORD: ${RCLONE_CRYPT_PASSWORD:-}
      RCLONE_CRYPT_PASSWORD2: ${RCLONE_CRYPT_PASSWORD2:-}
      # Bootstrap config (base64-encoded openclaw.json, used on first boot only)
      OPENCLAW_CONFIG_B64: ${OPENCLAW_CONFIG_B64:-}
      # Dstack runtime vars (used by config env-substitution for mux inboundUrl)
      DSTACK_APP_ID: ${DSTACK_APP_ID:-}
      DSTACK_GATEWAY_DOMAIN: ${DSTACK_GATEWAY_DOMAIN:-}
      # Debug logging (set to 1 to enable)
      OPENCLAW_RAW_STREAM: ${OPENCLAW_RAW_STREAM:-}
      OPENCLAW_ANTHROPIC_PAYLOAD_LOG: ${OPENCLAW_ANTHROPIC_PAYLOAD_LOG:-}
    restart: unless-stopped

volumes:
  openclaw_data:
  docker_data:
